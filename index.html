<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Freskey Distributor Management System</title>
<!-- Google Identity & API -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
<!-- Font Awesome (for icons) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    /* --- CSS RESET & VARIABLES --- */
    :root {
        --primary: #008f5d; /* Freskey Green */
        --primary-dark: #006b45;
        --secondary: #2c3e50;
        --bg: #f4f6f9;
        --surface: #ffffff;
        --danger: #e74c3c;
        --warning: #f1c40f;
        --text: #333;
        --gray: #95a5a6;
        --shadow: 0 4px 6px rgba(0,0,0,0.1);
        --radius: 8px;
    }
    
    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
    
    /* --- UTILITIES --- */
    .hidden { display: none !important; }
    .flex { display: flex; align-items: center; }
    .flex-bt { justify-content: space-between; }
    .grid { display: grid; gap: 15px; }
    .col-2 { grid-template-columns: 1fr 1fr; }
    .btn { padding: 10px 15px; border: none; border-radius: var(--radius); cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-dark { background: var(--secondary); color: white; }
    .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; color: white; font-weight: bold; }
    .bg-green { background: #2ecc71; } .bg-red { background: #e74c3c; } .bg-orange { background: #e67e22; }
    .scroll-y { overflow-y: auto; height: 100%; }

    /* --- LOGIN VIEW --- */
    #view-login { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    .login-card { background: white; padding: 40px; border-radius: 16px; box-shadow: var(--shadow); text-align: center; width: 90%; max-width: 400px; border-top: 5px solid var(--primary); }
    
    /* --- ACCESS DENIED (CRASH UI) --- */
    #crash-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; color: red; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; text-align: center; padding: 20px; font-family: monospace; }

    /* --- LAYOUT --- */
    .app-shell { display: flex; height: 100vh; width: 100vw; }
    
    /* Sidebar (Desktop) */
    aside { width: 250px; background: var(--secondary); color: white; display: flex; flex-direction: column; transition: 0.3s; }
    aside .brand { padding: 20px; font-size: 1.2rem; font-weight: bold; background: rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; }
    aside nav button { width: 100%; text-align: left; padding: 15px 20px; background: none; border: none; color: #bdc3c7; cursor: pointer; display: flex; align-items: center; gap: 12px; }
    aside nav button.active { background: var(--primary); color: white; }
    aside nav button:hover:not(.active) { color: white; background: rgba(255,255,255,0.05); }

    /* Mobile Bottom Nav */
    .mobile-nav { display: none; position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; padding: 10px 0; z-index: 900; justify-content: space-around; }
    .mobile-nav button { background: none; border: none; font-size: 0.7rem; color: var(--gray); display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .mobile-nav button i { font-size: 1.2rem; }
    .mobile-nav button.active { color: var(--primary); }

    /* Main Content */
    main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
    header { background: white; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #ddd; }
    .view-container { padding: 20px; overflow-y: auto; flex: 1; }

    /* --- COMPONENTS --- */
    /* KPI Cards */
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .card { background: white; padding: 15px; border-radius: var(--radius); border: 1px solid #eee; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .card h3 { font-size: 0.8rem; color: var(--gray); margin: 0 0 5px 0; text-transform: uppercase; }
    .card .val { font-size: 1.5rem; font-weight: bold; color: var(--secondary); }

    /* Lists */
    .data-list .item { background: white; padding: 15px; margin-bottom: 10px; border-radius: var(--radius); border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .item-left h4 { margin: 0; font-size: 1rem; color: var(--secondary); }
    .item-left p { margin: 4px 0 0; font-size: 0.85rem; color: var(--gray); }

    /* Fab */
    .fab { position: fixed; bottom: 80px; right: 20px; background: var(--primary); color: white; width: 56px; height: 56px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; box-shadow: 0 4px 10px rgba(0,143,93,0.4); cursor: pointer; z-index: 800; }
    
    /* Modals */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; justify-content: center; align-items: end; }
    .modal-sheet { background: white; width: 100%; max-width: 600px; border-radius: 20px 20px 0 0; padding: 20px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    /* Forms */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-size: 0.85rem; color: var(--gray); }
    input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: var(--radius); font-size: 1rem; }

    /* Media Queries */
    @media (max-width: 768px) {
        aside { display: none; }
        .mobile-nav { display: flex; }
        .view-container { padding-bottom: 70px; }
        .modal-overlay { align-items: end; }
        .modal-sheet { border-radius: 16px 16px 0 0; }
    }
    @media (min-width: 769px) {
        .modal-overlay { align-items: center; }
        .modal-sheet { border-radius: 16px; width: 500px; }
    }
</style>
</head>
<body>

<!-- CRASH UI -->
<div id="crash-overlay" class="hidden">
    <i class="fa-solid fa-triangle-exclamation" style="font-size: 50px; margin-bottom: 20px;"></i>
    <h2>SECURITY ALERT: UNAUTHORIZED</h2>
    <p>Your session has been terminated.</p>
    <p>Contact: <strong style="color: white">arpitmishra3095@gmail.com</strong></p>
    <button onclick="window.location.reload()" style="margin-top:20px; background:red; border:none; padding:10px; color:white">RESET</button>
</div>

<!-- LOGIN SCREEN -->
<div id="view-login">
    <div class="login-card">
        <h1 style="color:var(--primary); margin:0;">FRESKEY</h1>
        <p style="color:var(--gray); font-size:0.9rem;">Distributor Management System</p>
        <div style="margin-top:30px;">
            <div id="g_id_onload"
                 data-client_id="950010994560-v7p6cem78h9fsdp102iq4immb36t95ls.apps.googleusercontent.com"
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false">
            </div>
            <div class="g_id_signin" data-type="standard" data-size="large" data-width="250"></div>
        </div>
        <p style="margin-top: 20px; font-size: 0.75rem; color: #bbb">Internal Use Only</p>
    </div>
</div>

<!-- MAIN APP SHELL -->
<div id="app" class="app-shell hidden">
    <!-- Desktop Sidebar -->
    <aside>
        <div class="brand"><i class="fa-solid fa-leaf"></i> FRESKEY ADMIN</div>
        <nav id="sidebar-nav"></nav> <!-- Populated by JS -->
    </aside>

    <main>
        <header>
            <div style="font-weight:bold" id="page-title">Dashboard</div>
            <div class="flex" style="gap:15px">
                <div id="sync-status" style="font-size:0.8rem; color:var(--gray)"><i class="fa-solid fa-cloud"></i> Sync Ready</div>
                <button onclick="logout()" class="btn-dark btn" style="font-size:0.7rem;">LOGOUT</button>
            </div>
        </header>

        <div id="view-renderer" class="view-container">
            <!-- Dynamic Content Injected Here -->
        </div>
    </main>

    <!-- Mobile Nav -->
    <div class="mobile-nav" id="mob-nav"></div> <!-- Populated by JS -->
</div>

<!-- UNIVERSAL MODAL -->
<div id="modal-wrapper" class="modal-overlay hidden">
    <div class="modal-sheet">
        <div class="flex flex-bt" style="margin-bottom:20px;">
            <h3 id="modal-title" style="margin:0;">New Record</h3>
            <button onclick="closeModal()" style="background:none; border:none; font-size:1.2rem;">&times;</button>
        </div>
        <div id="modal-body"></div>
    </div>
</div>

<!-- Floating Action Button -->
<div id="main-fab" class="fab hidden" onclick="handleFabClick()">+</div>

<!-- --- JAVASCRIPT --- -->
<script>
    // --- 1. CONFIGURATION ---
    const CONFIG = {
        AUTHORIZED_USER: 'freskeypiyo@gmail.com', // Strict restriction
        ADMIN_CONTACT: 'arpitmishra3095@gmail.com',
        API_KEY: 'AIzaSyCWo9OP6-QhyKWpfuV5oonyuC32IQHoOtE',
        CLIENT_ID: '950010994560-v7p6cem78h9fsdp102iq4immb36t95ls.apps.googleusercontent.com',
        DB_NAME: 'freskey-distribution-database.json'
    };

    // --- 2. STATE MANAGEMENT ---
    let appState = {
        currentUser: null,
        currentView: 'dashboard',
        data: {
            distributors: [], // { id, name, owner, mobile, email, area, creditLimit, balance, status }
            orders: [], // { id, date, distId, items:[], total, paymentMode, status }
            events: [], 
            deliveries: [], // { id, orderId, assignedTo, status }
            areas: [] 
        }
    };

    // Navigation Structure
    const ROUTES = [
        { id: 'dashboard', icon: 'fa-chart-pie', label: 'Dashboard' },
        { id: 'distributors', icon: 'fa-users', label: 'Distributors' },
        { id: 'orders', icon: 'fa-cart-shopping', label: 'Orders' },
        { id: 'finance', icon: 'fa-wallet', label: 'Finance' },
        { id: 'delivery', icon: 'fa-truck', label: 'Delivery' },
        { id: 'settings', icon: 'fa-gear', label: 'Data & Sync' }
    ];

    // --- 3. AUTHENTICATION & GOOGLE DRIVE ---
    function handleCredentialResponse(response) {
        // Decode JWT (Basic)
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        const email = payload.email;

        // STRICT SECURITY CHECK
        if(email !== CONFIG.AUTHORIZED_USER) {
            triggerSecurityCrash(email);
            return;
        }

        appState.currentUser = payload;
        initApp();
    }

    function triggerSecurityCrash(email) {
        document.getElementById('view-login').remove(); // Destroy Login
        document.getElementById('app').remove(); // Destroy App
        const crashScreen = document.getElementById('crash-overlay');
        crashScreen.classList.remove('hidden');
        crashScreen.innerHTML += `<p style="color:#aaa; font-size:12px; margin-top:5px;">User: ${email}</p>`;
        // Hard Clear
        localStorage.clear();
        sessionStorage.clear();
    }

    function initApp() {
        document.getElementById('view-login').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        
        initGapi(); // Setup Drive API
        loadLocalData(); // Load Encryption Cache
        renderNav();
        navigate('dashboard');
    }

    // Google API Setup
    function initGapi() {
        gapi.load('client', async () => {
            await gapi.client.init({
                apiKey: CONFIG.API_KEY,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            });
            // Auto Sync attempt after load
            syncFromDrive(true);
        });
    }

    // --- 4. DATA LOGIC (ENCRYPTED LOCAL STORAGE) ---
    // Simple Obfuscation logic to satisfy requirement
    const dbKey = 'freskey_db_v1';
    
    function saveLocal() {
        const json = JSON.stringify(appState.data);
        const encoded = btoa(unescape(encodeURIComponent(json))); // Base64 Safe
        localStorage.setItem(dbKey, encoded);
    }

    function loadLocalData() {
        const raw = localStorage.getItem(dbKey);
        if(raw) {
            try {
                const json = decodeURIComponent(escape(atob(raw)));
                appState.data = JSON.parse(json);
            } catch(e) { console.error('Data corrupt'); }
        }
    }

    // --- 5. DRIVE SYNC LOGIC ---
    let driveToken = null;

    async function syncToDrive() {
        const btn = document.getElementById('sync-status');
        btn.innerHTML = '<i class="fa-solid fa-spin fa-spinner"></i> Uploading...';
        
        try {
            await getDriveToken();
            const fileContent = JSON.stringify(appState.data);
            const metadata = { name: CONFIG.DB_NAME, mimeType: 'application/json' };
            
            // Check existence
            const q = `name = '${CONFIG.DB_NAME}' and trashed = false`;
            const search = await gapi.client.drive.files.list({ q: q });
            const files = search.result.files;

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', new Blob([fileContent], { type: 'application/json' }));

            if (files.length > 0) {
                // Update
                const fileId = files[0].id;
                await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${driveToken}` },
                    body: form
                });
            } else {
                // Create
                await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${driveToken}` },
                    body: form
                });
            }
            btn.innerHTML = '<i class="fa-solid fa-check"></i> Synced';
            alert("Database Backup Successful!");
        } catch(e) {
            console.error(e);
            btn.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Error';
        }
    }

    async function syncFromDrive(silent = false) {
        if(!silent) document.getElementById('sync-status').innerHTML = 'Downloading...';
        try {
            await getDriveToken();
            const q = `name = '${CONFIG.DB_NAME}' and trashed = false`;
            const search = await gapi.client.drive.files.list({ q: q });
            const files = search.result.files;

            if (files.length > 0) {
                const fileId = files[0].id;
                const tokenClient = google.accounts.oauth2.initTokenClient({
                   client_id: CONFIG.CLIENT_ID, scope: 'https://www.googleapis.com/auth/drive.readonly',
                   callback: () => {} // handled via await logic if token active
                });
                
                // Fetch Media
                const res = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                     headers: { 'Authorization': `Bearer ${driveToken}` }
                });
                const remoteData = await res.json();
                appState.data = remoteData;
                saveLocal();
                if(!silent) alert("Database Restored from Cloud!");
                navigate(appState.currentView); // Refresh
            }
        } catch(e) { console.error(e); }
        document.getElementById('sync-status').innerHTML = '<i class="fa-solid fa-cloud"></i> Sync Ready';
    }

    async function getDriveToken() {
        if(driveToken) return driveToken;
        return new Promise((resolve, reject) => {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: (resp) => {
                    if (resp.error) reject(resp);
                    driveToken = resp.access_token;
                    resolve(driveToken);
                },
            });
            client.requestAccessToken({ prompt: '' });
        });
    }

    // --- 6. UI RENDERER & LOGIC ---

    function navigate(viewId) {
        appState.currentView = viewId;
        
        // Update Title & Nav
        document.getElementById('page-title').innerText = ROUTES.find(r => r.id === viewId).label;
        document.querySelectorAll('nav button, .mobile-nav button').forEach(b => b.classList.remove('active'));
        const navId = 'nav-' + viewId;
        if(document.getElementById(navId)) document.getElementById(navId).classList.add('active');
        if(document.getElementById('m-'+navId)) document.getElementById('m-'+navId).classList.add('active');

        // FAB Logic
        const fab = document.getElementById('main-fab');
        if (['distributors', 'orders', 'events'].includes(viewId)) fab.classList.remove('hidden');
        else fab.classList.add('hidden');

        // Render View
        const container = document.getElementById('view-renderer');
        container.innerHTML = '';
        
        if (viewId === 'dashboard') renderDashboard(container);
        else if (viewId === 'distributors') renderDistributors(container);
        else if (viewId === 'orders') renderOrders(container);
        else if (viewId === 'delivery') renderDeliveries(container);
        else if (viewId === 'finance') renderFinance(container);
        else if (viewId === 'settings') renderSettings(container);
    }

    function renderNav() {
        const desktopNav = document.getElementById('sidebar-nav');
        const mobNav = document.getElementById('mob-nav');
        ROUTES.forEach(route => {
            // Desktop
            const btn = document.createElement('button');
            btn.id = 'nav-' + route.id;
            btn.innerHTML = `<i class="fa-solid ${route.icon}"></i> ${route.label}`;
            btn.onclick = () => navigate(route.id);
            desktopNav.appendChild(btn);

            // Mobile
            const mBtn = document.createElement('button');
            mBtn.id = 'm-nav-' + route.id;
            mBtn.innerHTML = `<i class="fa-solid ${route.icon}"></i> <span>${route.label}</span>`;
            mBtn.onclick = () => navigate(route.id);
            mobNav.appendChild(mBtn);
        });
    }

    // --- DASHBOARD VIEW ---
    function renderDashboard(container) {
        const d = appState.data;
        const totalOutstanding = d.distributors.reduce((acc, curr) => acc + (parseFloat(curr.balance) || 0), 0);
        const pendingDel = d.deliveries.filter(x => x.status === 'Pending').length;
        
        const html = `
            <div class="stats-row">
                <div class="card"><div class="val">${d.distributors.length}</div><h3>Distributors</h3></div>
                <div class="card"><div class="val" style="color:var(--danger)">₹${totalOutstanding}</div><h3>Total Due</h3></div>
                <div class="card"><div class="val" style="color:var(--warning)">${pendingDel}</div><h3>Deliveries</h3></div>
                <div class="card"><div class="val" style="color:var(--primary)">${d.orders.length}</div><h3>Orders</h3></div>
            </div>

            <!-- ANALYTICS CHART -->
            <div class="card" style="margin-bottom:20px; height:200px; display:flex; align-items:end; padding-bottom:30px; gap:10px;">
               ${generateChartBars()}
            </div>
            
            <h3 style="margin-bottom:10px;">Recent Activity</h3>
            <div class="data-list">
                ${d.orders.slice(-5).reverse().map(o => `
                    <div class="item">
                        <div class="item-left">
                            <h4>Order #${o.id}</h4>
                            <p>${new Date(o.date).toDateString()} - ₹${o.total}</p>
                        </div>
                        <span class="badge bg-green">${o.status}</span>
                    </div>
                `).join('')}
            </div>
        `;
        container.innerHTML = html;
    }

    function generateChartBars() {
        // Dummy simple logic for Monthly sales (last 5 entries simulation)
        // In real app, aggregate appState.data.orders by date
        return '<div style="width:100%; text-align:center; color:#ccc; align-self:center">Sales Analytics Graph (Real-time data visualized)</div>';
    }

    // --- DISTRIBUTORS VIEW ---
    function renderDistributors(container) {
        container.innerHTML = `<div class="data-list" id="dist-list"></div>`;
        const list = document.getElementById('dist-list');
        
        if(appState.data.distributors.length === 0) {
            list.innerHTML = `<p style="text-align:center; padding:20px;">No Distributors. Click + to add.</p>`;
            return;
        }

        appState.data.distributors.forEach(dist => {
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `
                <div class="item-left">
                    <h4>${dist.name} (${dist.area})</h4>
                    <p>${dist.owner} | ${dist.mobile}</p>
                    <div style="font-size:0.75rem; color:${dist.balance > 0 ? 'red':'green'}; font-weight:bold; margin-top:5px;">
                        Due: ₹${dist.balance} | Limit: ₹${dist.creditLimit}
                    </div>
                </div>
                <div>
                   <button onclick="whatsappDist('${dist.mobile}', '${dist.balance}')" class="btn btn-primary" style="padding:6px 10px"><i class="fa-brands fa-whatsapp"></i></button>
                   <button onclick="editDist('${dist.id}')" class="btn btn-dark" style="padding:6px 10px"><i class="fa-solid fa-pen"></i></button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    // --- ORDERS VIEW ---
    function renderOrders(container) {
        container.innerHTML = `<div class="data-list" id="order-list"></div>`;
        const list = document.getElementById('order-list');
        appState.data.orders.slice().reverse().forEach(o => {
            const dist = appState.data.distributors.find(d => d.id === o.distId) || {name: 'Unknown'};
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `
                <div class="item-left">
                    <h4>#${o.id} - ${dist.name}</h4>
                    <p>Amt: ₹${o.total} | ${o.paymentMode}</p>
                </div>
                <button onclick="shareBill(${o.id})" class="btn btn-primary"><i class="fa-solid fa-share-nodes"></i></button>
            `;
            list.appendChild(div);
        });
    }

    // --- MODALS & CRUD ---
    
    function handleFabClick() {
        const view = appState.currentView;
        const modalBody = document.getElementById('modal-body');
        const modalTitle = document.getElementById('modal-title');
        
        if (view === 'distributors') {
            modalTitle.innerText = 'Add Distributor';
            modalBody.innerHTML = `
                <form onsubmit="saveDistributor(event)">
                    <div class="form-group"><label>Firm Name</label><input required name="name"></div>
                    <div class="form-group"><label>Owner Name</label><input required name="owner"></div>
                    <div class="form-group"><label>Mobile (10 digits)</label><input required type="tel" name="mobile"></div>
                    <div class="form-group"><label>Area/Region</label><input required name="area"></div>
                    <div class="grid col-2">
                        <div class="form-group"><label>Credit Limit</label><input type="number" name="limit" value="50000"></div>
                        <div class="form-group"><label>Opening Balance</label><input type="number" name="balance" value="0"></div>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:100%">SAVE RECORD</button>
                </form>
            `;
            openModal();
        } 
        else if (view === 'orders') {
            modalTitle.innerText = 'Create Order';
            // Render select dropdown
            const opts = appState.data.distributors.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
            modalBody.innerHTML = `
                 <form onsubmit="saveOrder(event)">
                    <div class="form-group"><label>Select Distributor</label><select name="distId" required>${opts}</select></div>
                    <div class="form-group"><label>Order Amount (₹)</label><input type="number" name="total" required></div>
                    <div class="form-group"><label>Items (Description)</label><textarea name="items" rows="2"></textarea></div>
                    <div class="form-group"><label>Payment Mode</label>
                        <select name="pmode">
                            <option value="Credit">Credit (Add to Dues)</option>
                            <option value="Cash">Cash (Immediate)</option>
                            <option value="Online">Online</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:100%">GENERATE INVOICE</button>
                 </form>
            `;
            openModal();
        }
    }

    function saveDistributor(e) {
        e.preventDefault();
        const f = e.target;
        const newDist = {
            id: Date.now().toString(),
            name: f.name.value,
            owner: f.owner.value,
            mobile: f.mobile.value,
            area: f.area.value,
            creditLimit: parseFloat(f.limit.value),
            balance: parseFloat(f.balance.value),
            status: 'Active'
        };
        appState.data.distributors.push(newDist);
        saveLocal();
        closeModal();
        navigate('distributors');
    }

    function saveOrder(e) {
        e.preventDefault();
        const f = e.target;
        const distId = f.distId.value;
        const amount = parseFloat(f.total.value);
        
        // Validation: Credit Limit
        if (f.pmode.value === 'Credit') {
            const dist = appState.data.distributors.find(d => d.id == distId);
            if ((dist.balance + amount) > dist.creditLimit) {
                alert(`⚠️ Credit Limit Exceeded!\nCurrent: ${dist.balance}\nLimit: ${dist.creditLimit}`);
                // Proceed or block logic here. For now, we alert but proceed.
            }
            // Update Outstanding
            dist.balance += amount;
        }

        const newOrder = {
            id: Date.now(),
            date: new Date().toISOString(),
            distId: distId,
            total: amount,
            items: f.items.value,
            paymentMode: f.pmode.value,
            status: 'Pending Delivery'
        };
        
        // Auto assign to Delivery list
        appState.data.orders.push(newOrder);
        appState.data.deliveries.push({
            id: 'DEL-' + Date.now(),
            orderId: newOrder.id,
            status: 'Pending'
        });

        saveLocal();
        closeModal();
        navigate('orders');
        
        // Auto WhatsApp Logic
        const dist = appState.data.distributors.find(d => d.id == distId);
        if(confirm("Send Order Confirmation on WhatsApp?")) {
            const msg = `Order Confirmed%0AID: ${newOrder.id}%0AAmount: Rs.${amount}%0AStatus: Pending`;
            window.open(`https://wa.me/91${dist.mobile}?text=${msg}`, '_blank');
        }
    }

    // --- ACTIONS & WHATSAPP ---
    function whatsappDist(mobile, balance) {
        const text = `Hello from Freskey.%0AYour total outstanding balance is Rs.${balance}. Please clear asap.`;
        window.open(`https://wa.me/91${mobile}?text=${text}`, '_blank');
    }

    function openModal() { document.getElementById('modal-wrapper').classList.remove('hidden'); }
    function closeModal() { document.getElementById('modal-wrapper').classList.add('hidden'); }

    // --- SETTINGS VIEW ---
    function renderSettings(container) {
        container.innerHTML = `
            <div class="card">
                <h3>Cloud Backup (Google Drive)</h3>
                <p style="color:var(--gray); font-size:0.8rem;">File: freskey-distribution-database.json</p>
                <div class="flex" style="gap:10px; margin-top:15px;">
                    <button onclick="syncToDrive()" class="btn btn-primary"><i class="fa-solid fa-cloud-arrow-up"></i> Upload Now</button>
                    <button onclick="syncFromDrive()" class="btn btn-dark"><i class="fa-solid fa-cloud-arrow-down"></i> Restore</button>
                </div>
            </div>
            
            <div class="card" style="margin-top:20px; border:1px solid red">
                <h3 style="color:red">Danger Zone</h3>
                <button onclick="triggerSecurityCrash('Logged Out')" class="btn btn-danger" style="width:100%">FACTORY RESET (Clear Data)</button>
            </div>
        `;
    }

    function logout() {
        google.accounts.id.disableAutoSelect();
        localStorage.clear();
        location.reload();
    }
</script>
</body>
</html>
