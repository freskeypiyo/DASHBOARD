<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <meta name="google-site-verification" content="Nb1niD3Ze90kAE2IZMWifCqivPVVWyO7ufwTUlBMSdU" />
    <title>Freskey Enterprise Admin | Cloud ERP</title>
    
    <!-- ================================================================================== 
         EXTERNAL DEPENDENCIES
         We use CDNs for Google Auth, PDF Generation, and Excel Generation.
         ================================================================================== -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* ================================================================================== 
           1. CSS VARIABLES & RESET 
           ================================================================================== */
        :root {
            /* Color Palette - Slate & Blue Theme */
            --primary-900: #0f172a;
            --primary-800: #1e293b;
            --primary-700: #334155;
            --primary-100: #f1f5f9;
            
            --accent-500: #0ea5e9; /* Sky Blue */
            --accent-600: #0284c7;
            
            --success-500: #10b981; /* Emerald */
            --success-bg: #dcfce7;
            --success-text: #166534;
            
            --warning-500: #f59e0b; /* Amber */
            --warning-bg: #fef3c7;
            --warning-text: #92400e;
            
            --danger-500: #ef4444; /* Red */
            --danger-bg: #fee2e2;
            --danger-text: #991b1b;
            
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-800: #1f2937;
            
            --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            
            --radius-md: 8px;
            --radius-lg: 12px;
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --sidebar-width: 260px;
            --header-height: 64px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--gray-100);
            color: var(--gray-800);
            font-size: 14px;
            line-height: 1.5;
            height: 100vh;
            overflow: hidden; /* App-like feel */
        }

        /* ================================================================================== 
           2. LAYOUT COMPONENTS 
           ================================================================================== */



        /* ================================================================================== 
   ORDER HISTORY SPECIFIC STYLES 
   ================================================================================== */
.filter-bar {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr auto;
    gap: 10px;
    margin-bottom: 1rem;
    background: var(--gray-50);
    padding: 1rem;
    border-radius: var(--radius-md);
    border: 1px solid var(--gray-200);
}

.table-compact th { padding: 0.75rem 0.5rem; font-size: 0.7rem; }
.table-compact td { padding: 0.75rem 0.5rem; font-size: 0.85rem; vertical-align: middle; }

/* Item Pill Style */
.item-pill {
    background: var(--primary-100);
    color: var(--primary-800);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-block;
    margin-right: 4px;
}

/* Balance Colors */
.bal-zero { color: var(--success-500); font-weight: 700; }
.bal-due { color: var(--danger-500); font-weight: 700; }

/* Expandable Rows */
.tr-clickable { cursor: pointer; transition: background 0.1s; }
.tr-clickable:hover { background: var(--gray-50); }
.tr-details { display: none; background: #f8fafc; }
.tr-details.active { display: table-row; }
.detail-box { padding: 1rem; border-left: 3px solid var(--accent-500); margin: 0.5rem; }

/* Mobile Filter Adjustment */
@media (max-width: 768px) {
    .filter-bar { grid-template-columns: 1fr; }
    .hide-mobile { display: none; }
} 
        #app-root {
            display: flex;
            height: 100vh;
            width: 100vw;
            transition: all 0.3s ease;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-900);
            color: var(--white);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--primary-800);
            flex-shrink: 0;
            z-index: 50;
            transition: transform 0.3s ease;
        }

        .brand-container {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.1);
        }

        .brand-logo {
            font-size: 1.25rem;
            font-weight: 800;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-container {
            flex: 1;
            padding: 1.5rem 0;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.85rem 1.5rem;
            color: var(--gray-300);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background-color: rgba(255,255,255,0.05);
            color: var(--white);
        }

        .nav-item.active {
            background-color: rgba(14, 165, 233, 0.1);
            color: var(--accent-500);
            border-left-color: var(--accent-500);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            fill: currentColor;
        }

        .user-profile {
            padding: 1rem 1.5rem;
            background-color: rgba(0,0,0,0.2);
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .user-email {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sync-status {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--success-500);
        }

        /* Main Content Styles */
        .main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .top-header {
            height: var(--header-height);
            background-color: var(--white);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            box-shadow: var(--shadow-sm);
            z-index: 40;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-900);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            scroll-behavior: smooth;
        }

        /* ================================================================================== 
           3. UI COMPONENTS 
           ================================================================================== */
        
        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--radius-md);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-800);
        }

        /* Grid Systems */
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }

        /* Stats Card */
        .stat-card {
            display: flex;
            flex-direction: column;
        }
        .stat-label { font-size: 0.85rem; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .stat-value { font-size: 2rem; font-weight: 800; color: var(--primary-900); margin: 0.5rem 0; }
        .stat-trend { font-size: 0.8rem; color: var(--success-500); display: flex; align-items: center; gap: 4px; }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            gap: 8px;
        }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        .btn-primary { background: var(--primary-900); color: var(--white); }
        .btn-primary:hover { background: var(--primary-800); }
        .btn-accent { background: var(--accent-500); color: var(--white); }
        .btn-accent:hover { background: var(--accent-600); }
        .btn-success { background: var(--success-500); color: var(--white); }
        .btn-danger { background: var(--danger-500); color: var(--white); }
        .btn-outline { background: transparent; border-color: var(--gray-300); color: var(--gray-800); }
        .btn-outline:hover { background: var(--gray-100); border-color: var(--gray-400); }

        /* Tables */
        .table-responsive {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--gray-200);
        }
        table { width: 100%; border-collapse: collapse; background: var(--white); white-space: nowrap; }
        th {
            background: var(--gray-50);
            padding: 1rem;
            text-align: left;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--gray-500);
            font-weight: 700;
            border-bottom: 1px solid var(--gray-200);
        }
        td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            color: var(--gray-800);
        }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: var(--gray-50); }

        /* Badges */
        .badge {
            display: inline-flex;
            padding: 0.25rem 0.6rem;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 700;
            line-height: 1;
        }
        .badge-success { background: var(--success-bg); color: var(--success-text); }
        .badge-warning { background: var(--warning-bg); color: var(--warning-text); }
        .badge-danger { background: var(--danger-bg); color: var(--danger-text); }
        .badge-info { background: #e0f2fe; color: #075985; }


        /* TRACKING STYLES */
.track-stepper {
    display: flex;
    justify-content: space-between;
    margin: 1.5rem 0;
    position: relative;
}
.track-stepper::before {
    content: ''; position: absolute; top: 15px; left: 0; width: 100%; height: 2px;
    background: var(--gray-200); z-index: 1;
}
.step-item {
    position: relative; z-index: 2; text-align: center; background: var(--white); padding: 0 10px;
}
.step-circle {
    width: 32px; height: 32px; border-radius: 50%; background: var(--gray-200); color: var(--gray-500);
    display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-weight: bold;
    border: 2px solid var(--white);
}
.step-item.active .step-circle { color: white; }
.step-item.active.s1 .step-circle { background: var(--warning-500); } /* Order Made - Orange */
.step-item.active.s2 .step-circle { background: var(--accent-500); }  /* Dispatch - Blue */
.step-item.active.s3 .step-circle { background: var(--success-500); } /* Delivered - Green */

.pay-progress { height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden; margin-top: 5px; }
.pay-bar { height: 100%; background: var(--success-500); }

        /* Forms */
        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--primary-800); font-size: 0.9rem; }
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.2s;
            background: var(--white);
        }
        .form-control:focus { outline: none; border-color: var(--accent-500); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); }
        .form-control[readonly] { background: var(--gray-100); cursor: not-allowed; }

        /* ================================================================================== 
           4. MODALS & OVERLAYS 
           ================================================================================== */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active { opacity: 1; pointer-events: all; }

        .modal-container {
            background: var(--white);
            width: 90%;
            max-width: 650px;
            max-height: 90vh;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            transform: translateY(20px);
            transition: transform 0.3s ease;
            position: relative;
        }

        .modal-overlay.active .modal-container { transform: translateY(0); }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title { font-size: 1.25rem; font-weight: 700; color: var(--primary-900); }
        
        /* CLOSE BUTTON STYLE */
        .btn-close {
            background: var(--gray-100);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--gray-500);
            transition: all 0.2s;
        }
        .btn-close:hover { background: var(--danger-bg); color: var(--danger-text); }

        .modal-body { padding: 1.5rem; overflow-y: auto; }
        .modal-footer { padding: 1.5rem; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 1rem; }

        /* ================================================================================== 
           5. NOTIFICATIONS (TOASTS) 
           ================================================================================== */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            background: var(--white);
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--accent-500);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideInRight 0.3s ease forwards;
        }

        .toast.success { border-left-color: var(--success-500); }
        .toast.error { border-left-color: var(--danger-500); }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ================================================================================== 
           6. MOBILE RESPONSIVENESS 
           ================================================================================== */
        .mobile-toggle { display: none; cursor: pointer; }
        .mobile-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 45; }

        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -100%; height: 100%; box-shadow: var(--shadow-lg); }
            .sidebar.open { left: 0; }
            .mobile-toggle { display: block; margin-right: 1rem; }
            .mobile-overlay.active { display: block; }
            .top-header { padding: 0 1rem; }
            .content-area { padding: 1rem; }
            .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr; }
        }

        /* ================================================================================== 
           7. LOGIN SCREEN 
           ================================================================================== */
        #login-view {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary-900);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-card {
            background: var(--white);
            padding: 3rem;
            border-radius: var(--radius-lg);
            text-align: center;
            width: 90%;
            max-width: 420px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="login-view">
        <div class="login-card">
            <h1 style="font-size: 2.5rem; font-weight: 800; color: var(--primary-900); margin-bottom: 0.5rem;">
                FRESKEY<span style="color: var(--accent-500);">.</span>
            </h1>
            <p style="color: var(--gray-500); margin-bottom: 2rem;">Enterprise Resource Planning</p>
            
            <button class="btn btn-outline" style="width: 100%; padding: 1rem; justify-content: center;" onclick="AuthManager.signIn()">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                Sign In with Google
            </button>
            <p id="login-status" style="margin-top: 1.5rem; font-size: 0.85rem; color: var(--gray-500);">Secure Cloud Access Required</p>
        </div>
    </div>

    <!-- MAIN APP STRUCTURE -->
    <div id="app-root" style="display: none;">
        
        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <div class="brand-container">
                <div class="brand-logo">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                    </svg>
                    FRESKEY ERP
                </div>
            </div>

            <nav class="nav-container">
                <div class="nav-item active" onclick="Router.navigate('dashboard')">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                    Dashboard
                </div>
                <div class="nav-item" onclick="Router.navigate('new-order')">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                    New Order
                </div>
                <!-- PASTE THIS BEFORE THE 'SETTINGS' NAV ITEM -->
<div class="nav-item" onclick="Router.navigate('invoiceGen')">
    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="12" y1="18" x2="12" y2="12"></line>
        <line x1="9" y1="15" x2="15" y2="15"></line>
    </svg>
    E-Invoice Gen
</div>
                <div class="nav-item" onclick="Router.navigate('orders')">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    Order History
                </div>
                <div class="nav-item" onclick="Router.navigate('customers')">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    Customers
                </div>
                <!-- ADD THIS AFTER THE 'NEW ORDER' NAV ITEM -->
<div class="nav-item" onclick="Router.navigate('tracking')">
    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="1" y="3" width="15" height="13"></rect>
        <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
        <circle cx="5.5" cy="18.5" r="2.5"></circle>
        <circle cx="18.5" cy="18.5" r="2.5"></circle>
    </svg>
    Tracking & Pay
</div>
                <div class="nav-item" onclick="Router.navigate('inventory')">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                    Inventory
                </div>
                <div class="nav-item" onclick="Router.navigate('events')">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    Events
                </div>
                <div class="nav-item" onclick="Router.navigate('reports')">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
                    Reports
                </div>
                <div class="nav-item" onclick="Router.navigate('settings')">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    Settings
                </div>
            </nav>

            <div class="user-profile">
                <div class="user-email" id="user-display">Connecting...</div>
                <div class="sync-status">
                    <svg width="10" height="10" viewBox="0 0 10 10" fill="currentColor"><circle cx="5" cy="5" r="5"></circle></svg>
                    <span id="sync-text">System Ready</span>
                </div>
            </div>
        </aside>

        <!-- MOBILE OVERLAY -->
        <div class="mobile-overlay" id="mobile-overlay" onclick="toggleSidebar()"></div>

        <!-- MAIN WRAPPER -->
        <div class="main-wrapper">
            <header class="top-header">
                <div class="header-title">
                    <svg class="mobile-toggle nav-icon" onclick="toggleSidebar()" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    <span id="page-title">Dashboard</span>
                </div>
                <div class="header-actions">
                    <button class="btn btn-outline btn-sm" onclick="DriveAdapter.forceSync()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path><polyline points="17 2 17 8 23 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        Force Save
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="location.reload()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    </button>
                </div>
            </header>

            <div class="content-area" id="main-content">
                <!-- DYNAMIC CONTENT INJECTED HERE -->
            </div>
        </div>
    </div>

    <!-- MODAL CONTAINER (Popups) -->
    <div id="modal-layer" class="modal-overlay">
        <!-- Content Injected via JS -->
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-root" class="toast-container"></div>

    <!-- ================================================================================== 
         JAVASCRIPT APPLICATION LOGIC
         ================================================================================== -->
    <script>
        /**
         * ================================================================================== 
         * 1. CONFIGURATION & CONSTANTS 
         * ================================================================================== 
         */
        const CONFIG = {
            // TODO: REPLACE THIS WITH YOUR ACTUAL GOOGLE CLOUD CLIENT ID
            CLIENT_ID: '950010994560-v7p6cem78h9fsdp102iq4immb36t95ls.apps.googleusercontent.com', 
            API_KEY: '', // Not strictly needed for Drive File Scope access via GIS
            SCOPES: 'https://www.googleapis.com/auth/drive.file',
            FILE_NAME: 'freskey_erp_v1.json',
            CASE_SIZE: {
                '200ml': 24,
                '500ml': 20,
                '1L': 12
            }
        };

        const SKUS = ['200ml', '500ml', '1L'];

        /**
         * ================================================================================== 
         * 2. UTILITY CLASSES 
         * ================================================================================== 
         */
        class Utils {
            static generateId(prefix = 'ID') {
                return prefix + '-' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            }

            static formatCurrency(amount) {
                return '₹' + parseFloat(amount || 0).toFixed(2);
            }

            static formatDate(dateString) {
                if(!dateString) return '-';
                const d = new Date(dateString);
                return d.toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' });
            }

            static deepClone(obj) {
                return JSON.parse(JSON.stringify(obj));
            }

            static getCasesAndBottles(sku, totalBottles) {
                const caseSize = CONFIG.CASE_SIZE[sku];
                const cases = Math.floor(totalBottles / caseSize);
                const loose = totalBottles % caseSize;
                return { cases, loose, text: `${cases} Cases + ${loose} Btls` };
            }
        }

        class ToastManager {
            static show(message, type = 'info') {
                const root = document.getElementById('toast-root');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                let icon = '';
                if(type === 'success') icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                else if(type === 'error') icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12" y2="16"></line></svg>';
                else icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="8"></line></svg>';

                toast.innerHTML = `${icon} <span>${message}</span>`;
                root.appendChild(toast);

                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        }

        class ModalManager {
            static show(title, contentHTML) {
                const layer = document.getElementById('modal-layer');
                layer.innerHTML = `
                    <div class="modal-container">
                        <div class="modal-header">
                            <h3 class="modal-title">${title}</h3>
                            <button class="btn-close" onclick="ModalManager.close()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                        <div class="modal-body">${contentHTML}</div>
                    </div>
                `;
                layer.classList.add('active');
            }

            static close() {
                const layer = document.getElementById('modal-layer');
                layer.classList.remove('active');
                setTimeout(() => layer.innerHTML = '', 300);
            }
        }

        /**
         * ================================================================================== 
         * 3. DATA STORE & STATE MANAGEMENT 
         * ================================================================================== 
         */
        class Store {
            constructor() {
                this.data = {
                    settings: {
                        prices: { '200ml': 10, '500ml': 20, '1L': 40 }
                    },
                    inventory: { '200ml': 0, '500ml': 0, '1L': 0 },
                    customers: [], // { id, name, company, phone, address, limit, balance }
                    orders: [],    // { id, date, custId, items: [{sku, qty, rate}], total, status, paymentMode }
                    events: [],    // { id, name, date, bottles, status }
                    auditLog: []
                };
            }

            load(jsonData) {
                this.data = { ...this.data, ...jsonData };
            }

            get() { return this.data; }

            // Operations
            addCustomer(customer) {
                this.data.customers.push(customer);
                this.log('Added Customer: ' + customer.company);
            }

            updateCustomer(id, updates) {
                const idx = this.data.customers.findIndex(c => c.id === id);
                if (idx > -1) {
                    this.data.customers[idx] = { ...this.data.customers[idx], ...updates };
                    this.log('Updated Customer: ' + this.data.customers[idx].company);
                }
            }

            adjustInventory(sku, qty, operation) {
                if (operation === 'add') this.data.inventory[sku] += qty;
                else this.data.inventory[sku] -= qty;
                
                // Prevent negative inventory visual glitch (logic allows it but we log warning)
                if(this.data.inventory[sku] < 0) this.log(`Warning: Negative Inventory for ${sku}`);
            }

            addOrder(order) {
                this.data.orders.push(order);
                
                // Deduct Inventory
                order.items.forEach(item => {
                    this.adjustInventory(item.sku, item.qty, 'sub');
                });

                // Update Customer Balance if Credit
                if(order.paymentMode === 'Credit') {
                    const cust = this.data.customers.find(c => c.id === order.custId);
                    if(cust) cust.balance += order.total;
                }

                this.log(`Created Order ${order.id}`);
            }

            voidOrder(orderId) {
                const idx = this.data.orders.findIndex(o => o.id === orderId);
                if(idx === -1) return;
                
                const order = this.data.orders[idx];
                
                // Rollback Inventory
                order.items.forEach(item => {
                    this.adjustInventory(item.sku, item.qty, 'add');
                });

                // Rollback Balance
                if(order.paymentMode === 'Credit') {
                    const cust = this.data.customers.find(c => c.id === order.custId);
                    if(cust) cust.balance -= order.total;
                }

                this.data.orders.splice(idx, 1);
                this.log(`Voided Order ${orderId}`);
            }

            log(action) {
                this.data.auditLog.unshift({ time: new Date().toISOString(), action });
                if(this.data.auditLog.length > 50) this.data.auditLog.pop();
            }
        }

        const appStore = new Store();

        /**
         * ================================================================================== 
         * 4. GOOGLE DRIVE ADAPTER 
         * ================================================================================== 
         */
        class DriveAdapter {
            static fileId = null;
            static tokenClient = null;

            static init() {
                this.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.CLIENT_ID,
                    scope: CONFIG.SCOPES,
                    callback: (resp) => this.handleAuthResponse(resp),
                });
                
                gapi.load('client', async () => {
                    await gapi.client.init({
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                    });
                });
            }

            static handleAuthResponse(resp) {
                if (resp.error) {
                    document.getElementById('login-status').innerText = "Access Denied: " + resp.error;
                    return;
                }
                this.onLoginSuccess();
            }

            static async onLoginSuccess() {
                document.getElementById('login-status').innerText = "Loading Database from Cloud...";
                
                // Fetch User Info
                const token = gapi.client.getToken().access_token;
                fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { Authorization: `Bearer ${token}` }})
                .then(r => r.json())
                .then(u => {
                    document.getElementById('user-display').innerText = u.email;
                });

                await this.loadDatabase();
                
                // UI Transition
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('app-root').style.display = 'flex';
                Router.navigate('dashboard');

                // Start Auto Sync
                setInterval(() => this.saveDatabase(true), 60000); 
            }

            static async loadDatabase() {
                try {
                    const q = `name = '${CONFIG.FILE_NAME}' and trashed = false`;
                    const list = await gapi.client.drive.files.list({ q: q, fields: 'files(id, name)' });
                    
                    if (list.result.files.length > 0) {
                        this.fileId = list.result.files[0].id;
                        const file = await gapi.client.drive.files.get({ fileId: this.fileId, alt: 'media' });
                        appStore.load(file.result);
                        ToastManager.show("Database Loaded Successfully", "success");
                    } else {
                        ToastManager.show("Creating New Database...", "info");
                        await this.saveDatabase(false); // Create new file
                    }
                } catch (e) {
                    console.error(e);
                    ToastManager.show("Error Loading Data", "error");
                }
            }

            static async saveDatabase(silent = false) {
                const content = JSON.stringify(appStore.get());
                const metadata = { name: CONFIG.FILE_NAME, mimeType: 'application/json' };
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', new Blob([content], { type: 'application/json' }));

                const token = gapi.client.getToken().access_token;
                
                try {
                    if (!this.fileId) {
                        // Create
                        const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                            method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: form
                        });
                        const val = await res.json();
                        this.fileId = val.id;
                    } else {
                        // Update
                        await fetch(`https://www.googleapis.com/upload/drive/v3/files/${this.fileId}?uploadType=media`, {
                            method: 'PATCH',
                            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                            body: content
                        });
                    }
                    
                    const time = new Date().toLocaleTimeString();
                    document.getElementById('sync-text').innerText = "Synced: " + time;
                    if(!silent) ToastManager.show("Data Saved to Drive", "success");
                } catch(e) {
                    if(!silent) ToastManager.show("Sync Failed", "error");
                }
            }

            static forceSync() { this.saveDatabase(false); }
        }

        class AuthManager {
            static signIn() { DriveAdapter.tokenClient.requestAccessToken({prompt: 'consent'}); }
        }

        /**
         * ================================================================================== 
         * 5. VIEW CONTROLLERS (PAGES) 
         * ================================================================================== 
         */
        const Views = {
            dashboard: function() {
                const data = appStore.get();
                const today = new Date().toISOString().split('T')[0];
                const todayOrders = data.orders.filter(o => o.date === today);
                
                const revenue = todayOrders.reduce((sum, o) => sum + o.total, 0);
                const bottles = todayOrders.reduce((sum, o) => sum + o.items.reduce((s, i) => s + i.qty, 0), 0);
                const customers = data.customers.length;
                const outstanding = data.customers.reduce((sum, c) => sum + c.balance, 0);

                return `
                    <div class="grid-4">
                        <div class="card stat-card">
                            <span class="stat-label">Today's Revenue</span>
                            <div class="stat-value">${Utils.formatCurrency(revenue)}</div>
                            <div class="stat-trend">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
                                <span>Based on ${todayOrders.length} orders</span>
                            </div>
                        </div>
                        <div class="card stat-card">
                            <span class="stat-label">Bottles Sold</span>
                            <div class="stat-value">${bottles}</div>
                            <div class="stat-trend" style="color:var(--accent-500)">Volume Movement</div>
                        </div>
                        <div class="card stat-card">
                            <span class="stat-label">Total Customers</span>
                            <div class="stat-value">${customers}</div>
                            <div class="stat-trend">Active Database</div>
                        </div>
                        <div class="card stat-card">
                            <span class="stat-label">Market Outstanding</span>
                            <div class="stat-value" style="color:var(--danger-500)">${Utils.formatCurrency(outstanding)}</div>
                            <div class="stat-trend" style="color:var(--danger-500)">Credit Collections Pending</div>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Recent Activity</h3></div>
                            ${this._renderRecentOrdersTable(data.orders.slice().reverse().slice(0, 5))}
                        </div>
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Inventory Overview</h3></div>
                            ${this._renderStockPreview(data.inventory)}
                        </div>
                    </div>
                `;
            },

            // ADD THIS NEW VIEW
    tracking: function() {
                // FILTER FIX: Treat undefined trackingStep as 1 so they show up
                const orders = appStore.get().orders.filter(o => {
                    const step = o.trackingStep || 1; 
                    return step <= 3; // Show everything from Ordered to Delivered
                }).reverse();

                if(orders.length === 0) return '<div class="card text-center" style="padding:3rem;"><h3>No Active Orders</h3><p style="color:#888;">New orders will appear here.</p></div>';

                return `
                    <div class="grid-2">
                        ${orders.map(o => {
                            const c = appStore.get().customers.find(cx => cx.id === o.custId);
                            
                            // Safe Data Handling
                            const currentStep = o.trackingStep || 1; 
                            const paid = o.paidAmount || 0;
                            const due = o.total - paid;
                            const pct = Math.min((paid / o.total) * 100, 100);
                            
                            // Step Classes for Colors
                            // s1 = Ordered (Orange), s2 = Dispatched (Blue), s3 = Delivered (Green)
                            const s1 = currentStep >= 1 ? 'active s1' : '';
                            const s2 = currentStep >= 2 ? 'active s2' : '';
                            const s3 = currentStep >= 3 ? 'active s3' : '';

                            return `
                            <div class="card">
                                <div class="card-header" style="align-items:flex-start;">
                                    <div>
                                        <h3 class="card-title">${c ? c.company : 'Unknown'}</h3>
                                        <div style="font-size:0.8rem; color:var(--gray-500)">${o.id} • ${o.date}</div>
                                    </div>
                                    <div style="text-align:right;">
                                        <div class="badge badge-info" style="font-size:0.9rem;">${Utils.formatCurrency(o.total)}</div>
                                        <div style="font-size:0.7rem; color:var(--gray-500); margin-top:4px;">${o.paymentMode}</div>
                                    </div>
                                </div>

                                <!-- 3-PHASE TRACKING VISUAL -->
                                <div class="track-stepper">
                                    <div class="step-item ${s1}">
                                        <div class="step-circle">1</div>
                                        <div style="font-size:0.75rem;">Ordered</div>
                                    </div>
                                    <div class="step-item ${s2}">
                                        <div class="step-circle">2</div>
                                        <div style="font-size:0.75rem;">Dispatched</div>
                                    </div>
                                    <div class="step-item ${s3}">
                                        <div class="step-circle">3</div>
                                        <div style="font-size:0.75rem;">Delivered</div>
                                    </div>
                                </div>

                                <!-- ACTION BUTTONS -->
                                <div style="display:flex; gap:10px; margin-bottom: 1.5rem;">
                                    ${currentStep === 1 ? 
                                        `<button class="btn btn-accent w-full" onclick="Logic.updateTracking('${o.id}', 2)">
                                            <svg width="16" height="16" style="margin-right:5px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
                                            Dispatch Order
                                         </button>` : ''}
                                    ${currentStep === 2 ? 
                                        `<button class="btn btn-success w-full" onclick="Logic.updateTracking('${o.id}', 3)">
                                            <svg width="16" height="16" style="margin-right:5px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                                            Mark Delivered
                                         </button>` : ''}
                                    ${currentStep === 3 ? 
                                        `<button class="btn btn-outline w-full" disabled style="opacity:0.6; cursor:not-allowed;">
                                            Delivered Successfully
                                         </button>` : ''}
                                </div>

                                <!-- PAYMENT SECTION -->
                                <div style="background:var(--gray-50); padding:1rem; border-radius:8px; border:1px solid var(--gray-200);">
                                    <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:5px;">
                                        <span>Paid: <strong>${Utils.formatCurrency(paid)}</strong></span>
                                        <span style="color:${due > 0.5 ? 'var(--danger-500)' : 'var(--success-500)'}; font-weight:700;">
                                            ${due > 0.5 ? 'Due: ' + Utils.formatCurrency(due) : 'Fully Paid'}
                                        </span>
                                    </div>
                                    
                                    <!-- Progress Bar -->
                                    <div class="pay-progress"><div class="pay-bar" style="width:${pct}%"></div></div>
                                    
                                    <!-- Payment Input (Only if Due > 0) -->
                                    ${due > 0.5 ? `
                                        <div style="margin-top:12px; display:flex; gap:8px;">
                                            <input type="number" id="pay-${o.id}" class="form-control" style="padding:6px;" placeholder="Enter Amount">
                                            <button class="btn btn-primary btn-sm" onclick="Logic.addPayment('${o.id}')">Add Pay</button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },




            
           // CHANGE "newOrder" to "'new-order'" (with quotes)
            'new-order': function() {
                const customers = appStore.get().customers;
                // Check if customers exist
                if(customers.length === 0) return `<div class="card text-center"><h3>No Customers</h3><p style="margin:1rem 0; color:#666;">You must add customers before creating an order.</p><button class="btn btn-primary" onclick="Router.navigate('customers')">Go to Customers</button></div>`;

                const custOptions = customers.map(c => `<option value="${c.id}">${c.company} (${c.name})</option>`).join('');
                const skus = ['200ml', '500ml', '1L'];
                const prices = appStore.get().settings.prices;
                const inventory = appStore.get().inventory;

                return `
                    <div class="card" style="max-width: 800px; margin: 0 auto;">
                        <div class="card-header"><h3 class="card-title">Create New Order</h3></div>
                        
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Select Customer</label>
                                <select id="ord-cust" class="form-control">${custOptions}</select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date</label>
                                <input type="date" id="ord-date" class="form-control" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                        </div>

                        <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 1.5rem;">
                            <h4 class="form-label" style="margin-bottom: 1rem;">Order Items</h4>
                            <div class="grid-3" style="font-weight:700; color:#64748b; font-size:0.8rem; margin-bottom:0.5rem;">
                                <div>ITEM & STOCK</div>
                                <div>RATE (₹)</div>
                                <div>QUANTITY</div>
                            </div>
                            ${skus.map(sku => `
                                <div class="grid-3" style="align-items: center; margin-bottom: 1rem;">
                                    <div>
                                        <strong>${sku}</strong>
                                        <div style="font-size: 0.75rem; color: #64748b;">Avail: ${inventory[sku]}</div>
                                    </div>
                                    <input type="number" id="rate-${sku}" class="form-control" value="${prices[sku]}" oninput="Logic.calcOrderTotal()">
                                    <input type="number" id="qty-${sku}" class="form-control" placeholder="0" oninput="Logic.calcOrderTotal()">
                                </div>
                            `).join('')}
                        </div>

                        <div class="grid-2" style="align-items: center;">
                            <div class="form-group">
                                <label class="form-label">Payment Mode</label>
                                <select id="ord-pay" class="form-control">
                                    <option value="Cash">Cash</option>
                                    <option value="Online">Online / UPI</option>
                                    <option value="Credit">Credit (Add to Balance)</option>
                                </select>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.9rem; color: #64748b;">Grand Total</div>
                                <div id="ord-total-disp" style="font-size: 2rem; font-weight: 800; color: #0f172a;">₹0.00</div>
                            </div>
                        </div>

                        <hr style="border:0; border-top: 1px solid #e2e8f0; margin: 1.5rem 0;">
                        <button class="btn btn-success" style="width:100%; padding: 1rem;" onclick="Logic.submitOrder()">Confirm & Save Order</button>
                    </div>
                `;
            },

            
            orders: function() {
    // Initial Render of the container
    // We delay the table population slightly to allow the DOM to paint
    setTimeout(() => Logic.filterOrders(), 50);

    const today = new Date().toISOString().split('T')[0];
    const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];

    return `
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Order History & Master Record</h3>
            </div>

            <!-- MASTER FILTER BAR -->
            <div class="filter-bar">
                <div>
                    <label class="form-label" style="font-size:0.75rem; margin-bottom:2px;">Search (ID, Name, Amount)</label>
                    <input type="text" id="filter-search" class="form-control" placeholder="Type to filter..." onkeyup="Logic.filterOrders()">
                </div>
                <div>
                    <label class="form-label" style="font-size:0.75rem; margin-bottom:2px;">From Date</label>
                    <input type="date" id="filter-from" class="form-control" value="${firstDay}" onchange="Logic.filterOrders()">
                </div>
                <div>
                    <label class="form-label" style="font-size:0.75rem; margin-bottom:2px;">To Date</label>
                    <input type="date" id="filter-to" class="form-control" value="${today}" onchange="Logic.filterOrders()">
                </div>
                <div style="display:flex; align-items:flex-end;">
                    <button class="btn btn-success" onclick="Logic.downloadExcelReport()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:5px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        Excel
                    </button>
                </div>
            </div>

            <!-- COMPACT TABLE -->
            <div class="table-responsive">
                <table class="table-compact">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Date</th>
                            <th>Customer Name</th>
                            <th>Items (Combined)</th>
                            <th style="text-align:right">Total</th>
                            <th style="text-align:right">Paid</th>
                            <th style="text-align:right">Balance</th>
                            <th>Status</th>
                            <th>Delivered</th>
                        </tr>
                    </thead>
                    <tbody id="order-table-body">
                        <!-- Populated via Javascript -->
                    </tbody>
                </table>
            </div>
            <div id="no-records" style="padding:2rem; text-align:center; color:#999; display:none;">No matching records found.</div>
        </div>
    `;
},

            
            customers: function() {
                const customers = appStore.get().customers;
                return `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Customer Database</h3>
                            <button class="btn btn-primary btn-sm" onclick="Logic.openAddCustomerModal()">+ Add Customer</button>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead><tr><th>Company</th><th>Contact Person</th><th>Phone</th><th>Area</th><th>Credit Limit</th><th>Balance</th><th>Actions</th></tr></thead>
                                <tbody>
                                    ${customers.map(c => `
                                        <tr>
                                            <td style="font-weight:600;">${c.company}</td>
                                            <td>${c.name}</td>
                                            <td>${c.phone}</td>
                                            <td>${c.address}</td>
                                            <td>${Utils.formatCurrency(c.limit)}</td>
                                            <td style="color:${c.balance > 0 ? 'var(--danger-500)' : 'var(--success-500)'}; font-weight:700;">${Utils.formatCurrency(c.balance)}</td>
                                            <td><button class="btn btn-outline btn-sm" onclick="Logic.editCustomer('${c.id}')">Edit</button></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },

            inventory: function() {
                const inv = appStore.get().inventory;
                return `
                    <div class="grid-3">
                        ${SKUS.map(sku => {
                            const stockInfo = Utils.getCasesAndBottles(sku, inv[sku]);
                            return `
                                <div class="card" style="text-align:center;">
                                    <h3 style="color:var(--gray-500); font-size: 0.9rem; margin-bottom: 0.5rem;">${sku} SKU</h3>
                                    <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary-900);">${inv[sku]} <span style="font-size: 1rem; color: var(--gray-400);">btls</span></div>
                                    <div class="badge badge-info" style="margin: 0.5rem 0;">${stockInfo.text}</div>
                                    <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 1.5rem;">1 Case = ${CONFIG.CASE_SIZE[sku]} Bottles</p>
                                    <button class="btn btn-primary w-full" onclick="Logic.openAddStockModal('${sku}')">Add Stock</button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },

            events: function() {
                const events = appStore.get().events;
                return `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Event Schedule</h3>
                            <button class="btn btn-primary btn-sm" onclick="Logic.openAddEventModal()">+ Schedule Event</button>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead><tr><th>Event Name</th><th>Date</th><th>Est. Bottles</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody>
                                    ${events.map(e => `
                                        <tr>
                                            <td><strong>${e.name}</strong></td>
                                            <td>${Utils.formatDate(e.date)}</td>
                                            <td>${e.bottles}</td>
                                            <td><span class="badge ${e.status==='Scheduled'?'badge-warning':e.status==='Done'?'badge-success':'badge-danger'}">${e.status}</span></td>
                                            <td>
                                                ${e.status === 'Scheduled' ? `
                                                    <button class="btn btn-success btn-sm" onclick="Logic.updateEventStatus('${e.id}', 'Done')">Done</button>
                                                    <button class="btn btn-danger btn-sm" onclick="Logic.updateEventStatus('${e.id}', 'Cancelled')">Cancel</button>
                                                ` : '-'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },

            reports: function() {
                return `
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Daily Sales PDF</h3></div>
                            <p style="color: var(--gray-500); margin-bottom: 1rem;">Generate a printable PDF report of today's sales including items sold, revenue, and payment breakdowns.</p>
                            <button class="btn btn-primary" onclick="Logic.generatePDF()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                Download Today's Report
                            </button>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Monthly Excel Export</h3></div>
                            <p style="color: var(--gray-500); margin-bottom: 1rem;">Export all order data for a specific month to Excel for accounting purposes.</p>
                            <div style="display: flex; gap: 10px;">
                                <input type="month" id="report-month" class="form-control">
                                <button class="btn btn-success" onclick="Logic.generateExcel()">Export XLSX</button>
                            </div>
                        </div>
                    </div>
                `;
            },
            
            settings: function() {
                const prices = appStore.get().settings.prices;
                return `
                    <div class="card" style="max-width: 600px;">
                        <div class="card-header"><h3 class="card-title">System Settings</h3></div>
                        <h4 class="form-label" style="margin-top: 1rem;">Default Pricing (Per Bottle)</h4>
                        <div class="grid-3" style="margin-bottom: 1rem;">
                            ${SKUS.map(sku => `
                                <div class="form-group">
                                    <label class="form-label">${sku}</label>
                                    <input type="number" id="set-price-${sku}" class="form-control" value="${prices[sku]}">
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn btn-primary" onclick="Logic.saveSettings()">Save Configuration</button>
                    </div>
                `;
            },

            // PASTE THIS INSIDE 'const Views = {' AFTER 'settings: ...'
    
    invoiceGen: function() {
        return `
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Generate E-Invoice / E-Way JSON</h3>
                </div>

                <!-- A. SUPPLIER DETAILS -->
                <div style="background:#f1f5f9; padding:10px; border-radius:6px; margin-bottom:15px;">
                    <h4 style="font-size:0.9rem; margin-bottom:10px; color:var(--primary-700);">🔹 A. Supplier (Freskeypiyo Beverages)</h4>
                    <div class="grid-3">
                        <div class="form-group"><label class="form-label">GSTIN</label><input class="form-control" id="inv-fromGstin" value="09ABCDE1234F1Z5" readonly style="background:#e2e8f0;"></div>
                        <div class="form-group"><label class="form-label">Legal Name</label><input class="form-control" id="inv-fromTrdName" value="FRESKEYPIYO BEVERAGES" readonly style="background:#e2e8f0;"></div>
                        <div class="form-group"><label class="form-label">State Code</label><input class="form-control" id="inv-fromStateCode" value="9" readonly style="background:#e2e8f0;"></div>
                        <div class="form-group"><label class="form-label">Address</label><input class="form-control" id="inv-fromAddr1" value="Industrial Area" readonly style="background:#e2e8f0;"></div>
                        <div class="form-group"><label class="form-label">Place</label><input class="form-control" id="inv-fromPlace" value="Lucknow" readonly style="background:#e2e8f0;"></div>
                        <div class="form-group"><label class="form-label">PIN Code</label><input class="form-control" id="inv-fromPincode" value="226010" readonly style="background:#e2e8f0;"></div>
                    </div>
                </div>

                <!-- B. RECIPIENT DETAILS -->
                <h4 style="font-size:0.9rem; margin-bottom:10px; color:var(--primary-700);">🔹 B. Recipient Details</h4>
                <div class="grid-2">
                    <div class="form-group"><label class="form-label">GSTIN / URP *</label><input class="form-control" id="inv-toGstin" placeholder="e.g. 09PQRSX5678L1Z9"></div>
                    <div class="form-group"><label class="form-label">Recipient Name *</label><input class="form-control" id="inv-toTrdName" placeholder="e.g. ABC DISTRIBUTOR"></div>
                </div>
                <div class="grid-4">
                    <div class="form-group"><label class="form-label">Address</label><input class="form-control" id="inv-toAddr1" placeholder="Market Road"></div>
                    <div class="form-group"><label class="form-label">Place</label><input class="form-control" id="inv-toPlace" placeholder="City"></div>
                    <div class="form-group"><label class="form-label">State Code</label><input type="number" class="form-control" id="inv-toStateCode" placeholder="9"></div>
                    <div class="form-group"><label class="form-label">PIN Code</label><input type="number" class="form-control" id="inv-toPincode" placeholder="208001"></div>
                </div>

                <hr style="border:0; border-top:1px solid #e2e8f0; margin:15px 0;">

                <!-- C. INVOICE & D. PRODUCT -->
                <div class="grid-2">
                    <div>
                        <h4 style="font-size:0.9rem; margin-bottom:10px; color:var(--primary-700);">🔹 C. Invoice Details</h4>
                        <div class="grid-2">
                            <div class="form-group"><label class="form-label">Invoice No</label><input class="form-control" id="inv-docNo" value="FRK-${new Date().toISOString().slice(0,10).replace(/-/g,'')}-001"></div>
                            <div class="form-group"><label class="form-label">Date</label><input class="form-control" id="inv-docDate" value="${new Date().toLocaleDateString('en-GB')}"></div>
                        </div>
                    </div>
                    <div>
                        <h4 style="font-size:0.9rem; margin-bottom:10px; color:var(--primary-700);">🔹 E. Transport (Mandatory ⚠️)</h4>
                        <div class="grid-2">
                            <div class="form-group"><label class="form-label">Distance (KM) *</label><input type="number" class="form-control" id="inv-distance" style="border-color:red;"></div>
                            <div class="form-group"><label class="form-label">Vehicle No</label><input class="form-control" id="inv-vehicleNo" placeholder="UP32AB1234"></div>
                        </div>
                    </div>
                </div>

                <h4 style="font-size:0.9rem; margin-bottom:10px; color:var(--primary-700);">🔹 D. Product Details</h4>
                <div class="grid-4" style="align-items:end;">
                    <div class="form-group" style="grid-column: span 2;"><label class="form-label">Product Name</label><input class="form-control" id="inv-productName" value="Packaged Drinking Water 500ml"></div>
                    <div class="form-group"><label class="form-label">HSN Code</label><input class="form-control" id="inv-hsnCode" value="22011010"></div>
                    <div class="form-group"><label class="form-label">Unit</label>
                        <select class="form-control" id="inv-qtyUnit"><option value="BOX">BOX</option><option value="NOS">NOS</option></select>
                    </div>
                </div>

                <!-- CALCULATION ROW -->
                <div style="background:#fff7ed; padding:15px; border-radius:8px; border:1px solid #ffedd5; margin-top:10px;">
                    <div class="grid-4">
                        <div class="form-group"><label class="form-label">Quantity</label><input type="number" class="form-control" id="inv-quantity" value="200" oninput="Logic.calcJsonTotals()"></div>
                        <div class="form-group"><label class="form-label">Unit Price</label><input type="number" class="form-control" id="inv-unitPrice" value="240" oninput="Logic.calcJsonTotals()"></div>
                        <div class="form-group"><label class="form-label">Taxable Val</label><input class="form-control" id="inv-taxableAmount" readonly style="font-weight:bold;"></div>
                        <div class="form-group"><label class="form-label">Total Value</label><input class="form-control" id="inv-totalValue" readonly style="font-weight:800; color:var(--primary-900);"></div>
                    </div>
                    <div class="grid-3" style="font-size:0.8rem; margin-top:5px;">
                        <div>CGST (3%): <span id="disp-cgst">0</span></div>
                        <div>SGST (3%): <span id="disp-sgst">0</span></div>
                        <div>IGST (0%): <span id="disp-igst">0</span></div>
                    </div>
                </div>

                <div style="margin-top:20px; text-align:right;">
                    <button class="btn btn-primary" onclick="Logic.downloadEInvoiceJSON()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        GENERATE & DOWNLOAD JSON
                    </button>
                </div>
            </div>
        `;
    },

            // Helper Views
            _renderRecentOrdersTable: function(orders) {
                if(orders.length === 0) return '<p style="padding: 1rem; color: var(--gray-500);">No activity yet.</p>';
                return `
                    <div class="table-responsive">
                    <table>
                        <thead><tr><th>Customer</th><th>Amount</th><th>Status</th></tr></thead>
                        <tbody>
                            ${orders.map(o => {
                                const c = appStore.get().customers.find(cx => cx.id === o.custId);
                                return `<tr>
                                    <td>${c ? c.company : 'N/A'}</td>
                                    <td style="font-weight:700">${Utils.formatCurrency(o.total)}</td>
                                    <td><span class="badge ${o.paymentMode==='Credit'?'badge-danger':'badge-success'}">${o.paymentMode}</span></td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                    </div>
                `;
            },

            _renderStockPreview: function(inv) {
                return `
                    <div style="padding: 1rem;">
                        ${SKUS.map(sku => {
                             const pct = (inv[sku] / 500) * 100; // Mock max for bar
                             return `
                                <div style="margin-bottom: 1rem;">
                                    <div style="display:flex; justify-content:space-between; font-size: 0.85rem; margin-bottom: 4px;">
                                        <strong>${sku}</strong>
                                        <span>${inv[sku]} btls</span>
                                    </div>
                                    <div style="height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                                        <div style="height: 100%; width: ${Math.min(pct, 100)}%; background: var(--accent-500);"></div>
                                    </div>
                                </div>
                             `;
                        }).join('')}
                    </div>
                `;
            }
        };

        /**
         * ================================================================================== 
         * 6. CONTROLLER & BUSINESS LOGIC 
         * ================================================================================== 
         */
        const Logic = {
            // --- Customer Logic ---
            openAddCustomerModal: function() {
                ModalManager.show("Add New Customer", `
                    <div class="grid-2">
                        <div class="form-group"><label class="form-label">Company Name</label><input id="new-c-comp" class="form-control"></div>
                        <div class="form-group"><label class="form-label">Contact Person</label><input id="new-c-name" class="form-control"></div>
                    </div>
                    <div class="form-group"><label class="form-label">Phone</label><input id="new-c-phone" class="form-control"></div>
                    <div class="form-group"><label class="form-label">Area / Address</label><input id="new-c-addr" class="form-control"></div>
                    <div class="form-group"><label class="form-label">Credit Limit (₹)</label><input type="number" id="new-c-limit" class="form-control" value="5000"></div>
                    <button class="btn btn-primary w-full" onclick="Logic.saveNewCustomer()">Save Customer</button>
                `);
            },

            

            saveNewCustomer: function() {
                const comp = document.getElementById('new-c-comp').value;
                if(!comp) return ToastManager.show("Company Name Required", "error");

                appStore.addCustomer({
                    id: Utils.generateId('CUST'),
                    company: comp,
                    name: document.getElementById('new-c-name').value,
                    phone: document.getElementById('new-c-phone').value,
                    address: document.getElementById('new-c-addr').value,
                    limit: parseFloat(document.getElementById('new-c-limit').value) || 0,
                    balance: 0
                });

                ModalManager.close();
                ToastManager.show("Customer Added", "success");
                Router.refresh();
            },

            // --- 1. ID GENERATOR (Paste at top of Logic object) ---
    generateNextOrderId: function(dateString) {
        // 1. Format Date: YYYY-MM-DD -> YYYYMMDD
        const cleanDate = dateString.replace(/-/g, '');
        const prefix = `FRK-${cleanDate}-`;

        // 2. Find existing orders for this specific date
        const existingOrders = appStore.get().orders.filter(o => o.id.startsWith(prefix));

        if (existingOrders.length === 0) {
            return prefix + '0001'; // First order of the day
        }

        // 3. Find highest sequence number
        let maxSeq = 0;
        existingOrders.forEach(o => {
            const parts = o.id.split('-');
            if(parts.length === 3) {
                const seq = parseInt(parts[2]);
                if (!isNaN(seq) && seq > maxSeq) maxSeq = seq;
            }
        });

        // 4. Return formatted ID (e.g., FRK-20251214-0002)
        return prefix + (maxSeq + 1).toString().padStart(4, '0');
    },


            // --- FILTER & TABLE LOGIC ---
    
    // 1. Master Filter Function
    filterOrders: function() {
        const search = document.getElementById('filter-search').value.toLowerCase();
        const fromDate = document.getElementById('filter-from').value;
        const toDate = document.getElementById('filter-to').value;
        
        const allOrders = appStore.get().orders;
        const customers = appStore.get().customers;

        // Filter Logic
        const filtered = allOrders.filter(o => {
            const c = customers.find(x => x.id === o.custId);
            const cName = c ? (c.company + ' ' + c.name).toLowerCase() : '';
            const oId = o.id.toLowerCase();
            
            // Search Match
            const matchesSearch = oId.includes(search) || cName.includes(search) || o.total.toString().includes(search);
            
            // Date Match
            const matchesDate = (!fromDate || o.date >= fromDate) && (!toDate || o.date <= toDate);
            
            return matchesSearch && matchesDate;
        }).sort((a,b) => new Date(b.date) - new Date(a.date)); // Sort Newest First

        Logic.renderOrderRows(filtered);
    },

    // 2. Render Rows (Generates the HTML)
    // --- 3. RENDER TABLE ROWS (Replace existing function) ---
    renderOrderRows: function(orders) {
        const tbody = document.getElementById('order-table-body');
        const noRec = document.getElementById('no-records');
        
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(orders.length === 0) {
            noRec.style.display = 'block';
            return;
        }
        noRec.style.display = 'none';

        orders.forEach(o => {
            const c = appStore.get().customers.find(cx => cx.id === o.custId);
            const paid = o.paidAmount || 0;
            const balance = o.total - paid;
            
            // Format Items: 200ml×10, 500ml×5
            const itemString = o.items.map(i => `<span class="item-pill">${i.sku}×${i.qty}</span>`).join(' ');
            
            // --- KEY CHANGE: Use the ID directly from database ---
            // If the ID is old (ORD-...), it shows as is. If new (FRK-...), it shows correctly.
            const displayId = o.id; 

            // Delivery Date
            let delDate = '-';
            if(o.status === 'Delivered') delDate = Utils.formatDate(o.date); 

            // Badge Color
            let badgeClass = 'badge-info';
            if(o.status === 'Delivered') badgeClass = 'badge-success';
            if(o.paymentMode === 'Credit' && balance > 0) badgeClass = 'badge-danger';

            const row = `
                <tr class="tr-clickable" onclick="Logic.toggleRow('${o.id}')">
                    <td style="font-family:monospace; font-weight:700; color:var(--primary-700)">
                        ${displayId}
                        <div class="hide-mobile" style="font-size:0.7rem; color:#999;">Click details</div>
                    </td>
                    <td>${Utils.formatDate(o.date)}</td>
                    <td style="font-weight:600;">${c ? c.company : 'Unknown'}</td>
                    <td class="hide-mobile">${itemString}</td>
                    <td style="text-align:right; font-weight:700;">${Utils.formatCurrency(o.total)}</td>
                    <td style="text-align:right; color:var(--success-700)">${Utils.formatCurrency(paid)}</td>
                    <td style="text-align:right;" class="${balance > 0.5 ? 'bal-due' : 'bal-zero'}">
                        ${Utils.formatCurrency(balance)}
                    </td>
                    <td><span class="badge ${badgeClass}">${o.status}</span></td>
                    <td class="hide-mobile">${delDate}</td>
                </tr>
                <tr id="detail-${o.id}" class="tr-details">
                    <td colspan="9">
                        <div class="detail-box">
                            <div class="grid-3">
                                <div><strong>Breakdown:</strong><br>${o.items.map(i => `${i.sku} (${i.qty})`).join(', ')}</div>
                                <div><strong>Payment:</strong><br>Paid: ${Utils.formatCurrency(paid)}<br>Due: ${Utils.formatCurrency(balance)}</div>
                                <div><button class="btn btn-outline btn-sm" onclick="Logic.editOrder('${o.id}')">Manage</button></div>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    },





// PASTE THIS INSIDE 'const Logic = {' AT THE BOTTOM
    
    calcJsonTotals: function() {
        const qty = parseFloat(document.getElementById('inv-quantity').value) || 0;
        const price = parseFloat(document.getElementById('inv-unitPrice').value) || 0;
        
        const taxable = qty * price;
        document.getElementById('inv-taxableAmount').value = taxable.toFixed(2);

        // Hardcoded rates as per your requirement (3% + 3%)
        const cgstVal = taxable * 0.03;
        const sgstVal = taxable * 0.03;
        const igstVal = 0;

        document.getElementById('disp-cgst').innerText = cgstVal.toFixed(2);
        document.getElementById('disp-sgst').innerText = sgstVal.toFixed(2);
        
        const total = taxable + cgstVal + sgstVal + igstVal;
        document.getElementById('inv-totalValue').value = total.toFixed(2);
    },

    downloadEInvoiceJSON: function() {
        // Validation
        const distance = document.getElementById('inv-distance').value;
        if(!distance) return ToastManager.show("Distance is Mandatory ⚠️", "error");
        
        // Trigger calc once to ensure totals are fresh
        this.calcJsonTotals();

        const data = {
            "supplyType": "O",
            "subSupplyType": "1",
            "docType": "INV",
            "docNo": document.getElementById('inv-docNo').value,
            "docDate": document.getElementById('inv-docDate').value,

            "fromGstin": document.getElementById('inv-fromGstin').value,
            "fromTrdName": document.getElementById('inv-fromTrdName').value,
            "fromAddr1": document.getElementById('inv-fromAddr1').value,
            "fromPlace": document.getElementById('inv-fromPlace').value,
            "fromPincode": parseInt(document.getElementById('inv-fromPincode').value),
            "fromStateCode": parseInt(document.getElementById('inv-fromStateCode').value),

            "toGstin": document.getElementById('inv-toGstin').value,
            "toTrdName": document.getElementById('inv-toTrdName').value,
            "toAddr1": document.getElementById('inv-toAddr1').value,
            "toPlace": document.getElementById('inv-toPlace').value,
            "toPincode": parseInt(document.getElementById('inv-toPincode').value) || 0,
            "toStateCode": parseInt(document.getElementById('inv-toStateCode').value) || 0,

            "totalValue": parseFloat(document.getElementById('inv-totalValue').value),
            "cgstValue": parseFloat(document.getElementById('disp-cgst').innerText),
            "sgstValue": parseFloat(document.getElementById('disp-sgst').innerText),
            "igstValue": 0,

            "transMode": "1",
            "distance": parseInt(distance),
            "vehicleNo": document.getElementById('inv-vehicleNo').value,
            "vehicleType": "R",

            "itemList": [
                {
                    "productName": document.getElementById('inv-productName').value,
                    "hsnCode": document.getElementById('inv-hsnCode').value,
                    "quantity": parseFloat(document.getElementById('inv-quantity').value),
                    "qtyUnit": document.getElementById('inv-qtyUnit').value,
                    "taxableAmount": parseFloat(document.getElementById('inv-taxableAmount').value),
                    "cgstRate": 3,
                    "sgstRate": 3,
                    "igstRate": 0
                }
            ]
        };

        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "Invoice_" + data.docNo + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        
        ToastManager.show("JSON Downloaded Successfully", "success");
    },

            

    // 3. Toggle Row Visibility
    toggleRow: function(id) {
        const row = document.getElementById(`detail-${id}`);
        if(row) row.classList.toggle('active');
    },

    // 4. Excel Download Logic
    downloadExcelReport: function() {
        const fromDate = document.getElementById('filter-from').value;
        const toDate = document.getElementById('filter-to').value;
        
        // Use the same filtering logic to get data
        const allOrders = appStore.get().orders;
        const customers = appStore.get().customers;
        
        const dataToExport = allOrders.filter(o => 
            o.date >= fromDate && o.date <= toDate
        ).map(o => {
             const c = customers.find(x => x.id === o.custId);
             const paid = o.paidAmount || 0;
             const balance = o.total - paid;
             
             return {
                 "Order ID": `FRK-${o.date.replace(/-/g,'')}-${o.id.split('-')[1]}`,
                 "Date": o.date,
                 "Customer": c ? c.company : 'Unknown',
                 "Items": o.items.map(i => `${i.sku}x${i.qty}`).join(', '),
                 "Total Amount": o.total,
                 "Paid Amount": paid,
                 "Balance": balance,
                 "Status": o.status,
                 "Payment Mode": o.paymentMode
             };
        });

        if(dataToExport.length === 0) return ToastManager.show("No data in selected range", "error");

        const ws = XLSX.utils.json_to_sheet(dataToExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Order History");
        XLSX.writeFile(wb, `Freskey_Orders_${fromDate}_to_${toDate}.xlsx`);
    },


            // --- TRACKING & PAYMENT LOGIC ---
    updateTracking: function(id, step) {
                const order = appStore.get().orders.find(o => o.id === id);
                if(order) {
                    order.trackingStep = step;
                    if(step === 2) order.status = 'Dispatched';
                    if(step === 3) order.status = 'Delivered';
                    
                    // Force Save to Drive
                    DriveAdapter.saveDatabase(true); 
                    Router.refresh();
                }
            },

            addPayment: function(id) {
                const amount = parseFloat(document.getElementById(`pay-${id}`).value);
                if(!amount || amount <= 0) return ToastManager.show("Invalid Amount", "error");

                const order = appStore.get().orders.find(o => o.id === id);
                const due = order.total - (order.paidAmount || 0);

                // Allow small floating point differences
                if(amount > due + 1) return ToastManager.show(`Amount exceeds balance of ${Utils.formatCurrency(due)}`, "error");

                // 1. Update Order
                order.paidAmount = (order.paidAmount || 0) + amount;

                // 2. Update Customer Balance (If they were in debt, paying reduces debt)
                const cust = appStore.get().customers.find(c => c.id === order.custId);
                if(cust) {
                    cust.balance -= amount;
                    // Prevent negative balance glitches
                    if(Math.abs(cust.balance) < 1) cust.balance = 0; 
                }

                ToastManager.show(`Payment of ${Utils.formatCurrency(amount)} recorded`, "success");
                DriveAdapter.saveDatabase(true);
                Router.refresh();
            },

    addPayment: function(id) {
        const amount = parseFloat(document.getElementById(`pay-${id}`).value);
        if(!amount || amount <= 0) return ToastManager.show("Invalid Amount", "error");

        const order = appStore.get().orders.find(o => o.id === id);
        const due = order.total - (order.paidAmount || 0);

        if(amount > due) return ToastManager.show(`Amount exceeds balance of ${due}`, "error");

        // 1. Update Order
        order.paidAmount = (order.paidAmount || 0) + amount;

        // 2. Update Customer Balance (Reduce debt)
        const cust = appStore.get().customers.find(c => c.id === order.custId);
        if(cust) {
            cust.balance -= amount;
            if(cust.balance < 0) cust.balance = 0; // Safety catch
        }

        ToastManager.show(`Payment of ${Utils.formatCurrency(amount)} recorded`, "success");
        Router.refresh();
    },
            
            editCustomer: function(id) {
                const c = appStore.get().customers.find(x => x.id === id);
                if(!c) return;
                ModalManager.show("Edit Customer", `
                    <div class="form-group"><label class="form-label">Company</label><input id="edit-c-comp" class="form-control" value="${c.company}"></div>
                    <div class="form-group"><label class="form-label">Limit</label><input type="number" id="edit-c-limit" class="form-control" value="${c.limit}"></div>
                    <button class="btn btn-primary w-full" onclick="Logic.updateCustomer('${id}')">Update</button>
                `);
            },

            updateCustomer: function(id) {
                appStore.updateCustomer(id, {
                    company: document.getElementById('edit-c-comp').value,
                    limit: parseFloat(document.getElementById('edit-c-limit').value)
                });
                ModalManager.close();
                Router.refresh();
            },

            // --- Order Logic ---


calcOrderTotal: function() {
        let total = 0;
        ['200ml', '500ml', '1L'].forEach(sku => {
            const r = parseFloat(document.getElementById(`rate-${sku}`).value) || 0;
            const q = parseFloat(document.getElementById(`qty-${sku}`).value) || 0;
            total += (r * q);
        });
        document.getElementById('ord-total-disp').innerText = '₹' + total.toFixed(2);
    },

  // --- 2. SUBMIT ORDER (Replace existing function) ---
    submitOrder: function() {
        const custId = document.getElementById('ord-cust').value;
        const date = document.getElementById('ord-date').value;
        const pay = document.getElementById('ord-pay').value;

        // Validation & Calculation
        const items = [];
        let total = 0;

        // Loop through SKUS to get items
        for(let sku of SKUS) {
            const q = parseFloat(document.getElementById(`qty-${sku}`).value) || 0;
            const r = parseFloat(document.getElementById(`rate-${sku}`).value) || 0;
            
            if(q > 0) {
                const currentStock = appStore.get().inventory[sku];
                if(currentStock < q) {
                    if(!confirm(`Low Inventory for ${sku}. Available: ${currentStock}. Proceed?`)) return;
                }
                items.push({ sku, qty: q, rate: r });
                total += (q * r);
            }
        }

        if(items.length === 0) return ToastManager.show("Please add at least one item", "error");

        // Credit Check
        const cust = appStore.get().customers.find(c => c.id === custId);
        if(pay === 'Credit' && (cust.balance + total > cust.limit)) {
            if(!confirm(`Credit Limit Exceeded! Bal: ${cust.balance}. Proceed?`)) return;
        }

        const initialPaid = (pay === 'Credit') ? 0 : total;

        // --- KEY CHANGE HERE: Generates FRK-YYYYMMDD-XXXX ---
        const order = {
            id: Logic.generateNextOrderId(date), 
            date, 
            custId, 
            items, 
            total, 
            paymentMode: pay, 
            status: 'Ordered',     
            trackingStep: 1,       
            paidAmount: initialPaid 
        };

        appStore.addOrder(order);
        ToastManager.show("Order Created: " + order.id, "success");
        Router.navigate('tracking');
    },
            
            calcOrderTotal: function() {
                let total = 0;
                SKUS.forEach(sku => {
                    const r = parseFloat(document.getElementById(`rate-${sku}`).value) || 0;
                    const q = parseFloat(document.getElementById(`qty-${sku}`).value) || 0;
                    total += (r * q);
                });
                document.getElementById('ord-total-disp').innerText = Utils.formatCurrency(total);
            },

            
            editOrder: function(id) {
                // To allow robust inventory rollback, "Editing" in this strict version works by Voiding the old one 
                // and allowing the user to create a new one, or simply changing payment mode.
                const order = appStore.get().orders.find(o => o.id === id);
                ModalManager.show(`Manage Order ${id.split('-')[1]}`, `
                    <p style="margin-bottom:1rem;">To modify items, please void this order and create a new one to ensure inventory accuracy.</p>
                    <div class="grid-2">
                        <button class="btn btn-danger w-full" onclick="Logic.voidOrder('${id}')">Void & Refund Inventory</button>
                        <button class="btn btn-outline w-full" onclick="ModalManager.close()">Cancel</button>
                    </div>
                `);
            },

            voidOrder: function(id) {
                if(confirm("Are you sure? This will return items to stock and adjust customer balance.")) {
                    appStore.voidOrder(id);
                    ModalManager.close();
                    ToastManager.show("Order Voided", "success");
                    Router.refresh();
                }
            },

            // --- Inventory Logic ---
            openAddStockModal: function(sku) {
                ModalManager.show(`Add Stock: ${sku}`, `
                    <p style="margin-bottom:1rem; color:var(--gray-500);">1 Case = ${CONFIG.CASE_SIZE[sku]} Bottles</p>
                    <div class="form-group">
                        <label class="form-label">Add Quantity (CASES)</label>
                        <input type="number" id="add-stock-cases" class="form-control" placeholder="0">
                    </div>
                    <button class="btn btn-success w-full" onclick="Logic.saveStock('${sku}')">Update Stock</button>
                `);
            },

            saveStock: function(sku) {
                const cases = parseInt(document.getElementById('add-stock-cases').value) || 0;
                const bottles = cases * CONFIG.CASE_SIZE[sku];
                if(bottles > 0) {
                    appStore.adjustInventory(sku, bottles, 'add');
                    ToastManager.show(`Added ${bottles} bottles`, "success");
                    ModalManager.close();
                    Router.refresh();
                }
            },

            // --- Event Logic ---
            openAddEventModal: function() {
                ModalManager.show("Schedule Event", `
                    <div class="form-group"><label class="form-label">Event Name</label><input id="evt-name" class="form-control"></div>
                    <div class="form-group"><label class="form-label">Date</label><input type="date" id="evt-date" class="form-control"></div>
                    <div class="form-group"><label class="form-label">Est. Bottles</label><input type="number" id="evt-btl" class="form-control"></div>
                    <button class="btn btn-primary w-full" onclick="Logic.saveEvent()">Schedule</button>
                `);
            },

            saveEvent: function() {
                appStore.get().events.push({
                    id: Utils.generateId('EVT'),
                    name: document.getElementById('evt-name').value,
                    date: document.getElementById('evt-date').value,
                    bottles: document.getElementById('evt-btl').value,
                    status: 'Scheduled'
                });
                ModalManager.close();
                Router.refresh();
            },

            updateEventStatus: function(id, status) {
                const e = appStore.get().events.find(x => x.id === id);
                if(e) e.status = status;
                Router.refresh();
            },

            // --- Reports ---
            generatePDF: function() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(18);
                doc.text("Freskey Daily Sales Report", 14, 20);
                doc.setFontSize(10);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 28);

                const today = new Date().toISOString().split('T')[0];
                const orders = appStore.get().orders.filter(o => o.date === today);

                const tableData = orders.map(o => {
                    const c = appStore.get().customers.find(cx => cx.id === o.custId);
                    return [o.id.split('-')[1], c?.company, Utils.formatCurrency(o.total), o.paymentMode];
                });

                doc.autoTable({
                    head: [['ID', 'Customer', 'Amount', 'Payment']],
                    body: tableData,
                    startY: 35
                });

                const total = orders.reduce((sum, o) => sum + o.total, 0);
                doc.text(`Total Revenue Today: ${Utils.formatCurrency(total)}`, 14, doc.lastAutoTable.finalY + 10);

                doc.save(`daily_report_${today}.pdf`);
            },

            generateExcel: function() {
                const month = document.getElementById('report-month').value;
                if(!month) return ToastManager.show("Please select a month", "error");

                const orders = appStore.get().orders.filter(o => o.date.startsWith(month));
                const data = orders.map(o => {
                    const c = appStore.get().customers.find(cx => cx.id === o.custId);
                    return {
                        Date: o.date,
                        OrderID: o.id,
                        Customer: c ? c.company : 'Unknown',
                        Total: o.total,
                        Payment: o.paymentMode,
                        Items: o.items.map(i => `${i.qty} ${i.sku}`).join('; ')
                    };
                });

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Sales");
                XLSX.writeFile(wb, `Sales_${month}.xlsx`);
            },
            
            saveSettings: function() {
                 SKUS.forEach(sku => {
                     appStore.get().settings.prices[sku] = parseFloat(document.getElementById(`set-price-${sku}`).value) || 0;
                 });
                 ToastManager.show("Settings Saved", "success");
            }
        };

        /**
         * ================================================================================== 
         * 7. ROUTING & NAVIGATION 
         * ================================================================================== 
         */
        const Router = {
            currentPage: 'dashboard',
            
            navigate: function(pageId) {
                this.currentPage = pageId;
                
                // Update Nav UI
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const activeNav = document.querySelector(`.nav-item[onclick="Router.navigate('${pageId}')"]`);
                if(activeNav) activeNav.classList.add('active');

                // Render Content
                document.getElementById('page-title').innerText = pageId.charAt(0).toUpperCase() + pageId.slice(1).replace('-', ' ');
                document.getElementById('main-content').innerHTML = Views[pageId] ? Views[pageId]() : '<h1>404 Page Not Found</h1>';

                // Close Mobile Sidebar
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('mobile-overlay').classList.remove('active');
            },

            refresh: function() {
                this.navigate(this.currentPage);
            }
        };

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('mobile-overlay').classList.toggle('active');
        }

        /**
         * ================================================================================== 
         * 8. INITIALIZATION 
         * ================================================================================== 
         */
        window.onload = function() {
            DriveAdapter.init(); // Init Google Auth scripts
        };

    </script>
</body>
</html>
