<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaFlow ERP - Water & Beverage Management System</title>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    
    <style>
        /* =========================================
           1. CORE VARIABLES & RESET (Lines 15-100)
           ========================================= */
        :root {
            --primary: #0077b6;
            --primary-dark: #023e8a;
            --secondary: #48cae4;
            --accent: #90e0ef;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --sidebar-width: 260px;
            --header-height: 60px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --radius: 8px;
            --font-family: 'Segoe UI', system-ui, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            font-size: 14px;
            line-height: 1.5;
        }

        /* =========================================
           2. LAYOUT & GRID SYSTEM
           ========================================= */
        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .app-container.active {
            opacity: 1;
            pointer-events: all;
        }

        /* Sidebar */
        aside {
            width: var(--sidebar-width);
            background: #1e293b;
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #334155;
        }

        .brand {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-size: 18px;
            font-weight: 700;
            border-bottom: 1px solid #334155;
            color: var(--secondary);
            letter-spacing: 0.5px;
        }

        .nav-menu {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #94a3b8;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover, .nav-item.active {
            background: #334155;
            color: white;
            border-left-color: var(--secondary);
        }

        .nav-item i { width: 20px; text-align: center; }

        /* Main Content */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            height: var(--header-height);
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 25px;
            box-shadow: var(--shadow-sm);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            position: relative;
        }

        /* =========================================
           3. UI COMPONENTS
           ========================================= */
        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
        }

        /* Grid for Dashboard */
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }

        /* Stat Box */
        .stat-box {
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .stat-value { font-size: 24px; font-weight: 700; color: var(--primary); margin-top: 5px; }
        .stat-label { font-size: 13px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-secondary:hover { background: #f8fafc; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 4px 10px; font-size: 12px; }

        /* Forms */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500; color: var(--text-main); }
        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: border 0.2s;
        }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(0, 119, 182, 0.1); }
        select.form-control { background-color: white; }

        /* Tables */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 12px 15px; background: #f8fafc; border-bottom: 2px solid var(--border); color: var(--text-muted); font-weight: 600; }
        td { padding: 12px 15px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:hover td { background: #f1f5f9; }
        
        /* Badges */
        .badge { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #dbeafe; color: #1e40af; }

        /* Login Screen */
        .login-wrapper {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            width: 400px;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .login-logo { font-size: 32px; font-weight: 800; color: var(--primary); margin-bottom: 10px; }
        .login-desc { color: var(--text-muted); margin-bottom: 30px; }
        .g-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 12px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            background: white;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        .g-btn:hover { background: #f8fafc; }
        .g-icon { width: 18px; margin-right: 10px; }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 900;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: var(--radius);
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideDown 0.3s ease;
        }
        .modal-lg { width: 800px; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
        
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Toast Notifications */
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: #333; color: white; padding: 12px 20px; border-radius: 6px; min-width: 250px;
            box-shadow: var(--shadow-md); animation: fadeIn 0.3s; display: flex; align-items: center; justify-content: space-between;
        }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Section Visibility */
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }

        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Utility */
        .text-right { text-align: right; }
        .mt-2 { margin-top: 10px; }
        .mb-2 { margin-bottom: 10px; }
        .d-flex { display: flex; gap: 10px; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .hidden { display: none !important; }

        /* Chart Canvas */
        canvas { width: 100%; height: 300px; }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-wrapper">
        <div class="login-box">
            <div class="login-logo">üíß AquaFlow ERP</div>
            <div class="login-desc">Secure Cloud ERP for Beverage Manufacturing</div>
            
            <div class="form-group" style="text-align: left;">
                <label class="form-label">Google API Client ID</label>
                <input type="text" id="clientIdInput" class="form-control" placeholder="Enter Client ID from Google Cloud">
            </div>
            <div class="form-group" style="text-align: left;">
                <label class="form-label">Google API Key</label>
                <input type="text" id="apiKeyInput" class="form-control" placeholder="Enter API Key from Google Cloud">
                <small style="color: #666; display: block; margin-top: 5px;">* Required to connect to your Google Drive</small>
            </div>

            <button class="g-btn" id="authorizeBtn" onclick="handleAuthClick()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" class="g-icon" alt="G">
                Sign in with Google Drive
            </button>
            <div id="authLoader" class="loader hidden"></div>
            <p id="authMessage" style="margin-top:15px; font-size:12px; color:var(--danger);"></p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="app-container">
        
        <!-- SIDEBAR -->
        <aside>
            <div class="brand">AquaFlow ERP</div>
            <div class="nav-menu">
                <div class="nav-item active" onclick="navTo('dashboard')"><i>üìä</i> Dashboard</div>
                <div class="nav-item" onclick="navTo('products')"><i>üì¶</i> Product Master</div>
                <div class="nav-item" onclick="navTo('inventory')"><i>üè≠</i> Inventory</div>
                <div class="nav-item" onclick="navTo('customers')"><i>üë•</i> Customers</div>
                <div class="nav-item" onclick="navTo('orders')"><i>üìù</i> Order Module</div>
                <div class="nav-item" onclick="navTo('dispatch')"><i>üöö</i> Dispatch</div>
                <div class="nav-item" onclick="navTo('payments')"><i>üí∞</i> Payments</div>
                <div class="nav-item" onclick="navTo('reports')"><i>üìà</i> Reports</div>
                <div class="nav-item" onclick="navTo('settings')"><i>‚öôÔ∏è</i> Settings</div>
            </div>
            <div style="padding: 20px; font-size: 11px; color: #64748b; text-align: center;">
                v1.0.0 | Cloud Sync On<br>
                <span id="lastSyncTime">Syncing...</span>
            </div>
        </aside>

        <!-- CONTENT -->
        <main>
            <header>
                <h2 id="pageTitle">Dashboard</h2>
                <div class="user-profile">
                    <div id="userName" style="font-weight: 500;">Admin User</div>
                    <div class="user-avatar" id="userInitials">A</div>
                    <button class="btn btn-sm btn-secondary" onclick="handleSignoutClick()">Logout</button>
                </div>
            </header>

            <div class="content-area">
                
                <!-- 1. DASHBOARD -->
                <div id="view-dashboard" class="section active">
                    <div class="grid-4">
                        <div class="stat-box">
                            <span class="stat-label">Today's Sales</span>
                            <span class="stat-value" id="dash-sales">‚Çπ0.00</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Pending Orders</span>
                            <span class="stat-value" id="dash-pending">0</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Total Outstanding</span>
                            <span class="stat-value" id="dash-credit" style="color: var(--danger)">‚Çπ0.00</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Low Stock Items</span>
                            <span class="stat-value" id="dash-lowstock" style="color: var(--warning)">0</span>
                        </div>
                    </div>

                    <div class="grid-2" style="margin-top: 20px;">
                        <div class="card">
                            <div class="card-header"><span class="card-title">Weekly Sales Trend</span></div>
                            <canvas id="salesChart"></canvas>
                        </div>
                        <div class="card">
                            <div class="card-header"><span class="card-title">Inventory Health</span></div>
                            <div class="table-container">
                                <table id="dash-inv-table">
                                    <thead><tr><th>Product</th><th>Factory</th><th>Warehouse</th><th>Status</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. PRODUCT MASTER -->
                <div id="view-products" class="section">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Product List</span>
                            <button class="btn btn-primary" onclick="openModal('modal-product')">+ Add Product</button>
                        </div>
                        <div class="table-container">
                            <table id="product-table">
                                <thead>
                                    <tr>
                                        <th>SKU Code</th>
                                        <th>Name</th>
                                        <th>Pack Size</th>
                                        <th>MRP (‚Çπ)</th>
                                        <th>Distributor Rate (‚Çπ)</th>
                                        <th>Tax %</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 3. INVENTORY -->
                <div id="view-inventory" class="section">
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header"><span class="card-title">Stock Summary</span></div>
                            <table id="inventory-table">
                                <thead><tr><th>Product</th><th>Factory</th><th>Warehouse</th><th>Vans</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="card">
                            <div class="card-header"><span class="card-title">Stock Adjustment (Inward/Outward)</span></div>
                            <form onsubmit="handleStockAdjust(event)">
                                <div class="form-group">
                                    <label class="form-label">Transaction Type</label>
                                    <select id="inv-type" class="form-control">
                                        <option value="inward">Production Inward (Add)</option>
                                        <option value="transfer">Transfer (Factory -> Warehouse)</option>
                                        <option value="damage">Damage/Loss (Deduct)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Product</label>
                                    <select id="inv-product" class="form-control"></select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Quantity</label>
                                    <input type="number" id="inv-qty" class="form-control" required min="1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Notes</label>
                                    <input type="text" id="inv-note" class="form-control" placeholder="Batch No / Reason">
                                </div>
                                <button type="submit" class="btn btn-primary">Update Stock</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- 4. CUSTOMERS -->
                <div id="view-customers" class="section">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Distributors & Retailers</span>
                            <button class="btn btn-primary" onclick="openModal('modal-customer')">+ Add Customer</button>
                        </div>
                        <div class="table-container">
                            <table id="customer-table">
                                <thead><tr><th>ID</th><th>Name</th><th>Region</th><th>Type</th><th>Credit Limit</th><th>Current Due</th><th>Action</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 5. ORDERS -->
                <div id="view-orders" class="section">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Order Management</span>
                            <button class="btn btn-primary" onclick="openOrderModal()">+ Create New Order</button>
                        </div>
                        <div class="table-container">
                            <table id="order-table">
                                <thead><tr><th>Order #</th><th>Date</th><th>Customer</th><th>Amount</th><th>Status</th><th>Payment</th><th>Action</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 6. DISPATCH -->
                <div id="view-dispatch" class="section">
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header"><span class="card-title">Pending Dispatch</span></div>
                            <div id="dispatch-pending-list"></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><span class="card-title">Out for Delivery / Delivered</span></div>
                            <div id="dispatch-active-list"></div>
                        </div>
                    </div>
                </div>

                <!-- 7. PAYMENTS -->
                <div id="view-payments" class="section">
                    <div class="grid-3">
                        <div class="card">
                            <div class="card-header"><span class="card-title">Add Payment</span></div>
                            <form onsubmit="handleAddPayment(event)">
                                <div class="form-group">
                                    <label>Customer</label>
                                    <select id="pay-customer" class="form-control" onchange="updatePayDue()"></select>
                                    <small id="pay-due-label" class="text-muted">Due: ‚Çπ0</small>
                                </div>
                                <div class="form-group">
                                    <label>Amount</label>
                                    <input type="number" id="pay-amount" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>Mode</label>
                                    <select id="pay-mode" class="form-control">
                                        <option>Cash</option>
                                        <option>Bank Transfer</option>
                                        <option>Cheque</option>
                                        <option>UPI</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-success" style="width:100%">Receive Payment</button>
                            </form>
                        </div>
                        <div class="card" style="grid-column: span 2">
                            <div class="card-header"><span class="card-title">Payment Ledger (Last 50)</span></div>
                            <table id="ledger-table">
                                <thead><tr><th>Date</th><th>Customer</th><th>Type</th><th>Amount</th><th>Mode</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 8. REPORTS -->
                <div id="view-reports" class="section">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">System Reports</span>
                            <div>
                                <button class="btn btn-secondary btn-sm" onclick="exportData()">Export JSON</button>
                            </div>
                        </div>
                        <div class="grid-4">
                            <button class="btn btn-secondary" onclick="alert('Generating Sales Report...')">üìÑ Daily Sales PDF</button>
                            <button class="btn btn-secondary" onclick="alert('Generating Stock Report...')">üìÑ Stock Summary PDF</button>
                            <button class="btn btn-secondary" onclick="alert('Generating Outstanding...')">üìÑ Credit Due List</button>
                            <button class="btn btn-secondary" onclick="alert('Generating Route Plan...')">üìÑ Route Analysis</button>
                        </div>
                        <div style="margin-top:20px">
                             <h3>Raw Data View</h3>
                             <textarea id="debug-area" class="form-control" style="height:200px; font-family:monospace; margin-top:10px" readonly></textarea>
                        </div>
                    </div>
                </div>

                <!-- 9. SETTINGS -->
                <div id="view-settings" class="section">
                     <div class="card">
                        <h3>Application Settings</h3>
                        <p>Currently using Google Drive Storage.</p>
                        <br>
                        <button class="btn btn-danger" onclick="resetDatabase()">‚ö† Factory Reset (Clear All Data)</button>
                     </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODALS -->

    <!-- Product Modal -->
    <div id="modal-product" class="modal-overlay">
        <div class="modal">
            <div class="modal-header"><h3>Add New Product</h3><span onclick="closeModal('modal-product')" style="cursor:pointer">‚úï</span></div>
            <form onsubmit="saveProduct(event)">
                <div class="modal-body">
                    <div class="form-group"><label>SKU Name</label><input id="prod-name" class="form-control" required></div>
                    <div class="grid-2">
                        <div class="form-group"><label>Size</label><input id="prod-size" class="form-control" placeholder="e.g. 500ml"></div>
                        <div class="form-group"><label>Pack Type</label><select id="prod-type" class="form-control"><option>Bottle</option><option>Jar</option><option>Carton</option></select></div>
                    </div>
                    <div class="grid-2">
                        <div class="form-group"><label>MRP</label><input type="number" id="prod-mrp" class="form-control" required></div>
                        <div class="form-group"><label>Rate</label><input type="number" id="prod-rate" class="form-control" required></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modal-product')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customer Modal -->
    <div id="modal-customer" class="modal-overlay">
        <div class="modal">
            <div class="modal-header"><h3>Add Customer</h3><span onclick="closeModal('modal-customer')" style="cursor:pointer">‚úï</span></div>
            <form onsubmit="saveCustomer(event)">
                <div class="modal-body">
                    <div class="form-group"><label>Business Name</label><input id="cust-name" class="form-control" required></div>
                    <div class="form-group"><label>Contact Person</label><input id="cust-contact" class="form-control"></div>
                    <div class="grid-2">
                        <div class="form-group"><label>Region</label><input id="cust-region" class="form-control"></div>
                        <div class="form-group"><label>Phone</label><input id="cust-phone" class="form-control"></div>
                    </div>
                    <div class="grid-2">
                         <div class="form-group"><label>Type</label><select id="cust-type" class="form-control"><option>Distributor</option><option>Retailer</option></select></div>
                         <div class="form-group"><label>Credit Limit</label><input type="number" id="cust-limit" class="form-control" value="0"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modal-customer')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Customer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Modal -->
    <div id="modal-order" class="modal-overlay">
        <div class="modal modal-lg">
            <div class="modal-header"><h3>Create Order</h3><span onclick="closeModal('modal-order')" style="cursor:pointer">‚úï</span></div>
            <div class="modal-body">
                <div class="grid-2">
                    <div class="form-group">
                        <label>Select Customer</label>
                        <select id="order-cust" class="form-control" onchange="orderCustChange()"></select>
                    </div>
                    <div class="form-group text-right">
                        <label>Date</label>
                        <input type="date" id="order-date" class="form-control">
                    </div>
                </div>
                <hr style="margin: 10px 0; border:0; border-top:1px solid #eee;">
                
                <div style="background: #f8fafc; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                    <div class="grid-4 align-center">
                        <div style="grid-column: span 2">
                            <select id="order-prod-select" class="form-control"></select>
                        </div>
                        <input type="number" id="order-prod-qty" class="form-control" placeholder="Qty" min="1">
                        <button class="btn btn-secondary" onclick="addOrderLine()">Add Item</button>
                    </div>
                </div>

                <div class="table-container" style="max-height: 200px; overflow-y: auto;">
                    <table id="order-lines-table">
                        <thead><tr><th>Product</th><th>Qty</th><th>Rate</th><th>Total</th><th>X</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <div class="text-right mt-2">
                    <h3>Total: ‚Çπ<span id="order-total-disp">0.00</span></h3>
                </div>

                <hr style="margin: 15px 0;">
                <div class="grid-2">
                    <div class="form-group">
                        <label>Payment Type</label>
                        <select id="order-pay-type" class="form-control">
                            <option value="Credit">Credit (Pay Later)</option>
                            <option value="Cash">Cash on Delivery</option>
                            <option value="Partial">Partial Payment</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Received Amount</label>
                        <input type="number" id="order-received" class="form-control" value="0">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-order')">Close</button>
                <button class="btn btn-primary" onclick="submitOrder()">Confirm Order</button>
            </div>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-area" class="toast-container"></div>

    <script>
        /* =========================================
           4. JAVASCRIPT LOGIC
           ========================================= */

        /**
         * GLOBAL CONFIGURATION & STATE
         */
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DB_FILENAME = 'aquaflow_erp_db.json';

        // Placeholder for user keys (input at runtime)
        let CLIENT_ID = '950010994560-v7p6cem78h9fsdp102iq4immb36t95ls.apps.googleusercontent.com';
        let API_KEY = 'AIzaSyCWo9OP6-QhyKWpfuV5oonyuC32IQHoOtE';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let dbFileId = null;

        // Central State Object
        let appData = {
            products: [],
            customers: [],
            inventory: [], // {sku: 'sku1', factory: 10, warehouse: 50, van: 0}
            orders: [],
            transactions: [], // Ledger
            settings: {
                lastSync: null
            }
        };

        // Temporary Order State
        let currentOrderLines = [];

        /* =========================================
           5. GOOGLE API AUTHENTICATION & DRIVE IO
           ========================================= */
        
        // Step 1: Initialize
        function handleAuthClick() {
            CLIENT_ID = document.getElementById('clientIdInput').value.trim();
            API_KEY = document.getElementById('apiKeyInput').value.trim();

            if (!CLIENT_ID || !API_KEY) {
                showAuthMsg("Please enter both Client ID and API Key.", "red");
                return;
            }

            document.getElementById('authLoader').classList.remove('hidden');
            gapi.load('client', initializeGapiClient);
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: async (resp) => {
                    if (resp.error !== undefined) {
                        throw (resp);
                    }
                    await findOrCreateDB();
                },
            });
            gisInited = true;
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            });
            gapiInited = true;
            
            // Trigger OAuth
            if (gapiInited && gisInited) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: 'consent'});
            }
        }

        // Step 2: Find or Create Database File
        async function findOrCreateDB() {
            try {
                showAuthMsg("Searching for ERP Database...", "blue");
                const response = await gapi.client.drive.files.list({
                    'pageSize': 1,
                    'fields': "nextPageToken, files(id, name)",
                    'q': `name = '${DB_FILENAME}' and trashed = false`
                });
                
                const files = response.result.files;
                if (files && files.length > 0) {
                    dbFileId = files[0].id;
                    showAuthMsg("Database found! Loading...", "green");
                    await loadDatabase();
                } else {
                    showAuthMsg("No database found. Creating new...", "blue");
                    await createDatabase();
                }
            } catch (err) {
                showAuthMsg("Error: " + JSON.stringify(err), "red");
                console.error(err);
            }
        }

        // Step 3: Create File
        async function createDatabase() {
            // Seed Data Generation
            appData = generateSeedData();
            const content = JSON.stringify(appData);
            
            const fileMetadata = {
                'name': DB_FILENAME,
                'mimeType': 'application/json'
            };
            
            // Multipart upload logic is complex in pure JS without libraries, 
            // so we use a simpler update logic after creating empty or using specific boundary methods.
            // For simplicity in this demo, we create then update.
            try {
                const createResp = await gapi.client.drive.files.create({
                    resource: fileMetadata
                });
                dbFileId = createResp.result.id;
                await saveDatabase(true); // Initial save
                enterApp();
            } catch (err) {
                showAuthMsg("Create Failed: " + err.message, "red");
            }
        }

        // Step 4: Load Data
        async function loadDatabase() {
            try {
                const response = await gapi.client.drive.files.get({
                    fileId: dbFileId,
                    alt: 'media'
                });
                appData = response.result;
                // Basic validation
                if(!appData.products) appData = generateSeedData();
                enterApp();
            } catch (err) {
                showAuthMsg("Load Failed: " + err.message, "red");
            }
        }

        // Step 5: Save Data (Sync)
        async function saveDatabase(force = false) {
            if (!dbFileId) return;
            
            // Debounce or immediate
            document.getElementById('lastSyncTime').innerText = "Syncing...";
            appData.settings.lastSync = new Date().toISOString();

            const content = JSON.stringify(appData);
            
            try {
                await gapi.client.request({
                    path: '/upload/drive/v3/files/' + dbFileId,
                    method: 'PATCH',
                    params: { uploadType: 'media' },
                    body: content
                });
                document.getElementById('lastSyncTime').innerText = new Date().toLocaleTimeString();
                if(force) showToast("Cloud Backup Complete", "success");
            } catch (err) {
                showToast("Sync Failed", "error");
                console.error(err);
            }
        }

        function showAuthMsg(msg, color) {
            const el = document.getElementById('authMessage');
            el.innerText = msg;
            el.style.color = color === "red" ? "var(--danger)" : "var(--primary)";
        }

        function enterApp() {
            document.getElementById('loginScreen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').classList.add('active');
                renderAll();
                // Auto sync every minute
                setInterval(() => saveDatabase(), 60000);
            }, 500);
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                location.reload();
            }
        }

        /* =========================================
           6. BUSINESS LOGIC & RENDERING
           ========================================= */

        // --- Navigation ---
        function navTo(pageId) {
            // Update Sidebar
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Update Title
            const titles = {
                'dashboard': 'Dashboard', 'products': 'Product Master', 'inventory': 'Inventory Management',
                'customers': 'Customer Database', 'orders': 'Order Processing', 'dispatch': 'Dispatch & Logistics',
                'payments': 'Payments & Ledger', 'reports': 'Analytics & Reports', 'settings': 'System Settings'
            };
            document.getElementById('pageTitle').innerText = titles[pageId];

            // Toggle Sections
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + pageId).classList.add('active');

            // Refresh Data view
            if (pageId === 'dashboard') renderDashboard();
            if (pageId === 'inventory') renderInventory();
        }

        // --- Render All ---
        function renderAll() {
            renderDashboard();
            renderProducts();
            renderCustomers();
            renderInventory();
            renderOrders();
            renderDispatch();
            renderPayments();
            renderReports();
        }

        // --- 1. Dashboard Logic ---
        function renderDashboard() {
            // Stats
            const today = new Date().toISOString().split('T')[0];
            const todayOrders = appData.orders.filter(o => o.date.startsWith(today));
            const salesTotal = todayOrders.reduce((sum, o) => sum + o.total, 0);
            
            const pending = appData.orders.filter(o => o.status !== 'Delivered').length;
            const totalDue = appData.customers.reduce((sum, c) => sum + (c.due || 0), 0);
            
            // Low Stock
            let lowStockCount = 0;
            appData.inventory.forEach(i => {
                if ((i.factory + i.warehouse) < 50) lowStockCount++;
            });

            document.getElementById('dash-sales').innerText = formatCurrency(salesTotal);
            document.getElementById('dash-pending').innerText = pending;
            document.getElementById('dash-credit').innerText = formatCurrency(totalDue);
            document.getElementById('dash-lowstock').innerText = lowStockCount;

            // Simple Chart Draw (Canvas)
            drawSalesChart();
            
            // Inv Table
            const tbody = document.querySelector('#dash-inv-table tbody');
            tbody.innerHTML = '';
            appData.inventory.slice(0, 5).forEach(inv => {
                const prod = appData.products.find(p => p.sku === inv.sku);
                const name = prod ? prod.name : inv.sku;
                const total = inv.factory + inv.warehouse;
                const status = total < 50 ? '<span class="badge badge-danger">Low</span>' : '<span class="badge badge-success">OK</span>';
                tbody.innerHTML += `<tr><td>${name}</td><td>${inv.factory}</td><td>${inv.warehouse}</td><td>${status}</td></tr>`;
            });
        }

        function drawSalesChart() {
            const canvas = document.getElementById('salesChart');
            const ctx = canvas.getContext('2d');
            // Reset
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#f8fafc';
            ctx.fillRect(0,0, canvas.width, canvas.height);
            
            // Mock Data Generator for "Weekly Trend" based on actual dates if available, or random for demo
            const dataPoints = [12000, 15000, 11000, 18000, 22000, 19000, 25000]; // Last 7 days
            
            // Draw Lines
            const maxVal = Math.max(...dataPoints) * 1.2;
            const stepX = canvas.width / (dataPoints.length - 1);
            
            ctx.beginPath();
            ctx.strokeStyle = '#0077b6';
            ctx.lineWidth = 3;
            
            dataPoints.forEach((val, i) => {
                const x = i * stepX;
                const y = canvas.height - ((val / maxVal) * canvas.height);
                if (i===0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
                
                // Dot
                ctx.fillStyle = '#0077b6';
                ctx.fillRect(x-3, y-3, 6, 6);
            });
            ctx.stroke();
        }

        // --- 2. Products Logic ---
        function renderProducts() {
            const tbody = document.querySelector('#product-table tbody');
            tbody.innerHTML = '';
            appData.products.forEach(p => {
                tbody.innerHTML += `
                    <tr>
                        <td><span class="badge badge-info">${p.sku}</span></td>
                        <td>${p.name}</td>
                        <td>${p.size}</td>
                        <td>${formatCurrency(p.mrp)}</td>
                        <td>${formatCurrency(p.rate)}</td>
                        <td>18%</td>
                        <td><button class="btn btn-sm btn-secondary" onclick="deleteProduct('${p.sku}')">Del</button></td>
                    </tr>
                `;
            });
            
            // Populate Dropdowns elsewhere
            const selects = ['inv-product', 'order-prod-select'];
            selects.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.innerHTML = appData.products.map(p => `<option value="${p.sku}">${p.name} (${p.size})</option>`).join('');
                }
            });
        }

        function saveProduct(e) {
            e.preventDefault();
            const sku = 'SKU' + Math.floor(Math.random() * 10000);
            const newProd = {
                sku: sku,
                name: document.getElementById('prod-name').value,
                size: document.getElementById('prod-size').value,
                type: document.getElementById('prod-type').value,
                mrp: parseFloat(document.getElementById('prod-mrp').value),
                rate: parseFloat(document.getElementById('prod-rate').value)
            };
            appData.products.push(newProd);
            // Init Inventory
            appData.inventory.push({ sku: sku, factory: 0, warehouse: 0, van: 0 });
            
            closeModal('modal-product');
            renderProducts();
            showToast("Product Added", "success");
            saveDatabase();
        }

        // --- 3. Inventory Logic ---
        function renderInventory() {
            const tbody = document.querySelector('#inventory-table tbody');
            tbody.innerHTML = '';
            appData.inventory.forEach(inv => {
                const prod = appData.products.find(p => p.sku === inv.sku);
                if (!prod) return;
                tbody.innerHTML += `
                    <tr>
                        <td><b>${prod.name}</b> <span class="text-muted">(${prod.size})</span></td>
                        <td>${inv.factory}</td>
                        <td>${inv.warehouse}</td>
                        <td>${inv.van}</td>
                    </tr>
                `;
            });
        }

        function handleStockAdjust(e) {
            e.preventDefault();
            const type = document.getElementById('inv-type').value;
            const sku = document.getElementById('inv-product').value;
            const qty = parseInt(document.getElementById('inv-qty').value);
            
            const item = appData.inventory.find(i => i.sku === sku);
            if (!item) return;

            if (type === 'inward') {
                item.factory += qty;
                showToast(`Added ${qty} to Factory`, "success");
            } else if (type === 'transfer') {
                if (item.factory >= qty) {
                    item.factory -= qty;
                    item.warehouse += qty;
                    showToast("Transfer Successful", "success");
                } else {
                    showToast("Insufficient Factory Stock", "error");
                }
            } else if (type === 'damage') {
                item.warehouse = Math.max(0, item.warehouse - qty);
                showToast("Stock Deducted", "warning");
            }

            document.getElementById('inv-qty').value = '';
            renderInventory();
            saveDatabase();
        }

        // --- 4. Customer Logic ---
        function renderCustomers() {
            const tbody = document.querySelector('#customer-table tbody');
            tbody.innerHTML = '';
            appData.customers.forEach(c => {
                tbody.innerHTML += `
                    <tr>
                        <td>${c.id}</td>
                        <td>${c.name}</td>
                        <td>${c.region}</td>
                        <td>${c.type}</td>
                        <td>${formatCurrency(c.limit)}</td>
                        <td style="color:${c.due > 0 ? 'red':'green'}">${formatCurrency(c.due || 0)}</td>
                        <td><button class="btn btn-sm btn-secondary">Edit</button></td>
                    </tr>
                `;
            });

            // Populate Order Customer Select
            const orderSel = document.getElementById('order-cust');
            const paySel = document.getElementById('pay-customer');
            const opts = '<option value="">Select Customer</option>' + appData.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            if(orderSel) orderSel.innerHTML = opts;
            if(paySel) paySel.innerHTML = opts;
        }

        function saveCustomer(e) {
            e.preventDefault();
            const newCust = {
                id: 'C' + (1000 + appData.customers.length + 1),
                name: document.getElementById('cust-name').value,
                contact: document.getElementById('cust-contact').value,
                region: document.getElementById('cust-region').value,
                phone: document.getElementById('cust-phone').value,
                type: document.getElementById('cust-type').value,
                limit: parseFloat(document.getElementById('cust-limit').value),
                due: 0
            };
            appData.customers.push(newCust);
            closeModal('modal-customer');
            renderCustomers();
            showToast("Customer Added", "success");
            saveDatabase();
        }

        // --- 5. Order Logic ---
        function openOrderModal() {
            currentOrderLines = [];
            document.getElementById('order-date').valueAsDate = new Date();
            renderOrderLines();
            openModal('modal-order');
        }

        function addOrderLine() {
            const sku = document.getElementById('order-prod-select').value;
            const qty = parseInt(document.getElementById('order-prod-qty').value);
            
            if (!sku || !qty || qty <= 0) return;

            const prod = appData.products.find(p => p.sku === sku);
            
            // Check Warehouse Stock
            const inv = appData.inventory.find(i => i.sku === sku);
            if (inv.warehouse < qty) {
                showToast(`Low Stock! Only ${inv.warehouse} in Warehouse`, "error");
                return;
            }

            const line = {
                sku: sku,
                name: prod.name,
                qty: qty,
                rate: prod.rate,
                total: qty * prod.rate
            };
            currentOrderLines.push(line);
            renderOrderLines();
        }

        function renderOrderLines() {
            const tbody = document.querySelector('#order-lines-table tbody');
            tbody.innerHTML = '';
            let total = 0;
            currentOrderLines.forEach((line, idx) => {
                total += line.total;
                tbody.innerHTML += `
                    <tr>
                        <td>${line.name}</td>
                        <td>${line.qty}</td>
                        <td>${line.rate}</td>
                        <td>${line.total}</td>
                        <td style="cursor:pointer; color:red" onclick="removeOrderLine(${idx})">x</td>
                    </tr>
                `;
            });
            document.getElementById('order-total-disp').innerText = total.toFixed(2);
        }

        function removeOrderLine(idx) {
            currentOrderLines.splice(idx, 1);
            renderOrderLines();
        }

        function submitOrder() {
            const custId = document.getElementById('order-cust').value;
            if (!custId || currentOrderLines.length === 0) {
                showToast("Select customer and add items", "error");
                return;
            }

            const total = currentOrderLines.reduce((acc, l) => acc + l.total, 0);
            const received = parseFloat(document.getElementById('order-received').value) || 0;
            const payType = document.getElementById('order-pay-type').value;

            // 1. Create Order
            const newOrder = {
                id: 'ORD-' + Date.now().toString().substr(-6),
                date: document.getElementById('order-date').value,
                customerId: custId,
                items: [...currentOrderLines],
                total: total,
                received: received,
                status: 'Pending', // Pending -> Packed -> Dispatched -> Delivered
                paymentStatus: payType
            };

            // 2. Deduct Inventory (Warehouse)
            newOrder.items.forEach(item => {
                const inv = appData.inventory.find(i => i.sku === item.sku);
                inv.warehouse -= item.qty;
                inv.van += item.qty; // Move to Van temporarily (logic for dispatch)
            });

            // 3. Update Ledger
            const cust = appData.customers.find(c => c.id === custId);
            const due = total - received;
            if (due > 0) cust.due += due;

            if (received > 0) {
                appData.transactions.push({
                    date: new Date().toISOString(),
                    customerId: custId,
                    type: 'Payment',
                    amount: received,
                    mode: payType
                });
            }

            appData.orders.unshift(newOrder);
            
            closeModal('modal-order');
            renderOrders();
            renderDispatch();
            renderDashboard(); // Update stats
            showToast("Order Placed Successfully", "success");
            saveDatabase();
        }

        function renderOrders() {
            const tbody = document.querySelector('#order-table tbody');
            tbody.innerHTML = '';
            appData.orders.forEach(o => {
                const cust = appData.customers.find(c => c.id === o.customerId);
                tbody.innerHTML += `
                    <tr>
                        <td>${o.id}</td>
                        <td>${o.date}</td>
                        <td>${cust ? cust.name : 'Unknown'}</td>
                        <td>${formatCurrency(o.total)}</td>
                        <td><span class="badge badge-warning">${o.status}</span></td>
                        <td>${o.paymentStatus}</td>
                        <td><button class="btn btn-sm btn-secondary">View</button></td>
                    </tr>
                `;
            });
        }

        // --- 6. Dispatch Logic ---
        function renderDispatch() {
            const pendingDiv = document.getElementById('dispatch-pending-list');
            const activeDiv = document.getElementById('dispatch-active-list');
            pendingDiv.innerHTML = '';
            activeDiv.innerHTML = '';

            appData.orders.forEach(o => {
                const cust = appData.customers.find(c => c.id === o.customerId);
                const card = `
                    <div style="background: #f8fafc; padding: 15px; margin-bottom: 10px; border: 1px solid #e2e8f0; border-radius: 6px;">
                        <div class="d-flex justify-between mb-2">
                            <b>${o.id}</b>
                            <span class="text-muted">${cust.region}</span>
                        </div>
                        <div class="mb-2" style="font-size:12px">
                            ${o.items.map(i => `${i.name} x${i.qty}`).join(', ')}
                        </div>
                        <div class="d-flex justify-between align-center">
                            <b>${formatCurrency(o.total)}</b>
                            ${getDispatchActionBtn(o)}
                        </div>
                    </div>
                `;

                if (o.status === 'Pending' || o.status === 'Packed') {
                    pendingDiv.innerHTML += card;
                } else if (o.status === 'Dispatched') {
                    activeDiv.innerHTML += card;
                }
            });
        }

        function getDispatchActionBtn(order) {
            if (order.status === 'Pending') {
                return `<button class="btn btn-sm btn-primary" onclick="changeOrderStatus('${order.id}', 'Dispatched')">Dispatch üöö</button>`;
            } else if (order.status === 'Dispatched') {
                return `<button class="btn btn-sm btn-success" onclick="changeOrderStatus('${order.id}', 'Delivered')">Mark Delivered ‚úÖ</button>`;
            }
            return '';
        }

        function changeOrderStatus(oid, status) {
            const order = appData.orders.find(o => o.id === oid);
            order.status = status;
            
            // If delivered, remove from van stock
            if (status === 'Delivered') {
                order.items.forEach(item => {
                    const inv = appData.inventory.find(i => i.sku === item.sku);
                    if (inv.van >= item.qty) inv.van -= item.qty; 
                });
            }

            renderDispatch();
            renderOrders(); // Refresh status there too
            saveDatabase();
        }

        // --- 7. Payments Logic ---
        function updatePayDue() {
            const cid = document.getElementById('pay-customer').value;
            const cust = appData.customers.find(c => c.id === cid);
            document.getElementById('pay-due-label').innerText = cust ? `Due: ‚Çπ${cust.due}` : 'Due: ‚Çπ0';
        }

        function handleAddPayment(e) {
            e.preventDefault();
            const cid = document.getElementById('pay-customer').value;
            const amt = parseFloat(document.getElementById('pay-amount').value);
            const mode = document.getElementById('pay-mode').value;

            const cust = appData.customers.find(c => c.id === cid);
            cust.due -= amt;

            appData.transactions.unshift({
                date: new Date().toISOString(),
                customerId: cid,
                type: 'Received',
                amount: amt,
                mode: mode
            });

            renderPayments();
            renderCustomers();
            showToast("Payment Recorded", "success");
            saveDatabase();
        }

        function renderPayments() {
            const tbody = document.querySelector('#ledger-table tbody');
            tbody.innerHTML = '';
            appData.transactions.slice(0, 50).forEach(t => {
                const cust = appData.customers.find(c => c.id === t.customerId);
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(t.date).toLocaleDateString()}</td>
                        <td>${cust ? cust.name : 'N/A'}</td>
                        <td><span class="badge badge-success">${t.type}</span></td>
                        <td>${formatCurrency(t.amount)}</td>
                        <td>${t.mode}</td>
                    </tr>
                `;
            });
        }

        // --- 8. Reports & Utils ---
        function renderReports() {
            document.getElementById('debug-area').value = JSON.stringify(appData, null, 2);
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "erp_backup.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function resetDatabase() {
            if(confirm("Are you sure? This deletes everything locally and on Drive.")) {
                appData = generateSeedData();
                saveDatabase(true);
                location.reload();
            }
        }

        // --- Helpers ---
        function formatCurrency(num) {
            return '‚Çπ' + num.toFixed(2);
        }

        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function showToast(msg, type) {
            const container = document.getElementById('toast-area');
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerText = msg;
            container.appendChild(el);
            setTimeout(() => {
                el.style.opacity = '0';
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        // --- Seed Data ---
        function generateSeedData() {
            return {
                products: [
                    {sku: 'AQ-200', name: 'Aqua Pure 200ml', size: '200ml', type: 'Bottle', mrp: 10, rate: 6},
                    {sku: 'AQ-500', name: 'Aqua Pure 500ml', size: '500ml', type: 'Bottle', mrp: 20, rate: 12},
                    {sku: 'AQ-1000', name: 'Aqua Pure 1L', size: '1L', type: 'Bottle', mrp: 30, rate: 18},
                    {sku: 'AQ-JAR', name: 'Aqua Jar 20L', size: '20L', type: 'Jar', mrp: 90, rate: 50},
                    {sku: 'SODA-PET', name: 'Club Soda', size: '500ml', type: 'Bottle', mrp: 25, rate: 15}
                ],
                customers: [
                    {id: 'C1001', name: 'City Mart Distributors', contact: 'Rajesh Kumar', region: 'North Zone', phone: '9876543210', type: 'Distributor', limit: 50000, due: 12000},
                    {id: 'C1002', name: 'Green Valley Hotel', contact: 'Manager', region: 'West Zone', phone: '9988776655', type: 'Retailer', limit: 10000, due: 0},
                    {id: 'C1003', name: 'Sunshine Events', contact: 'Sunil', region: 'South Zone', phone: '9123456789', type: 'Retailer', limit: 20000, due: 5000}
                ],
                inventory: [
                    {sku: 'AQ-200', factory: 5000, warehouse: 2000, van: 0},
                    {sku: 'AQ-500', factory: 3000, warehouse: 1000, van: 0},
                    {sku: 'AQ-1000', factory: 2500, warehouse: 500, van: 0},
                    {sku: 'AQ-JAR', factory: 200, warehouse: 50, van: 0},
                    {sku: 'SODA-PET', factory: 1000, warehouse: 200, van: 0}
                ],
                orders: [],
                transactions: [],
                settings: { lastSync: null }
            };
        }

        /* 
           =========================================
           7. INITIALIZERS & EVENT BINDINGS
           =========================================
           (Included inline in HTML tags mostly)
        */

    </script>
</body>
</html>
