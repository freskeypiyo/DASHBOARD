<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freskey Manager (Restricted)</title>
    
    <!-- LOAD GOOGLE API SCRIPTS -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <style>
        /* --- CSS STYLES --- */
        :root { 
            --primary: #1a73e8; 
            --primary-hover: #1557b0;
            --danger: #d93025; 
            --success: #188038; 
            --gray: #5f6368; 
            --bg: #f0f2f5; 
            --surface: #ffffff; 
            --border: #dadce0; 
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            color: #202124; 
            margin: 0; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }

        * { box-sizing: border-box; outline: none; }

        /* Utility Classes */
        .hidden { display: none !important; }
        .flex { display: flex; align-items: center; gap: 10px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .centered { display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; }
        .text-red { color: var(--danger); }
        .text-gray { color: var(--gray); }

        /* Buttons */
        .btn { 
            padding: 10px 18px; 
            border-radius: 4px; 
            border: none; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 500; 
            transition: all 0.2s ease; 
        }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 1px 2px rgba(60,64,67,0.3); }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-primary:disabled { background: #a8c7fa; cursor: not-allowed; }
        
        .btn-outline { background: white; border: 1px solid var(--border); color: #3c4043; }
        .btn-outline:hover { background: #f8f9fa; }
        
        .btn-danger { background: var(--danger); color: white; }

        /* Login & Card Styles */
        .card { 
            background: var(--surface); 
            border-radius: 8px; 
            box-shadow: 0 2px 6px rgba(60,64,67,0.15); 
            padding: 40px; 
            text-align: center; 
            max-width: 400px; 
            width: 100%;
        }

        /* Access Denied Specific */
        .denied-container { border-top: 5px solid var(--danger); }

        /* Dashboard Styles */
        header { 
            background: var(--surface); 
            height: 64px; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0 24px; 
            box-shadow: 0 1px 2px rgba(60,64,67,0.1); 
        }
        .logo { font-size: 20px; color: var(--primary); font-weight: 700; letter-spacing: -0.5px; }
        
        .main-content { max-width: 1000px; margin: 30px auto; padding: 0 20px; width: 100%; flex: 1; }

        /* Lists */
        .list-wrapper { background: var(--surface); border-radius: 8px; border: 1px solid var(--border); overflow: hidden; margin-top: 15px; }
        .list-header { background: #f8f9fa; padding: 12px 20px; font-size: 12px; font-weight: 700; color: var(--gray); text-transform: uppercase; border-bottom: 1px solid var(--border); }
        
        .list-item { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; transition: background 0.1s; }
        .list-item:hover { background: #fafafa; }
        .list-item:last-child { border-bottom: none; }
        
        .tag { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; background: #e8f0fe; color: var(--primary); margin-left: 8px; }

        /* Loader */
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Modal */
        .modal-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .modal { background: var(--surface); width: 450px; padding: 25px; border-radius: 10px; box-shadow: 0 15px 30px rgba(0,0,0,0.2); animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #202124; }
        .form-input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; transition: border 0.2s; }
        .form-input:focus { border-color: var(--primary); }

        #upload-status { font-size: 12px; color: var(--primary); text-align: right; min-height: 20px; font-weight: 600; }
    </style>
</head>
<body>

    <!-- 1. LOADING SCREEN (Starts here) -->
    <div id="view-loading" class="centered" style="flex-direction: column;">
        <div class="spinner"></div>
        <p class="text-gray">Initializing Security...</p>
    </div>

    <!-- 2. LOGIN SCREEN -->
    <div id="view-login" class="centered hidden">
        <div class="card">
            <h1 class="logo" style="font-size: 26px; margin-bottom: 5px;">Freskey Manager</h1>
            <p class="text-gray" style="font-size: 14px; margin-bottom: 30px;">Protected System</p>
            
            <button id="btn-google-login" class="btn btn-outline" style="width: 100%; padding: 12px; display: flex; justify-content: center; gap: 10px; font-size: 16px;">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20" height="20">
                Sign in with Google
            </button>
            <p style="margin-top: 20px; font-size: 12px; color: #999;">Only <b>freskeypiyo@gmail.com</b> can login</p>
        </div>
    </div>

    <!-- 3. ACCESS DENIED SCREEN -->
    <div id="view-denied" class="centered hidden">
        <div class="card denied-container">
            <div style="font-size: 40px; margin-bottom: 10px;">ðŸš«</div>
            <h2 class="text-red" style="margin: 0;">Access Denied</h2>
            <p class="text-gray" style="margin: 20px 0;">This application is private.</p>
            <div style="background: #fff0f0; color: var(--danger); padding: 10px; border-radius: 4px; font-size: 13px; margin-bottom: 20px;">
                User: <b id="lbl-denied-email"></b> is not authorized.
            </div>
            <button onclick="handleLogout()" class="btn btn-danger" style="width: 100%;">Sign Out</button>
        </div>
    </div>

    <!-- 4. DASHBOARD -->
    <div id="view-dashboard" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
        <header>
            <div class="flex">
                <span class="logo">Freskey</span>
                <span style="color:#ddd; margin:0 5px">/</span>
                <span id="lbl-user-email" style="font-size: 13px; font-weight: 500;"></span>
            </div>
            <button onclick="handleLogout()" class="btn btn-outline" style="font-size: 13px; padding: 6px 12px;">Logout</button>
        </header>
        
        <!-- Blue Loading Bar for Operations -->
        <div id="progress-bar" style="height: 3px; background: #e8f0fe; width: 100%; display:none;">
            <div style="width: 30%; height: 100%; background: var(--primary); animation: loadLine 1s infinite;"></div>
            <style>@keyframes loadLine { 0% {margin-left:0; width:0} 50% {width: 100%} 100% {margin-left:100%; width:0} }</style>
        </div>

        <div class="main-content">
            <div class="flex-between" style="margin-bottom: 15px;">
                <div>
                    <h2 style="margin:0;">Distributors</h2>
                    <small class="text-gray">Source: Google Drive / freskey_db.json</small>
                </div>
                <button onclick="openModal()" class="btn btn-primary">+ Add New</button>
            </div>

            <div class="list-wrapper">
                <div class="list-header flex-between">
                    <span>Distributor Profile</span>
                    <span>Document</span>
                </div>
                <div id="list-container">
                    <!-- Javascript populates data here -->
                    <div style="padding: 40px; text-align: center; color: #999;">Loading database...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Add Distributor -->
    <div id="modal-overlay" class="modal-backdrop hidden">
        <div class="modal">
            <h2 style="margin-top: 0; font-size: 20px;">Add Distributor</h2>
            
            <div class="form-group">
                <label>Distributor Name</label>
                <input type="text" id="inp-name" class="form-input" placeholder="e.g. Acme Traders">
            </div>

            <div class="form-group">
                <label>Region</label>
                <input type="text" id="inp-region" class="form-input" placeholder="e.g. North Zone">
            </div>

            <div class="form-group">
                <label>KYC Document (PDF or Image)</label>
                <input type="file" id="inp-file" class="form-input" style="border: none; padding-left: 0;">
            </div>

            <p id="upload-status"></p>

            <div class="flex" style="justify-content: flex-end; margin-top: 25px;">
                <button onclick="closeModal()" class="btn btn-outline" id="btn-cancel">Cancel</button>
                <button onclick="saveDistributor()" class="btn btn-primary" id="btn-save">Save to Drive</button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // ---------------------------------------------------------
        // 1. CONFIGURATION
        // ---------------------------------------------------------
        const CONFIG = {
            apiKey: 'AIzaSyCWo9OP6-QhyKWpfuV5oonyuC32IQHoOtE',
            clientId: '950010994560-v7p6cem78h9fsdp102iq4immb36t95ls.apps.googleusercontent.com',
            adminEmail: 'freskeypiyo@gmail.com', // STRICT LOCK
            dbFileName: 'freskey_db.json',
            scopes: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email'
        };

        // State
        let tokenClient;
        let accessToken = null;
        let dbFileId = null;
        let dbData = { distributors: [] };
        
        // ---------------------------------------------------------
        // 2. INITIALIZATION
        // ---------------------------------------------------------
        
        // Run when page loads
        window.onload = function() {
            // Check if libraries loaded
            if (typeof google === 'undefined' || typeof gapi === 'undefined') {
                alert("Google Scripts not loaded. Check your internet connection.");
                return;
            }

            gapi.load('client', initGapiClient);
            google.accounts.id.initialize({
                client_id: CONFIG.clientId,
                callback: handleCredentialResponse
            });
        };

        async function initGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: CONFIG.apiKey,
                    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
                });
                
                // Initialize OAuth 2.0 Token Client
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.clientId,
                    scope: CONFIG.scopes,
                    callback: async (resp) => {
                        if (resp.error) return;
                        accessToken = resp.access_token;
                        verifyUserAndLogin(); // Proceed after getting permission
                    }
                });

                // UI Ready
                document.getElementById('view-loading').classList.add('hidden');
                document.getElementById('view-login').classList.remove('hidden');

            } catch(e) {
                console.error("GAPI Init failed", e);
                alert("Could not initialize Google API. Check console.");
            }
        }

        // ---------------------------------------------------------
        // 3. AUTHENTICATION & SECURITY
        // ---------------------------------------------------------

        // Button click
        document.getElementById('btn-google-login').onclick = () => {
            // Trigger popup
            tokenClient.requestAccessToken({ prompt: 'consent' });
        };

        // Unused for OAuth2 flow but part of ID lib
        function handleCredentialResponse(response) { /* not used here */ }

        async function verifyUserAndLogin() {
            // Switch views
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-loading').classList.remove('hidden');

            try {
                // Get User Info from Google
                const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const user = await response.json();
                
                console.log("Logged in as:", user.email);

                // --- SECURITY CHECK ---
                if (user.email !== CONFIG.adminEmail) {
                    // Fail
                    document.getElementById('view-loading').classList.add('hidden');
                    document.getElementById('view-denied').classList.remove('hidden');
                    document.getElementById('lbl-denied-email').textContent = user.email;
                    return; 
                }

                // Success
                document.getElementById('view-loading').classList.add('hidden');
                document.getElementById('view-dashboard').style.display = "flex"; // Show flex
                document.getElementById('view-dashboard').classList.remove('hidden');
                document.getElementById('lbl-user-email').textContent = user.email;

                // Load Database
                loadDatabase();

            } catch (error) {
                console.error("Auth verify failed", error);
                alert("Login verification failed. Reloading.");
                location.reload();
            }
        }

        function handleLogout() {
            if (confirm("Sign out of session?")) {
                location.reload();
            }
        }

        // ---------------------------------------------------------
        // 4. DATABASE (JSON FILE) & DRIVE LOGIC
        // ---------------------------------------------------------
        
        async function loadDatabase() {
            showLoader(true);
            try {
                // Search for our DB file
                const query = `name = '${CONFIG.dbFileName}' and trashed = false`;
                const resp = await gapi.client.drive.files.list({ q: query, fields: 'files(id, name)' });
                const files = resp.result.files;

                if (files && files.length > 0) {
                    // File exists - Read it
                    dbFileId = files[0].id;
                    await fetchDBContent();
                } else {
                    // Create new DB file
                    console.log("DB File not found. Creating new one...");
                    await createDBFile();
                }
            } catch(e) {
                console.error("DB Load Error", e);
                alert("Error connecting to Google Drive Database.");
            }
            showLoader(false);
        }

        async function fetchDBContent() {
            // Using raw fetch to get file content media
            const res = await fetch(`https://www.googleapis.com/drive/v3/files/${dbFileId}?alt=media`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            dbData = await res.json();
            renderList();
        }

        async function createDBFile() {
            const metadata = { name: CONFIG.dbFileName, mimeType: 'application/json' };
            const content = JSON.stringify({ distributors: [] });
            
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', new Blob([content], { type: 'application/json' }));

            const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                body: form
            });
            const file = await res.json();
            dbFileId = file.id;
            dbData = { distributors: [] };
            renderList();
        }

        async function syncDatabase() {
            // Save local variable `dbData` to the Drive file
            const url = `https://www.googleapis.com/upload/drive/v3/files/${dbFileId}?uploadType=media`;
            await fetch(url, {
                method: 'PATCH',
                headers: new Headers({ 
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                }),
                body: JSON.stringify(dbData)
            });
        }

        // ---------------------------------------------------------
        // 5. APPLICATION LOGIC (CRUD & UPLOAD)
        // ---------------------------------------------------------

        const modal = document.getElementById('modal-overlay');
        const statusLbl = document.getElementById('upload-status');
        
        function openModal() {
            modal.classList.remove('hidden');
            // Reset form
            document.getElementById('inp-name').value = "";
            document.getElementById('inp-region').value = "";
            document.getElementById('inp-file').value = "";
            statusLbl.textContent = "";
        }
        function closeModal() {
            modal.classList.add('hidden');
        }

        async function saveDistributor() {
            const name = document.getElementById('inp-name').value;
            const region = document.getElementById('inp-region').value;
            const file = document.getElementById('inp-file').files[0];

            if(!name || !file) {
                alert("Please fill name and select a file.");
                return;
            }

            // Disable buttons
            const btnSave = document.getElementById('btn-save');
            btnSave.disabled = true;
            statusLbl.textContent = "Step 1: Uploading File to Drive...";
            showLoader(true);

            try {
                // 1. Upload the File
                const driveFile = await uploadFile(file);
                if(!driveFile.id) throw new Error("Upload failed");

                statusLbl.textContent = "Step 2: Updating Database...";

                // 2. Add to Local DB
                dbData.distributors.push({
                    id: Date.now(),
                    name: name,
                    region: region,
                    kycName: driveFile.name,
                    kycLink: driveFile.webViewLink,
                    dateAdded: new Date().toLocaleDateString()
                });

                // 3. Sync to Drive
                await syncDatabase();

                closeModal();
                renderList();
                alert("Distributor successfully added!");

            } catch (err) {
                console.error(err);
                alert("Error saving data: " + err.message);
            }
            
            btnSave.disabled = false;
            showLoader(false);
        }

        async function uploadFile(file) {
            const metadata = { name: `KYC_${Date.now()}_${file.name}`, mimeType: file.type };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink,name', {
                method: 'POST',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                body: form
            });
            return await res.json();
        }

        // ---------------------------------------------------------
        // 6. RENDER LOGIC
        // ---------------------------------------------------------
        function renderList() {
            const container = document.getElementById('list-container');
            const list = dbData.distributors || [];
            
            if(list.length === 0) {
                container.innerHTML = '<div style="padding:40px; text-align:center; color:#999;">No distributors found.</div>';
                return;
            }

            container.innerHTML = '';
            // Render newest first
            list.slice().reverse().forEach(item => {
                const el = document.createElement('div');
                el.className = 'list-item';
                el.innerHTML = `
                    <div>
                        <div style="font-weight:600; font-size:15px; margin-bottom:4px;">
                            ${item.name} <span class="tag">${item.region || 'No Region'}</span>
                        </div>
                        <div class="text-gray" style="font-size:12px;">Added: ${item.dateAdded}</div>
                    </div>
                    <a href="${item.kycLink}" target="_blank" class="btn btn-outline" style="text-decoration:none; font-size:12px; display:flex; align-items:center;">
                        View KYC â†—
                    </a>
                `;
                container.appendChild(el);
            });
        }

        function showLoader(visible) {
            const bar = document.getElementById('progress-bar');
            visible ? bar.style.display = 'block' : bar.style.display = 'none';
        }

    </script>
</body>
</html>
