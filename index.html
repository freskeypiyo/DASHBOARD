<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Himalayan Beverages | Freskey Enterprise Operations Platform</title>
    <meta name="description" content="Production Grade Single-File ERP">
    <meta name="theme-color" content="#0f172a">

    <!-- 
      ========================================================================================
      1. DEPENDENCY MANIFEST
      - Google Identity (GSI): Authentication.
      - GAPI: Google Drive REST API Interaction.
      - JSPDF: PDF Generation for Invoices.
      - AutoTable: Advanced PDF Tables.
      ========================================================================================
    -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <!-- 
      ========================================================================================
      2. DESIGN SYSTEM & CSS FRAMEWORK (Core UI Layer)
      Complete styling engine including layout, typography, components, and responsive grid.
      ========================================================================================
    -->
    <style>
        /* 
         * ----------------------------------------------------------------------------------
         * 2.1 CSS VARIABLES & COLOR PALETTE
         * Using the 'Himalayan' Brand Strategy: Deep Slate & Fresh Ice Blue
         * ----------------------------------------------------------------------------------
         */
        :root {
            /* BRAND IDENTITY */
            --color-primary-50:  #f0f9ff;
            --color-primary-100: #e0f2fe;
            --color-primary-200: #bae6fd;
            --color-primary-300: #7dd3fc;
            --color-primary-400: #38bdf8;
            --color-primary-500: #0ea5e9;
            --color-primary-600: #0284c7;
            --color-primary-700: #0369a1;
            --color-primary-800: #075985;
            --color-primary-900: #0c4a6e;
            --color-primary-950: #082f49;

            /* SEMANTIC STATES */
            --color-success: #22c55e;
            --color-success-dark: #15803d;
            --color-success-bg: #dcfce7;
            
            --color-warning: #f59e0b;
            --color-warning-dark: #b45309;
            --color-warning-bg: #fef3c7;
            
            --color-danger: #ef4444;
            --color-danger-dark: #b91c1c;
            --color-danger-bg: #fee2e2;

            /* NEUTRALS / SURFACE */
            --color-slate-50:  #f8fafc;
            --color-slate-100: #f1f5f9;
            --color-slate-200: #e2e8f0;
            --color-slate-300: #cbd5e1;
            --color-slate-400: #94a3b8;
            --color-slate-500: #64748b;
            --color-slate-600: #475569;
            --color-slate-700: #334155;
            --color-slate-800: #1e293b;
            --color-slate-900: #0f172a;
            --color-white:     #ffffff;

            /* COMPONENT VARIABLES */
            --font-family-sans: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            --font-family-mono: 'JetBrains Mono', 'Fira Code', monospace;
            
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);

            /* LAYOUT METRICS */
            --sidebar-width: 280px;
            --header-height: 70px;
            --z-header: 40;
            --z-modal: 100;
            --z-toast: 900;
            --z-login: 9999;
        }

        /* 
         * ----------------------------------------------------------------------------------
         * 2.2 CSS RESET & BASE
         * ----------------------------------------------------------------------------------
         */
        *, *::before, *::after {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            font-family: var(--font-family-sans);
            font-size: 14px;
            background-color: var(--color-slate-50);
            color: var(--color-slate-800);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        h1, h2, h3, h4, h5, h6 { margin: 0; font-weight: 700; color: var(--color-slate-900); }
        a { color: var(--color-primary-600); text-decoration: none; cursor: pointer; }
        ul, ol { margin: 0; padding: 0; list-style: none; }
        
        button { border: none; background: none; font-family: inherit; cursor: pointer; }
        img, svg { display: block; max-width: 100%; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--color-slate-300); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-slate-400); }

        /* 
         * ----------------------------------------------------------------------------------
         * 2.3 LAYOUT STRUCTURES
         * Flexbox and Grid definitions for the Shell
         * ----------------------------------------------------------------------------------
         */
        #root {
            display: flex;
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--color-slate-900);
            color: var(--color-slate-400);
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255,255,255,0.05);
            flex-shrink: 0;
            transition: transform 0.3s ease;
            z-index: 50;
        }

        .sidebar-brand {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .brand-text {
            color: var(--color-white);
            font-size: 1.25rem;
            font-weight: 800;
            letter-spacing: -0.025em;
        }
        .brand-text span { color: var(--color-primary-400); }

        .nav-wrapper { flex: 1; overflow-y: auto; padding: 1.5rem 1rem; }
        
        .nav-group-title {
            font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em;
            color: var(--color-slate-500); margin-bottom: 0.5rem; padding-left: 0.75rem;
            font-weight: 700;
        }

        .nav-item {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0.75rem 1rem; border-radius: var(--border-radius-md);
            margin-bottom: 0.25rem; transition: all 0.2s;
            color: var(--color-slate-400); font-weight: 500; font-size: 0.95rem;
        }

        .nav-item:hover { background-color: rgba(255,255,255,0.05); color: var(--color-white); }
        .nav-item.active { 
            background-color: var(--color-primary-600); 
            color: var(--color-white); 
            box-shadow: var(--shadow-md); 
        }

        .sidebar-footer {
            padding: 1.25rem;
            background: rgba(0,0,0,0.3);
            border-top: 1px solid rgba(255,255,255,0.05);
            font-size: 0.85rem;
        }

        /* --- MAIN CONTENT AREA --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--color-slate-50);
            position: relative;
        }

        /* --- HEADER --- */
        .app-header {
            height: var(--header-height);
            background-color: var(--color-white);
            border-bottom: 1px solid var(--color-slate-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            z-index: var(--z-header);
            box-shadow: var(--shadow-sm);
        }
        
        .mobile-toggle { display: none; color: var(--color-slate-800); margin-right: 1rem; }

        .header-title h2 { font-size: 1.15rem; font-weight: 700; color: var(--color-slate-800); }
        .header-breadcrumb { font-size: 0.85rem; color: var(--color-slate-500); margin-top: 0.1rem; }

        .user-pill {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0.35rem 0.5rem 0.35rem 1rem;
            background-color: var(--color-slate-50);
            border: 1px solid var(--color-slate-200);
            border-radius: 50px;
        }
        .user-avatar {
            width: 32px; height: 32px; background: var(--color-primary-600); color: white;
            border-radius: 50%; display: grid; place-items: center; font-weight: 700; font-size: 0.9rem;
        }

        /* --- SCROLL VIEWPORT --- */
        .view-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            scroll-behavior: smooth;
        }

        /* 
         * ----------------------------------------------------------------------------------
         * 2.4 COMPONENTS
         * ----------------------------------------------------------------------------------
         */

        /* CARDS */
        .card {
            background: var(--color-white);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--color-slate-200);
            box-shadow: var(--shadow-sm);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--color-slate-100);
            display: flex; justify-content: space-between; align-items: center;
        }
        .card-title { font-size: 1rem; font-weight: 600; color: var(--color-slate-800); }
        .card-body { padding: 1.5rem; }
        
        /* GRIDS */
        .grid-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--color-white);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--color-slate-200);
            box-shadow: var(--shadow-sm);
            position: relative;
        }
        .stat-card::after {
            content: ''; position: absolute; left: 0; top: 15%; bottom: 15%; width: 4px; 
            background: var(--color-primary-500); border-radius: 0 4px 4px 0;
        }
        .stat-label { font-size: 0.75rem; color: var(--color-slate-500); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
        .stat-val { font-size: 1.85rem; color: var(--color-slate-800); font-weight: 800; margin-top: 0.5rem; }

        /* BUTTONS */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 0.5rem 1rem; font-size: 0.9rem; font-weight: 600; border-radius: var(--border-radius-md);
            transition: all 0.2s; white-space: nowrap; user-select: none;
        }
        .btn:active { transform: translateY(1px); }
        
        .btn-primary { background-color: var(--color-primary-600); color: white; border: 1px solid transparent; }
        .btn-primary:hover { background-color: var(--color-primary-700); }

        .btn-secondary { background-color: var(--color-white); color: var(--color-slate-700); border: 1px solid var(--color-slate-300); }
        .btn-secondary:hover { background-color: var(--color-slate-50); border-color: var(--color-slate-400); }

        .btn-success { background-color: var(--color-success); color: white; border: 1px solid transparent; }
        .btn-danger { background-color: white; color: var(--color-danger); border: 1px solid var(--color-danger); }
        
        /* TABLES */
        .table-responsive { width: 100%; overflow-x: auto; border: 1px solid var(--color-slate-200); border-radius: var(--border-radius-md); }
        table { width: 100%; border-collapse: collapse; min-width: 650px; }
        th { text-align: left; background: var(--color-slate-50); color: var(--color-slate-500); padding: 0.85rem 1rem; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; border-bottom: 2px solid var(--color-slate-200); }
        td { padding: 1rem; border-bottom: 1px solid var(--color-slate-100); color: var(--color-slate-700); }
        tr:hover { background-color: var(--color-slate-50); }

        .status-badge { padding: 0.2rem 0.6rem; border-radius: 50px; font-size: 0.75rem; font-weight: 700; }
        .status-paid { background: var(--color-success-bg); color: var(--color-success-dark); }
        .status-unpaid { background: var(--color-danger-bg); color: var(--color-danger-dark); }
        .status-partial { background: var(--color-warning-bg); color: var(--color-warning-dark); }

        /* FORMS */
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.875rem; font-weight: 500; color: var(--color-slate-700); margin-bottom: 0.4rem; }
        .form-control {
            width: 100%; padding: 0.65rem 0.75rem; font-size: 0.95rem; border: 1px solid var(--color-slate-300);
            border-radius: var(--border-radius-md); color: var(--color-slate-900); transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-control:focus { border-color: var(--color-primary-500); box-shadow: 0 0 0 3px var(--color-primary-100); }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        
        /* 
         * ----------------------------------------------------------------------------------
         * 2.5 LOGIN PAGE & MODALS
         * ----------------------------------------------------------------------------------
         */
        
        /* LOGIN OVERLAY - Ensure it covers EVERYTHING initially */
        #auth-portal {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: var(--color-slate-900);
            background-image: radial-gradient(circle at top right, #1e293b, #0f172a);
            z-index: var(--z-login);
            display: flex;
            align-items: center; justify-content: center;
            opacity: 1; transition: opacity 0.5s ease-out;
        }
        
        .login-card {
            background: var(--color-white);
            width: 100%; max-width: 420px;
            padding: 3rem 2rem;
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-xl);
            text-align: center;
        }

        .auth-logo-box {
            width: 64px; height: 64px; background: var(--color-primary-600);
            border-radius: 50%; display: grid; place-items: center; color: white;
            font-size: 2rem; font-weight: 800; margin: 0 auto 1.5rem auto;
            box-shadow: 0 10px 20px -5px rgba(2, 132, 199, 0.4);
        }

        /* MODAL SYSTEM */
        .modal-mask {
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(4px); z-index: var(--z-modal);
            display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s;
        }
        .modal-mask.active { display: flex; opacity: 1; }
        
        .modal-container {
            background: var(--color-white); width: 100%; max-width: 650px; max-height: 90vh;
            border-radius: var(--border-radius-xl); box-shadow: var(--shadow-xl);
            display: flex; flex-direction: column; transform: translateY(20px); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal-mask.active .modal-container { transform: translateY(0); }

        .modal-body { padding: 1.5rem; overflow-y: auto; }
        .modal-footer { padding: 1.25rem 1.5rem; background: var(--color-slate-50); border-top: 1px solid var(--color-slate-200); display: flex; justify-content: flex-end; gap: 0.75rem; border-radius: 0 0 12px 12px; }

        /* TOAST */
        .toast-container { position: fixed; bottom: 30px; right: 30px; z-index: var(--z-toast); display: flex; flex-direction: column; gap: 10px; }
        .toast {
            min-width: 320px; background: var(--color-slate-800); color: white;
            padding: 14px 20px; border-radius: 8px; border-left: 4px solid var(--color-primary-500);
            box-shadow: var(--shadow-lg); font-size: 0.9rem;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from{ transform:translateX(50px); opacity:0 } to { transform:translateX(0); opacity:1} }

        /* RESPONSIVE */
        @media (max-width: 1024px) {
            .grid-stats { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -100%; height: 100%; z-index: 1000; box-shadow: 10px 0 25px rgba(0,0,0,0.5); }
            .sidebar.active { left: 0; }
            .mobile-toggle { display: block; }
            .grid-stats { grid-template-columns: 1fr; }
            .grid-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>

<body>

    <!-- 
      ========================================================================================
      3. AUTH PORTAL (Fixed & Robust Login)
      ========================================================================================
    -->
    <div id="auth-portal">
        <div class="login-card">
            <div class="auth-logo-box">H</div>
            <h1 class="text-xl font-bold text-slate-900 mb-1">Himalayan ERP</h1>
            <p class="text-slate-500 mb-6">Secure Cloud Workspace v4.0</p>

            <div id="loading-spinner" style="display:none; margin: 20px 0;">
                 <div style="width:30px; height:30px; border:3px solid #e2e8f0; border-top-color:#0ea5e9; border-radius:50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                 <p class="text-xs text-slate-400 mt-2" id="loading-msg">Connecting to Google Drive...</p>
                 <style>@keyframes spin {to{transform: rotate(360deg)}}</style>
            </div>

            <!-- PRIMARY AUTH: GOOGLE IDENTITY -->
            <div id="g_id_onload"
                 data-client_id="950010994560-v7p6cem78h9fsdp102iq4immb36t95ls.apps.googleusercontent.com"
                 data-callback="onGoogleAuth"
                 data-auto_prompt="false">
            </div>
            <div class="g_id_signin" 
                 data-type="standard" 
                 data-size="large" 
                 data-theme="filled_blue" 
                 data-text="sign_in_with" 
                 data-shape="rectangular" 
                 data-logo_alignment="left"
                 data-width="320">
            </div>

            <div style="margin-top: 1.5rem; border-top: 1px solid #e2e8f0; padding-top: 1.5rem;">
                <p class="text-xs text-slate-400 mb-2">Dev / Offline Testing Only</p>
                <button onclick="System.Auth.demoLogin()" class="btn btn-secondary w-full">
                    ⚠️ Demo Mode (Skip Auth)
                </button>
            </div>
        </div>
    </div>


    <!-- 
      ========================================================================================
      4. APP SHELL (Hidden by default)
      ========================================================================================
    -->
    <div id="root" style="display: none;">
        
        <!-- 4.1 SIDEBAR NAVIGATION -->
        <aside class="sidebar" id="sidebar-nav">
            <div class="sidebar-brand">
                <span class="brand-text"><span>Himalayan</span> ERP</span>
            </div>

            <nav class="nav-wrapper">
                <div class="nav-group-title">MAIN MENU</div>
                
                <div class="nav-item active" onclick="System.Router.go('dashboard')">
                    <!-- Dashboard Icon -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                    <span>Dashboard</span>
                </div>

                <div class="nav-item" onclick="System.Router.go('orders')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                    <span>Sales & Orders</span>
                </div>

                <div class="nav-item" onclick="System.Router.go('inventory')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                    <span>Stock Control</span>
                </div>

                <div class="nav-item" onclick="System.Router.go('finance')">
                     <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2v20M2 12h20"></path></svg>
                     <span>Payments & Ledger</span>
                </div>

                <div class="nav-group-title" style="margin-top:1.5rem">SETTINGS</div>

                <div class="nav-item" onclick="System.Router.go('crm')">
                     <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg>
                     <span>CRM Database</span>
                </div>

                <div class="nav-item" onclick="System.Router.go('settings')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
                    <span>Data & Backup</span>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div style="font-size:0.75rem; color:#64748b;">LOGGED IN AS</div>
                <div class="text-white font-bold" id="ui-user-email">Guest User</div>
                <div style="margin-top:8px; display:flex; align-items:center; gap:8px;">
                    <div id="sync-light" style="width:8px; height:8px; border-radius:50%; background: #64748b;"></div>
                    <span style="font-size:0.75rem; color:#94a3b8;" id="sync-txt">Offline Mode</span>
                </div>
            </div>
        </aside>

        <!-- 4.2 CONTENT -->
        <main class="main-content">
            <header class="app-header">
                <div style="display:flex; align-items:center;">
                    <button class="mobile-toggle" onclick="document.getElementById('sidebar-nav').classList.toggle('active')">
                        <svg width="24" height="24" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                    </button>
                    <div>
                        <div class="header-breadcrumb">Workspace</div>
                        <h2 id="page-heading">Operations Dashboard</h2>
                    </div>
                </div>

                <div class="user-pill">
                    <div class="user-avatar">F</div>
                    <span style="font-size:0.85rem; font-weight:600;">Admin</span>
                </div>
            </header>

            <div id="viewport" class="view-scroll">
                <!-- DYNAMIC CONTENT LOADED HERE -->
            </div>
        </main>
    </div>

    <!-- TOAST RACK -->
    <div class="toast-container" id="toast-rack"></div>

    <!-- 
      ========================================================================================
      5. MODAL SYSTEM
      Reuseable UI blocks for data entry.
      ========================================================================================
    -->

    <!-- MODAL: ORDER CREATION -->
    <div id="m-order" class="modal-mask">
        <div class="modal-container">
            <div style="padding:1.5rem; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between;">
                <h3 style="font-size:1.25rem;">Create Sales Invoice</h3>
                <button onclick="System.UI.closeModal('m-order')">✕</button>
            </div>
            <div class="modal-body">
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Customer</label>
                        <select id="o-cust" class="form-select"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" id="o-date" class="form-control">
                    </div>
                </div>

                <div class="card" style="margin-top:10px; border:none; background:#f8fafc;">
                    <div class="card-body">
                        <h4 style="margin-bottom:1rem; color:#64748b;">Add Items</h4>
                        <div class="table-responsive" style="max-height: 250px; background:white; border:1px solid #e2e8f0;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th style="width:100px;">Price</th>
                                        <th style="width:80px;">Qty</th>
                                        <th style="width:120px;text-align:right;">Line Total</th>
                                    </tr>
                                </thead>
                                <tbody id="o-lines">
                                    <!-- Rendered JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div style="text-align:right; font-size:1.5rem; font-weight:bold; margin-top:1rem; color:var(--color-primary-600);">
                    Total: <span id="o-total">INR 0.00</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="System.UI.closeModal('m-order')">Cancel</button>
                <button class="btn btn-primary" onclick="Controllers.Sales.confirmOrder()">Generate Invoice</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL: PAYMENT -->
    <div id="m-pay" class="modal-mask">
        <div class="modal-container" style="max-width:500px;">
             <div style="padding:1.5rem; border-bottom:1px solid #e2e8f0;">
                <h3 style="font-size:1.25rem;">Record Payment</h3>
            </div>
            <div class="modal-body">
                <input type="hidden" id="p-id">
                <div class="form-group">
                    <label class="form-label">Invoice ID</label>
                    <input class="form-control" id="p-disp" disabled>
                </div>
                 <div class="grid-2">
                     <div><label class="form-label">Due Amount</label><input class="form-control" id="p-due" disabled style="color:red; font-weight:bold;"></div>
                     <div><label class="form-label">Paid So Far</label><input class="form-control" id="p-curr" disabled></div>
                 </div>
                 <div class="form-group" style="margin-top:15px;">
                     <label class="form-label">Payment Received (INR)</label>
                     <input type="number" id="p-amt" class="form-control" style="font-size:1.25rem; font-weight:bold;">
                 </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="System.UI.closeModal('m-pay')">Cancel</button>
                <button class="btn btn-success" onclick="Controllers.Finance.pay()">Save Payment</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL: ADD STOCK -->
    <div id="m-stk" class="modal-mask">
        <div class="modal-container" style="max-width:500px;">
            <div style="padding:1.5rem; border-bottom:1px solid #e2e8f0;">
                <h3>Purchase Entry (Add Stock)</h3>
            </div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Select Product</label><select id="s-prod" class="form-select"></select></div>
                <div class="form-group"><label class="form-label">Qty Purchased (Cases)</label><input type="number" id="s-qty" class="form-control"></div>
                <div class="form-group"><label class="form-label">Reference / Supplier</label><input type="text" id="s-ref" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="System.UI.closeModal('m-stk')">Cancel</button>
                <button class="btn btn-primary" onclick="Controllers.Inventory.add()">Confirm Purchase</button>
            </div>
        </div>
    </div>


    <!-- 
      ========================================================================================
      6. JAVASCRIPT KERNEL (State, Logic, Drive Sync)
      Complete MVC Architecture
      ========================================================================================
    -->
    <script>
        
        /**
         * 6.1 APP CONFIGURATION & STATE
         */
        const AppConfig = {
            API_KEY: 'AIzaSyCWo9OP6-QhyKWpfuV5oonyuC32IQHoOtE', // * Your provided key *
            CLIENT_ID: '950010994560-v7p6cem78h9fsdp102iq4immb36t95ls.apps.googleusercontent.com', // * Your provided client *
            SCOPES: 'https://www.googleapis.com/auth/drive.file',
            DB_FILE: 'himalayan_db_v4.json'
        };

        // Reactive State Store
        const Store = {
            customers: [
                { id: 'C01', name: 'Sample Retailer', loc: 'Main Market', type: 'Retailer', phone:'9999999999' }
            ],
            products: [
                { id: 'P01', name: 'Freskey Lemon 200ml', stock: 150, price: 480 },
                { id: 'P02', name: 'Freskey Mango 200ml', stock: 80, price: 500 },
                { id: 'P03', name: 'Freskey Litchi 500ml', stock: 45, price: 360 },
                { id: 'P04', name: 'Soda Fizz 300ml', stock: 200, price: 600 },
                { id: 'P05', name: 'Water 1L', stock: 500, price: 240 }
            ],
            orders: [], // { id, date, custId, total, paid, status, items:[] }
            ledgers: [] // { date, desc, amt, type }
        };
        
        let accessToken = null;

        /**
         * 6.2 HELPER UTILITIES
         */
        const Util = {
            $: (id) => document.getElementById(id),
            currency: (n) => "INR " + parseFloat(n).toLocaleString('en-IN', {minimumFractionDigits: 2}), // PDF Safe
            today: () => new Date().toISOString().split('T')[0],
            uid: () => Date.now().toString(36),
            toast: (msg) => {
                const el = document.createElement('div');
                el.className = 'toast'; el.innerText = msg;
                Util.$('toast-rack').appendChild(el);
                setTimeout(()=>el.remove(), 4000);
            }
        };

        /**
         * 6.3 CUSTOM CHART RENDERER (Canvas)
         * Avoids 200kb external libraries.
         */
        const Graphics = {
            drawBar: (canvasId, data, labels) => {
                const cvs = Util.$(canvasId);
                if(!cvs) return;
                const ctx = cvs.getContext('2d');
                const w = cvs.width, h = cvs.height;
                const pad = 40;
                
                // BG
                ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h);
                
                // Axis
                ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, h-pad); ctx.lineTo(w-pad, h-pad);
                ctx.strokeStyle = '#cbd5e1'; ctx.stroke();
                
                // Bars
                const max = Math.max(...data, 10);
                const stepX = (w - 2*pad) / data.length;
                const scaleY = (h - 2*pad) / max;
                
                data.forEach((val, i) => {
                    const bh = val * scaleY;
                    const bx = pad + i*stepX + 10;
                    const by = h - pad - bh;
                    
                    ctx.fillStyle = val < 20 ? '#ef4444' : '#0ea5e9'; // Red if low stock
                    ctx.fillRect(bx, by, stepX - 20, bh);
                    
                    // Text
                    ctx.fillStyle = '#333';
                    ctx.font = '12px sans-serif';
                    ctx.fillText(val, bx, by - 5);
                    ctx.fillText(labels[i].substring(0,3), bx, h - pad + 15);
                });
            }
        };

        /**
         * 6.4 PDF GENERATOR ENGINE
         * Defines the visual layout of invoices
         */
        const PDF = {
            make: (ord, cust) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header Banner
                doc.setFillColor(7, 89, 133); doc.rect(0, 0, 210, 35, 'F');
                doc.setTextColor(255); doc.setFontSize(22); doc.text("Himalayan Beverages", 14, 22);
                doc.setFontSize(10); doc.text("Freskey Distribution Center", 14, 28);
                
                doc.setTextColor(0); 
                doc.text("INVOICE NO:", 140, 50); doc.text(ord.id, 170, 50);
                doc.text("DATE:", 140, 55); doc.text(ord.date, 170, 55);
                
                // Bill To
                doc.setFontSize(12); doc.text("Bill To:", 14, 50);
                doc.setFontSize(10); doc.text(cust.name, 14, 55);
                doc.text(cust.loc, 14, 60);
                doc.text(cust.phone, 14, 65);
                
                // Table
                const rows = ord.items.map(i => [i.name, i.qty, i.price, i.price*i.qty]);
                doc.autoTable({
                    startY: 80,
                    head: [['Item Description', 'Qty', 'Rate', 'Amount']],
                    body: rows,
                    theme: 'grid',
                    headStyles: {fillColor:[7, 89, 133]},
                });
                
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(12); doc.setFont(undefined, 'bold');
                doc.text(`Total Payable: INR ${ord.total}`, 140, finalY);
                
                doc.save(`Inv_${ord.id}.pdf`);
            }
        };

        /**
         * 6.5 DRIVE ADAPTER (API Service)
         * Robust Error handling + Token Management
         */
        const DriveService = {
            tokenClient: null,
            init: () => {
                // Initialize Scripts
                gapi.load('client', async () => {
                    try {
                        await gapi.client.init({ apiKey: AppConfig.API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] });
                    } catch(e) { console.warn("Google API Init fail - likely offline or blocked origin"); }
                });
                
                try {
                    DriveService.tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: AppConfig.CLIENT_ID,
                        scope: AppConfig.SCOPES,
                        callback: async (resp) => {
                            if (resp.error) throw resp;
                            accessToken = resp.access_token;
                            await DriveService.load();
                        },
                    });
                } catch(e){ console.warn("GSI Fail"); }
            },
            
            prompt: () => {
                 document.querySelector('.g_id_signin').style.display = 'none';
                 document.getElementById('loading-spinner').style.display = 'block';
                 if(DriveService.tokenClient) DriveService.tokenClient.requestAccessToken({prompt: ''});
            },
            
            // DOWNLOAD DB
            load: async () => {
                 document.getElementById('loading-msg').innerText = "Syncing Database...";
                 try {
                     const q = `name = '${AppConfig.DB_FILE}' and trashed = false`;
                     const res = await gapi.client.drive.files.list({q: q, fields: 'files(id)'});
                     const files = res.result.files;

                     if (files && files.length > 0) {
                         const fId = files[0].id;
                         const content = await gapi.client.drive.files.get({fileId: fId, alt: 'media'});
                         Store = content.result; // HYDRATE STATE
                     } else {
                         // Create New if not found
                         await DriveService.save(true);
                     }
                     System.Auth.unlock("Google User");
                 } catch (e) {
                     alert("Sync Error: " + JSON.stringify(e));
                 }
            },
            
            // UPLOAD DB (Multipart)
            save: async (isNew = false) => {
                 const body = JSON.stringify(Store);
                 const fileBlob = new Blob([body], {type:'application/json'});
                 const meta = {name: AppConfig.DB_FILE, mimeType:'application/json'};

                 const form = new FormData();
                 form.append('metadata', new Blob([JSON.stringify(meta)], {type: 'application/json'}));
                 form.append('file', fileBlob);
                 
                 const headers = new Headers({'Authorization': 'Bearer ' + accessToken});

                 // Find Existing
                 if(!isNew) {
                     const q = `name = '${AppConfig.DB_FILE}' and trashed = false`;
                     const listRes = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}`, {headers});
                     const listData = await listRes.json();
                     if(listData.files && listData.files.length > 0) {
                         // PATCH
                         const fId = listData.files[0].id;
                         await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fId}?uploadType=media`, {
                             method: 'PATCH',
                             headers: new Headers({'Authorization': 'Bearer ' + accessToken, 'Content-Type': 'application/json'}),
                             body: body
                         });
                         System.UI.setSyncStatus(true);
                         return;
                     }
                 }

                 // POST (Create)
                 await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                     method: 'POST', headers: headers, body: form
                 });
                 System.UI.setSyncStatus(true);
            }
        };

        /**
         * 6.6 SYSTEM CONTROLLERS (Business Logic)
         */
        const System = {
            Auth: {
                // Triggered by the Google button via global callback
                onGoogleSuccess: (response) => {
                    DriveService.init(); // Load APIs
                    setTimeout(() => DriveService.prompt(), 500); // Ask for scope
                },
                // Developer Bypass
                demoLogin: () => {
                    document.getElementById('loading-spinner').style.display = 'block';
                    setTimeout(() => {
                        System.Auth.unlock("Demo User");
                        System.UI.setSyncStatus(false);
                    }, 800);
                },
                unlock: (user) => {
                    document.getElementById('auth-portal').style.opacity = '0';
                    setTimeout(()=>document.getElementById('auth-portal').style.display='none', 500);
                    
                    document.getElementById('root').style.display = 'flex';
                    document.getElementById('ui-user-email').innerText = user;
                    System.Router.go('dashboard');
                }
            },
            
            Router: {
                go: (view) => {
                    const vp = Util.$('viewport');
                    const ph = Util.$('page-heading');
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    // Simplified active handling via click bubbling not impl in this mono-file
                    
                    if (view === 'dashboard') {
                        ph.innerText = "Operations Dashboard";
                        
                        // Calculate metrics
                        const sales = Store.orders.reduce((a,b) => a+b.total, 0);
                        const due = Store.orders.reduce((a,b) => a+(b.total-b.paid), 0);
                        
                        vp.innerHTML = `
                            <div class="grid-stats">
                                <div class="stat-card">
                                    <div class="stat-label">Total Revenue</div>
                                    <div class="stat-val text-slate-900">${Util.currency(sales)}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Outstanding</div>
                                    <div class="stat-val text-red-600" style="color:#ef4444">${Util.currency(due)}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Active Products</div>
                                    <div class="stat-val text-blue-600">${Store.products.length}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Customers</div>
                                    <div class="stat-val text-blue-600">${Store.customers.length}</div>
                                </div>
                            </div>
                            
                            <div class="grid-2">
                                <div class="card">
                                    <div class="card-header"><h3 class="card-title">Inventory Levels</h3></div>
                                    <div class="card-body">
                                        <canvas id="invCanvas" width="400" height="200" style="width:100%; height:200px"></canvas>
                                    </div>
                                </div>
                                <div class="card">
                                    <div class="card-header"><h3 class="card-title">Recent Ledgers</h3></div>
                                    <div class="table-responsive">
                                        <table>
                                            <thead><tr><th>Date</th><th>Desc</th><th>Amt</th></tr></thead>
                                            <tbody>
                                                ${Store.ledgers.slice(0,5).map(l => `<tr>
                                                    <td>${l.date}</td><td>${l.desc}</td><td>${Util.currency(l.amt)}</td>
                                                </tr>`).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                        // Draw Chart
                        const pNames = Store.products.map(p=>p.name);
                        const pStocks = Store.products.map(p=>p.stock);
                        setTimeout(() => Graphics.drawBar('invCanvas', pStocks, pNames), 50);
                    } 
                    else if (view === 'orders') {
                        ph.innerText = "Sales Orders";
                        vp.innerHTML = `
                            <div class="card">
                                <div class="table-responsive">
                                    <table>
                                        <thead><tr><th>ID</th><th>Customer</th><th class="text-right">Total</th><th>Status</th><th>Action</th></tr></thead>
                                        <tbody>
                                            ${Store.orders.slice().reverse().map(o => {
                                                const cust = Store.customers.find(c=>c.id==o.custId);
                                                const due = o.total - o.paid;
                                                const badge = due <= 0 ? 'paid' : (o.paid>0 ? 'partial' : 'unpaid');
                                                return `<tr>
                                                    <td>${o.id}<br><span style="font-size:0.7rem; color:#64748b">${o.date}</span></td>
                                                    <td>${cust ? cust.name : 'Unk'}</td>
                                                    <td class="text-right">
                                                        <div>${Util.currency(o.total)}</div>
                                                        ${due>0 ? `<div style="color:red; font-size:0.75rem">Due: ${due}</div>` : ''}
                                                    </td>
                                                    <td><span class="status-badge status-${badge}">${badge.toUpperCase()}</span></td>
                                                    <td>
                                                        <button class="btn btn-secondary btn-sm" onclick="Controllers.Sales.print('${o.id}')">PDF</button>
                                                    </td>
                                                </tr>`;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    }
                    else if (view === 'inventory') {
                        ph.innerText = "Warehouse Management";
                        vp.innerHTML = `
                            <div class="card">
                                <div class="card-header"><h3 class="card-title">Stock Overview</h3></div>
                                <div class="table-responsive">
                                    <table><thead><tr><th>Product</th><th>Stock</th><th>Rate</th></tr></thead><tbody>
                                    ${Store.products.map(p=>`<tr>
                                        <td><b>${p.name}</b><br><span style="color:#64748b;font-size:0.8rem">${p.pack}</span></td>
                                        <td style="${p.stock<30?'color:red; font-weight:bold':''}">${p.stock} Cases</td>
                                        <td>${Util.currency(p.price)}</td>
                                    </tr>`).join('')}
                                    </tbody></table>
                                </div>
                            </div>
                        `;
                    }
                    else if (view === 'finance') {
                         ph.innerText = "Financials";
                         const pending = Store.orders.filter(o => o.total - o.paid > 0);
                         vp.innerHTML = `
                             <div class="card">
                                 <div class="card-header"><h3 class="card-title">Pending Collections</h3></div>
                                 <div class="table-responsive">
                                     <table><thead><tr><th>Invoice</th><th>Customer</th><th>Balance</th><th>Action</th></tr></thead>
                                     <tbody>
                                         ${pending.length===0 ? '<tr><td colspan="4" class="text-center">All Clear!</td></tr>' :
                                           pending.map(o => {
                                               const c = Store.customers.find(cx=>cx.id==o.custId);
                                               return `<tr>
                                                   <td>${o.id}</td><td>${c.name}</td>
                                                   <td style="color:red;font-weight:bold">${Util.currency(o.total - o.paid)}</td>
                                                   <td><button class="btn btn-success btn-sm" onclick="System.UI.modal('m-pay', '${o.id}')">Receive Pay</button></td>
                                               </tr>`;
                                           }).join('')
                                         }
                                     </tbody>
                                     </table>
                                 </div>
                             </div>
                         `;
                    }
                }
            },
            
            UI: {
                modal: (id, payload) => {
                    const el = Util.$(id);
                    el.classList.add('active');
                    
                    if(id==='m-order') {
                        // Fill customers
                        Util.$('o-cust').innerHTML = Store.customers.map(c=>`<option value="${c.id}">${c.name}</option>`);
                        // Build Items rows with input
                        Util.$('o-lines').innerHTML = Store.products.map(p=>`
                            <tr>
                                <td>${p.name}</td>
                                <td>${p.price}</td>
                                <td style="${p.stock<10?'color:red':''}">${p.stock}</td>
                                <td><input type="number" min="0" class="form-control item-qty" data-id="${p.id}" onchange="Controllers.Sales.calcTotal()"></td>
                                <td class="text-right" id="sub-${p.id}">0.00</td>
                            </tr>
                        `).join('');
                        Controllers.Sales.calcTotal(); // Reset
                    }
                    if(id==='m-pay' && payload) {
                        const o = Store.orders.find(x=>x.id==payload);
                        Util.$('p-id').value = payload;
                        Util.$('p-disp').value = `${o.id} | Total: ${o.total}`;
                        Util.$('p-due').value = (o.total - o.paid);
                        Util.$('p-curr').value = o.paid;
                    }
                },
                closeModal: (id) => Util.$(id).classList.remove('active'),
                setSyncStatus: (isOnline) => {
                    const l = Util.$('sync-light');
                    const t = Util.$('sync-txt');
                    if(isOnline){ l.style.background='#22c55e'; t.innerText="Online"; }
                }
            }
        };

        const Controllers = {
             Sales: {
                 calcTotal: () => {
                     let sum = 0;
                     document.querySelectorAll('.item-qty').forEach(el => {
                         const q = parseInt(el.value)||0;
                         const pid = el.dataset.id;
                         const prod = Store.products.find(p=>p.id==pid);
                         const line = q * prod.price;
                         Util.$('sub-'+pid).innerText = line;
                         sum += line;
                     });
                     Util.$('o-total').innerText = Util.currency(sum);
                 },
                 confirmOrder: () => {
                     const inputs = document.querySelectorAll('.item-qty');
                     const items = [];
                     let total = 0;
                     
                     inputs.forEach(el => {
                         const q = parseInt(el.value);
                         if(q > 0) {
                             const p = Store.products.find(x=>x.id==el.dataset.id);
                             p.stock -= q;
                             items.push({name: p.name, qty: q, price: p.price, total: q*p.price});
                             total += q*p.price;
                         }
                     });
                     
                     if(total === 0) return alert("Add items");

                     const id = 'INV-' + Date.now();
                     const cid = Util.$('o-cust').value;
                     const cObj = Store.customers.find(c=>c.id==cid);

                     const order = {
                         id: id, date: Util.$('o-date').value || Util.today(),
                         custId: cid, total: total, paid: 0, status: 'Unpaid',
                         items: items
                     };
                     
                     Store.orders.unshift(order);
                     Store.ledgers.unshift({date:Util.today(), desc:`Inv ${id} generated`, type:'Sale', amt:total});
                     
                     Util.toast("Invoice Created");
                     System.UI.closeModal('m-order');
                     System.Router.go('orders');
                     
                     // PDF
                     if(confirm("Download PDF?")) PDF.make(order, cObj);

                     // SYNC
                     if(accessToken) DriveService.save();
                 },
                 print: (oid) => {
                     const o = Store.orders.find(x=>x.id==oid);
                     const c = Store.customers.find(x=>x.id==o.custId);
                     PDF.make(o, c);
                 }
             },
             Finance: {
                 pay: () => {
                     const oid = Util.$('p-id').value;
                     const amt = parseFloat(Util.$('p-amt').value);
                     if(!amt) return;
                     const o = Store.orders.find(x=>x.id==oid);
                     if(amt > (o.total - o.paid)) return alert("Excess amount");
                     
                     o.paid += amt;
                     o.status = o.paid >= o.total ? 'Paid' : 'Partial';
                     Store.ledgers.unshift({date:Util.today(), desc:`Receipt for ${oid}`, type:'Credit', amt:amt});
                     
                     System.UI.closeModal('m-pay');
                     System.Router.go('finance');
                     Util.toast("Payment Recorded");
                     if(accessToken) DriveService.save();
                 }
             }
        };

        // --- GLOBAL EXPORTS FOR HTML CALLBACKS ---
        window.onGoogleAuth = System.Auth.onGoogleSuccess;

        // Auto Init logic moved to "Demo Button" or "Google Button" to ensure login reliability
    </script>
</body>
</html>
