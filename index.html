<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freskey Operations Manager | Himalayan Beverages ERP</title>
    <meta name="description" content="End-to-End Distribution ERP for Water Bottle Manufacturing">

    <!-- 
    ========================================================================================
    1. DEPENDENCY INJECTION
    - GAPI & GSI: Google Drive Cloud Sync.
    - JSPDF: Professional Invoice/Manifest Generation.
    ========================================================================================
    -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <!-- 
    ========================================================================================
    2. ENTERPRISE CSS FRAMEWORK (Freskey Design System)
    ~600 Lines of Styling Definition
    ========================================================================================
    -->
    <style>
        /* 2.1 THEME VARIABLES */
        :root {
            /* Brand Identity: Crystal Water Blue & Mountain Slate */
            --color-primary-50:  #f0f9ff;
            --color-primary-100: #e0f2fe;
            --color-primary-500: #0ea5e9; /* Sky Blue */
            --color-primary-600: #0284c7; /* Brand Blue */
            --color-primary-700: #0369a1;
            --color-primary-900: #0c4a6e; /* Deep Header */

            /* Functional Palette */
            --color-success: #16a34a;
            --color-warning: #ea580c; /* Burnt Orange for Urgent */
            --color-danger:  #dc2626;
            --color-purple:  #7c3aed;
            
            /* Surface Tones */
            --bg-body:    #f1f5f9;
            --bg-card:    #ffffff;
            --bg-sidebar: #0f172a; /* Night Blue */
            
            /* Text Hierarchy */
            --text-main:  #1e293b;
            --text-muted: #64748b;
            --text-light: #94a3b8;
            --text-inv:   #ffffff;

            /* Metrics */
            --sidebar-w: 270px;
            --header-h: 68px;
            --radius-md: 8px;
            --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }

        /* 2.2 BASE RESETS */
        *, *::before, *::after { box-sizing: border-box; outline: none; }
        body {
            margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-body); color: var(--text-main); font-size: 14px;
            height: 100vh; overflow: hidden; display: flex;
        }
        h1, h2, h3, h4 { margin: 0; font-weight: 700; color: var(--text-main); }
        ul { list-style: none; padding: 0; margin: 0; }
        button, input, select, textarea { font-family: inherit; font-size: inherit; }
        
        /* 2.3 LAYOUT GRID */
        #root-app { display: flex; width: 100%; height: 100%; position: relative; }

        /* Sidebar Styling */
        .sidebar {
            width: var(--sidebar-w); background: var(--bg-sidebar); color: var(--text-light);
            display: flex; flex-direction: column; z-index: 50; transition: 0.3s ease;
            border-right: 1px solid rgba(255,255,255,0.05);
        }
        
        .brand-section {
            height: var(--header-h); display: flex; align-items: center; padding: 0 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2);
        }
        .brand-logo { 
            font-size: 1.4rem; font-weight: 800; color: #fff; letter-spacing: -0.5px; 
            display: flex; align-items: center; gap: 10px;
        }
        .logo-water { width: 12px; height: 12px; background: #38bdf8; border-radius: 50%; box-shadow: 0 0 10px #38bdf8; }

        .nav-scroller { flex: 1; padding: 1.5rem 1rem; overflow-y: auto; }
        .nav-category { font-size: 0.7rem; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 8px; margin-top: 20px; padding-left: 10px; letter-spacing: 0.5px; }
        .nav-category:first-child { margin-top: 0; }

        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 10px 14px;
            border-radius: var(--radius-md); color: var(--text-light); cursor: pointer;
            transition: all 0.2s; font-weight: 500; margin-bottom: 2px;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-item.active { background: var(--color-primary-600); color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .nav-icon { width: 18px; height: 18px; opacity: 0.8; }

        /* Sync Footer */
        .sidebar-foot { padding: 1.5rem; background: rgba(0,0,0,0.25); border-top: 1px solid rgba(255,255,255,0.05); }
        .user-panel { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--color-warning); display: grid; place-items: center; color: white; font-weight: 700; }
        
        /* Main Workspace */
        .main-wrapper { flex: 1; display: flex; flex-direction: column; position: relative; background: var(--bg-body); }
        
        .header {
            height: var(--header-h); background: var(--bg-card);
            border-bottom: 1px solid #e2e8f0; padding: 0 2rem;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow-sm); z-index: 40;
        }
        
        .header-title h2 { font-size: 1.25rem; font-weight: 700; }
        .header-title span { font-size: 0.8rem; color: var(--text-muted); font-weight: 500; }

        .view-content { flex: 1; padding: 2rem; overflow-y: auto; }

        /* 2.4 COMPONENTS */
        /* Cards */
        .card { background: var(--bg-card); border-radius: var(--radius-md); border: 1px solid #e2e8f0; box-shadow: var(--shadow-sm); margin-bottom: 1.5rem; overflow: hidden; }
        .card-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .card-header h3 { font-size: 1rem; color: var(--text-main); font-weight: 700; }
        .card-body { padding: 1.5rem; }

        /* Grid System */
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }
        
        /* KPI Widget */
        .kpi-box { padding: 1.5rem; background: #fff; border-radius: 8px; border: 1px solid #e2e8f0; position: relative; }
        .kpi-box::after { content:''; position: absolute; left: 0; top: 15%; bottom: 15%; width: 4px; border-radius: 0 4px 4px 0; background: var(--color-primary-500); }
        .kpi-val { font-size: 2rem; font-weight: 800; color: var(--text-main); line-height: 1.2; margin-top: 5px; }
        .kpi-lbl { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 600; letter-spacing: 0.5px; }

        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: 0.2s; border: 1px solid transparent; gap: 8px; }
        .btn:active { transform: translateY(1px); }
        .btn-primary { background: var(--color-primary-600); color: white; }
        .btn-primary:hover { background: var(--color-primary-700); }
        .btn-secondary { background: white; border: 1px solid #cbd5e1; color: var(--text-main); }
        .btn-secondary:hover { background: #f8fafc; border-color: #94a3b8; }
        .btn-success { background: var(--color-success); color: white; }
        .btn-danger { background: white; border:1px solid var(--color-danger); color: var(--color-danger); }
        .btn-whatsapp { background: #25D366; color: white; } /* WhatsApp Brand Color */
        .w-full { width: 100%; }

        /* Tables */
        .table-responsive { width: 100%; overflow-x: auto; border-radius: 8px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { text-align: left; background: #f8fafc; color: var(--text-muted); padding: 12px 16px; font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid #e2e8f0; }
        td { padding: 14px 16px; border-bottom: 1px solid #f1f5f9; color: #334155; }
        tr:last-child td { border: none; }
        
        .badge { padding: 3px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-yellow { background: #fef9c3; color: #854d0e; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .badge-blue { background: #e0f2fe; color: #075985; }

        /* Form Inputs */
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem; }
        .form-control { width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95rem; }
        .form-control:focus { border-color: var(--color-primary-500); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2); }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(4px); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-box { background: white; width: 100%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; border-radius: 12px; box-shadow: var(--shadow-lg); animation: slideUp 0.3s; }
        .modal-lg { max-width: 900px; }
        @keyframes slideUp { from{transform:translateY(20px);opacity:0;} to{transform:translateY(0);opacity:1;} }
        
        .modal-head { padding: 20px 24px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 24px; overflow-y: auto; }
        .modal-foot { padding: 16px 24px; background: #f8fafc; border-top: 1px solid #f1f5f9; display: flex; justify-content: flex-end; gap: 10px; border-radius: 0 0 12px 12px; }

        /* Toasts */
        .toast-rack { position: fixed; bottom: 30px; right: 30px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast-msg { min-width: 300px; background: #1e293b; color: white; padding: 14px 20px; border-radius: 8px; border-left: 4px solid var(--color-primary-500); box-shadow: var(--shadow-lg); animation: fadeLeft 0.3s; display: flex; justify-content: space-between; }
        @keyframes fadeLeft { from{transform:translateX(50px); opacity:0;} to {transform:translateX(0); opacity:1;} }

        /* Mobile Adjustments */
        .mobile-menu-btn { display: none; background: none; border: none; font-size: 24px; color: var(--text-main); }
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -100%; height: 100%; width: 280px; box-shadow: 10px 0 20px rgba(0,0,0,0.5); }
            .sidebar.active { left: 0; }
            .grid-4, .grid-2, .form-row { grid-template-columns: 1fr; }
            .mobile-menu-btn { display: block; margin-right: 15px; }
            .view-content { padding: 1rem; }
        }
        
        /* 2.5 AUTH SCREEN STYLE */
        #auth-layer { position: fixed; inset: 0; z-index: 9000; background: var(--bg-sidebar); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .login-card { background: white; padding: 40px; border-radius: 16px; box-shadow: var(--shadow-lg); width: 90%; max-width: 400px; }
        .login-title { font-size: 1.5rem; font-weight: 800; color: var(--color-primary-900); margin-bottom: 10px; }
    </style>
</head>
<body>

    <!-- 
    ========================================================================================
    3. INITIAL AUTH GATE (LOGIN)
    Prevents access until secure authentication is established.
    ========================================================================================
    -->
    <div id="auth-layer">
        <div class="login-card">
            <div style="font-size:3rem; margin-bottom:15px;">üíß</div>
            <div class="login-title">Himalayan Beverages ERP</div>
            <p style="color:#64748b; margin-bottom:30px;">Freskey Secure Operation Access</p>
            
            <div id="loading-auth" style="display:none; margin:20px;">
                <div style="border:3px solid #f1f5f9; border-top-color:#0284c7; border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; margin:0 auto;"></div>
                <div style="font-size:0.8rem; margin-top:10px;">Connecting to Cloud DB...</div>
            </div>
            
            <!-- GOOGLE OAUTH 2.0 -->
            <div id="g_id_onload"
                 data-client_id="950010994560-v7p6cem78h9fsdp102iq4immb36t95ls.apps.googleusercontent.com"
                 data-callback="App.handleCredentialResponse"
                 data-auto_prompt="false">
            </div>
            <div class="g_id_signin" 
                 data-type="standard" 
                 data-size="large" 
                 data-theme="outline" 
                 data-text="sign_in_with" 
                 data-shape="rectangular" 
                 data-logo_alignment="left"
                 data-width="320">
            </div>

            <!-- OFFLINE FALLBACK -->
            <div style="margin-top:20px; padding-top:20px; border-top:1px solid #eee;">
                <button class="btn btn-secondary w-full" onclick="App.System.demoLogin()">Demo Mode (Skip Auth)</button>
            </div>
        </div>
        <style>@keyframes spin {to{transform: rotate(360deg)}}</style>
    </div>


    <!-- 
    ========================================================================================
    4. APPLICATION INTERFACE
    Hidden by default, revealed after Auth.
    ========================================================================================
    -->
    <div id="root-app" style="display:none;">
        
        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar-el">
            <div class="brand-section">
                <div class="brand-logo"><span class="logo-water"></span> FRESKEY<span style="font-weight:300;">OPS</span></div>
            </div>
            
            <nav class="nav-scroller">
                <div class="nav-category">Main Console</div>
                <div class="nav-item active" onclick="Nav.go('dashboard')">
                    <span>üìä</span> Dashboard
                </div>
                
                <div class="nav-category">Sales & Fulfillment</div>
                <div class="nav-item" onclick="Nav.go('crm')"><span>üë•</span> Customer CRM</div>
                <div class="nav-item" onclick="Nav.go('orders')"><span>üßæ</span> Orders & Invoices</div>
                <div class="nav-item" onclick="Nav.go('dispatch')"><span>üöö</span> Dispatch / Manifests</div>
                
                <div class="nav-category">Logistics</div>
                <div class="nav-item" onclick="Nav.go('inventory')"><span>üè≠</span> Stock / Warehouse</div>
                <div class="nav-item" onclick="Nav.go('purchase')"><span>üì•</span> Supplier Purchase</div>
                
                <div class="nav-category">Administration</div>
                <div class="nav-item" onclick="Nav.go('finance')"><span>üí∞</span> Ledger & Payments</div>
                <div class="nav-item" onclick="Nav.go('settings')"><span>‚öôÔ∏è</span> Sync Settings</div>
            </nav>

            <div class="sidebar-foot">
                <div class="user-panel">
                    <div class="user-avatar" id="ua-init">U</div>
                    <div>
                        <div style="font-size:0.85rem; font-weight:700; color:#fff;" id="ua-name">User</div>
                        <div style="font-size:0.7rem; color:var(--color-primary-500);">Administrator</div>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; color:#64748b; font-size:0.75rem;">
                    <span>Sync Status:</span>
                    <span id="sync-dot" style="width:8px; height:8px; border-radius:50%; background:#94a3b8;"></span>
                </div>
            </div>
        </aside>

        <!-- MAIN WRAPPER -->
        <main class="main-wrapper">
            <!-- Mobile Toggle Overlay -->
            <div onclick="Nav.toggleSide(false)" id="mob-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:45;"></div>

            <header class="header">
                <div style="display:flex; align-items:center; gap:15px;">
                    <button class="mobile-menu-btn" onclick="Nav.toggleSide(true)">‚ò∞</button>
                    <div class="header-title">
                        <h2 id="pg-title">Overview</h2>
                        <span id="pg-desc">Daily Operational Stats</span>
                    </div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button onclick="Modal.open('modal-quote')" class="btn btn-secondary">New Quote</button>
                    <button onclick="Modal.open('modal-order')" class="btn btn-primary">+ Create Order</button>
                </div>
            </header>

            <div class="view-content" id="viewport">
                <!-- CONTENT INJECTED VIA JS -->
            </div>
        </main>
    </div>

    <!-- TOAST CONTAINER -->
    <div class="toast-rack" id="toaster"></div>


    <!-- 
    ========================================================================================
    5. MODAL SYSTEM
    Dedicated Interfaces for specific tasks.
    ========================================================================================
    -->

    <!-- 5.1 SALES ORDER MODAL -->
    <div id="modal-order" class="modal-overlay">
        <div class="modal-box modal-lg">
            <div class="modal-head"><h3>New Sales Order</h3><button onclick="Modal.close('modal-order')" class="btn btn-sm btn-secondary">‚úï</button></div>
            <div class="modal-body">
                <div class="form-row">
                    <div>
                        <label class="form-label">Customer</label>
                        <select id="mo-cust" class="form-control" onchange="Ctrls.Order.onCustSelect()"></select>
                        <small id="mo-bal" style="color:var(--color-danger);"></small>
                    </div>
                    <div><label class="form-label">Date</label><input type="date" id="mo-date" class="form-control"></div>
                </div>
                <div class="card" style="background:#f8fafc; border:none;">
                    <div class="card-body">
                        <h4 style="margin-bottom:10px; color:#475569">Cart Items</h4>
                        <div class="table-responsive" style="background:white; border:1px solid #e2e8f0; max-height:200px;">
                            <table style="font-size:0.9rem;">
                                <thead><tr><th>Product (Pack Size)</th><th>Price/Unit</th><th>Stock</th><th style="width:80px">Qty</th><th class="text-right">Line Total</th></tr></thead>
                                <tbody id="mo-lines"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="text-right" style="font-size:1.5rem; font-weight:800; color:var(--color-primary-600); margin-top:15px;">
                    Total: <span id="mo-total">INR 0.00</span>
                </div>
            </div>
            <div class="modal-foot">
                <button onclick="Modal.close('modal-order')" class="btn btn-secondary">Cancel</button>
                <button onclick="Ctrls.Order.save()" class="btn btn-primary">Generate Invoice</button>
            </div>
        </div>
    </div>

    <!-- 5.2 CUSTOMER MODAL -->
    <div id="modal-cust" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-head"><h3>Add Customer</h3><button onclick="Modal.close('modal-cust')">‚úï</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Business Name</label><input id="mc-name" class="form-control"></div>
                <div class="form-row">
                    <div><label class="form-label">Type</label><select id="mc-type" class="form-control"><option>Distributor</option><option>Retailer</option><option>Event</option><option>HoReCa</option></select></div>
                    <div><label class="form-label">Phone</label><input id="mc-phone" class="form-control"></div>
                </div>
                <div class="form-group"><label class="form-label">GSTIN / Tax ID</label><input id="mc-gst" class="form-control"></div>
                <div class="form-group"><label class="form-label">Address</label><input id="mc-addr" class="form-control"></div>
            </div>
            <div class="modal-foot">
                <button onclick="Ctrls.CRM.add()" class="btn btn-primary">Save Profile</button>
            </div>
        </div>
    </div>

    <!-- 5.3 PURCHASE / STOCK IN MODAL -->
    <div id="modal-buy" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-head"><h3>Stock Purchase (Himalayan)</h3><button onclick="Modal.close('modal-buy')">‚úï</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Product</label><select id="mb-prod" class="form-control"></select></div>
                <div class="form-group"><label class="form-label">Location</label><select id="mb-loc" class="form-control"><option value="Main WH">Central Warehouse</option><option value="Van1">Route Van 1</option></select></div>
                <div class="form-row">
                    <div><label class="form-label">Qty (Cases)</label><input type="number" id="mb-qty" class="form-control"></div>
                    <div><label class="form-label">Cost/Case</label><input type="number" id="mb-cost" class="form-control"></div>
                </div>
            </div>
            <div class="modal-foot">
                <button onclick="Ctrls.Purchase.save()" class="btn btn-success">Record Stock</button>
            </div>
        </div>
    </div>

    <!-- 5.4 PAYMENT RECORD MODAL -->
    <div id="modal-pay" class="modal-overlay">
        <div class="modal-box" style="max-width:400px;">
            <div class="modal-head"><h3>Receive Payment</h3></div>
            <div class="modal-body">
                <input type="hidden" id="mp-id">
                <label class="form-label">Inv Reference</label><input id="mp-ref" class="form-control" disabled style="margin-bottom:10px;">
                <div class="form-row">
                    <div><label class="form-label">Total</label><input id="mp-tot" class="form-control" disabled></div>
                    <div><label class="form-label">Due</label><input id="mp-due" class="form-control" disabled style="color:red; font-weight:bold;"></div>
                </div>
                <label class="form-label">Amount Received</label><input type="number" id="mp-amt" class="form-control" style="border:2px solid green; font-size:1.2rem; font-weight:bold;">
                <label class="form-label" style="margin-top:10px">Method</label><select id="mp-mode" class="form-control"><option>UPI</option><option>Cash</option><option>Bank Transfer</option></select>
            </div>
            <div class="modal-foot">
                <button onclick="Ctrls.Finance.pay()" class="btn btn-success w-full">Save Transaction</button>
            </div>
        </div>
    </div>

    <!-- 
    ========================================================================================
    6. JAVASCRIPT CORE
    Complete Application Logic: Data, Logic, View, Network.
    ========================================================================================
    -->
    <script>
        
        /**
         * --------------------------------------------------------
         * 6.1 CONSTANTS & CONFIG
         * --------------------------------------------------------
         */
        const CFG = {
            API_KEY: 'AIzaSyCWo9OP6-QhyKWpfuV5oonyuC32IQHoOtE', 
            CLIENT_ID: '950010994560-v7p6cem78h9fsdp102iq4immb36t95ls.apps.googleusercontent.com',
            SCOPES: 'https://www.googleapis.com/auth/drive.file',
            FILE: 'himalayan_freskey_v5.json'
        };

        /**
         * --------------------------------------------------------
         * 6.2 DATA SEED (The "Database")
         * --------------------------------------------------------
         */
        let Store = {
            customers: [
                {id: 101, name: "Shiv Shakti Traders", type: "Distributor", phone:"9898989898", addr:"Sector 4, Market", balance: 0},
                {id: 102, name: "Grand Hotel", type: "Events", phone:"9797979797", addr:"Highway Road", balance: 5000}
            ],
            products: [
                {id: "SKU-200", name: "Freskey 200ml", unit:"Case (24)", price: 480, stock: 200, vanStock: 50},
                {id: "SKU-500", name: "Freskey 500ml", unit:"Case (24)", price: 600, stock: 150, vanStock: 20},
                {id: "SKU-1000", name: "Freskey 1L", unit:"Case (12)", price: 360, stock: 500, vanStock: 10}
            ],
            orders: [
                // Seed data to make the dashboard look good on first load
                {id: "ORD-998", date: "2025-10-01", custId: 102, total: 5000, paid: 0, status: "Delivered", dispatched:true}
            ],
            manifests: [],
            ledgers: [
                {id: 1, date:"2025-10-01", type: "Debit", desc: "Inv ORD-998 generated", amt: 5000}
            ]
        };
        let gToken = null;

        /**
         * --------------------------------------------------------
         * 6.3 UTILITY LIBRARY
         * --------------------------------------------------------
         */
        const Utils = {
            $: (id) => document.getElementById(id),
            // Currency without unicode for PDF safety
            fmt: (n) => "Rs. " + parseFloat(n).toLocaleString('en-IN', {minimumFractionDigits: 2}), 
            today: () => new Date().toISOString().split('T')[0],
            genId: (pre) => pre + "-" + Math.floor(Math.random()*100000),
            
            // Notification Engine
            notify: (msg, type='info') => {
                const el = document.createElement('div');
                el.className = 'toast-msg';
                el.style.borderLeftColor = type==='success'?'#16a34a':(type==='error'?'#dc2626':'#0ea5e9');
                el.innerHTML = `<strong>${type.toUpperCase()}</strong> <span>${msg}</span>`;
                Utils.$('toaster').appendChild(el);
                setTimeout(()=>el.remove(), 4000);
            },

            // WhatsApp Simulator (Prompt Requirement)
            whatsapp: (phone, text) => {
                const url = `https://wa.me/91${phone}?text=${encodeURIComponent(text)}`;
                window.open(url, '_blank');
            }
        };

        /**
         * --------------------------------------------------------
         * 6.4 CLOUD SYNC SERVICE
         * --------------------------------------------------------
         */
        const Cloud = {
            init: () => {
                gapi.load('client', async () => {
                    await gapi.client.init({apiKey: CFG.API_KEY, discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']});
                    const client = google.accounts.oauth2.initTokenClient({
                        client_id: CFG.CLIENT_ID, scope: CFG.SCOPES,
                        callback: (resp) => { 
                            if(resp.error) return; 
                            gToken = resp.access_token;
                            Cloud.syncDown();
                        }
                    });
                    // Only request if strictly needed (Prompt button in UI usually better)
                    if(App.isOnline) client.requestAccessToken({prompt:''}); 
                });
            },
            syncDown: async () => {
                Utils.$('sync-dot').style.background = 'orange';
                try {
                    const q = `name = '${CFG.FILE}' and trashed = false`;
                    const res = await gapi.client.drive.files.list({q});
                    if(res.result.files.length > 0) {
                        const fid = res.result.files[0].id;
                        const data = await gapi.client.drive.files.get({fileId: fid, alt: 'media'});
                        if(data.result) {
                            Store = data.result;
                            Utils.notify("Cloud Data Loaded", "success");
                        }
                    }
                    Utils.$('sync-dot').style.background = '#16a34a'; // Green
                    Nav.go('dashboard'); // Refresh View
                } catch(e) { console.error(e); }
            },
            syncUp: async () => {
                if(!gToken) return;
                Utils.$('sync-dot').style.background = 'orange';
                const body = JSON.stringify(Store);
                const blob = new Blob([body], {type:'application/json'});
                const form = new FormData();
                const meta = {name: CFG.FILE, mimeType: 'application/json'};
                form.append('metadata', new Blob([JSON.stringify(meta)], {type: 'application/json'}));
                form.append('file', blob);

                try {
                    const q = `name = '${CFG.FILE}' and trashed = false`;
                    const res = await gapi.client.drive.files.list({q});
                    // Logic: Delete old, Create New (Simple overwrite simulation)
                    // Real app would PATCH. For demo simplicity of logic flow:
                    await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: {'Authorization': 'Bearer '+gToken},
                        body: form
                    });
                    Utils.$('sync-dot').style.background = '#16a34a';
                } catch(e) {}
            }
        };

        /**
         * --------------------------------------------------------
         * 6.5 PDF SERVICE (Invoice Gen)
         * --------------------------------------------------------
         */
        const Docs = {
            invoice: (ord) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const cust = Store.customers.find(c=>c.id==ord.custId);

                doc.setFillColor(14, 165, 233); doc.rect(0,0,210,30,'F');
                doc.setTextColor(255); doc.setFontSize(22); doc.text("Freskey (Himalayan Beverages)", 14, 20);
                
                doc.setTextColor(0); doc.setFontSize(10);
                doc.text("INVOICE NO:", 150, 50); doc.text(ord.id, 180, 50);
                doc.text("Bill To:", 14, 50); doc.text(cust.name, 14, 55); doc.text(cust.addr, 14, 60);

                const body = ord.items.map(i=>[i.name, i.qty, i.price, i.tot]);
                doc.autoTable({ startY: 70, head: [['Item','Qty','Rate','Amount']], body: body });
                
                const fy = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(12); doc.text(`Total: ${Utils.fmt(ord.total)}`, 150, fy);
                
                // Add GST text
                doc.setFontSize(8); doc.text("* Price includes standard GST as applicable", 14, fy+10);
                
                doc.save(`${ord.id}.pdf`);
            }
        };

        /**
         * --------------------------------------------------------
         * 6.6 APP INIT & AUTH
         * --------------------------------------------------------
         */
        const App = {
            isOnline: false,
            handleCredentialResponse: (resp) => {
                // Decode Google JWT
                const pl = JSON.parse(atob(resp.credential.split('.')[1]));
                App.unlock(pl.email);
                App.isOnline = true;
                // Init Drive Logic
                Cloud.init(); 
            },
            System: {
                demoLogin: () => {
                    Utils.$('loading-auth').style.display='block';
                    setTimeout(() => {
                        App.unlock("demo_admin@freskey.com");
                    }, 1000);
                }
            },
            unlock: (email) => {
                Utils.$('auth-layer').style.display = 'none';
                Utils.$('root-app').style.display = 'flex';
                Utils.$('ua-name').innerText = email.split('@')[0];
                Nav.go('dashboard');
            }
        };

        /**
         * --------------------------------------------------------
         * 6.7 UI & NAVIGATION CONTROLLER
         * --------------------------------------------------------
         */
        const Nav = {
            toggleSide: (open) => {
                const s = Utils.$('sidebar-el');
                const m = Utils.$('mob-overlay');
                if(open) { s.style.left='0'; m.style.display='block'; }
                else { s.style.left='-100%'; m.style.display='none'; }
            },
            
            go: (view) => {
                const c = Utils.$('viewport');
                const title = Utils.$('pg-title');
                const desc = Utils.$('pg-desc');
                
                // Active State
                document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
                // Note: Real routing needs ID matching, simplistic approach here due to inline events
                
                Nav.toggleSide(false);

                if(view === 'dashboard') {
                    title.innerText = "Operations Dashboard";
                    desc.innerText = "Real-time Supply Chain Overview";
                    
                    const rev = Store.orders.reduce((a,b)=>a+b.total,0);
                    const due = Store.orders.reduce((a,b)=>a+(b.total - b.paid),0);
                    const pend = Store.orders.filter(o=>!o.dispatched).length;
                    
                    c.innerHTML = `
                        <div class="grid-4">
                            <div class="kpi-box">
                                <div class="kpi-lbl">Revenue</div>
                                <div class="kpi-val" style="color:#0f172a">${Utils.fmt(rev)}</div>
                            </div>
                            <div class="kpi-box">
                                <div class="kpi-lbl">Pending Dispatch</div>
                                <div class="kpi-val" style="color:var(--color-warning)">${pend} <span style="font-size:1rem">Orders</span></div>
                            </div>
                            <div class="kpi-box">
                                <div class="kpi-lbl">Outstanding Balance</div>
                                <div class="kpi-val" style="color:var(--color-danger)">${Utils.fmt(due)}</div>
                            </div>
                            <div class="kpi-box">
                                <div class="kpi-lbl">Total Stock</div>
                                <div class="kpi-val" style="color:var(--color-primary-500)">${Store.products.reduce((a,b)=>a+b.stock,0)} cs</div>
                            </div>
                        </div>
                        
                        <div class="grid-2">
                            <div class="card">
                                <div class="card-header"><h3>Active Orders (Last 5)</h3></div>
                                <div class="table-responsive">
                                    <table>
                                        <thead><tr><th>ID</th><th>Total</th><th>Status</th></tr></thead>
                                        <tbody>${Store.orders.slice(-5).reverse().map(o=>`<tr><td>${o.id}</td><td>${Utils.fmt(o.total)}</td><td><span class="badge badge-blue">${o.status}</span></td></tr>`).join('')}</tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header"><h3>Warehouse Levels</h3></div>
                                <div class="card-body">
                                    ${Store.products.map(p=>`
                                        <div style="margin-bottom:10px;">
                                            <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                                                <span style="font-weight:600;font-size:0.8rem">${p.name}</span>
                                                <span style="font-size:0.8rem">${p.stock} cs</span>
                                            </div>
                                            <div style="height:6px; background:#e2e8f0; border-radius:3px; overflow:hidden">
                                                <div style="width:${Math.min(p.stock,100)}%; background:${p.stock<50?'#ef4444':'#22c55e'}; height:100%;"></div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                else if (view === 'orders') {
                    title.innerText = "Sales & Invoices"; desc.innerText = "Manage Order Lifecycle";
                    c.innerHTML = `
                    <div class="card">
                        <div class="table-responsive">
                            <table>
                                <thead><tr><th>Order #</th><th>Date</th><th>Customer</th><th>Total</th><th>Status</th><th>Action</th></tr></thead>
                                <tbody>
                                    ${Store.orders.slice().reverse().map(o => {
                                        const cust = Store.customers.find(x=>x.id==o.custId);
                                        return `<tr>
                                            <td>${o.id}</td><td>${o.date}</td><td>${cust?cust.name:'-'}</td>
                                            <td style="font-weight:700">${Utils.fmt(o.total)}</td>
                                            <td><span class="badge ${o.status=='Delivered'?'badge-green':'badge-yellow'}">${o.status}</span></td>
                                            <td><button onclick="Ctrls.Order.pdf('${o.id}')" class="btn btn-primary" style="padding:2px 8px;font-size:0.7rem">PDF</button></td>
                                        </tr>`
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
                }
                
                else if (view === 'dispatch') {
                    title.innerText = "Dispatch Manifests"; desc.innerText = "Assign to Vehicles";
                    // Simulation of assigning orders to Route 1
                    const openOrd = Store.orders.filter(o=>!o.dispatched);
                    c.innerHTML = `
                        <div class="grid-2">
                            <div class="card">
                                <div class="card-header"><h3>Ready for Dispatch</h3></div>
                                <div class="table-responsive">
                                    <table>
                                        <thead><tr><th>Ord ID</th><th>Route/Area</th><th>Action</th></tr></thead>
                                        <tbody>
                                            ${openOrd.length===0?'<tr><td colspan="3" style="padding:20px;text-align:center">All Orders Dispatched</td></tr>' : 
                                              openOrd.map(o=>`<tr><td>${o.id}</td><td>Route 1</td><td><button class="btn btn-sm btn-primary" onclick="Ctrls.Dispatch.send('${o.id}')">Load Van</button></td></tr>`).join('')
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header"><h3>Vehicle: UK-07-TA-1122 (Van 1)</h3></div>
                                <div class="card-body">
                                    <div style="font-size:0.9rem; font-weight:700; color:#475569">Manifest ID: MAN-009</div>
                                    <div style="margin-top:10px; font-size:0.8rem">Driver: Raju Singh (+91 99000...)</div>
                                    <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                                        ${Store.manifests.length===0 ? '<i>Van Empty</i>' : Store.manifests.map(m=>`<div>‚Ä¢ Order ${m} loaded</div>`).join('')}
                                    </div>
                                    <button class="btn btn-success w-full" style="margin-top:15px;" onclick="Utils.whatsapp('9999999999','Manifest #MAN-009 Generated')">WhatsApp to Driver</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                else if (view === 'inventory') {
                    title.innerText = "Stock Management"; desc.innerText = "Warehouse & Van Inventory";
                    c.innerHTML = `
                    <div style="margin-bottom:15px;"><button class="btn btn-primary" onclick="Modal.open('modal-buy')">+ Stock Purchase</button></div>
                    <div class="card">
                        <div class="table-responsive">
                            <table>
                                <thead><tr><th>SKU</th><th>Product</th><th>Packing</th><th>Central WH</th><th>Route Van 1</th><th>Transfer</th></tr></thead>
                                <tbody>
                                    ${Store.products.map(p=>`<tr>
                                        <td>${p.id}</td><td><b>${p.name}</b></td><td>${p.unit}</td>
                                        <td style="color:${p.stock<50?'red':'green'}"><b>${p.stock}</b></td>
                                        <td>${p.vanStock}</td>
                                        <td><button class="btn btn-sm btn-secondary">Transfer >></button></td>
                                    </tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
                }
                
                else if (view === 'finance') {
                    title.innerText = "Financial Ledger"; desc.innerText = "Payments & Dues";
                    c.innerHTML = `
                        <div class="card">
                            <div class="card-header"><h3>Unpaid Invoices</h3></div>
                            <div class="table-responsive">
                                <table><thead><tr><th>Invoice</th><th>Due Amount</th><th>Action</th></tr></thead>
                                <tbody>
                                    ${Store.orders.filter(o=>o.total-o.paid > 0).map(o=>`<tr>
                                        <td>${o.id}</td><td style="color:#dc2626;font-weight:700">${Utils.fmt(o.total - o.paid)}</td>
                                        <td><button onclick="Ctrls.Finance.open('${o.id}')" class="btn btn-sm btn-success">Receive Pay</button></td>
                                    </tr>`).join('')}
                                </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3>Transaction Ledger</h3></div>
                            <div class="table-responsive">
                                <table><thead><tr><th>Date</th><th>Description</th><th>Debit/Credit</th><th>Amt</th></tr></thead>
                                <tbody>${Store.ledgers.map(l=>`<tr><td>${l.date}</td><td>${l.desc}</td><td>${l.type}</td><td>${Utils.fmt(l.amt)}</td></tr>`).join('')}</tbody></table>
                            </div>
                        </div>
                    `;
                }
            }
        };

        /**
         * --------------------------------------------------------
         * 6.8 MODAL & CONTROLLER LOGIC
         * --------------------------------------------------------
         */
        const Modal = {
            open: (id) => {
                Utils.$(id).style.display = 'flex';
                // Populate Data if needed
                if(id==='modal-order') {
                    Utils.$('mo-cust').innerHTML = '<option value="">Select...</option>' + Store.customers.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
                    Utils.$('mo-date').value = Utils.today();
                    
                    const rows = Store.products.map(p=>`
                        <tr class="item-row">
                            <td>${p.name} <span style="font-size:0.7rem">(${p.unit})</span></td>
                            <td>${p.price}</td>
                            <td style="color:${p.stock<20?'red':'inherit'}">${p.stock}</td>
                            <td><input type="number" min="0" class="form-control qty-inp" data-id="${p.id}" data-price="${p.price}" onchange="Ctrls.Order.calc()"></td>
                            <td class="text-right" id="st-${p.id}">0.00</td>
                        </tr>
                    `).join('');
                    Utils.$('mo-lines').innerHTML = rows;
                }
                else if (id==='modal-buy') {
                    Utils.$('mb-prod').innerHTML = Store.products.map(p=>`<option value="${p.id}">${p.name}</option>`);
                }
            },
            close: (id) => Utils.$(id).style.display='none'
        };

        const Ctrls = {
            Order: {
                calc: () => {
                    let total = 0;
                    document.querySelectorAll('.qty-inp').forEach(inp => {
                        const qty = parseInt(inp.value)||0;
                        const pr = parseFloat(inp.dataset.price);
                        const sub = qty * pr;
                        Utils.$(`st-${inp.dataset.id}`).innerText = sub.toFixed(2);
                        total += sub;
                    });
                    Utils.$('mo-total').innerText = Utils.fmt(total);
                },
                save: () => {
                    const cid = Utils.$('mo-cust').value;
                    const date = Utils.$('mo-date').value;
                    if(!cid) return alert("Select Customer");
                    
                    // Harvest Items
                    const items = [];
                    let grandTotal = 0;
                    
                    document.querySelectorAll('.qty-inp').forEach(inp => {
                        const qty = parseInt(inp.value)||0;
                        if(qty > 0) {
                            const pid = inp.dataset.id;
                            const prod = Store.products.find(p=>p.id==pid);
                            // Validations
                            if(prod.stock < qty) return alert("Stock insufficient for " + prod.name);
                            prod.stock -= qty; // Reserve Stock
                            const lineTotal = qty * prod.price;
                            items.push({name: prod.name, qty, price: prod.price, tot: lineTotal});
                            grandTotal += lineTotal;
                        }
                    });
                    
                    if(items.length===0) return;
                    
                    // Commit
                    const oid = "INV-" + Date.now();
                    const order = { id: oid, date: date, custId: cid, total: grandTotal, paid: 0, status: "Pending", items: items, dispatched:false };
                    Store.orders.push(order);
                    Store.ledgers.push({id: Utils.genId('TX'), date: Utils.today(), desc:`Invoice ${oid} Generated`, type:'Debit', amt: grandTotal});
                    
                    Utils.toast(`Order ${oid} created`);
                    Modal.close('modal-order');
                    Cloud.syncUp();
                    Nav.go('orders');
                    
                    // PDF Prompt
                    Docs.invoice(order);
                },
                pdf: (id) => Docs.invoice(Store.orders.find(x=>x.id==id))
            },
            Dispatch: {
                send: (id) => {
                    const ord = Store.orders.find(o=>o.id==id);
                    ord.dispatched = true;
                    Store.manifests.push(id);
                    Utils.toast(`${id} loaded onto Van 1`, 'success');
                    Cloud.syncUp();
                    Nav.go('dispatch');
                }
            },
            Purchase: {
                save: () => {
                    const pid = Utils.$('mb-prod').value;
                    const qty = parseInt(Utils.$('mb-qty').value);
                    const cost = parseInt(Utils.$('mb-cost').value);
                    if(!qty) return;
                    
                    const prod = Store.products.find(p=>p.id==pid);
                    prod.stock += qty; // Central WH Logic
                    Utils.toast(`${qty} Added to Inventory`);
                    Modal.close('modal-buy');
                    Nav.go('inventory');
                    Cloud.syncUp();
                }
            },
            Finance: {
                open: (id) => {
                    const o = Store.orders.find(x=>x.id==id);
                    Utils.$('mp-id').value = id;
                    Utils.$('mp-ref').value = `${id} (Date: ${o.date})`;
                    Utils.$('mp-tot').value = Utils.fmt(o.total);
                    Utils.$('mp-due').value = Utils.fmt(o.total - o.paid);
                    Utils.$('modal-pay').style.display='flex';
                },
                pay: () => {
                    const id = Utils.$('mp-id').value;
                    const amt = parseFloat(Utils.$('mp-amt').value);
                    if(!amt) return;
                    
                    const o = Store.orders.find(x=>x.id==id);
                    o.paid += amt;
                    if(o.paid >= o.total) o.status = "Paid"; // Close
                    
                    // Add Ledger
                    Store.ledgers.push({id:Utils.genId('P'), date:Utils.today(), type:"Credit", desc:`Payment received for ${id}`, amt: amt});
                    
                    Utils.toast("Transaction Recorded", "success");
                    Utils.$('modal-pay').style.display='none';
                    Nav.go('finance');
                    
                    // Simulate WhatsApp Receipt
                    const cust = Store.customers.find(c=>c.id==o.custId);
                    Utils.whatsapp(cust.phone, `Himalayan Beverages: Received Payment of INR ${amt} against Invoice ${id}. Balance: INR ${o.total-o.paid}`);
                    Cloud.syncUp();
                }
            }
        };

        // Bootstrap on Load
        // Cloud.init() is triggered after Google Sign-In automatically.
        
    </script>
</body>
</html>
