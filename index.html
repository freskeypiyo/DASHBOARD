<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Himalayan Beverages | Freskey Enterprise Operations</title>
    
    <!-- 
      =============================================================================
      EXTERNAL DEPENDENCIES 
      1. Google Identity Services (GSI) - Authentication
      2. Google API Client (GAPI) - Drive REST Interaction
      3. JSPDF - Professional PDF Generator
      4. JSPDF AutoTable - Advanced PDF Tables
      =============================================================================
    -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <!-- 
      =============================================================================
      PART 1: THE CSS FRAMEWORK (STYLES)
      A complete custom design system to ensure responsive, high-DPI rendering.
      =============================================================================
    -->
    <style>
        /* ------------------------------------------------------------
           1.1 VARIABLES & RESET
           ------------------------------------------------------------ */
        :root {
            /* Branding Palette - Himalayan Deep Blue & Fresh Ice */
            --color-brand-50:  #f0f9ff;
            --color-brand-100: #e0f2fe;
            --color-brand-500: #0ea5e9;
            --color-brand-600: #0284c7;
            --color-brand-800: #075985;
            --color-brand-900: #0c4a6e;

            /* Functional Status Colors */
            --color-success-bg: #dcfce7;
            --color-success-fg: #15803d;
            --color-warning-bg: #fef9c3;
            --color-warning-fg: #a16207;
            --color-danger-bg:  #fee2e2;
            --color-danger-fg:  #b91c1c;

            /* Surface Colors */
            --color-bg-app:    #f8fafc;
            --color-bg-card:   #ffffff;
            --color-bg-sidebar:#0f172a;
            
            /* Text Colors */
            --color-text-main:  #1e293b;
            --color-text-muted: #64748b;
            --color-text-light: #94a3b8;
            --color-text-inv:   #ffffff;

            /* Borders & Shadows */
            --border-light: 1px solid #e2e8f0;
            --border-dark:  1px solid rgba(255,255,255,0.1);
            --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);

            /* Metrics */
            --sidebar-width: 280px;
            --header-height: 64px;
            --border-radius: 8px;
        }

        /* Standard Reset */
        *, *::before, *::after {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--color-bg-app);
            color: var(--color-text-main);
            font-size: 14px;
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* We handle scrolling in specific regions */
        }

        button, input, select, textarea {
            font-family: inherit;
        }

        /* ------------------------------------------------------------
           1.2 UTILITY CLASSES (Grid, Flex, Text)
           ------------------------------------------------------------ */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }

        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-base { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        
        .text-brand { color: var(--color-brand-600); }
        .text-muted { color: var(--color-text-muted); }
        .text-danger { color: var(--color-danger-fg); }
        .text-success { color: var(--color-success-fg); }

        .mt-2 { margin-top: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .p-4 { padding: 1rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }

        .hidden { display: none !important; }

        /* ------------------------------------------------------------
           1.3 COMPONENT: BUTTONS
           ------------------------------------------------------------ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            user-select: none;
            white-space: nowrap;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background-color: var(--color-brand-800);
            color: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .btn-primary:hover {
            background-color: var(--color-brand-900);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .btn-secondary {
            background-color: #fff;
            color: var(--color-text-main);
            border-color: #cbd5e1;
        }
        .btn-secondary:hover {
            background-color: #f1f5f9;
            border-color: #94a3b8;
        }

        .btn-danger {
            background-color: var(--color-danger-bg);
            color: var(--color-danger-fg);
            border-color: transparent;
        }
        .btn-danger:hover {
            background-color: #fee2e2;
            border-color: #fecaca;
        }
        
        .btn-icon {
            padding: 0.5rem;
        }

        /* ------------------------------------------------------------
           1.4 COMPONENT: CARDS & STATS
           ------------------------------------------------------------ */
        .card {
            background: var(--color-bg-card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            border: var(--border-light);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            padding: 1.25rem;
            border-bottom: var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text-main);
        }

        .card-body {
            padding: 1.25rem;
            flex: 1;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--color-bg-card);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            border: var(--border-light);
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .metric-card::after {
            content: '';
            position: absolute;
            left: 0; top: 10%; bottom: 10%;
            width: 4px;
            background: var(--color-brand-500);
            border-radius: 0 4px 4px 0;
        }

        .metric-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--color-text-muted);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--color-text-main);
        }

        /* ------------------------------------------------------------
           1.5 COMPONENT: TABLES
           ------------------------------------------------------------ */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            border-radius: var(--border-radius);
            border: var(--border-light);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        th {
            background-color: #f8fafc;
            color: var(--color-text-muted);
            font-weight: 600;
            text-align: left;
            padding: 0.75rem 1.25rem;
            border-bottom: var(--border-light);
            text-transform: uppercase;
            font-size: 0.75rem;
        }

        td {
            padding: 1rem 1.25rem;
            border-bottom: var(--border-light);
            color: var(--color-text-main);
        }

        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: #f8fafc; }

        /* Status Badges in Table */
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .badge-paid { background: var(--color-success-bg); color: var(--color-success-fg); }
        .badge-unpaid { background: var(--color-danger-bg); color: var(--color-danger-fg); }
        .badge-partial { background: var(--color-warning-bg); color: var(--color-warning-fg); }

        /* ------------------------------------------------------------
           1.6 COMPONENT: FORMS & INPUTS
           ------------------------------------------------------------ */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text-main);
        }

        .form-input, .form-select {
            display: block;
            width: 100%;
            padding: 0.625rem 0.875rem;
            font-size: 0.875rem;
            line-height: 1.5;
            color: var(--color-text-main);
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
        }

        .form-input:focus, .form-select:focus {
            border-color: var(--color-brand-500);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
            outline: 0;
        }
        
        .input-error {
            border-color: var(--color-danger-fg);
        }
        
        .help-text {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            margin-top: 0.25rem;
        }

        /* ------------------------------------------------------------
           1.7 LAYOUT: SIDEBAR & MAIN AREA
           ------------------------------------------------------------ */
        #app-shell {
            display: flex;
            height: 100%;
            position: relative;
        }

        /* Sidebar Styling */
        #sidebar {
            width: var(--sidebar-width);
            background-color: var(--color-bg-sidebar);
            display: flex;
            flex-direction: column;
            border-right: var(--border-dark);
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .logo-area {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            border-bottom: var(--border-dark);
            background-color: rgba(0,0,0,0.15);
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--color-text-inv);
        }

        .logo-icon {
            width: 32px; height: 32px;
            background: linear-gradient(135deg, var(--color-brand-500), var(--color-brand-800));
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            margin-right: 0.75rem;
            box-shadow: 0 0 10px rgba(14,165,233,0.3);
        }

        .nav-links {
            flex: 1;
            padding: 1.5rem 0.75rem;
            overflow-y: auto;
        }

        .nav-group-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #64748b;
            margin-bottom: 0.5rem;
            padding-left: 0.75rem;
            font-weight: 700;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            color: #94a3b8;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 0.25rem;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background-color: rgba(255,255,255,0.05);
            color: #fff;
        }

        .nav-item.active {
            background-color: var(--color-brand-600);
            color: #fff;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2);
        }

        /* Sidebar Sync Widget */
        .sync-footer {
            padding: 1rem;
            background-color: rgba(0,0,0,0.2);
            border-top: var(--border-dark);
        }

        /* Main Content Styling */
        #main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--color-bg-app);
        }

        .header {
            height: var(--header-height);
            background-color: var(--color-bg-card);
            border-bottom: var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            z-index: 50;
        }

        .page-content-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            scroll-behavior: smooth;
        }
        
        .hamburger-btn {
            display: none; /* Desktop hidden */
            font-size: 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-text-main);
        }

        .overlay-mask {
            display: none;
            position: fixed; inset: 0; 
            background: rgba(0,0,0,0.5); 
            z-index: 90;
            backdrop-filter: blur(2px);
        }

        /* ------------------------------------------------------------
           1.8 LAYOUT: RESPONSIVE / MOBILE 
           ------------------------------------------------------------ */
        @media (max-width: 1024px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            /* Transform Sidebar into Drawer */
            #sidebar {
                position: fixed;
                left: -100%;
                top: 0; bottom: 0;
                width: 280px;
                box-shadow: 10px 0 20px rgba(0,0,0,0.15);
            }
            #sidebar.open {
                left: 0;
                transform: translateX(0);
            }
            
            .overlay-mask.active {
                display: block;
            }

            .hamburger-btn {
                display: block;
                margin-right: 1rem;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .page-content-scroll {
                padding: 1rem;
            }

            .table-responsive table {
                min-width: 600px; /* Force scroll on small screens */
            }
        }

        /* ------------------------------------------------------------
           1.9 COMPONENT: MODALS
           ------------------------------------------------------------ */
        .modal-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(15, 23, 42, 0.65);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-container.visible {
            opacity: 1;
            pointer-events: all;
        }

        .modal-panel {
            background-color: #fff;
            width: 100%;
            max-width: 700px; /* Wide default */
            max-height: 90vh;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            transform: translateY(20px);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .modal-sm { max-width: 450px; }

        .modal-container.visible .modal-panel {
            transform: translateY(0);
        }

        .modal-head {
            padding: 1.5rem;
            border-bottom: var(--border-light);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title { font-size: 1.25rem; font-weight: 700; color: var(--color-text-main); margin: 0; }
        .modal-close { font-size: 1.5rem; color: #94a3b8; cursor: pointer; transition: 0.2s; border:none; background:transparent;}
        .modal-close:hover { color: #475569; }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: 60vh;
        }
        
        .modal-foot {
            padding: 1rem 1.5rem;
            border-top: var(--border-light);
            background-color: #f8fafc;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            border-radius: 0 0 12px 12px;
        }

        /* ------------------------------------------------------------
           1.10 COMPONENT: TOAST NOTIFICATIONS
           ------------------------------------------------------------ */
        #toast-zone {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 2000;
        }

        .toast-msg {
            background-color: var(--color-brand-900);
            color: #fff;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            min-width: 300px;
            border-left: 4px solid var(--color-brand-500);
            animation: slideLeft 0.3s ease-out forwards;
            font-size: 0.9rem;
        }
        
        @keyframes slideLeft {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }

    </style>
</head>

<body>

    <!-- MOBILE OVERLAY BACKDROP -->
    <div id="sidebar-overlay" class="overlay-mask" onclick="UI.Nav.toggleSidebar(false)"></div>

    <div id="app-shell">
        
        <!-- SIDEBAR NAV -->
        <aside id="sidebar">
            <div class="logo-area">
                <div class="logo-icon">H</div>
                <span>HimalayanERP <span style="font-weight:400; opacity:0.7">v2.0</span></span>
            </div>

            <nav class="nav-links">
                
                <div class="nav-group-label">OPERATIONS</div>
                <div class="nav-item active" onclick="Router.nav('dashboard')">
                    <!-- Icon Dashboard -->
                    <svg style="width:20px;margin-right:10px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    Dashboard
                </div>
                
                <div class="nav-item" onclick="Router.nav('orders')">
                    <svg style="width:20px;margin-right:10px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Sales Invoicing
                </div>

                <div class="nav-item" onclick="Router.nav('inventory')">
                    <svg style="width:20px;margin-right:10px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                    Stock Manager
                </div>
                
                <div class="nav-group-label">COMMERCIAL</div>
                <div class="nav-item" onclick="Router.nav('finance')">
                    <svg style="width:20px;margin-right:10px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Payments & Ledger
                </div>

                <div class="nav-item" onclick="Router.nav('crm')">
                    <svg style="width:20px;margin-right:10px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    Customer Database
                </div>
                
                <div class="nav-group-label">SYSTEM</div>
                 <div class="nav-item" onclick="Router.nav('settings')">
                    <svg style="width:20px;margin-right:10px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Settings
                </div>
            </nav>
            
            <div class="sync-footer">
                <div style="font-size:0.75rem; color:#64748b; margin-bottom:5px; font-weight:700">GOOGLE DRIVE</div>
                <div class="flex items-center gap-2 mb-4">
                    <span id="sync-dot" style="width:10px; height:10px; border-radius:50%; background:#94a3b8"></span>
                    <span id="sync-text" style="font-size:0.8rem; color:#f1f5f9;">Disconnected</span>
                </div>
                <button id="btn-sync-action" onclick="Services.Drive.connect()" class="btn btn-primary w-full text-xs">Initialize Connection</button>
            </div>
        </aside>

        <!-- CONTENT AREA -->
        <main id="main-wrapper">
            <header class="header">
                <div class="flex items-center">
                    <button class="hamburger-btn" onclick="UI.Nav.toggleSidebar(true)">
                        &#9776;
                    </button>
                    <div>
                        <div class="text-xs text-brand font-bold tracking-widest uppercase">Overview</div>
                        <h2 class="text-lg font-bold text-gray-800" id="header-title">Executive Dashboard</h2>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="hidden sm:block text-right">
                        <div class="text-xs text-muted">Freskey Admin</div>
                        <div class="text-xs font-bold text-brand">freskeypiyo@gmail.com</div>
                    </div>
                    <div style="width:36px; height:36px; background:#e0f2fe; color:#0369a1; border-radius:50%; display:grid; place-items:center; font-weight:700; border:1px solid #bae6fd;">
                        A
                    </div>
                </div>
            </header>

            <div class="page-content-scroll" id="viewport">
                <!-- VIEW COMPONENT MOUNT POINT -->
            </div>
        </main>
    </div>

    <!-- 
      =============================================================================
      PART 2: MODAL DEFINITIONS
      =============================================================================
    -->
    
    <!-- 2.1 CREATE ORDER MODAL -->
    <div id="modal-order" class="modal-container">
        <div class="modal-panel">
            <div class="modal-head">
                <h3 class="modal-title">New Invoice Creation</h3>
                <button class="modal-close" onclick="UI.Modals.Order.close()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div>
                        <label class="form-label">Select Customer</label>
                        <select id="mo-customer" class="form-select" onchange="UI.Modals.Order.onCustomerSelect()">
                            <!-- filled by js -->
                        </select>
                        <div id="mo-cust-info" class="text-xs text-muted mt-2">Balance Info Loading...</div>
                    </div>
                    <div>
                        <label class="form-label">Invoice Date</label>
                        <input type="date" id="mo-date" class="form-input">
                    </div>
                </div>

                <div class="card mt-2" style="background-color:var(--color-bg-app); border:none;">
                    <div class="p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-bold text-sm text-brand">PRODUCT LINE ITEMS</h4>
                            <span class="text-xs text-muted">Adjust Qty (0 to skip)</span>
                        </div>
                        
                        <div class="table-responsive" style="max-height: 250px; background:white; border:1px solid #e2e8f0;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Rate (INR)</th>
                                        <th>Stock</th>
                                        <th style="width:80px">Qty</th>
                                        <th style="text-align:right">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody id="mo-table-body">
                                    <!-- Rows injected -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end mt-4 items-center gap-4">
                    <div class="text-right">
                        <div class="text-xs text-muted uppercase">Grand Total</div>
                        <div class="text-xl font-bold text-brand" id="mo-total">INR 0.00</div>
                    </div>
                </div>
            </div>
            <div class="modal-foot">
                <button class="btn btn-secondary" onclick="UI.Modals.Order.close()">Cancel</button>
                <button class="btn btn-primary" onclick="Controllers.Sales.submitOrder()">Generate PDF & Save</button>
            </div>
        </div>
    </div>

    <!-- 2.2 RECORD PAYMENT MODAL -->
    <div id="modal-pay" class="modal-container">
        <div class="modal-panel modal-sm">
            <div class="modal-head">
                <h3 class="modal-title">Receive Payment</h3>
                <button class="modal-close" onclick="UI.Modals.Pay.close()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="mp-invid">
                <div class="form-group">
                    <label class="form-label">Invoice Reference</label>
                    <input class="form-input" id="mp-ref-disp" disabled>
                </div>
                
                <div class="flex gap-4 mb-4">
                     <div class="w-full">
                         <label class="form-label">Total Amount</label>
                         <input class="form-input" id="mp-tot-disp" disabled>
                     </div>
                     <div class="w-full">
                         <label class="form-label">Balance Due</label>
                         <input class="form-input" id="mp-due-disp" disabled style="color:var(--color-danger-fg); font-weight:700">
                     </div>
                </div>

                <div class="form-group p-4 bg-brand-50 rounded" style="background:#eff6ff; border:1px solid #dbeafe; border-radius:6px;">
                    <label class="form-label text-brand">Amount Received (INR)</label>
                    <input type="number" id="mp-amt" class="form-input" style="font-size:1.2rem; font-weight:bold;">
                </div>

                <div class="form-group">
                    <label class="form-label">Payment Mode</label>
                    <select id="mp-mode" class="form-select">
                        <option value="Cash">Cash Payment</option>
                        <option value="Bank">Bank Transfer / NEFT</option>
                        <option value="UPI">UPI / GPay / PhonePe</option>
                        <option value="Cheque">Cheque</option>
                    </select>
                </div>
            </div>
            <div class="modal-foot">
                <button class="btn btn-secondary" onclick="UI.Modals.Pay.close()">Close</button>
                <button class="btn btn-primary" style="background:var(--color-success-fg)" onclick="Controllers.Finance.processPayment()">Record Transaction</button>
            </div>
        </div>
    </div>

    <!-- 2.3 ADD STOCK MODAL -->
    <div id="modal-stock" class="modal-container">
        <div class="modal-panel modal-sm">
            <div class="modal-head">
                <h3 class="modal-title">Inventory Purchase</h3>
                <button class="modal-close" onclick="UI.Modals.Stock.close()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Product</label>
                    <select id="ms-prod" class="form-select"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Quantity Purchased (Cases)</label>
                    <input type="number" id="ms-qty" class="form-input" placeholder="e.g., 50">
                </div>
                <div class="form-group">
                    <label class="form-label">Reference / PO Number</label>
                    <input type="text" id="ms-ref" class="form-input" placeholder="PO-2023-X">
                </div>
            </div>
            <div class="modal-foot">
                <button class="btn btn-secondary" onclick="UI.Modals.Stock.close()">Cancel</button>
                <button class="btn btn-primary" onclick="Controllers.Inventory.addStock()">Confirm Purchase</button>
            </div>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-zone"></div>

    <!-- 
      =============================================================================
      PART 3: DATA KERNEL & REPOSITORIES (JAVASCRIPT)
      Strict data typing and seed logic.
      =============================================================================
    -->
    <script>
        
        // --- 3.1 APP CONFIGURATION ---
        const Config = {
            API_KEY: 'AIzaSyCWo9OP6-QhyKWpfuV5oonyuC32IQHoOtE',
            CLIENT_ID: '950010994560-v7p6cem78h9fsdp102iq4immb36t95ls.apps.googleusercontent.com',
            SCOPES: 'https://www.googleapis.com/auth/drive.file',
            DB_FILE: 'himalayan_full_erp.json'
        };

        // --- 3.2 DATA REPOSITORIES (MOCK DB) ---
        // Seeding extended data for 1600 lines equivalent logic demo
        
        const State = {
            customers: [
                { id: 101, name: "Big Bazaar Retail", loc: "Delhi NCR", type: "Retailer", phone:"9876543210" },
                { id: 102, name: "Hotel Le Meridien", loc: "Gurgaon", type: "HoReCa", phone:"9988776655" },
                { id: 103, name: "Wedding Bells Event", loc: "Noida", type: "Event", phone:"8877665544" },
                { id: 104, name: "Easy Day Store", loc: "Dehradun", type: "Retailer", phone:"7766554433" },
                { id: 105, name: "Highway King Dhaba", loc: "Jaipur Highway", type: "HoReCa", phone:"6655443322" }
            ],
            products: [
                { id: "P001", name: "Freskey Lemon (200ml)", category: "Glass", packing: "24 x 200ml", price: 480, stock: 150 },
                { id: "P002", name: "Freskey Mango (200ml)", category: "Glass", packing: "24 x 200ml", price: 500, stock: 80 },
                { id: "P003", name: "Freskey Jeera (200ml)", category: "Glass", packing: "24 x 200ml", price: 480, stock: 45 },
                { id: "P004", name: "Soda Fizz (300ml)", category: "Soda", packing: "24 x 300ml", price: 600, stock: 220 },
                { id: "P005", name: "Litchi Juice (500ml)", category: "PET", packing: "12 x 500ml", price: 360, stock: 35 },
                { id: "P006", name: "Mineral Water 1L", category: "Water", packing: "12 x 1L", price: 240, stock: 500 }
            ],
            invoices: [
                { id: "INV-2023-1001", date: "2023-11-01", custId: 102, total: 15000, paid: 5000, status: "Partial", items: 2 },
                { id: "INV-2023-1002", date: "2023-11-05", custId: 105, total: 2400, paid: 2400, status: "Paid", items: 1 },
                { id: "INV-2023-1003", date: "2023-11-08", custId: 103, total: 45000, paid: 0, status: "Unpaid", items: 4 }
            ],
            ledger: [
                { id: "T1", date: "2023-11-01", desc: "Inv INV-2023-1001 generated", type: "Debit", amount: 15000 },
                { id: "T2", date: "2023-11-02", desc: "Partial Pay received (Hotel Le Meridien)", type: "Credit", amount: 5000 }
            ]
        };

        // --- 3.3 UTILITIES CLASS ---
        class Utils {
            static formatMoney(num) {
                // PDF-Safe currency formatting (No unicode glyphs)
                return "INR " + parseFloat(num).toLocaleString('en-IN', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }

            static today() {
                return new Date().toISOString().split('T')[0];
            }
            
            static generateId() {
                return Math.random().toString(36).substr(2, 9).toUpperCase();
            }

            static notify(msg) {
                const zone = document.getElementById('toast-zone');
                const div = document.createElement('div');
                div.className = 'toast-msg';
                div.textContent = msg;
                zone.appendChild(div);
                setTimeout(() => div.remove(), 4000);
            }
        }


        // --- 3.4 PDF GENERATOR SERVICE ---
        // Special logic to handle professional layout without breaking font encodings.
        class PDFEngine {
            static createInvoice(invoiceId, customerObj, lineItems, total, date) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Color Definitions
                const brandPrimary = [7, 89, 133]; // Brand Blue
                const brandLight   = [241, 245, 249]; // Slate 100

                // HEADER SECTION
                doc.setFillColor(...brandPrimary);
                doc.rect(0, 0, 210, 40, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(22);
                doc.setFont("helvetica", "bold");
                doc.text("HIMALAYAN BEVERAGES", 15, 20);
                
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text("Quality Refreshments & Distribution", 15, 26);
                
                // Invoice Label
                doc.setFontSize(30);
                doc.text("INVOICE", 195, 28, {align: 'right'});

                // INFO SECTION
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                
                // Company Details (Left)
                let y = 50;
                doc.setFont("helvetica", "bold");
                doc.text("FROM:", 15, y);
                doc.setFont("helvetica", "normal"); y += 5;
                doc.text("Himalayan Beverages Ltd.", 15, y); y += 5;
                doc.text("Ind. Area, Dehradun - 248001", 15, y); y += 5;
                doc.text("GSTIN: 05AABCU9999K1Z5", 15, y); y += 5;
                doc.text("Phone: +91-9876543210", 15, y);

                // Client Details (Right)
                y = 50;
                doc.setFont("helvetica", "bold");
                doc.text("BILL TO:", 140, y);
                doc.setFont("helvetica", "normal"); y += 5;
                doc.text(customerObj.name, 140, y); y += 5;
                doc.text(customerObj.loc, 140, y); y += 5;
                doc.text("Cust Type: " + customerObj.type, 140, y); y += 5;
                doc.text("Ref ID: C-" + customerObj.id, 140, y);

                // Meta Box
                doc.setFillColor(...brandLight);
                doc.rect(140, 75, 55, 15, 'F');
                doc.setFont("helvetica", "bold");
                doc.text(`Invoice #: ${invoiceId}`, 145, 81);
                doc.text(`Date: ${date}`, 145, 86);

                // ITEMS TABLE using autoTable plugin
                // Note: Using standard INR text to prevent PDF glitch
                const tableData = lineItems.map((item, index) => [
                    index + 1, 
                    item.name, 
                    item.packing,
                    item.qty, 
                    item.rateFormatted.replace('INR', '').trim(), 
                    item.totalFormatted
                ]);

                doc.autoTable({
                    startY: 100,
                    head: [['#', 'Item Description', 'Packing', 'Qty (Cs)', 'Rate', 'Total']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: brandPrimary,
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    styles: { 
                        fontSize: 9, 
                        cellPadding: 4 
                    },
                    columnStyles: {
                        0: {cellWidth: 10},
                        3: {halign: 'center'},
                        4: {halign: 'right'},
                        5: {halign: 'right', fontStyle: 'bold'}
                    }
                });

                let finalY = doc.lastAutoTable.finalY + 10;
                
                // TOTALS
                doc.setFont("helvetica", "bold");
                doc.setFontSize(12);
                doc.text(`Grand Total: ${Utils.formatMoney(total)}`, 195, finalY, { align: 'right'});
                
                doc.setDrawColor(200);
                doc.line(140, finalY+2, 195, finalY+2);
                
                // FOOTER
                finalY += 30;
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.text("Bank Details:", 15, finalY);
                doc.setFontSize(9);
                doc.text("HDFC Bank | A/c: 502000334455 | IFSC: HDFC000123", 15, finalY + 5);
                
                doc.setFontSize(8);
                doc.setTextColor(100);
                doc.text("Terms & Conditions: Interest @ 18% on overdue payments. Goods once sold not returnable.", 105, 280, {align:'center'});

                doc.save(`${invoiceId}.pdf`);
                Utils.notify("PDF Downloaded successfully");
            }
        }


        // --- 3.5 CONTROLLERS & VIEW LOGIC ---

        class InventoryController {
            static getStock(skuId) {
                return State.products.find(p => p.id === skuId)?.stock || 0;
            }
            
            static addStock() {
                const prodId = document.getElementById('ms-prod').value;
                const qty = parseInt(document.getElementById('ms-qty').value);
                const ref = document.getElementById('ms-ref').value;

                if (!qty || qty <= 0) return alert("Please enter valid quantity");

                const product = State.products.find(p => p.id === prodId);
                if (product) {
                    product.stock += qty;
                    State.ledger.push({
                        id: Utils.generateId(),
                        date: Utils.today(),
                        desc: `Stock In (${product.name}) Ref: ${ref}`,
                        type: 'Stock',
                        amount: 0 // Financial amount could be added here in full ERP
                    });
                    
                    Utils.notify(`${qty} cases added to ${product.name}`);
                    UI.Modals.Stock.close();
                    Router.nav('inventory');
                    Services.Drive.backup();
                }
            }
        }

        class SalesController {
            static calcLiveTotal() {
                let total = 0;
                document.querySelectorAll('.order-row-qty').forEach(input => {
                    const qty = parseInt(input.value) || 0;
                    const rate = parseFloat(input.dataset.rate);
                    const subtotalEl = document.getElementById(`sub-${input.dataset.id}`);
                    const sub = qty * rate;
                    subtotalEl.innerText = Utils.formatMoney(sub);
                    total += sub;
                });
                document.getElementById('mo-total').innerText = Utils.formatMoney(total);
            }

            static submitOrder() {
                const custId = document.getElementById('mo-customer').value;
                if (!custId) return alert("Select a Customer");

                const itemsToOrder = [];
                let grandTotal = 0;

                // Harvest table data
                document.querySelectorAll('.order-row-qty').forEach(input => {
                    const qty = parseInt(input.value) || 0;
                    if (qty > 0) {
                        const pid = input.dataset.id;
                        const product = State.products.find(p => p.id === pid);
                        const rate = parseFloat(input.dataset.rate);
                        itemsToOrder.push({
                            id: pid,
                            name: product.name,
                            packing: product.packing,
                            qty: qty,
                            rateFormatted: Utils.formatMoney(rate),
                            totalFormatted: Utils.formatMoney(qty * rate)
                        });
                        
                        grandTotal += (qty * rate);
                        
                        // Decrease Stock
                        product.stock -= qty; 
                    }
                });

                if (itemsToOrder.length === 0) return alert("Please add at least 1 item");

                // Check Stock Constraints (Simplified)
                const insufficient = itemsToOrder.find(item => {
                     const p = State.products.find(p=>p.id === item.id);
                     return p.stock < 0; 
                });
                
                if(insufficient) return alert(`Stock not sufficient for ${insufficient.name}. Order cancelled.`);

                // Create Objects
                const invId = "INV-" + Date.now();
                const date = document.getElementById('mo-date').value || Utils.today();
                
                State.invoices.unshift({
                    id: invId,
                    date: date,
                    custId: parseInt(custId),
                    total: grandTotal,
                    paid: 0,
                    status: 'Unpaid',
                    items: itemsToOrder.length
                });

                // Update Ledger
                State.ledger.unshift({
                    id: Utils.generateId(),
                    date: date,
                    desc: `Sales Invoice ${invId} Generated`,
                    type: 'Debit',
                    amount: grandTotal
                });

                Utils.notify("Order Created & Stock Updated");
                UI.Modals.Order.close();
                Router.nav('orders'); // Refresh View
                
                // Trigger PDF
                const customer = State.customers.find(c => c.id == custId);
                PDFEngine.createInvoice(invId, customer, itemsToOrder, grandTotal, date);
                
                Services.Drive.backup();
            }
        }
        
        class FinanceController {
            static processPayment() {
                const invId = document.getElementById('mp-invid').value;
                const amt = parseFloat(document.getElementById('mp-amt').value);
                const mode = document.getElementById('mp-mode').value;
                
                if (!amt || amt <= 0) return alert("Invalid Amount");
                
                const invoice = State.invoices.find(i => i.id === invId);
                const due = invoice.total - invoice.paid;
                
                if (amt > due) return alert("Amount exceeds balance due!");
                
                invoice.paid += amt;
                invoice.status = (invoice.paid >= invoice.total) ? 'Paid' : 'Partial';
                
                State.ledger.unshift({
                    id: Utils.generateId(),
                    date: Utils.today(),
                    desc: `Payment Recd (${mode}) for ${invId}`,
                    type: 'Credit',
                    amount: amt
                });

                Utils.notify("Payment Recorded Successfully");
                UI.Modals.Pay.close();
                Router.nav('finance');
                Services.Drive.backup();
            }
        }

        // --- 3.6 CLOUD SYNC SERVICES (GAPI) ---

        const Services = {
            Drive: {
                tokenClient: null,
                init: () => {
                    try {
                        gapi.load('client', async () => {
                            await gapi.client.init({
                                apiKey: Config.API_KEY,
                                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                            });
                        });
                        Services.Drive.tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: Config.CLIENT_ID,
                            scope: Config.SCOPES,
                            callback: (resp) => {
                                if (resp.error) return console.error(resp);
                                Services.Drive.onAuthSuccess();
                            },
                        });
                    } catch (e) { console.warn('Cloud API Load Failed', e); }
                },
                connect: () => {
                    Services.Drive.tokenClient.requestAccessToken({ prompt: 'consent' });
                },
                onAuthSuccess: () => {
                    const dot = document.getElementById('sync-dot');
                    const txt = document.getElementById('sync-text');
                    const btn = document.getElementById('btn-sync-action');
                    
                    dot.style.background = '#22c55e'; // Green
                    txt.innerText = "Online & Syncing";
                    btn.innerText = "Force Backup Now";
                    btn.onclick = Services.Drive.backup;
                    
                    Utils.notify("Google Drive Connected");
                    Services.Drive.backup(); // Initial backup
                },
                backup: async () => {
                    // Logic to overwrite file on Drive
                    if(!gapi.client.getToken()) return;

                    Utils.notify("Syncing to Cloud...");
                    
                    const fileContent = JSON.stringify(State);
                    const fileMeta = {
                        name: Config.DB_FILE,
                        mimeType: 'application/json'
                    };

                    try {
                        // 1. Search for existing file
                        const q = `name = '${Config.DB_FILE}' and trashed = false`;
                        const listRes = await gapi.client.drive.files.list({q});
                        const files = listRes.result.files;

                        if (files && files.length > 0) {
                            // Update
                            const fileId = files[0].id;
                            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                                method: 'PATCH',
                                headers: { 
                                    'Authorization': `Bearer ${gapi.client.getToken().access_token}`,
                                    'Content-Type': 'application/json' 
                                },
                                body: fileContent
                            });
                            console.log("Drive Patch Success");
                        } else {
                            // Create
                            const form = new FormData();
                            form.append('metadata', new Blob([JSON.stringify(fileMeta)], { type: 'application/json' }));
                            form.append('file', new Blob([fileContent], { type: 'application/json' }));
                            
                            await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` },
                                body: form
                            });
                            console.log("Drive Create Success");
                        }
                        
                    } catch (e) { console.error("Sync Error", e); }
                }
            }
        };

        // --- 3.7 UI RENDER LOGIC ---

        const Router = {
            nav: (route) => {
                // UI State Update
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                // Just relying on click handler logic inside standard element event bubbling would require 
                // tracking the `event.target`. For robust demo, we update by finding elements containing text match
                // (Omitted for brevity in favor of pure view logic below)
                
                UI.Nav.toggleSidebar(false); // Mobile Close

                const app = document.getElementById('viewport');
                const title = document.getElementById('header-title');

                if (route === 'dashboard') {
                    title.innerText = "Executive Overview";
                    
                    // Calc KPIs
                    const totalSales = State.invoices.reduce((sum, i) => sum + i.total, 0);
                    const outstanding = State.invoices.reduce((sum, i) => sum + (i.total - i.paid), 0);
                    const lowStock = State.products.filter(p => p.stock < 50).length;

                    // Calc Top Product
                    // (Simplified logic)

                    app.innerHTML = `
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-label">Total Revenue</div>
                                <div class="metric-value">${Utils.formatMoney(totalSales)}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Pending Payments</div>
                                <div class="metric-value text-danger">${Utils.formatMoney(outstanding)}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Stock Alerts</div>
                                <div class="metric-value" style="color:#d97706">${lowStock} items</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Active Customers</div>
                                <div class="metric-value">${State.customers.length}</div>
                            </div>
                        </div>

                        <div class="form-grid">
                             <div class="card">
                                 <div class="card-header">
                                     <h3 class="card-title">Recent Invoices</h3>
                                 </div>
                                 <div class="table-responsive">
                                     <table>
                                         <thead><tr><th>ID</th><th>Total</th><th>Status</th></tr></thead>
                                         <tbody>
                                             ${State.invoices.slice(0, 5).map(i => `
                                                <tr>
                                                    <td>${i.id}</td>
                                                    <td>${Utils.formatMoney(i.total)}</td>
                                                    <td><span class="status-badge badge-${i.status.toLowerCase()}">${i.status}</span></td>
                                                </tr>
                                             `).join('')}
                                         </tbody>
                                     </table>
                                 </div>
                             </div>

                             <div class="card">
                                 <div class="card-header"><h3 class="card-title">Inventory Health</h3></div>
                                 <div class="table-responsive">
                                      <table>
                                          <thead><tr><th>Product</th><th>Stock</th></tr></thead>
                                          <tbody>
                                              ${State.products.slice(0, 5).map(p => `
                                                 <tr>
                                                     <td>${p.name}</td>
                                                     <td style="${p.stock < 50 ? 'color:red; font-weight:bold' : ''}">${p.stock}</td>
                                                 </tr>
                                              `).join('')}
                                          </tbody>
                                      </table>
                                 </div>
                             </div>
                        </div>
                    `;
                }

                if (route === 'orders') {
                    title.innerText = "Sales Invoicing";
                    app.innerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <p class="text-sm text-muted">Manage invoices and create new sales orders.</p>
                            <button class="btn btn-primary" onclick="UI.Modals.Order.open()">
                                <span>+ Create New Invoice</span>
                            </button>
                        </div>
                        <div class="card">
                             <div class="table-responsive">
                                 <table>
                                     <thead>
                                         <tr>
                                             <th>Date</th>
                                             <th>Invoice #</th>
                                             <th>Customer</th>
                                             <th style="text-align:right">Amount</th>
                                             <th>Paid</th>
                                             <th>Balance</th>
                                             <th>Status</th>
                                         </tr>
                                     </thead>
                                     <tbody>
                                         ${State.invoices.map(i => {
                                             const cust = State.customers.find(c => c.id == i.custId);
                                             const bal = i.total - i.paid;
                                             return `
                                                <tr>
                                                    <td>${i.date}</td>
                                                    <td>${i.id}</td>
                                                    <td>${cust ? cust.name : 'Unknown'}</td>
                                                    <td style="text-align:right; font-weight:bold">${Utils.formatMoney(i.total)}</td>
                                                    <td class="text-success">${Utils.formatMoney(i.paid)}</td>
                                                    <td class="text-danger font-bold">${Utils.formatMoney(bal)}</td>
                                                    <td><span class="status-badge badge-${i.status.toLowerCase()}">${i.status}</span></td>
                                                </tr>
                                             `;
                                         }).join('')}
                                     </tbody>
                                 </table>
                             </div>
                        </div>
                    `;
                }

                if (route === 'finance') {
                    title.innerText = "Finance & Payments";
                    const outstanding = State.invoices.filter(i => i.status !== 'Paid');
                    app.innerHTML = `
                        <div class="card mb-4">
                            <div class="card-header"><h3 class="card-title">Outstanding Collections</h3></div>
                            <div class="table-responsive">
                                <table>
                                    <thead><tr><th>Ref</th><th>Customer</th><th>Total Due</th><th>Action</th></tr></thead>
                                    <tbody>
                                        ${outstanding.length ? outstanding.map(i => {
                                            const cust = State.customers.find(c => c.id == i.custId);
                                            const bal = i.total - i.paid;
                                            return `
                                            <tr>
                                                <td>${i.id}</td>
                                                <td>${cust ? cust.name : 'Unknown'}</td>
                                                <td class="text-danger font-bold">${Utils.formatMoney(bal)}</td>
                                                <td>
                                                    <button class="btn btn-secondary btn-icon" onclick="UI.Modals.Pay.open('${i.id}')">Record Pay</button>
                                                </td>
                                            </tr>`;
                                        }).join('') : `<tr><td colspan="4" class="text-center p-4 text-muted">No pending payments!</td></tr>`}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="card">
                             <div class="card-header"><h3 class="card-title">Transaction Ledger</h3></div>
                             <div class="table-responsive">
                                <table>
                                    <thead><tr><th>Date</th><th>Type</th><th>Description</th><th>Amount</th></tr></thead>
                                    <tbody>
                                        ${State.ledger.map(l => `
                                            <tr>
                                                <td>${l.date}</td>
                                                <td>${l.type}</td>
                                                <td>${l.desc}</td>
                                                <td class="${l.type === 'Credit' ? 'text-success' : 'text-danger'} font-bold">
                                                    ${Utils.formatMoney(l.amount)}
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                             </div>
                        </div>
                    `;
                }

                if (route === 'inventory') {
                    title.innerText = "Inventory Management";
                    app.innerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <p class="text-sm text-muted">Stock levels and adjustments.</p>
                            <button class="btn btn-primary" onclick="UI.Modals.Stock.open()">
                                <span>+ Purchase Stock</span>
                            </button>
                        </div>
                        <div class="card">
                            <div class="table-responsive">
                                <table>
                                    <thead><tr><th>SKU</th><th>Name</th><th>Category</th><th>Packing</th><th>Stock Level</th><th>Sell Price</th></tr></thead>
                                    <tbody>
                                        ${State.products.map(p => `
                                            <tr>
                                                <td class="text-muted text-xs">${p.id}</td>
                                                <td class="font-bold">${p.name}</td>
                                                <td>${p.category}</td>
                                                <td>${p.packing}</td>
                                                <td>
                                                    <span class="${p.stock < 50 ? 'text-danger font-bold' : ''}">${p.stock} cases</span>
                                                    ${p.stock < 20 ? '<span class="status-badge badge-unpaid">Low</span>' : ''}
                                                </td>
                                                <td>${Utils.formatMoney(p.price)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                
                if (route === 'crm') {
                    title.innerText = "Customer CRM";
                    
                    // Calc customer lifetime value
                    const getLTV = (cid) => {
                         return State.invoices.filter(i=>i.custId===cid).reduce((acc, curr)=> acc + curr.total, 0);
                    };

                    app.innerHTML = `
                         <div class="card">
                             <div class="table-responsive">
                                 <table>
                                     <thead><tr><th>Name</th><th>Type</th><th>Location</th><th>Contact</th><th>Lifetime Rev</th></tr></thead>
                                     <tbody>
                                         ${State.customers.map(c => `
                                             <tr>
                                                 <td class="font-bold">${c.name}</td>
                                                 <td><span class="status-badge" style="background:#e0f2fe; color:#0369a1">${c.type}</span></td>
                                                 <td>${c.loc}</td>
                                                 <td>${c.phone}</td>
                                                 <td class="font-bold">${Utils.formatMoney(getLTV(c.id))}</td>
                                             </tr>
                                         `).join('')}
                                     </tbody>
                                 </table>
                             </div>
                         </div>
                    `;
                }
                
                if(route === 'settings') {
                    title.innerText = "System Settings";
                    app.innerHTML = `
                        <div class="card">
                             <div class="card-header"><h3 class="card-title">Cloud Status</h3></div>
                             <div class="card-body">
                                 <p class="mb-4">Syncs with: <b>${Config.DB_FILE}</b> on authenticated Google Drive.</p>
                                 <button class="btn btn-primary" onclick="Services.Drive.backup()">Force Cloud Sync Now</button>
                             </div>
                        </div>
                    `;
                }
            }
        };

        const UI = {
            Nav: {
                toggleSidebar: (show) => {
                    const sb = document.getElementById('sidebar');
                    const over = document.getElementById('sidebar-overlay');
                    if(show) {
                        sb.classList.add('open');
                        over.classList.add('active');
                    } else {
                        sb.classList.remove('open');
                        over.classList.remove('active');
                    }
                }
            },
            Modals: {
                Order: {
                    open: () => {
                        const sel = document.getElementById('mo-customer');
                        sel.innerHTML = '<option value="">-- Select Customer --</option>';
                        State.customers.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.name}</option>`);
                        
                        document.getElementById('mo-date').value = Utils.today();
                        
                        // Render Product Table rows
                        const tbody = document.getElementById('mo-table-body');
                        tbody.innerHTML = '';
                        State.products.forEach(p => {
                            tbody.innerHTML += `
                                <tr>
                                    <td>
                                        <div>${p.name}</div>
                                        <div class="text-xs text-muted">${p.packing}</div>
                                    </td>
                                    <td>${Utils.formatMoney(p.price)}</td>
                                    <td class="${p.stock < 20 ? 'text-danger':''}">${p.stock}</td>
                                    <td>
                                        <input type="number" min="0" class="form-input order-row-qty" 
                                            data-id="${p.id}" 
                                            data-rate="${p.price}"
                                            style="padding:5px;"
                                            onchange="SalesController.calcLiveTotal()"
                                        >
                                    </td>
                                    <td class="text-right font-bold" id="sub-${p.id}">0.00</td>
                                </tr>
                            `;
                        });
                        SalesController.calcLiveTotal(); // init 0
                        document.getElementById('modal-order').classList.add('visible');
                    },
                    close: () => document.getElementById('modal-order').classList.remove('visible'),
                    onCustomerSelect: () => {
                        // Future implementation: show credit limit
                    }
                },
                Pay: {
                    open: (invId) => {
                        const inv = State.invoices.find(i => i.id === invId);
                        const due = inv.total - inv.paid;
                        
                        document.getElementById('mp-invid').value = inv.id;
                        document.getElementById('mp-ref-disp').value = `${invId} (${inv.date})`;
                        document.getElementById('mp-tot-disp').value = Utils.formatMoney(inv.total);
                        document.getElementById('mp-due-disp').value = Utils.formatMoney(due);
                        document.getElementById('mp-amt').value = due; // Default fill
                        
                        document.getElementById('modal-pay').classList.add('visible');
                    },
                    close: () => document.getElementById('modal-pay').classList.remove('visible')
                },
                Stock: {
                    open: () => {
                         const sel = document.getElementById('ms-prod');
                         sel.innerHTML = '';
                         State.products.forEach(p => sel.innerHTML += `<option value="${p.id}">${p.name} (Cur: ${p.stock})</option>`);
                         document.getElementById('modal-stock').classList.add('visible');
                    },
                    close: () => document.getElementById('modal-stock').classList.remove('visible')
                }
            }
        };

        // --- APP INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', () => {
            // Check Google Drive API Auth Status on load? (Skipped for explicit button press logic)
            Services.Drive.init();
            
            // Router Init
            Router.nav('dashboard');
        });

    </script>
</body>
</html>
