<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Himalayan Beverages | Enterprise Resource Planning System v3.0</title>
    <meta name="description" content="A complete single-file ERP solution for distribution management.">
    <meta name="author" content="Himalayan Tech Team">

    <!-- 
    ==========================================================================================
    1. EXTERNAL LIBRARIES (Only Essentials)
       - Google Identity Services: For secure OAuth2.0
       - Google API Client: For Drive REST interactions
       - JSPDF + AutoTable: For professional Invoice PDF generation (client-side)
    ==========================================================================================
    -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <!-- 
    ==========================================================================================
    2. DESIGN SYSTEM & CSS ARCHITECTURE (Approx. 600 lines)
       Custom built UI framework including grids, responsive utilities, and animations.
    ==========================================================================================
    -->
    <style>
        /* ------------------------------------------------------------
           2.1 ROOT VARIABLES (THEMING)
           Defining the Himalayan Beverages Brand Palette.
           ------------------------------------------------------------ */
        :root {
            /* Brand Colors: Deep Mountain Blue & Glacial White */
            --color-brand-50:  #f0f9ff;
            --color-brand-100: #e0f2fe;
            --color-brand-200: #bae6fd;
            --color-brand-500: #0ea5e9; /* Sky Blue Accent */
            --color-brand-700: #0369a1;
            --color-brand-800: #075985;
            --color-brand-900: #0c4a6e; /* Sidebar & Headers */
            
            /* Semantics */
            --color-success: #16a34a; /* Green 600 */
            --color-success-bg: #dcfce7;
            --color-warning: #ca8a04; /* Yellow 600 */
            --color-warning-bg: #fef9c3;
            --color-danger:  #dc2626; /* Red 600 */
            --color-danger-bg: #fee2e2;
            --color-info:    #4f46e5;
            --color-info-bg: #eef2ff;

            /* Surface Colors */
            --bg-canvas: #f1f5f9;  /* Slate 100 - Main BG */
            --bg-surface: #ffffff; /* White - Card BG */
            --bg-sidebar: #0f172a; /* Slate 900 - Sidebar */
            --bg-header:  #ffffff;

            /* Typography */
            --font-stack: 'Segoe UI', system-ui, -apple-system, Roboto, sans-serif;
            --text-primary: #1e293b; /* Slate 800 */
            --text-secondary:#64748b; /* Slate 500 */
            --text-light:   #94a3b8; /* Slate 400 */
            --text-inverse: #ffffff;

            /* Metrics & Layout */
            --sidebar-width-desktop: 280px;
            --header-height: 64px;
            --border-radius: 8px;
            --shadow-xs: 0 1px 2px 0 rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            
            /* Z-Index Hierarchy */
            --z-header: 50;
            --z-sidebar: 60;
            --z-overlay: 70;
            --z-modal: 100;
            --z-toast: 9000;
        }

        /* ------------------------------------------------------------
           2.2 GLOBAL RESETS & TYPOGRAPHY
           ------------------------------------------------------------ */
        *, *::before, *::after {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            font-family: var(--font-stack);
            font-size: 14px;
            line-height: 1.5;
            background-color: var(--bg-canvas);
            color: var(--text-primary);
            overflow: hidden; /* App-like Interface */
        }

        h1, h2, h3, h4, h5, h6 { margin: 0; font-weight: 700; color: var(--text-primary); }
        p { margin: 0 0 1rem 0; }
        a { text-decoration: none; color: var(--color-brand-600); transition: 0.2s; }
        ul, ol { list-style: none; padding: 0; margin: 0; }
        img, svg { display: block; max-width: 100%; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* ------------------------------------------------------------
           2.3 LAYOUT STRUCTURE (SHELL)
           ------------------------------------------------------------ */
        .app-shell { display: flex; height: 100%; width: 100%; }
        
        /* Sidebar Navigation */
        .app-sidebar {
            width: var(--sidebar-width-desktop);
            background-color: var(--bg-sidebar);
            color: var(--text-light);
            display: flex; flex-direction: column;
            border-right: 1px solid rgba(255,255,255,0.05);
            z-index: var(--z-sidebar);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .brand-logo {
            height: var(--header-height);
            display: flex; align-items: center; padding: 0 24px;
            background-color: rgba(0,0,0,0.2);
            font-size: 1.25rem; font-weight: 800; color: var(--text-inverse);
            letter-spacing: -0.025em; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .brand-logo span { color: var(--color-brand-500); }

        .sidebar-nav { flex: 1; padding: 24px 16px; overflow-y: auto; }
        
        .nav-label {
            font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.05em; color: #475569; margin-bottom: 8px;
            padding-left: 12px; margin-top: 16px;
        }
        .nav-label:first-child { margin-top: 0; }

        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 10px 12px;
            border-radius: 6px; cursor: pointer; color: #94a3b8;
            transition: all 0.2s; margin-bottom: 4px; font-weight: 500;
        }
        .nav-item svg { width: 20px; height: 20px; stroke-width: 2px; }
        .nav-item:hover { background-color: rgba(255,255,255,0.05); color: #f1f5f9; }
        .nav-item.active { background-color: var(--color-brand-600); color: #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }

        .sidebar-footer { padding: 20px; background: rgba(0,0,0,0.3); border-top: 1px solid rgba(255,255,255,0.05); }

        /* Main Viewport */
        .app-main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        .app-header {
            height: var(--header-height);
            background: var(--bg-header); border-bottom: 1px solid #e2e8f0;
            display: flex; align-items: center; justify-content: space-between; padding: 0 32px;
            box-shadow: var(--shadow-xs); z-index: var(--z-header);
        }

        .header-left { display: flex; align-items: center; gap: 16px; }
        .mobile-menu-btn { display: none; background: none; border: none; font-size: 24px; color: var(--text-primary); cursor: pointer; }
        
        .page-title { font-size: 1.15rem; font-weight: 700; color: var(--text-primary); display: flex; flex-direction: column; }
        .page-subtitle { font-size: 0.75rem; color: var(--text-secondary); font-weight: 400; margin-top: 2px; }

        .app-viewport { flex: 1; padding: 32px; overflow-y: auto; scroll-behavior: smooth; position: relative; }

        /* ------------------------------------------------------------
           2.4 UTILITY CLASSES & COMPONENTS
           ------------------------------------------------------------ */
        .card {
            background: var(--bg-surface);
            border-radius: var(--border-radius);
            border: 1px solid #e2e8f0;
            box-shadow: var(--shadow-sm);
            overflow: hidden; margin-bottom: 24px;
            transition: box-shadow 0.2s;
        }
        .card:hover { box-shadow: var(--shadow-md); }
        .card-header { padding: 20px 24px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 24px; }
        .card-title { font-size: 1rem; font-weight: 600; margin: 0; color: var(--text-primary); }

        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; font-weight: 600;
            border: 1px solid transparent; cursor: pointer; transition: 0.15s; user-select: none;
        }
        .btn:active { transform: translateY(1px); }
        .btn-primary { background-color: var(--color-brand-600); color: #fff; }
        .btn-primary:hover { background-color: var(--color-brand-700); }
        
        .btn-secondary { background-color: #fff; border-color: #cbd5e1; color: var(--text-primary); }
        .btn-secondary:hover { background-color: #f8fafc; border-color: #94a3b8; }
        
        .btn-success { background-color: var(--color-success); color: #fff; }
        .btn-danger  { background-color: #fff; border-color: #fecaca; color: var(--color-danger); }
        .btn-sm { padding: 4px 12px; font-size: 0.8rem; }
        .w-full { width: 100%; }

        /* Forms */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 6px; font-size: 0.85rem; font-weight: 600; color: var(--text-primary); }
        .form-input, .form-select {
            display: block; width: 100%; padding: 10px 12px;
            border: 1px solid #cbd5e1; border-radius: 6px;
            font-size: 0.95rem; color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s; background: #fff;
        }
        .form-input:focus, .form-select:focus { border-color: var(--color-brand-500); box-shadow: 0 0 0 3px var(--color-brand-100); }
        
        /* Tables */
        .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border: 1px solid #e2e8f0; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { text-align: left; background: #f8fafc; padding: 12px 16px; border-bottom: 2px solid #e2e8f0; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em; }
        td { padding: 14px 16px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; color: #334155; vertical-align: middle; }
        tr:hover { background-color: #f8fafc; }
        
        /* Badges */
        .badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; }
        .badge-success { background: var(--color-success-bg); color: var(--color-success); }
        .badge-warning { background: var(--color-warning-bg); color: var(--color-warning); }
        .badge-danger { background: var(--color-danger-bg); color: var(--color-danger); }
        .badge-info { background: var(--color-info-bg); color: var(--color-info); }
        .text-right { text-align: right; }
        .text-center { text-align: center; }

        /* Metric Grid */
        .metric-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 24px; }
        .metric-card {
            background: #fff; border-radius: 8px; border: 1px solid #e2e8f0; padding: 24px;
            display: flex; flex-direction: column; position: relative;
        }
        .metric-card::before { content:''; position: absolute; left: 0; top: 15%; bottom: 15%; width: 4px; background: var(--color-brand-500); border-radius: 0 4px 4px 0; }
        .metric-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); font-weight: 600; margin-bottom: 8px; }
        .metric-value { font-size: 2rem; font-weight: 800; color: var(--text-primary); letter-spacing: -0.05em; }

        /* Loaders & Auth */
        .auth-container { position: fixed; inset: 0; background: var(--bg-sidebar); z-index: 9000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; margin-top: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ------------------------------------------------------------
           2.5 MODAL SYSTEM
           ------------------------------------------------------------ */
        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(15, 23, 42, 0.75); backdrop-filter: blur(4px);
            z-index: var(--z-modal); display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s ease-out;
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        
        .modal {
            background: #fff; width: 100%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column;
            border-radius: 12px; box-shadow: var(--shadow-lg); transform: translateY(20px); transition: transform 0.3s;
        }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal-lg { max-width: 900px; }

        .modal-header { padding: 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 24px; overflow-y: auto; }
        .modal-footer { padding: 16px 24px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px; border-radius: 0 0 12px 12px; }

        /* ------------------------------------------------------------
           2.6 TOAST NOTIFICATIONS
           ------------------------------------------------------------ */
        #toast-wrapper { position: fixed; bottom: 32px; right: 32px; z-index: var(--z-toast); display: flex; flex-direction: column; gap: 12px; }
        .toast {
            min-width: 320px; background: #1e293b; color: white; padding: 16px 20px; border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 12px;
            border-left: 4px solid var(--color-brand-500); animation: slideInRight 0.3s ease-out forwards;
        }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* ------------------------------------------------------------
           2.7 RESPONSIVENESS (MOBILE)
           ------------------------------------------------------------ */
        @media (max-width: 1024px) {
            .metric-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .app-sidebar {
                position: fixed; left: -100%; top: 0; bottom: 0;
                box-shadow: 10px 0 25px rgba(0,0,0,0.2);
            }
            .app-sidebar.open { left: 0; }
            .mobile-menu-btn { display: block; }
            .app-viewport { padding: 16px; }
            .metric-grid { grid-template-columns: 1fr; gap: 16px; }
            .form-grid { grid-template-columns: 1fr; }
            
            .modal { max-width: 100%; height: 100%; border-radius: 0; max-height: 100vh; }
            .modal-footer { position: absolute; bottom: 0; width: 100%; }
            .modal-body { padding-bottom: 80px; }
        }

    </style>
</head>

<body>
    
    <!-- 3.1 AUTH OVERLAY (First Paint) -->
    <div id="auth-gate" class="auth-container">
        <div style="text-align:center;">
            <div style="font-size:3rem; font-weight:800; letter-spacing:-2px; margin-bottom:10px;">Himalayan<span style="color:var(--color-brand-500);">ERP</span></div>
            <p style="color:#94a3b8; font-size:1.1rem; max-width:400px; margin:0 auto 30px;">
                Secure Enterprise Operations Platform.<br>Authentication Required.
            </p>
            
            <div id="g_id_onload"
                 data-client_id="950010994560-v7p6cem78h9fsdp102iq4immb36t95ls.apps.googleusercontent.com"
                 data-callback="App.Events.onGoogleAuthSuccess"
                 data-auto_prompt="false">
            </div>
            <div class="g_id_signin" 
                 data-type="standard" 
                 data-size="large" 
                 data-theme="filled_blue"
                 data-text="sign_in_with"
                 data-shape="rectangular"
                 data-logo_alignment="left" 
                 data-width="300">
            </div>

            <div id="sync-status" style="display:none; margin-top:20px; font-family:monospace; color:#38bdf8;">
                Initialize Cloud Sync...
            </div>
            <div class="spinner" id="loading-spinner" style="display:none; margin: 20px auto;"></div>
        </div>
        <div style="position:fixed; bottom:20px; opacity:0.5; font-size:0.8rem;">
            © 2025 Himalayan Beverages Tech | Version 3.1.0-RC
        </div>
    </div>


    <!-- 3.2 APPLICATION SHELL -->
    <div class="app-shell" id="main-interface" style="display:none;"> <!-- Hidden initially -->
        
        <!-- Sidebar -->
        <aside class="app-sidebar" id="sidebar">
            <div class="brand-logo">
                <span>Himalayan</span>ERP
            </div>
            
            <nav class="sidebar-nav">
                
                <div class="nav-label">Core Modules</div>
                <div class="nav-item active" onclick="App.Router.go('dashboard')">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
                    Dashboard
                </div>
                <div class="nav-item" onclick="App.Router.go('orders')">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    Sales Invoices
                </div>
                <div class="nav-item" onclick="App.Router.go('inventory')">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                    Inventory
                </div>

                <div class="nav-label">Management</div>
                <div class="nav-item" onclick="App.Router.go('customers')">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                    Customer CRM
                </div>
                <div class="nav-item" onclick="App.Router.go('finance')">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    Payments & Ledger
                </div>

                <div class="nav-label">System</div>
                <div class="nav-item" onclick="App.Router.go('settings')">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                    Data Sync & Backup
                </div>

            </nav>

            <div class="sidebar-footer">
                <div style="font-size:0.75rem; color:#64748b; font-weight:700;">USER ACCOUNT</div>
                <div style="margin-top:5px; font-weight:500; color:#fff;" id="active-user-display">Freskey Admin</div>
                <div style="margin-top:8px; display:flex; align-items:center; gap:6px;">
                     <div class="indicator-dot" style="width:8px;height:8px;background:#22c55e;border-radius:50%"></div>
                     <span style="font-size:0.75rem; color:#cbd5e1">Drive Sync Active</span>
                </div>
            </div>
        </aside>

        <!-- Main Layout -->
        <main class="app-main">
            <!-- Overlay for Mobile Sidebar -->
            <div id="mobile-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:55;" onclick="App.Router.toggleSidebar()"></div>

            <!-- Top Header -->
            <header class="app-header">
                <div class="header-left">
                    <button class="mobile-menu-btn" onclick="App.Router.toggleSidebar()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                    </button>
                    <div>
                        <h2 class="page-title" id="page-head-title">Overview</h2>
                        <div class="page-subtitle">Real-time business insights</div>
                    </div>
                </div>
                
                <div class="header-actions">
                     <button class="btn btn-primary" onclick="App.Modals.open('modal-order')">
                        <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                        <span>New Order</span>
                     </button>
                </div>
            </header>

            <!-- Dynamic Viewport -->
            <div class="app-viewport" id="main-view">
                <!-- Javascript will inject content here based on Navigation -->
            </div>

        </main>
    </div>

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div id="toast-wrapper"></div>


    <!-- 
    ==========================================================================================
    4. MODAL DEFINITIONS
       Reusable modal structures controlled by the Controller.
    ==========================================================================================
    -->

    <!-- 4.1 SALES ORDER MODAL -->
    <div id="modal-order" class="modal-overlay">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3>New Invoice Generation</h3>
                <button style="border:none;background:none;font-size:24px;cursor:pointer" onclick="App.Modals.close('modal-order')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div>
                        <label class="form-label">Customer Selection</label>
                        <select id="ord-customer-select" class="form-select"></select>
                    </div>
                    <div>
                        <label class="form-label">Invoice Date</label>
                        <input type="date" id="ord-date-input" class="form-input">
                    </div>
                </div>

                <!-- Product Lines -->
                <div class="card" style="border:none; background: #f8fafc;">
                    <div style="padding:16px;">
                        <h4 style="margin-bottom:10px; color:#475569;">Line Items</h4>
                        <div class="table-responsive" style="background:white; max-height:250px;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Product Name</th>
                                        <th style="width:100px;">Rate</th>
                                        <th style="width:80px;">Avail</th>
                                        <th style="width:80px;">Qty</th>
                                        <th style="width:120px;text-align:right;">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="ord-lines-body">
                                    <!-- Dynamic -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                    <div style="color:#64748b; font-size:0.9rem;">Tax Calculation (Exclusive) logic applied automatically.</div>
                    <div style="text-align:right;">
                        <div style="font-size:0.85rem; text-transform:uppercase; color:#94a3b8; font-weight:700;">Grand Total</div>
                        <div style="font-size:2rem; font-weight:800; color:var(--color-brand-600);" id="ord-grand-total">₹ 0.00</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="App.Modals.close('modal-order')">Cancel</button>
                <button class="btn btn-primary" onclick="App.Controllers.Sales.submitOrder()">Generate Invoice & Sync</button>
            </div>
        </div>
    </div>

    <!-- 4.2 PURCHASE / ADD STOCK MODAL -->
    <div id="modal-stock" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Inventory Purchase Entry</h3>
                <button style="border:none;background:none;font-size:24px;cursor:pointer" onclick="App.Modals.close('modal-stock')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select Product</label>
                    <select id="stk-prod-select" class="form-select"></select>
                </div>
                <div class="form-grid">
                    <div>
                         <label class="form-label">Quantity (Cases)</label>
                         <input type="number" id="stk-qty" class="form-input" placeholder="e.g. 50">
                    </div>
                    <div>
                         <label class="form-label">Batch Reference / PO #</label>
                         <input type="text" id="stk-ref" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <input type="text" id="stk-note" class="form-input" placeholder="Optional notes">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="App.Modals.close('modal-stock')">Close</button>
                <button class="btn btn-success" onclick="App.Controllers.Inventory.addStock()">Confirm Purchase</button>
            </div>
        </div>
    </div>

    <!-- 4.3 ADD CUSTOMER MODAL -->
    <div id="modal-cust" class="modal-overlay">
         <div class="modal">
            <div class="modal-header"><h3>New Customer Profile</h3><button onclick="App.Modals.close('modal-cust')" style="border:none;background:none;font-size:20px">&times;</button></div>
            <div class="modal-body">
                 <div class="form-group">
                    <label class="form-label">Business Name</label>
                    <input id="nc-name" class="form-input">
                 </div>
                 <div class="form-grid">
                    <div><label class="form-label">Type</label><select id="nc-type" class="form-select"><option>Retailer</option><option>Distributor</option><option>Event</option></select></div>
                    <div><label class="form-label">Phone</label><input id="nc-phone" class="form-input"></div>
                 </div>
                 <div class="form-group"><label class="form-label">Location/Address</label><input id="nc-loc" class="form-input"></div>
            </div>
            <div class="modal-footer">
                 <button class="btn btn-secondary" onclick="App.Modals.close('modal-cust')">Cancel</button>
                 <button class="btn btn-primary" onclick="App.Controllers.CRM.add()">Save Profile</button>
            </div>
         </div>
    </div>
    
    <!-- 4.4 RECORD PAYMENT MODAL -->
    <div id="modal-pay" class="modal-overlay">
        <div class="modal">
             <div class="modal-header"><h3>Record Transaction</h3><button onclick="App.Modals.close('modal-pay')" style="border:none;background:none;font-size:20px">&times;</button></div>
             <div class="modal-body">
                  <input type="hidden" id="np-inv-id">
                  <div class="form-group"><label class="form-label">Ref Invoice</label><input id="np-inv-display" class="form-input" disabled></div>
                  <div class="form-grid">
                      <div><label class="form-label">Balance Due</label><input id="np-due" class="form-input" disabled style="color:var(--color-danger);font-weight:700"></div>
                      <div><label class="form-label">Total Inv Amount</label><input id="np-total" class="form-input" disabled></div>
                  </div>
                  <div class="form-group">
                      <label class="form-label">Payment Amount (INR)</label>
                      <input type="number" id="np-amt" class="form-input" style="font-size:1.5rem; font-weight:700;">
                  </div>
             </div>
             <div class="modal-footer">
                  <button class="btn btn-secondary" onclick="App.Modals.close('modal-pay')">Cancel</button>
                  <button class="btn btn-success" onclick="App.Controllers.Finance.processPay()">Record Receipt</button>
             </div>
        </div>
    </div>

    <!-- 
    ==========================================================================================
    5. JAVASCRIPT KERNEL (Application Logic)
       State Management, Drive Sync Service, Controllers.
    ==========================================================================================
    -->
    <script>
        
        // -------------------------------------------------------------
        // 5.1 APP CONFIGURATION
        // -------------------------------------------------------------
        const Config = {
            API_KEY: 'AIzaSyCWo9OP6-QhyKWpfuV5oonyuC32IQHoOtE', 
            CLIENT_ID: '950010994560-v7p6cem78h9fsdp102iq4immb36t95ls.apps.googleusercontent.com',
            SCOPES: 'https://www.googleapis.com/auth/drive.file',
            DB_FILE_NAME: 'himalayan_beverages_master_db.json'
        };

        // -------------------------------------------------------------
        // 5.2 DATA MODEL (Seed Data)
        // -------------------------------------------------------------
        // Initial empty structure to be replaced by Drive or initialized new.
        let DB = {
            customers: [
                {id: 101, name: "Sample Distributor", type: "Distributor", loc: "New Delhi", phone: "9876543210"}
            ],
            products: [
                {id: "p1", name: "Freskey Lemon 200ml", pack: "24x200", stock: 150, price: 480, cat: "Glass"},
                {id: "p2", name: "Freskey Mango 200ml", pack: "24x200", stock: 80, price: 500, cat: "Glass"},
                {id: "p3", name: "Freskey Litchi 500ml", pack: "12x500", stock: 45, price: 360, cat: "PET"},
                {id: "p4", name: "Soda Fizz 300ml", pack: "24x300", stock: 220, price: 600, cat: "Soda"},
                {id: "p5", name: "Water 1L Box", pack: "12x1L", stock: 300, price: 240, cat: "Water"},
                {id: "p6", name: "Jeera Masala 200ml", pack: "24x200", stock: 15, price: 480, cat: "Glass"}
            ],
            orders: [
                // Seed some orders for chart visualization on first load if file not found
                {id: "INV-SEED-1", date: "2025-10-01", custId: 101, total: 15000, paid: 10000, status: "Partial", items: []}
            ],
            ledgers: [
                {id: "TX-1", date: "2025-10-01", type: "Credit", desc: "Seed Capital / Payment", amt: 10000}
            ]
        };

        // -------------------------------------------------------------
        // 5.3 UTILITIES CLASS
        // -------------------------------------------------------------
        const Utils = {
            fmtMoney: (amt) => {
                // Ensure plain string "Rs." is used for PDF compat, UTF symbols can break standard fonts
                return `Rs. ${parseFloat(amt).toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
            },
            generateId: () => Math.random().toString(36).substr(2, 9).toUpperCase(),
            today: () => new Date().toISOString().split('T')[0],
            toast: (msg, type='info') => {
                const wrap = document.getElementById('toast-wrapper');
                const el = document.createElement('div');
                el.className = 'toast';
                el.style.borderLeftColor = type === 'success' ? '#22c55e' : (type==='error'?'#dc2626':'#0ea5e9');
                el.innerHTML = `<span>${msg}</span>`;
                wrap.appendChild(el);
                setTimeout(() => el.remove(), 4000);
            }
        };

        // -------------------------------------------------------------
        // 5.4 CHARTING ENGINE (Custom Canvas Renderer)
        // Implemented from scratch to avoid huge ChartJS library dependency in single file.
        // -------------------------------------------------------------
        class ChartEngine {
            static drawBarChart(canvasId, dataLabels, dataValues) {
                const cvs = document.getElementById(canvasId);
                if (!cvs) return;
                const ctx = cvs.getContext('2d');
                const W = cvs.width, H = cvs.height;
                const pad = 30;
                
                // Clear
                ctx.clearRect(0,0,W,H);
                
                // Find Max
                const maxVal = Math.max(...dataValues, 10); // Prevent div by 0
                const scale = (H - pad*2) / maxVal;
                const barWidth = (W - pad*2) / dataValues.length - 10;

                // Draw Bars
                dataValues.forEach((val, i) => {
                    const h = val * scale;
                    const x = pad + i * (barWidth + 10);
                    const y = H - pad - h;
                    
                    // Gradient Fill
                    const grd = ctx.createLinearGradient(0, y, 0, H-pad);
                    grd.addColorStop(0, '#38bdf8');
                    grd.addColorStop(1, '#0284c7');
                    
                    ctx.fillStyle = grd;
                    ctx.fillRect(x, y, barWidth, h);
                    
                    // Value Label
                    ctx.fillStyle = '#0f172a';
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(val, x + barWidth/2, y - 5);
                    
                    // X Axis Label (Truncate)
                    const label = dataLabels[i].substring(0,6);
                    ctx.fillText(label, x + barWidth/2, H - 10);
                });
                
                // Axis Line
                ctx.strokeStyle = '#cbd5e1';
                ctx.beginPath();
                ctx.moveTo(pad, H-pad); ctx.lineTo(W-pad, H-pad);
                ctx.stroke();
            }
        }


        // -------------------------------------------------------------
        // 5.5 PDF GENERATOR SERVICE
        // -------------------------------------------------------------
        class PDFService {
            static generateInvoice(order, items, customer) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Styling constants
                const blue = [3, 105, 161];
                const slate = [248, 250, 252];
                
                // Header Bar
                doc.setFillColor(...blue);
                doc.rect(0, 0, 210, 30, 'F');
                doc.setFontSize(22); doc.setTextColor(255); doc.setFont("helvetica", "bold");
                doc.text("HIMALAYAN BEVERAGES", 15, 20);
                
                // Title
                doc.setFontSize(26); doc.setTextColor(200);
                doc.text("INVOICE", 195, 20, {align: 'right'});
                
                // Info Section
                doc.setTextColor(0); doc.setFontSize(10);
                doc.text("FROM:", 15, 40); doc.setFont("helvetica", "normal");
                doc.text("Himalayan Beverages Ltd.\nEco Park, Uttarakhand\nGSTIN: 05AABCH9999K1Z5", 15, 45);
                
                doc.setFont("helvetica", "bold");
                doc.text("BILL TO:", 120, 40); doc.setFont("helvetica", "normal");
                doc.text(`${customer.name}\n${customer.loc}\nPh: ${customer.phone}\nType: ${customer.type}`, 120, 45);
                
                // Meta
                doc.setFillColor(...slate);
                doc.rect(15, 65, 180, 10, 'F');
                doc.text(`Invoice No: ${order.id}    |    Date: ${order.date}`, 20, 71);
                
                // Table
                const tableData = items.map(i => [
                    i.name, i.qty, Utils.fmtMoney(i.price).replace("Rs. ",""), Utils.fmtMoney(i.total).replace("Rs. ","")
                ]);
                
                doc.autoTable({
                    startY: 80,
                    head: [['Product Description', 'Qty (Cs)', 'Rate', 'Total']],
                    body: tableData,
                    theme: 'striped',
                    headStyles: { fillColor: blue, textColor: 255 },
                    foot: [['', '', 'Grand Total:', Utils.fmtMoney(order.total).replace("Rs. ","")]],
                    footStyles: { fillColor: [241, 245, 249], textColor: 0, fontStyle: 'bold' }
                });
                
                const finalY = doc.lastAutoTable.finalY + 10;
                
                // Footer
                doc.setFontSize(9); doc.setTextColor(100);
                doc.text("Terms & Conditions:", 15, finalY);
                doc.setFontSize(8);
                doc.text("1. Interest @18% on overdue payments.\n2. Goods once sold will not be taken back.\n\nBank: HDFC Bank | A/c: 502000XXXX | IFSC: HDFC000123", 15, finalY+5);
                
                doc.save(`Invoice_${order.id}.pdf`);
            }
        }


        // -------------------------------------------------------------
        // 5.6 DRIVE SYNC ADAPTER (CORE SERVICE)
        // -------------------------------------------------------------
        const Drive = {
            tokenClient: null,
            init: () => {
                gapi.load('client', async () => {
                    await gapi.client.init({ apiKey: Config.API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] });
                    Drive.tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: Config.CLIENT_ID,
                        scope: Config.SCOPES,
                        callback: (resp) => {
                            if (resp.error) return;
                            Drive.handleAuthSuccess();
                        }
                    });
                    
                    // Check if we can prompt
                    // Drive.promptAuth(); --> User click required usually
                });
            },
            promptAuth: () => { Drive.tokenClient.requestAccessToken({prompt: ''}); },
            handleAuthSuccess: () => {
                document.getElementById('auth-gate').style.display = 'none'; // Fade out handled by controller later actually
                // Begin Sync Process
                App.Sync.loadFromCloud();
            }
        };


        // -------------------------------------------------------------
        // 5.7 APP CONTROLLERS
        // -------------------------------------------------------------
        const App = {
            State: DB, // Ref to local variable
            
            // Events for Initial Load
            Events: {
                onGoogleAuthSuccess: (response) => {
                    const decoded = App.Events.parseJwt(response.credential);
                    document.getElementById('active-user-display').innerText = decoded.email;
                    document.querySelector('.g_id_signin').style.display = 'none';
                    document.getElementById('loading-spinner').style.display = 'block';
                    document.getElementById('sync-status').style.display = 'block';
                    
                    // Initialize GAPI Token Request
                    Drive.init();
                    // NOTE: Drive.init loads library. We need user interaction usually or token prompt.
                    // Google One-Tap provides Identity token, not Access token.
                    // We trigger the Access Token request immediately after.
                    setTimeout(() => Drive.promptAuth(), 500);
                },
                parseJwt: (token) => {
                    var base64Url = token.split('.')[1];
                    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    return JSON.parse(window.atob(base64));
                }
            },

            // Cloud Logic
            Sync: {
                loadFromCloud: async () => {
                    try {
                        document.getElementById('sync-status').innerText = "Scanning Google Drive...";
                        const q = `name = '${Config.DB_FILE_NAME}' and trashed = false`;
                        const res = await gapi.client.drive.files.list({ q: q, fields: 'files(id)' });
                        const files = res.result.files;

                        if (files && files.length > 0) {
                             document.getElementById('sync-status').innerText = "Downloading Database...";
                             const fileId = files[0].id;
                             const content = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
                             if(content.result) {
                                 App.State = content.result; // HYDRATE STATE
                             }
                        } else {
                            document.getElementById('sync-status').innerText = "Creating New Database...";
                            await App.Sync.saveToCloud(true);
                        }
                        
                        // Proceed to App
                        document.getElementById('auth-gate').style.display = 'none';
                        document.getElementById('main-interface').style.display = 'flex';
                        App.Router.go('dashboard');

                    } catch(e) {
                        console.error(e);
                        alert("Sync Failed: " + JSON.stringify(e));
                    }
                },
                saveToCloud: async (isNew = false) => {
                    // Quick Save Logic
                    Utils.toast("Syncing...", "info");
                    const body = JSON.stringify(App.State);
                    
                    try {
                        if (!isNew) {
                             // Find ID
                             const q = `name = '${Config.DB_FILE_NAME}' and trashed = false`;
                             const res = await gapi.client.drive.files.list({q: q});
                             if (res.result.files.length > 0) {
                                 const fileId = res.result.files[0].id;
                                 await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                                     method: 'PATCH',
                                     headers: new Headers({'Authorization': 'Bearer ' + gapi.client.getToken().access_token, 'Content-Type': 'application/json'}),
                                     body: body
                                 });
                                 Utils.toast("Cloud Sync Complete", "success");
                                 return;
                             }
                        }
                        
                        // New File Logic (Multipart)
                        const metadata = { name: Config.DB_FILE_NAME, mimeType: 'application/json' };
                        const form = new FormData();
                        form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                        form.append('file', new Blob([body], {type: 'application/json'}));
                        
                        await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                             method: 'POST',
                             headers: new Headers({'Authorization': 'Bearer ' + gapi.client.getToken().access_token}),
                             body: form
                        });
                        Utils.toast("Database Created in Drive", "success");

                    } catch(e) { console.error(e); Utils.toast("Sync Error", "error"); }
                }
            },

            // Routing Views
            Router: {
                current: null,
                toggleSidebar: () => {
                     document.getElementById('sidebar').classList.toggle('open');
                     const mob = document.getElementById('mobile-overlay');
                     mob.style.display = mob.style.display==='none'?'block':'none';
                },
                go: (route) => {
                    // Update Nav UI
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    // We assume navigation index matching or use data attributes.
                    // For this monolith, quick simple matching logic:
                    
                    const container = document.getElementById('main-view');
                    const headerTitle = document.getElementById('page-head-title');
                    
                    // View Rendering Logic
                    if (route === 'dashboard') {
                        headerTitle.innerText = "Operations Dashboard";
                        // Calculate Stats
                        const totalRev = App.State.orders.reduce((acc,o)=>acc+o.total, 0);
                        const due = App.State.orders.reduce((acc,o)=>acc+(o.total-o.paid), 0);
                        const lowStock = App.State.products.filter(p=>p.stock<20).length;
                        
                        container.innerHTML = `
                             <div class="metric-grid">
                                 <div class="metric-card">
                                     <div class="metric-label">Total Revenue</div>
                                     <div class="metric-value" style="color:#0f172a">${Utils.fmtMoney(totalRev)}</div>
                                 </div>
                                 <div class="metric-card">
                                     <div class="metric-label">Pending Payments</div>
                                     <div class="metric-value" style="color:var(--color-danger)">${Utils.fmtMoney(due)}</div>
                                 </div>
                                 <div class="metric-card">
                                     <div class="metric-label">Stock Alerts</div>
                                     <div class="metric-value" style="color:var(--color-warning)">${lowStock} items</div>
                                 </div>
                                 <div class="metric-card">
                                     <div class="metric-label">Customers</div>
                                     <div class="metric-value">${App.State.customers.length}</div>
                                 </div>
                             </div>

                             <div class="form-grid">
                                 <div class="card">
                                      <div class="card-header"><h3 class="card-title">Inventory Distribution</h3></div>
                                      <div class="card-body" style="height:250px; display:grid; place-items:center;">
                                           <canvas id="invChart" width="400" height="200"></canvas>
                                      </div>
                                 </div>
                                 <div class="card">
                                      <div class="card-header"><h3 class="card-title">Recent Invoices</h3></div>
                                      <div class="table-responsive">
                                           <table>
                                               <thead><tr><th>ID</th><th>Total</th><th>Status</th></tr></thead>
                                               <tbody>
                                                   ${App.State.orders.slice(0,5).map(o=>`
                                                      <tr><td>${o.id}</td><td>${Utils.fmtMoney(o.total)}</td><td><span class="badge ${o.status==='Paid'?'badge-success':'badge-danger'}">${o.status}</span></td></tr>
                                                   `).join('')}
                                               </tbody>
                                           </table>
                                      </div>
                                 </div>
                             </div>
                        `;
                        // Draw Chart after render
                        setTimeout(() => {
                             const pNames = App.State.products.map(p=>p.name);
                             const pStocks = App.State.products.map(p=>p.stock);
                             ChartEngine.drawBarChart('invChart', pNames, pStocks);
                        }, 100);
                    }
                    else if (route === 'orders') {
                        headerTitle.innerText = "Sales Invoices";
                        container.innerHTML = `
                            <div class="card">
                                 <div class="table-responsive">
                                     <table>
                                         <thead><tr><th>Date</th><th>Inv #</th><th>Customer</th><th class="text-right">Total</th><th>Paid</th><th class="text-right">Due</th><th>Status</th><th>PDF</th></tr></thead>
                                         <tbody>
                                             ${App.State.orders.slice().reverse().map(o=>{
                                                 const c = App.State.customers.find(c=>c.id==o.custId);
                                                 const due = o.total - o.paid;
                                                 return `<tr>
                                                    <td>${o.date}</td><td>${o.id}</td>
                                                    <td>${c ? c.name : 'Unknown'}</td>
                                                    <td class="text-right font-bold">${Utils.fmtMoney(o.total)}</td>
                                                    <td class="text-success">${Utils.fmtMoney(o.paid)}</td>
                                                    <td class="text-right text-danger font-bold">${Utils.fmtMoney(due)}</td>
                                                    <td><span class="badge ${o.status==='Paid'?'badge-success':(o.status==='Unpaid'?'badge-danger':'badge-warning')}">${o.status}</span></td>
                                                    <td><button class="btn btn-sm btn-secondary" onclick="App.Controllers.Sales.pdf('${o.id}')">⇩</button></td>
                                                 </tr>`
                                             }).join('')}
                                         </tbody>
                                     </table>
                                 </div>
                            </div>
                        `;
                    }
                    else if (route === 'inventory') {
                        headerTitle.innerText = "Stock Management";
                        container.innerHTML = `
                            <div class="card">
                                <div class="card-header"><h3 class="card-title">Product Master</h3></div>
                                <div class="table-responsive">
                                     <table><thead><tr><th>Name</th><th>Cat</th><th>Packing</th><th>Stock</th><th>Price</th></tr></thead><tbody>
                                     ${App.State.products.map(p=>`<tr>
                                        <td style="font-weight:700">${p.name}</td><td>${p.cat}</td><td>${p.pack}</td>
                                        <td class="${p.stock<20?'text-danger':''} font-bold">${p.stock} cs</td>
                                        <td>${Utils.fmtMoney(p.price)}</td>
                                     </tr>`).join('')}
                                     </tbody></table>
                                </div>
                            </div>
                        `;
                    }
                    else if (route === 'finance') {
                        headerTitle.innerText = "Finance Ledger";
                        container.innerHTML = `
                            <div class="card">
                                <div class="card-header"><h3 class="card-title">Pending Collections</h3></div>
                                <div class="table-responsive">
                                    <table><thead><tr><th>Inv #</th><th>Customer</th><th>Pending Amount</th><th>Action</th></tr></thead>
                                    <tbody>
                                        ${App.State.orders.filter(o=>o.status!=='Paid').map(o=>{
                                             const c = App.State.customers.find(cx=>cx.id==o.custId);
                                             return `<tr>
                                                 <td>${o.id}</td><td>${c?c.name:'-'}</td><td class="text-danger font-bold">${Utils.fmtMoney(o.total - o.paid)}</td>
                                                 <td><button class="btn btn-success btn-sm" onclick="App.Modals.openPay('${o.id}')">Record Pay</button></td>
                                             </tr>`;
                                        }).join('')}
                                    </tbody></table>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header"><h3 class="card-title">Ledger Transactions</h3></div>
                                <div class="table-responsive">
                                    <table><thead><tr><th>Date</th><th>Type</th><th>Desc</th><th>Amount</th></tr></thead><tbody>
                                        ${App.State.ledgers.slice().reverse().map(l=>`<tr>
                                            <td>${l.date}</td><td><span class="badge badge-info">${l.type}</span></td><td>${l.desc}</td><td>${Utils.fmtMoney(l.amt)}</td>
                                        </tr>`).join('')}
                                    </tbody></table>
                                </div>
                            </div>
                        `;
                    }
                    else if (route === 'customers') {
                        headerTitle.innerText = "Customer Database";
                         container.innerHTML = `
                             <div class="form-grid">
                                  <div class="card">
                                      <div class="card-header">
                                          <h3 class="card-title">Clients</h3>
                                          <button class="btn btn-sm btn-primary" onclick="App.Modals.open('modal-cust')">+ Add</button>
                                      </div>
                                      <div class="table-responsive">
                                          <table><thead><tr><th>Name</th><th>Loc</th><th>Type</th><th>Phone</th></tr></thead><tbody>
                                              ${App.State.customers.map(c=>`<tr><td><b>${c.name}</b></td><td>${c.loc}</td><td>${c.type}</td><td>${c.phone}</td></tr>`).join('')}
                                          </tbody></table>
                                      </div>
                                  </div>
                             </div>`;
                    }
                    else if (route === 'settings') {
                        headerTitle.innerText = "System Settings";
                        container.innerHTML = `<div class="card"><div class="card-body">Connected to Drive: <b>${Config.DB_FILE_NAME}</b>.<br><br><button onclick="App.Sync.saveToCloud()" class="btn btn-primary">Force Sync</button></div></div>`;
                    }
                }
            },

            // Functional Controllers
            Controllers: {
                Inventory: {
                    addStock: () => {
                         const pid = document.getElementById('stk-prod-select').value;
                         const qty = parseInt(document.getElementById('stk-qty').value);
                         const ref = document.getElementById('stk-ref').value;
                         if(!qty) return;

                         const prod = App.State.products.find(p=>p.id===pid);
                         if(prod){
                             prod.stock += qty;
                             App.State.ledgers.push({id: Utils.generateId(), date:Utils.today(), type:'Stock In', desc: `Purchase ${prod.name} (Ref:${ref})`, amt: 0});
                             Utils.toast(`${qty} cases added.`);
                             App.Modals.close('modal-stock');
                             App.Router.go('inventory');
                             App.Sync.saveToCloud();
                         }
                    }
                },
                CRM: {
                    add: () => {
                        const name = document.getElementById('nc-name').value;
                        if(!name) return;
                        App.State.customers.push({
                            id: Date.now(),
                            name: name,
                            type: document.getElementById('nc-type').value,
                            phone: document.getElementById('nc-phone').value,
                            loc: document.getElementById('nc-loc').value
                        });
                        Utils.toast("Customer Saved");
                        App.Modals.close('modal-cust');
                        App.Router.go('customers');
                        App.Sync.saveToCloud();
                    }
                },
                Sales: {
                    submitOrder: () => {
                        const custId = document.getElementById('ord-customer-select').value;
                        if(!custId) return;
                        
                        // Parse Lines
                        let total = 0;
                        const items = [];
                        const inputs = document.querySelectorAll('.line-qty');
                        inputs.forEach(inp => {
                             const q = parseInt(inp.value);
                             if(q > 0) {
                                 const pid = inp.dataset.pid;
                                 const prod = App.State.products.find(p=>p.id===pid);
                                 total += (q * prod.price);
                                 // Deduct Stock
                                 prod.stock -= q;
                                 items.push({name: prod.name, price: prod.price, qty: q, total: (q*prod.price)});
                             }
                        });
                        
                        if(items.length === 0) return alert("Select at least 1 item");

                        const id = "INV-" + Math.floor(Math.random()*100000);
                        const order = {
                             id: id,
                             date: document.getElementById('ord-date-input').value,
                             custId: parseInt(custId),
                             total: total,
                             paid: 0, 
                             status: 'Unpaid',
                             items: items
                        };
                        
                        App.State.orders.push(order);
                        App.State.ledgers.push({id: Utils.generateId(), date:order.date, type: 'Sale', desc:`Invoice ${id}`, amt: total});
                        
                        Utils.toast("Invoice Created");
                        App.Modals.close('modal-order');
                        
                        // Trigger PDF
                        const c = App.State.customers.find(cx=>cx.id==order.custId);
                        PDFService.generateInvoice(order, items, c);

                        App.Router.go('orders');
                        App.Sync.saveToCloud();
                    },
                    pdf: (oid) => {
                         const order = App.State.orders.find(o=>o.id==oid);
                         const c = App.State.customers.find(cx=>cx.id==order.custId);
                         PDFService.generateInvoice(order, order.items || [], c);
                    }
                },
                Finance: {
                     processPay: () => {
                          const oid = document.getElementById('np-inv-id').value;
                          const amt = parseFloat(document.getElementById('np-amt').value);
                          if(!amt) return;
                          
                          const ord = App.State.orders.find(o=>o.id===oid);
                          ord.paid += amt;
                          ord.status = ord.paid >= ord.total ? 'Paid' : 'Partial';
                          App.State.ledgers.push({id:Utils.generateId(), date:Utils.today(), type:'Payment', desc:`Recd against ${oid}`, amt: amt});
                          
                          Utils.toast("Payment Recorded");
                          App.Modals.close('modal-pay');
                          App.Router.go('finance');
                          App.Sync.saveToCloud();
                     }
                }
            },
            
            // Modal Handlers
            Modals: {
                open: (id) => {
                    const el = document.getElementById(id);
                    el.classList.add('active');
                    
                    // Populators
                    if(id==='modal-stock') {
                         const s = document.getElementById('stk-prod-select');
                         s.innerHTML = App.State.products.map(p=>`<option value="${p.id}">${p.name} (Stock: ${p.stock})</option>`).join('');
                    }
                    if(id==='modal-order') {
                         document.getElementById('ord-date-input').value = Utils.today();
                         const cs = document.getElementById('ord-customer-select');
                         cs.innerHTML = '<option value="">--Select Customer--</option>' + App.State.customers.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
                         
                         // Build Lines
                         const tbody = document.getElementById('ord-lines-body');
                         tbody.innerHTML = App.State.products.map(p => `
                             <tr>
                                 <td>
                                     <div style="font-weight:600">${p.name}</div>
                                     <div style="font-size:0.75rem; color:#94a3b8">${p.pack}</div>
                                 </td>
                                 <td>${p.price}</td>
                                 <td class="${p.stock<20?'text-danger':''}">${p.stock}</td>
                                 <td><input type="number" min="0" class="form-input line-qty" data-pid="${p.id}" onchange="App.Modals.calcOrder()"></td>
                                 <td style="text-align:right" id="sub-${p.id}">0.00</td>
                             </tr>
                         `).join('');
                         App.Modals.calcOrder(); // reset
                    }
                },
                openPay: (oid) => {
                     const ord = App.State.orders.find(o=>o.id===oid);
                     document.getElementById('np-inv-id').value = oid;
                     document.getElementById('np-inv-display').value = `${oid} (${ord.date})`;
                     document.getElementById('np-total').value = Utils.fmtMoney(ord.total);
                     const bal = ord.total - ord.paid;
                     document.getElementById('np-due').value = Utils.fmtMoney(bal);
                     document.getElementById('np-amt').value = bal;
                     
                     document.getElementById('modal-pay').classList.add('active');
                },
                calcOrder: () => {
                     let gTotal = 0;
                     const inputs = document.querySelectorAll('.line-qty');
                     inputs.forEach(inp => {
                          const pid = inp.dataset.pid;
                          const q = parseInt(inp.value) || 0;
                          const prod = App.State.products.find(p=>p.id===pid);
                          const sub = q * prod.price;
                          document.getElementById('sub-'+pid).innerText = sub.toFixed(2);
                          gTotal += sub;
                     });
                     document.getElementById('ord-grand-total').innerText = Utils.fmtMoney(gTotal);
                },
                close: (id) => document.getElementById(id).classList.remove('active')
            }
        };

        // Bootstrap on Load - Only Waiting for Google Callback
    </script>
</body>
</html>
