<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Himalayan Beverages ERP | Freskey Ops</title>
    
    <!-- External Libraries (CDN) -->
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            /* Branding Colors */
            --primary: #0D47A1;
            --primary-light: #5472d3;
            --secondary: #1976D2;
            --bg-body: #f1f5f9;
            --bg-sidebar: #111827;
            --bg-card: #ffffff;
            --text-dark: #1e293b;
            --text-gray: #64748b;
            --text-white: #f8fafc;
            
            /* Alerts */
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;

            --sidebar-width: 250px;
        }

        * { box-sizing: border-box; outline: none; }
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            margin: 0; padding: 0; 
            background: var(--bg-body); color: var(--text-dark); 
            height: 100vh; overflow: hidden; display: flex; 
        }

        /* --- SIDEBAR --- */
        aside {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            color: var(--text-white);
            display: flex; flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            z-index: 100;
        }
        .brand {
            padding: 20px; font-size: 1.3rem; font-weight: bold; 
            background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.1);
            display:flex; align-items:center; gap:10px;
        }
        .nav { flex:1; padding-top: 15px; overflow-y:auto; }
        .nav-item {
            padding: 12px 20px; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 10px;
            color: #9ca3af; border-left: 3px solid transparent;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.05); color: white;
        }
        .nav-item.active { border-left-color: var(--primary-light); }
        .nav-section {
            padding: 10px 20px; font-size: 0.7rem; text-transform: uppercase;
            color: #4b5563; font-weight: bold; margin-top: 10px;
        }
        .drive-status {
            padding: 15px; background: #0f172a; border-top: 1px solid #1f2937;
            font-size: 0.8rem;
        }
        .drive-status div { display: flex; align-items:center; gap: 8px; margin-bottom: 5px; }
        .dot { width: 8px; height: 8px; background: #64748b; border-radius: 50%; }
        .dot.online { background: var(--success); box-shadow: 0 0 5px var(--success); }

        /* --- MAIN AREA --- */
        main { flex: 1; display: flex; flex-direction: column; position: relative; }
        
        header {
            background: var(--bg-card); height: 60px; border-bottom: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
        }
        h2 { margin: 0; font-size: 1.2rem; }
        
        .viewport { flex: 1; overflow-y: auto; padding: 25px; }

        /* --- UI ELEMENTS --- */
        .card {
            background: var(--bg-card); padding: 20px; border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }
        .card h3 { margin-top: 0; color: var(--text-gray); font-size: 0.9rem; text-transform: uppercase; }

        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .kpi-box { padding: 15px; background:white; border-radius:6px; border-left: 4px solid var(--primary); box-shadow:0 1px 2px rgba(0,0,0,0.05); }
        .kpi-val { font-size: 1.8rem; font-weight: bold; margin-top: 5px; color: var(--text-dark); }
        
        /* Table */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        th { text-align: left; padding: 12px; background: #f8fafc; border-bottom: 2px solid #e2e8f0; color: var(--text-gray); }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        tr:hover td { background: #f8fafc; }

        /* Buttons */
        .btn { 
            padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; 
            font-size: 0.9rem; transition: 0.2s; font-weight: 500; display: inline-flex; align-items: center; gap:5px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); }
        .btn-success { background: var(--success); color: white; }
        .btn-secondary { background: white; border: 1px solid #cbd5e1; color: var(--text-dark); }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-sm { padding: 4px 10px; font-size: 0.8rem; }

        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; } }

        /* Modal */
        .modal-mask {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5); z-index: 500;
            display: none; align-items: center; justify-content: center;
        }
        .modal-mask.open { display: flex; }
        .modal-body {
            background: white; padding: 25px; border-radius: 8px;
            width: 500px; max-width: 90%; position: relative;
        }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 0.85rem; margin-bottom: 5px; font-weight: 600; }
        .form-control {
            width: 100%; padding: 10px; border: 1px solid #cbd5e1;
            border-radius: 4px; font-size: 0.95rem;
        }

        /* Invoice Badge */
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; }
        .st-paid { background: #dcfce7; color: #166534; }
        .st-unpaid { background: #fee2e2; color: #991b1b; }
        
        /* Alerts Toast */
        .toast-container { position: absolute; top: 70px; right: 20px; z-index: 200; }
        .toast { padding: 15px 20px; background: #334155; color: white; border-radius: 4px; margin-bottom: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); opacity: 0.95; animation: slideIn 0.3s; }
        @keyframes slideIn { from{ transform:translateX(100%); } to { transform: translateX(0); }}

    </style>
</head>
<body>

<aside>
    <div class="brand">
        <svg width="24" height="24" fill="white" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.94-1.47L12 11l-2.94-1.47L12 11zm10 2.66l-9 4.5v-2.12l7-3.5 2 1.12zM2 9.66l2-1.12 7 3.5v2.12l-9-4.5zM7.05 13.9l-5.02 2.51L12 21l9.98-4.59-5.04-2.45L12 16.3 7.05 13.9z"/></svg>
        FRESKEY ERP
    </div>
    <div class="nav">
        <div class="nav-item active" onclick="Router.go('dashboard')">
            <span>üìä</span> Dashboard
        </div>

        <div class="nav-section">Operations</div>
        <div class="nav-item" onclick="Router.go('crm')">
            <span>üë•</span> Sales & CRM
        </div>
        <div class="nav-item" onclick="Router.go('orders')">
            <span>üõí</span> Sales Orders
        </div>
        <div class="nav-item" onclick="Router.go('inventory')">
            <span>üì¶</span> Inventory / Stock
        </div>
        <div class="nav-item" onclick="Router.go('accounts')">
            <span>üí∞</span> Invoices & Ledger
        </div>

        <div class="nav-section">Configuration</div>
        <div class="nav-item" onclick="Router.go('settings')">
            <span>‚öôÔ∏è</span> System & Sync
        </div>
    </div>
    
    <div class="drive-status">
        <div id="drive-dot-row">
            <div class="dot" id="sync-dot"></div> 
            <span id="sync-text">Cloud Disconnected</span>
        </div>
        <small style="color:#64748b" id="sync-user"></small>
        <button id="btn-sync" onclick="GDocs.authenticate()" style="width:100%; margin-top:10px; border:none; background:#334155; color:#ccc; padding:6px; cursor:pointer; border-radius:3px;">
            Connect G-Drive
        </button>
    </div>
</aside>

<main>
    <header>
        <h2 id="page-title">Dashboard</h2>
        <div style="display:flex; gap:10px">
            <button class="btn btn-primary" onclick="Router.go('orders'); UI.openOrderModal()">+ New Sale</button>
            <div style="width:35px; height:35px; background:purple; color:white; border-radius:50%; display:flex; justify-content:center; align-items:center; font-weight:bold;">A</div>
        </div>
    </header>

    <div class="viewport" id="app-view">
        <!-- Content injected via JS -->
    </div>
    
    <div class="toast-container" id="toaster"></div>
</main>

<!-- ==== MODALS ==== -->

<!-- New Order Modal -->
<div class="modal-mask" id="modal-order">
    <div class="modal-body" style="width:700px">
        <h3>Create Sales Order</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
                <label class="form-label">Select Customer</label>
                <select id="ord-customer" class="form-control"></select>
            </div>
            <div>
                <label class="form-label">Date</label>
                <input type="date" id="ord-date" class="form-control">
            </div>
        </div>
        <hr>
        <table style="margin-bottom:15px">
            <thead style="font-size:0.8rem"><tr><th>Product</th><th>Stock</th><th>Price/Cs</th><th>Qty</th></tr></thead>
            <tbody id="ord-items-body"></tbody>
        </table>
        <div style="text-align:right; font-weight:bold; font-size:1.1rem; margin-bottom:20px;">
            Total: ‚Çπ<span id="ord-total">0</span>
        </div>
        <div style="text-align:right">
            <button class="btn btn-secondary" onclick="UI.closeModal('modal-order')">Cancel</button>
            <button class="btn btn-success" onclick="OrderOps.create()">Generate Invoice</button>
        </div>
    </div>
</div>

<!-- Purchase / Add Stock Modal -->
<div class="modal-mask" id="modal-purchase">
    <div class="modal-body">
        <h3>Stock In / Purchase Entry</h3>
        <p style="font-size:0.85rem; color:#666">Add items received from factory/supplier.</p>
        
        <div class="form-group">
            <label class="form-label">Product SKU</label>
            <select id="pch-sku" class="form-control">
                <!-- filled by JS -->
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Quantity Received (Cases)</label>
            <input type="number" id="pch-qty" class="form-control" value="0">
        </div>
        <div class="form-group">
            <label class="form-label">Ref / Batch No.</label>
            <input type="text" id="pch-batch" class="form-control" placeholder="e.g. PO-55102">
        </div>

        <div style="text-align:right; margin-top:20px;">
            <button class="btn btn-secondary" onclick="UI.closeModal('modal-purchase')">Cancel</button>
            <button class="btn btn-primary" onclick="InventoryOps.addStock()">Update Inventory</button>
        </div>
    </div>
</div>

<!-- New Customer Modal -->
<div class="modal-mask" id="modal-customer">
    <div class="modal-body">
        <h3>New Customer</h3>
        <div class="form-group"><label>Business Name</label><input id="new-c-name" class="form-control"></div>
        <div class="form-group"><label>Phone</label><input id="new-c-phone" class="form-control"></div>
        <div class="form-group"><label>Type</label>
            <select id="new-c-type" class="form-control">
                <option>Retailer</option>
                <option>Distributor</option>
                <option>Event</option>
            </select>
        </div>
        <div style="text-align:right;">
            <button class="btn btn-secondary" onclick="UI.closeModal('modal-customer')">Cancel</button>
            <button class="btn btn-primary" onclick="CRMOps.add()">Save</button>
        </div>
    </div>
</div>

<script>
    /** 
     * CONFIGURATION
     * 1. API Keys provided by user
     */
    const CONFIG = {
        AUTHORIZED_USER: 'freskeypiyo@gmail.com', // UI Warning only (Client side can't fully enforce without backend)
        API_KEY: 'AIzaSyCWo9OP6-QhyKWpfuV5oonyuC32IQHoOtE', 
        CLIENT_ID: '950010994560-v7p6cem78h9fsdp102iq4immb36t95ls.apps.googleusercontent.com',
        SCOPES: 'https://www.googleapis.com/auth/drive.file',
        DB_FILENAME: 'freskey-distribution-database.json'
    };

    /**
     * DATABASE STATE (In-Memory)
     */
    const DB = {
        products: [
            { id: "P200", name: "Freskey 200ml", price: 480, stock: 150 },
            { id: "P500", name: "Freskey 500ml", price: 360, stock: 80 },
            { id: "P1000", name: "Freskey 1L Bottle", price: 300, stock: 40 }
        ],
        customers: [
            { id: 101, name: "City Mart", phone: "9876543210", type: "Retailer", balance: 0 },
            { id: 102, name: "Highway Dhaba", phone: "9988776655", type: "HoReCa", balance: 2400 }
        ],
        orders: [], // { id, custId, items: [{pid, qty, amt}], total, date, status }
        invoices: [], // { id, orderId, total, status: 'Unpaid' | 'Paid' }
        ledgers: [] // { date, desc, type, amount }
    };

    /**
     * ROUTER & UI RENDERING
     */
    const Router = {
        current: 'dashboard',
        go: (route) => {
            Router.current = route;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // simple check based on click (nav handling handled inline)
            
            const titles = {
                dashboard: "Overview", crm: "Customer Management", orders: "Sales & Orders",
                inventory: "Inventory Management", accounts: "Ledgers & Payments", settings: "System Settings"
            };
            document.getElementById('page-title').innerText = titles[route];
            
            const view = document.getElementById('app-view');
            view.innerHTML = ""; // Clear current
            
            // RENDER LOGIC
            if(route === 'dashboard') Views.dashboard(view);
            if(route === 'crm') Views.crm(view);
            if(route === 'orders') Views.orders(view);
            if(route === 'inventory') Views.inventory(view);
            if(route === 'accounts') Views.accounts(view);
            if(route === 'settings') Views.settings(view);
        }
    };

    const Views = {
        dashboard: (el) => {
            const totalSales = DB.orders.reduce((acc,o) => acc + o.total, 0);
            const lowStock = DB.products.filter(p=>p.stock < 50).length;
            const pendingInv = DB.invoices.filter(i=>i.status==='Unpaid').length;

            el.innerHTML = `
                <div class="kpi-grid fade-in">
                    <div class="kpi-box"><h3>Total Sales</h3><div class="kpi-val">‚Çπ${totalSales.toLocaleString()}</div></div>
                    <div class="kpi-box" style="border-color:orange"><h3>Pending Payment</h3><div class="kpi-val">${pendingInv}</div></div>
                    <div class="kpi-box" style="border-color:red"><h3>Low Stock SKUs</h3><div class="kpi-val">${lowStock}</div></div>
                    <div class="kpi-box" style="border-color:green"><h3>Customers</h3><div class="kpi-val">${DB.customers.length}</div></div>
                </div>
                <div class="card fade-in">
                    <h3>Recent Ledger Activity</h3>
                    <ul style="padding-left:20px; font-size:0.9rem; color:#555">
                        ${DB.ledgers.slice(-5).reverse().map(l => `<li>${l.date} - ${l.desc} (‚Çπ${l.amount})</li>`).join('') || "<li>No recent activity</li>"}
                    </ul>
                </div>
            `;
        },
        inventory: (el) => {
            el.innerHTML = `
                <div class="fade-in">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px">
                        <h3>Stock Status</h3>
                        <button class="btn btn-primary" onclick="UI.openPurchaseModal()">+ Purchase / Add Stock</button>
                    </div>
                    <div class="card">
                        <table class="table-wrap">
                            <thead><tr><th>SKU ID</th><th>Product</th><th>Price / Case</th><th>Available Cases</th><th>Value (Approx)</th></tr></thead>
                            <tbody>
                                ${DB.products.map(p => `
                                    <tr style="${p.stock<50?'color:red':''}">
                                        <td>${p.id}</td>
                                        <td><b>${p.name}</b></td>
                                        <td>‚Çπ${p.price}</td>
                                        <td>${p.stock}</td>
                                        <td>‚Çπ${(p.stock*p.price).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        },
        orders: (el) => {
            el.innerHTML = `
                <div class="card fade-in">
                    <table class="table-wrap">
                        <thead><tr><th>Order ID</th><th>Date</th><th>Customer</th><th>Total</th><th>Status</th><th>Action</th></tr></thead>
                        <tbody>
                            ${DB.orders.map(o => {
                                const c = DB.customers.find(x => x.id == o.custId);
                                return `
                                <tr>
                                    <td>#${o.id}</td>
                                    <td>${o.date}</td>
                                    <td>${c ? c.name : 'Unknown'}</td>
                                    <td>‚Çπ${o.total}</td>
                                    <td><span class="badge" style="background:#eee">Completed</span></td>
                                    <td><button class="btn btn-sm btn-secondary" onclick="OrderOps.downloadPDF('${o.id}')">Download PDF</button></td>
                                </tr>`;
                            }).reverse().join('')}
                        </tbody>
                    </table>
                </div>
            `;
        },
        accounts: (el) => {
            el.innerHTML = `
                <div class="card fade-in">
                    <h3>Invoices Due</h3>
                    <table>
                        <thead><tr><th>Invoice #</th><th>Order #</th><th>Amount</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody>
                            ${DB.invoices.map(inv => `
                                <tr>
                                    <td>${inv.id}</td><td>#${inv.orderId}</td>
                                    <td>‚Çπ${inv.total}</td>
                                    <td><span class="badge ${inv.status==='Paid'?'st-paid':'st-unpaid'}">${inv.status}</span></td>
                                    <td>
                                        ${inv.status === 'Unpaid' 
                                          ? `<button class="btn btn-sm btn-success" onclick="AccountOps.recordPay('${inv.id}')">Record Pay</button>` 
                                          : '<span style="color:green;font-size:0.8rem">‚úî Cleared</span>'
                                        }
                                    </td>
                                </tr>
                            `).reverse().join('')}
                        </tbody>
                    </table>
                </div>
            `;
        },
        crm: (el) => {
            el.innerHTML = `
                <div class="card fade-in">
                    <div style="text-align:right; margin-bottom:10px"><button class="btn btn-primary" onclick="UI.openCustomerModal()">Add Customer</button></div>
                    <table>
                        <thead><tr><th>ID</th><th>Name</th><th>Phone</th><th>Type</th><th>Credit Bal</th></tr></thead>
                        <tbody>
                            ${DB.customers.map(c => `
                                <tr><td>${c.id}</td><td>${c.name}</td><td>${c.phone}</td><td>${c.type}</td>
                                <td style="${c.balance>0?'color:red':''}">${c.balance>0 ? '-‚Çπ'+c.balance : '0'}</td></tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        },
        settings: (el) => {
            el.innerHTML = `
                <div class="card fade-in">
                    <h3>Authorized Info</h3>
                    <p>System authorized for: <b>${CONFIG.AUTHORIZED_USER}</b></p>
                    <p>API Configured: Yes (Key ends with ...${CONFIG.API_KEY.slice(-5)})</p>
                    <hr>
                    <h3>Google Drive Backup</h3>
                    <p>Manual backup will overwrite <b>${CONFIG.DB_FILENAME}</b> in your drive root.</p>
                    <button class="btn btn-primary" onclick="GDocs.syncNow()">Force Backup Now</button>
                    <pre id="sync-logs" style="background:#333; color:#0f0; padding:10px; margin-top:10px; border-radius:5px; font-size:0.8rem;">Ready.</pre>
                </div>
            `;
        }
    };

    /**
     * BUSINESS LOGIC HANDLERS
     */
    const UI = {
        toast: (msg, type="info") => {
            const div = document.getElementById('toaster');
            const el = document.createElement('div');
            el.className = 'toast';
            el.innerHTML = msg;
            if(type==='success') el.style.background = '#065f46';
            if(type==='error') el.style.background = '#991b1b';
            div.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        },
        openModal: (id) => document.getElementById(id).classList.add('open'),
        closeModal: (id) => document.getElementById(id).classList.remove('open'),
        
        openPurchaseModal: () => {
            const sel = document.getElementById('pch-sku');
            sel.innerHTML = DB.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            UI.openModal('modal-purchase');
        },
        
        openOrderModal: () => {
            // Fill Customer List
            document.getElementById('ord-customer').innerHTML = DB.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('ord-date').valueAsDate = new Date();
            
            // Build item rows
            const body = document.getElementById('ord-items-body');
            body.innerHTML = '';
            DB.products.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.name}</td>
                    <td style="${p.stock<10?'color:red':''}">${p.stock}</td>
                    <td>‚Çπ${p.price}</td>
                    <td><input type="number" min="0" class="form-control qty-in" data-id="${p.id}" data-price="${p.price}" style="width:70px"></td>
                `;
                body.appendChild(tr);
            });
            
            // Calc listener
            const calcer = () => {
                let sum = 0;
                document.querySelectorAll('.qty-in').forEach(i => {
                    const q = parseInt(i.value) || 0;
                    sum += q * parseFloat(i.dataset.price);
                });
                document.getElementById('ord-total').innerText = sum;
            };
            document.querySelectorAll('.qty-in').forEach(i => i.addEventListener('input', calcer));
            UI.openModal('modal-order');
        },
        openCustomerModal: () => UI.openModal('modal-customer')
    };

    const InventoryOps = {
        addStock: () => {
            const sku = document.getElementById('pch-sku').value;
            const qty = parseInt(document.getElementById('pch-qty').value);
            const ref = document.getElementById('pch-batch').value;
            
            if(!qty || qty <= 0) return alert("Valid quantity required");

            const product = DB.products.find(p => p.id === sku);
            if(product) {
                product.stock += qty;
                DB.ledgers.push({ date: new Date().toLocaleDateString(), desc: `Stock In (${sku}) Ref: ${ref}`, amount: 0, type:'Stock' });
                
                UI.toast(`Added ${qty} cases to ${product.name}`, 'success');
                UI.closeModal('modal-purchase');
                if(Router.current === 'inventory') Router.go('inventory');
            }
        }
    };

    const OrderOps = {
        create: () => {
            const inputs = document.querySelectorAll('.qty-in');
            const cart = [];
            let total = 0;
            let hasStockError = false;

            inputs.forEach(input => {
                const q = parseInt(input.value) || 0;
                if(q > 0) {
                    const pid = input.dataset.id;
                    const p = DB.products.find(x => x.id === pid);
                    if(p.stock < q) {
                        hasStockError = true;
                        alert(`Not enough stock for ${p.name}. Available: ${p.stock}`);
                    } else {
                        cart.push({ pid, name: p.name, price: p.price, qty: q });
                        total += (p.price * q);
                    }
                }
            });

            if(hasStockError || cart.length === 0) return;

            // Execute Order
            const custId = document.getElementById('ord-customer').value;
            const orderId = 1000 + DB.orders.length + 1;
            
            // Deduct Stock
            cart.forEach(item => {
                const p = DB.products.find(x => x.id === item.pid);
                p.stock -= item.qty;
            });

            // Save Records
            const order = { id: orderId, custId: custId, items: cart, total, date: new Date().toLocaleDateString(), status: "Completed" };
            DB.orders.push(order);
            
            DB.invoices.push({ id: "INV-" + orderId, orderId: orderId, total: total, status: 'Unpaid' });
            
            const cust = DB.customers.find(c => c.id == custId);
            if(cust) cust.balance += total;

            UI.closeModal('modal-order');
            UI.toast(`Order #${orderId} Created`, 'success');
            
            // Ask for PDF
            if(confirm("Order Created. Download PDF Invoice now?")) {
                OrderOps.downloadPDF(orderId);
            }

            Router.go('orders');
        },
        downloadPDF: (oid) => {
            const { jsPDF } = window.jspdf;
            const order = DB.orders.find(o => o.id == oid);
            if(!order) return;
            const cust = DB.customers.find(c => c.id == order.custId);

            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text("Himalayan Beverages - INVOICE", 14, 20);
            
            doc.setFontSize(11);
            doc.text(`Invoice #: INV-${order.id}`, 14, 30);
            doc.text(`Date: ${order.date}`, 14, 36);
            doc.text(`Customer: ${cust ? cust.name : 'Unknown'}`, 14, 42);

            const rows = order.items.map(it => [it.name, it.qty, it.price, (it.qty*it.price)]);
            
            doc.autoTable({
                startY: 50,
                head: [['Product', 'Qty', 'Rate', 'Amount']],
                body: rows,
            });

            const finalY = doc.lastAutoTable.finalY || 60;
            doc.text(`Grand Total: ${order.total} INR`, 14, finalY + 10);
            
            // Real Download logic
            doc.save(`Invoice_Freskey_${oid}.pdf`);
        }
    };

    const AccountOps = {
        recordPay: (invId) => {
            const inv = DB.invoices.find(i => i.id === invId);
            if(inv && inv.status === 'Unpaid') {
                if(!confirm(`Mark Invoice ${invId} of ‚Çπ${inv.total} as PAID?`)) return;
                
                inv.status = 'Paid';
                
                // Ledger Entry
                DB.ledgers.push({ date: new Date().toLocaleDateString(), desc: `Payment received for ${invId}`, amount: inv.total });
                
                // Adjust Cust Balance
                const ord = DB.orders.find(o => o.id == inv.orderId);
                const cust = DB.customers.find(c => c.id == ord.custId);
                if(cust) cust.balance -= inv.total;

                UI.toast("Payment Recorded", 'success');
                Router.go('accounts'); // Refresh UI
            }
        }
    };
    
    const CRMOps = {
        add: () => {
            const name = document.getElementById('new-c-name').value;
            const phone = document.getElementById('new-c-phone').value;
            if(!name) return alert("Name required");
            
            DB.customers.push({
                id: 100 + DB.customers.length + 1,
                name, phone,
                type: document.getElementById('new-c-type').value,
                balance: 0
            });
            UI.closeModal('modal-customer');
            Router.go('crm');
        }
    };

    /**
     * GOOGLE DRIVE SYNC (Real Implementation)
     */
    const GDocs = {
        tokenClient: null,
        
        init: () => {
            // Load the client
            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: CONFIG.API_KEY,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                });
            });

            // Initialize Token Client (GIS)
            GDocs.tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: CONFIG.SCOPES,
                callback: (resp) => {
                    if (resp.error) throw resp;
                    GDocs.onAuthSuccess();
                },
            });
        },
        authenticate: () => {
            if(!GDocs.tokenClient) return alert("Google API not loaded yet. Check internet.");
            GDocs.tokenClient.requestAccessToken({prompt: 'consent'});
        },
        onAuthSuccess: () => {
            document.getElementById('sync-dot').classList.add('online');
            document.getElementById('sync-text').innerText = "Drive Connected";
            document.getElementById('btn-sync').innerText = "Sync Now";
            document.getElementById('btn-sync').setAttribute('onclick', 'GDocs.syncNow()');
            UI.toast("Google Account Linked", 'success');
            
            // Check for authorized user if possible or warn
            // Since client-side JS without backend verification implies we just trust the user clicked login
            console.log("Access Token received.");
        },
        syncNow: async () => {
            try {
                const logs = document.getElementById('sync-logs');
                if(logs) logs.innerText += "\n> Searching for DB file...";
                
                // 1. Check if file exists
                const q = `name = '${CONFIG.DB_FILENAME}' and trashed = false`;
                const searchRes = await gapi.client.drive.files.list({ q: q, fields: 'files(id, name)' });
                const files = searchRes.result.files;

                const fileContent = JSON.stringify(DB, null, 2);
                const fileBlob = new Blob([fileContent], {type: 'application/json'});
                
                if (files && files.length > 0) {
                    // Update existing
                    const fileId = files[0].id;
                    if(logs) logs.innerText += `\n> Found file (${fileId}). Updating...`;
                    
                    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                        method: 'PATCH',
                        headers: new Headers({ 
                            'Authorization': 'Bearer ' + gapi.client.getToken().access_token,
                            'Content-Type': 'application/json' 
                        }),
                        body: fileContent
                    });
                } else {
                    // Create New
                    if(logs) logs.innerText += `\n> File not found. Creating new...`;
                    
                    const metadata = { name: CONFIG.DB_FILENAME, mimeType: 'application/json' };
                    const formData = new FormData();
                    formData.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                    formData.append('file', fileBlob);

                    await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                        body: formData
                    });
                }

                if(logs) logs.innerText += `\n> SUCCESS. Synced at ${new Date().toLocaleTimeString()}`;
                UI.toast("Backup successfully saved to Drive", 'success');

            } catch(e) {
                console.error(e);
                alert("Sync Error: " + JSON.stringify(e));
            }
        }
    };

    // --- Init ---
    window.onload = () => {
        Router.go('dashboard');
        GDocs.init(); // Initialize Google API stubs
        
        // Initial Dummy Data Logic
        const firstC = DB.customers[0].id;
        DB.orders.push({id:1001, custId:firstC, items:[], total:480, date:"2025-10-10", status:'Completed'});
        DB.invoices.push({id:"INV-1001", orderId:1001, total:480, status:'Unpaid'});
        Views.dashboard(document.getElementById('app-view')); // Refresh view
    };

</script>

</body>
</html>
