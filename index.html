<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Freskey ERP - Water & Beverage Management</title>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    
    <style>
        /* =========================================
           1. CORE VARIABLES & RESET
           ========================================= */
        :root {
            --primary: #0077b6;
            --primary-dark: #023e8a;
            --secondary: #48cae4;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --sidebar-width: 260px;
            --header-height: 60px;
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            font-size: 14px;
        }

        /* =========================================
           2. LAYOUT & RESPONSIVENESS
           ========================================= */
        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .app-container.active { opacity: 1; pointer-events: all; }

        /* Sidebar */
        aside {
            width: var(--sidebar-width);
            background: #1e293b;
            color: white;
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .brand {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-size: 18px;
            font-weight: 700;
            border-bottom: 1px solid #334155;
            color: var(--secondary);
        }

        .nav-menu { flex: 1; overflow-y: auto; padding: 20px 0; }
        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #94a3b8;
            border-left: 3px solid transparent;
        }
        .nav-item:hover, .nav-item.active { background: #334155; color: white; border-left-color: var(--secondary); }

        /* Main Content */
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }

        header {
            height: var(--header-height);
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        .menu-toggle { display: none; font-size: 20px; cursor: pointer; color: var(--text-main); }
        .content-area { flex: 1; overflow-y: auto; padding: 20px; position: relative; }

        /* Mobile Responsive Rules */
        @media (max-width: 768px) {
            aside {
                position: fixed;
                top: 0; left: 0; height: 100%;
                transform: translateX(-100%);
                box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            }
            aside.open { transform: translateX(0); }
            .menu-toggle { display: block; margin-right: 15px; }
            .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr !important; }
            .card { padding: 15px; }
            .modal { width: 95% !important; margin: 10px; max-height: 85vh; }
            /* Mobile Overlay */
            .sidebar-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 90; display: none;
            }
            .sidebar-overlay.active { display: block; }
        }

        /* =========================================
           3. UI COMPONENTS
           ========================================= */
        .card { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .card-title { font-weight: 600; font-size: 16px; }

        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }

        .stat-box { background: white; padding: 15px; border-radius: var(--radius); border: 1px solid var(--border); }
        .stat-value { font-size: 22px; font-weight: 700; color: var(--primary); display: block; margin-top: 5px; }
        .stat-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; }

        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #f1f5f9; color: var(--text-main); border: 1px solid var(--border); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }

        .form-group { margin-bottom: 12px; }
        .form-label { display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; }
        .form-control { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; background: #fff; }
        
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; padding: 12px; background: #f8fafc; border-bottom: 2px solid var(--border); font-size: 12px; color: var(--text-muted); }
        td { padding: 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-block; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }

        /* Login Screen */
        .login-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex; align-items: center; justify-content: center; z-index: 2000;
        }
        .login-box { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; }
        .g-btn { width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 4px; background: white; font-weight: 500; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-top: 20px; }
        
        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: var(--radius); width: 600px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-body { padding: 20px; flex: 1; overflow-y: auto; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }

        /* Toast */
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #333; color: white; padding: 12px 20px; border-radius: 6px; animation: fadeIn 0.3s; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
        .loader.active { display: block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s; }
        .hidden { display: none !important; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    </style>
</head>
<body>

    <!-- MOBILE OVERLAY -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-wrapper">
        <div class="login-box">
            <h1 style="color: var(--primary); margin-bottom: 5px;">üíß AquaFlow</h1>
            <p style="color: var(--text-muted); margin-bottom: 20px;">Mobile ERP System</p>
            
            <div id="authLoader" class="loader"></div>
            <p id="authMessage" style="font-size:13px; margin-bottom:10px; color:var(--text-muted)">Please sign in to access data.</p>
            
            <button class="g-btn" onclick="handleAuthClick()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" style="width:18px; margin-right:10px;">
                Sign in with Google
            </button>
            <p style="margin-top:15px; font-size:11px; color:#999">Restricted to: freskeypiyo@gmail.com</p>
        </div>
    </div>

    <!-- MAIN APPLICATION -->
    <div id="app" class="app-container">
        <!-- SIDEBAR -->
        <aside id="sidebar">
            <div class="brand">freskey ERP <span style="font-size:10px; margin-left:auto; opacity:0.5">v1.1</span></div>
            <div class="nav-menu">
                <div class="nav-item active" onclick="navTo('dashboard')">üìä Dashboard</div>
                <div class="nav-item" onclick="navTo('products')">üì¶ Products</div>
                <div class="nav-item" onclick="navTo('inventory')">üè≠ Inventory</div>
                <div class="nav-item" onclick="navTo('customers')">üë• Customers</div>
                <div class="nav-item" onclick="navTo('orders')">üìù Orders</div>
                <div class="nav-item" onclick="navTo('dispatch')">üöö Dispatch</div>
                <div class="nav-item" onclick="navTo('payments')">üí∞ Payments</div>
                <div class="nav-item" onclick="navTo('reports')">üìà Reports</div>
                <div class="nav-item" onclick="navTo('settings')">‚öôÔ∏è Settings</div>
            </div>
        </aside>

        <!-- CONTENT -->
        <main>
            <header>
                <div style="display:flex; align-items:center;">
                    <span class="menu-toggle" onclick="toggleSidebar()">‚ò∞</span>
                    <h3 id="pageTitle" style="margin:0; font-size:18px;">Dashboard</h3>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <div class="user-avatar" id="userInitials">F</div>
                    <button class="btn btn-sm btn-secondary" onclick="handleSignoutClick()">Logout</button>
                </div>
            </header>

            <div class="content-area">
                
                <!-- 1. DASHBOARD -->
                <div id="view-dashboard" class="section active">
                    <div class="grid-4">
                        <div class="stat-box">
                            <span class="stat-label">Sales Today</span>
                            <span class="stat-value" id="dash-sales">‚Çπ0</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Orders Pending</span>
                            <span class="stat-value" id="dash-pending">0</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Total Due</span>
                            <span class="stat-value" id="dash-credit" style="color:var(--danger)">‚Çπ0</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Alerts</span>
                            <span class="stat-value" id="dash-lowstock" style="color:var(--warning)">0</span>
                        </div>
                    </div>
                    
                    <div class="grid-2" style="margin-top:20px;">
                        <div class="card">
                            <div class="card-header"><span class="card-title">Live Stock Overview</span></div>
                            <div class="table-container">
                                <table id="dash-inv-table">
                                    <thead><tr><th>Item</th><th>Factory</th><th>Whouse</th><th>Status</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><span class="card-title">Recent Activity</span></div>
                             <div id="dash-activity" style="font-size:13px; color:#555;">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- 2. PRODUCTS -->
                <div id="view-products" class="section">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Product List</span>
                            <button class="btn btn-primary btn-sm" onclick="openModal('modal-product')">+ Add</button>
                        </div>
                        <div class="table-container">
                            <table id="product-table">
                                <thead><tr><th>SKU</th><th>Name</th><th>Size</th><th>MRP</th><th>Rate</th><th>Action</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 3. INVENTORY -->
                <div id="view-inventory" class="section">
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header"><span class="card-title">Add/Move Stock</span></div>
                            <form onsubmit="handleStockAdjust(event)">
                                <div class="form-group">
                                    <label class="form-label">Action</label>
                                    <select id="inv-type" class="form-control">
                                        <option value="inward">Production (Add to Factory)</option>
                                        <option value="transfer">Transfer (Factory ‚Üí Warehouse)</option>
                                        <option value="damage">Damage (Remove)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Product</label>
                                    <select id="inv-product" class="form-control"></select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Quantity</label>
                                    <input type="number" id="inv-qty" class="form-control" required min="1">
                                </div>
                                <button type="submit" class="btn btn-primary" style="width:100%">Update Stock</button>
                            </form>
                        </div>
                        <div class="card">
                            <div class="card-header"><span class="card-title">Current Holdings</span></div>
                            <div class="table-container">
                                <table id="inventory-table">
                                    <thead><tr><th>Product</th><th>Fact.</th><th>Whse.</th><th>Van</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. CUSTOMERS -->
                <div id="view-customers" class="section">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Customers</span>
                            <button class="btn btn-primary btn-sm" onclick="openModal('modal-customer')">+ New</button>
                        </div>
                        <div class="table-container">
                            <table id="customer-table">
                                <thead><tr><th>Name</th><th>Region</th><th>Type</th><th>Due Amt</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 5. ORDERS -->
                <div id="view-orders" class="section">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Orders</span>
                            <button class="btn btn-primary btn-sm" onclick="openOrderModal()">+ New Order</button>
                        </div>
                        <div class="table-container">
                            <table id="order-table">
                                <thead><tr><th>ID</th><th>Cust</th><th>Amt</th><th>Status</th><th>Action</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 6. DISPATCH -->
                <div id="view-dispatch" class="section">
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header"><span class="card-title">Ready for Dispatch</span></div>
                            <div id="dispatch-pending-list"></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><span class="card-title">Out / Delivered</span></div>
                            <div id="dispatch-active-list"></div>
                        </div>
                    </div>
                </div>

                <!-- 7. PAYMENTS -->
                <div id="view-payments" class="section">
                    <div class="card">
                        <div class="card-header"><span class="card-title">Receive Payment</span></div>
                        <form onsubmit="handleAddPayment(event)" class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Customer</label>
                                <select id="pay-customer" class="form-control" onchange="updatePayDue()"></select>
                                <div id="pay-due-label" style="font-size:11px; color:red; text-align:right; margin-top:2px;">Due: ‚Çπ0</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount</label>
                                <input type="number" id="pay-amount" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Mode</label>
                                <select id="pay-mode" class="form-control">
                                    <option>Cash</option><option>UPI</option><option>Bank</option>
                                </select>
                            </div>
                            <div class="form-group" style="display:flex; align-items:flex-end;">
                                <button type="submit" class="btn btn-success" style="width:100%">Receive</button>
                            </div>
                        </form>
                    </div>
                    <div class="card">
                        <div class="card-header"><span class="card-title">Transaction History</span></div>
                        <div class="table-container">
                            <table id="ledger-table"><thead><tr><th>Date</th><th>Customer</th><th>Amount</th><th>Mode</th></tr></thead><tbody></tbody></table>
                        </div>
                    </div>
                </div>

                <!-- 8. REPORTS & SETTINGS -->
                <div id="view-reports" class="section">
                     <div class="card">
                        <h3>Export Data</h3>
                        <p>Download backup of current system state.</p>
                        <br>
                        <button class="btn btn-secondary" onclick="exportData()">Download JSON</button>
                     </div>
                </div>
                <div id="view-settings" class="section">
                    <div class="card">
                        <h3>System Reset</h3>
                        <p style="color:var(--danger)">Warning: This will delete all data.</p>
                        <br>
                        <button class="btn btn-danger" onclick="resetDatabase()">Factory Reset</button>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODALS -->
    <!-- Product Modal -->
    <div id="modal-product" class="modal-overlay">
        <div class="modal">
            <div class="card-header"><h3>Add Product</h3><span onclick="closeModal('modal-product')" style="cursor:pointer; font-size:20px;">&times;</span></div>
            <form onsubmit="saveProduct(event)">
                <div class="modal-body">
                    <div class="form-group"><label>Name</label><input id="prod-name" class="form-control" required></div>
                    <div class="grid-2">
                        <div class="form-group"><label>Size</label><input id="prod-size" class="form-control"></div>
                        <div class="form-group"><label>Type</label><select id="prod-type" class="form-control"><option>Bottle</option><option>Jar</option></select></div>
                    </div>
                    <div class="grid-2">
                        <div class="form-group"><label>MRP</label><input type="number" id="prod-mrp" class="form-control" required></div>
                        <div class="form-group"><label>Rate</label><input type="number" id="prod-rate" class="form-control" required></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modal-product')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customer Modal -->
    <div id="modal-customer" class="modal-overlay">
        <div class="modal">
            <div class="card-header"><h3>Add Customer</h3><span onclick="closeModal('modal-customer')" style="cursor:pointer; font-size:20px;">&times;</span></div>
            <form onsubmit="saveCustomer(event)">
                <div class="modal-body">
                    <div class="form-group"><label>Shop/Name</label><input id="cust-name" class="form-control" required></div>
                    <div class="form-group"><label>Region</label><input id="cust-region" class="form-control"></div>
                    <div class="grid-2">
                        <div class="form-group"><label>Type</label><select id="cust-type" class="form-control"><option>Distributor</option><option>Retailer</option></select></div>
                        <div class="form-group"><label>Phone</label><input id="cust-phone" class="form-control"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modal-customer')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Modal -->
    <div id="modal-order" class="modal-overlay">
        <div class="modal">
            <div class="card-header"><h3>New Order</h3><span onclick="closeModal('modal-order')" style="cursor:pointer; font-size:20px;">&times;</span></div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Customer</label>
                    <select id="order-cust" class="form-control"></select>
                </div>
                <div style="background:#f8fafc; padding:10px; border-radius:6px; margin-bottom:10px;">
                    <div class="grid-2">
                        <select id="order-prod-select" class="form-control"></select>
                        <input type="number" id="order-prod-qty" class="form-control" placeholder="Qty">
                    </div>
                    <button class="btn btn-secondary btn-sm" style="width:100%; margin-top:5px;" onclick="addOrderLine()">+ Add Item</button>
                </div>
                <div class="table-container" style="max-height:150px; overflow-y:auto; border:1px solid #eee;">
                    <table id="order-lines-table"><thead><tr><th>Item</th><th>Qty</th><th>Tot</th><th>X</th></tr></thead><tbody></tbody></table>
                </div>
                <div style="text-align:right; font-weight:bold; margin-top:10px; font-size:16px;">Total: ‚Çπ<span id="order-total-disp">0</span></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-order')">Close</button>
                <button class="btn btn-primary" onclick="submitOrder()">Confirm Order</button>
            </div>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-area" class="toast-container"></div>

    <script>
        // CONFIG
        const CLIENT_ID = '950010994560-v7p6cem78h9fsdp102iq4immb36t95ls.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCWo9OP6-QhyKWpfuV5oonyuC32IQHoOtE';
        const TARGET_EMAIL = 'freskeypiyo@gmail.com';
        
        // SCOPES: Drive File access + UserInfo to verify email
        const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email';
        const DB_FILENAME = 'aquaflow_erp_db.json';

        // STATE
        let tokenClient;
        let dbFileId = null;
        let appData = {};
        let currentOrderLines = [];

        // --- AUTH LOGIC ---
        function handleAuthClick() {
            document.getElementById('authLoader').classList.add('active');
            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [
                        'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                        'https://www.googleapis.com/discovery/v1/apis/oauth2/v2/rest'
                    ],
                });

                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: async (resp) => {
                        if (resp.error) {
                            showAuthMsg("Auth Error: " + resp.error, "red");
                            return;
                        }
                        await verifyUserAndLoad();
                    },
                });

                tokenClient.requestAccessToken({prompt: 'consent'});
            });
        }

        async function verifyUserAndLoad() {
            try {
                // Check Email
                const userInfo = await gapi.client.oauth2.userinfo.get();
                const email = userInfo.result.email;
                
                if (email !== TARGET_EMAIL) {
                    showAuthMsg(`Access Denied. Signed in as ${email}. Expected: ${TARGET_EMAIL}`, "red");
                    // Revoke token immediately
                    google.accounts.oauth2.revoke(gapi.client.getToken().access_token);
                    return;
                }

                showAuthMsg("User Verified! Searching Database...", "green");
                await findOrCreateDB();

            } catch (err) {
                showAuthMsg("Verification Failed: " + err.message, "red");
            }
        }

        async function findOrCreateDB() {
            try {
                const response = await gapi.client.drive.files.list({
                    'pageSize': 1,
                    'fields': "files(id, name)",
                    'q': `name = '${DB_FILENAME}' and trashed = false`
                });
                
                const files = response.result.files;
                if (files && files.length > 0) {
                    dbFileId = files[0].id;
                    await loadDatabase();
                } else {
                    await createDatabase();
                }
            } catch (err) {
                showAuthMsg("DB Error: " + err.message, "red");
            }
        }

        async function createDatabase() {
            appData = generateSeedData();
            const content = JSON.stringify(appData);
            const fileMetadata = { 'name': DB_FILENAME, 'mimeType': 'application/json' };
            
            try {
                // Create file logic (using multipart upload simplified for browser JS)
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
                form.append('file', new Blob([content], { type: 'application/json' }));

                const accessToken = gapi.client.getToken().access_token;
                const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                    body: form
                });
                const val = await res.json();
                dbFileId = val.id;
                enterApp();
            } catch (err) {
                showAuthMsg("Create Failed: " + err.message, "red");
            }
        }

        async function loadDatabase() {
            try {
                const response = await gapi.client.drive.files.get({
                    fileId: dbFileId,
                    alt: 'media'
                });
                appData = response.result;
                if(!appData.products) appData = generateSeedData(); // recovery
                enterApp();
            } catch (err) {
                showAuthMsg("Load Failed: " + err.message, "red");
            }
        }

        async function saveDatabase() {
            if (!dbFileId) return;
            const content = JSON.stringify(appData);
            try {
                await gapi.client.request({
                    path: '/upload/drive/v3/files/' + dbFileId,
                    method: 'PATCH',
                    params: { uploadType: 'media' },
                    body: content
                });
            } catch (err) {
                showToast("Sync Error", "error");
            }
        }

        function enterApp() {
            document.getElementById('loginScreen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').classList.add('active');
                renderAll();
                // Auto sync
                setInterval(saveDatabase, 30000); 
            }, 500);
        }

        function showAuthMsg(msg, color) {
            const el = document.getElementById('authMessage');
            el.innerText = msg;
            el.style.color = color === "red" ? "var(--danger)" : "var(--success)";
            document.getElementById('authLoader').classList.remove('active');
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) google.accounts.oauth2.revoke(token.access_token);
            location.reload();
        }

        // --- UI LOGIC ---

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.querySelector('.sidebar-overlay');
            sb.classList.toggle('open');
            ov.classList.toggle('active');
        }

        function navTo(pageId) {
            // Close sidebar on mobile upon navigation
            document.getElementById('sidebar').classList.remove('open');
            document.querySelector('.sidebar-overlay').classList.remove('active');

            // Update Menu
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // Title
            document.getElementById('pageTitle').innerText = pageId.charAt(0).toUpperCase() + pageId.slice(1);
            
            // Sections
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + pageId).classList.add('active');

            renderAll();
        }

        function renderAll() {
            renderDashboard();
            renderProducts();
            renderCustomers();
            renderInventory();
            renderOrders();
            renderDispatch();
            renderPayments();
        }

        // 1. DASHBOARD
        function renderDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const sales = appData.orders
                .filter(o => o.date === today)
                .reduce((sum, o) => sum + o.total, 0);
            
            const due = appData.customers.reduce((sum, c) => sum + (c.due || 0), 0);
            const pending = appData.orders.filter(o => o.status !== 'Delivered').length;
            
            document.getElementById('dash-sales').innerText = `‚Çπ${sales}`;
            document.getElementById('dash-pending').innerText = pending;
            document.getElementById('dash-credit').innerText = `‚Çπ${due}`;

            const tbody = document.querySelector('#dash-inv-table tbody');
            tbody.innerHTML = '';
            appData.inventory.slice(0,5).forEach(i => {
                const p = appData.products.find(x => x.sku === i.sku);
                if(p) tbody.innerHTML += `<tr><td>${p.name}</td><td>${i.factory}</td><td>${i.warehouse}</td><td>${i.warehouse < 50 ? '‚ö†Ô∏è' : 'OK'}</td></tr>`;
            });
        }

        // 2. PRODUCTS
        function renderProducts() {
            const tbody = document.querySelector('#product-table tbody');
            tbody.innerHTML = '';
            const opts = appData.products.map(p => `<option value="${p.sku}">${p.name} (${p.size})</option>`).join('');
            
            // Update dropdowns
            ['inv-product', 'order-prod-select'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.innerHTML = opts;
            });

            appData.products.forEach(p => {
                tbody.innerHTML += `<tr><td>${p.sku}</td><td>${p.name}</td><td>${p.size}</td><td>${p.mrp}</td><td>${p.rate}</td><td><button class="btn btn-danger btn-sm" onclick="delProduct('${p.sku}')">X</button></td></tr>`;
            });
        }
        function saveProduct(e) {
            e.preventDefault();
            const sku = 'SKU' + Math.floor(Math.random()*10000);
            appData.products.push({
                sku: sku,
                name: document.getElementById('prod-name').value,
                size: document.getElementById('prod-size').value,
                mrp: parseFloat(document.getElementById('prod-mrp').value),
                rate: parseFloat(document.getElementById('prod-rate').value)
            });
            appData.inventory.push({sku:sku, factory:0, warehouse:0, van:0});
            closeModal('modal-product');
            renderProducts();
            saveDatabase();
        }
        function delProduct(sku) {
            if(confirm('Delete?')) {
                appData.products = appData.products.filter(p => p.sku !== sku);
                renderProducts(); saveDatabase();
            }
        }

        // 3. INVENTORY
        function renderInventory() {
            const tbody = document.querySelector('#inventory-table tbody');
            tbody.innerHTML = '';
            appData.inventory.forEach(i => {
                const p = appData.products.find(x => x.sku === i.sku);
                if(p) tbody.innerHTML += `<tr><td>${p.name}</td><td>${i.factory}</td><td>${i.warehouse}</td><td>${i.van}</td></tr>`;
            });
        }
        function handleStockAdjust(e) {
            e.preventDefault();
            const type = document.getElementById('inv-type').value;
            const sku = document.getElementById('inv-product').value;
            const qty = parseInt(document.getElementById('inv-qty').value);
            const item = appData.inventory.find(i => i.sku === sku);

            if(type === 'inward') {
                item.factory += qty;
                showToast('Stock Added', 'success');
            } else if (type === 'transfer') {
                if(item.factory >= qty) { item.factory -= qty; item.warehouse += qty; showToast('Transferred', 'success'); }
                else showToast('Not enough Factory Stock', 'error');
            } else {
                item.warehouse = Math.max(0, item.warehouse - qty);
                showToast('Stock Deducted', 'warning');
            }
            document.getElementById('inv-qty').value = '';
            renderInventory(); saveDatabase();
        }

        // 4. CUSTOMERS
        function renderCustomers() {
            const tbody = document.querySelector('#customer-table tbody');
            tbody.innerHTML = '';
            const opts = '<option value="">Select</option>' + appData.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('order-cust').innerHTML = opts;
            document.getElementById('pay-customer').innerHTML = opts;

            appData.customers.forEach(c => {
                tbody.innerHTML += `<tr><td>${c.name}</td><td>${c.region}</td><td>${c.type}</td><td style="color:${c.due>0?'red':'green'}">‚Çπ${c.due}</td></tr>`;
            });
        }
        function saveCustomer(e) {
            e.preventDefault();
            appData.customers.push({
                id: 'C'+Date.now(),
                name: document.getElementById('cust-name').value,
                region: document.getElementById('cust-region').value,
                type: document.getElementById('cust-type').value,
                phone: document.getElementById('cust-phone').value,
                due: 0
            });
            closeModal('modal-customer');
            renderCustomers(); saveDatabase();
        }

        // 5. ORDERS
        function openOrderModal() { currentOrderLines=[]; renderOrderLines(); openModal('modal-order'); }
        function addOrderLine() {
            const sku = document.getElementById('order-prod-select').value;
            const qty = parseInt(document.getElementById('order-prod-qty').value);
            if(!sku || !qty) return;
            const p = appData.products.find(x => x.sku === sku);
            const inv = appData.inventory.find(i => i.sku === sku);
            
            if(inv.warehouse < qty) { showToast('Not enough warehouse stock', 'error'); return; }
            
            currentOrderLines.push({sku:sku, name:p.name, qty:qty, total:qty*p.rate});
            renderOrderLines();
        }
        function renderOrderLines() {
            const tbody = document.querySelector('#order-lines-table tbody');
            tbody.innerHTML = '';
            let total = 0;
            currentOrderLines.forEach((l, i) => {
                total += l.total;
                tbody.innerHTML += `<tr><td>${l.name}</td><td>${l.qty}</td><td>${l.total}</td><td onclick="currentOrderLines.splice(${i},1);renderOrderLines()">‚ùå</td></tr>`;
            });
            document.getElementById('order-total-disp').innerText = total;
        }
        function submitOrder() {
            const cid = document.getElementById('order-cust').value;
            if(!cid || currentOrderLines.length===0) return showToast('Invalid Order', 'error');
            
            const total = currentOrderLines.reduce((s,l)=>s+l.total,0);
            const order = {
                id: 'ORD-'+Math.floor(Math.random()*1000),
                date: new Date().toISOString().split('T')[0],
                customerId: cid,
                items: currentOrderLines,
                total: total,
                status: 'Pending'
            };
            
            // Update Stock & Due
            currentOrderLines.forEach(l => {
                const inv = appData.inventory.find(i => i.sku === l.sku);
                inv.warehouse -= l.qty;
                inv.van += l.qty;
            });
            const cust = appData.customers.find(c => c.id === cid);
            cust.due += total;
            
            appData.orders.unshift(order);
            closeModal('modal-order');
            renderAll(); saveDatabase(); showToast('Order Created', 'success');
        }
        function renderOrders() {
            const tbody = document.querySelector('#order-table tbody');
            tbody.innerHTML = '';
            appData.orders.forEach(o => {
                const c = appData.customers.find(x => x.id === o.customerId);
                tbody.innerHTML += `<tr><td>${o.id}</td><td>${c?c.name:'?'}</td><td>‚Çπ${o.total}</td><td>${o.status}</td><td><button class="btn btn-sm btn-secondary">üëÅÔ∏è</button></td></tr>`;
            });
        }

        // 6. DISPATCH
        function renderDispatch() {
            const pDiv = document.getElementById('dispatch-pending-list');
            const aDiv = document.getElementById('dispatch-active-list');
            pDiv.innerHTML = ''; aDiv.innerHTML = '';
            
            appData.orders.forEach(o => {
                const c = appData.customers.find(x => x.id === o.customerId);
                const html = `
                    <div class="card" style="padding:10px; margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between"><b>${o.id}</b> <span>${c.region}</span></div>
                        <div style="font-size:12px; color:#666">${o.items.map(i=>`${i.qty}x ${i.name}`).join(', ')}</div>
                        <div style="margin-top:5px; text-align:right">
                            ${o.status==='Pending' ? `<button class="btn btn-primary btn-sm" onclick="setStatus('${o.id}','Dispatched')">Dispatch üöö</button>` : ''}
                            ${o.status==='Dispatched' ? `<button class="btn btn-success btn-sm" onclick="setStatus('${o.id}','Delivered')">Delivered ‚úÖ</button>` : ''}
                        </div>
                    </div>`;
                if(o.status==='Pending') pDiv.innerHTML += html;
                else if(o.status==='Dispatched') aDiv.innerHTML += html;
            });
        }
        function setStatus(oid, status) {
            const o = appData.orders.find(x => x.id === oid);
            o.status = status;
            if(status === 'Delivered') {
                o.items.forEach(i => {
                    const inv = appData.inventory.find(x => x.sku === i.sku);
                    if(inv.van >= i.qty) inv.van -= i.qty;
                });
            }
            renderAll(); saveDatabase();
        }

        // 7. PAYMENTS
        function updatePayDue() {
            const cid = document.getElementById('pay-customer').value;
            const c = appData.customers.find(x => x.id === cid);
            document.getElementById('pay-due-label').innerText = c ? `Due: ‚Çπ${c.due}` : 'Due: ‚Çπ0';
        }
        function handleAddPayment(e) {
            e.preventDefault();
            const cid = document.getElementById('pay-customer').value;
            const amt = parseFloat(document.getElementById('pay-amount').value);
            const mode = document.getElementById('pay-mode').value;
            
            const c = appData.customers.find(x => x.id === cid);
            c.due -= amt;
            
            if(!appData.transactions) appData.transactions = [];
            appData.transactions.unshift({date: new Date().toISOString(), customerId: cid, amount: amt, mode: mode});
            
            renderAll(); saveDatabase(); showToast('Payment Received', 'success');
            document.getElementById('pay-amount').value = '';
        }
        function renderPayments() {
            const tbody = document.querySelector('#ledger-table tbody');
            tbody.innerHTML = '';
            (appData.transactions || []).forEach(t => {
                const c = appData.customers.find(x => x.id === t.customerId);
                tbody.innerHTML += `<tr><td>${t.date.split('T')[0]}</td><td>${c?c.name:'?'}</td><td>‚Çπ${t.amount}</td><td>${t.mode}</td></tr>`;
            });
        }

        // UTILS
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showToast(msg, type) {
            const d = document.createElement('div'); d.className = `toast ${type}`; d.innerText = msg;
            document.getElementById('toast-area').appendChild(d);
            setTimeout(() => d.remove(), 3000);
        }
        function resetDatabase() { if(confirm('Reset all data?')) { appData = generateSeedData(); saveDatabase(); location.reload(); } }
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
            const a = document.createElement('a'); a.href = dataStr; a.download = "aquaflow_backup.json"; a.click();
        }

        function generateSeedData() {
            return {
                products: [{sku:'P1', name:'20L Jar', size:'20L', mrp:90, rate:50}, {sku:'P2', name:'500ml Bottle', size:'500ml', mrp:20, rate:10}],
                inventory: [{sku:'P1', factory:100, warehouse:50, van:0}, {sku:'P2', factory:1000, warehouse:500, van:0}],
                customers: [{id:'C1', name:'City Mart', region:'North', type:'Retailer', due:500, phone:'9998887776'}],
                orders: [],
                transactions: []
            };
        }
    </script>
</body>
</html>
