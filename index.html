<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Himalayan Beverages | Enterprise Operations Platform</title>
    
    <!-- 
      ===================================================================
      EXTERNAL DEPENDENCIES (Loaded via CDN)
      =================================================================== 
      1. Google Identity Services (GIS) - For Auth
      2. Google API Client (GAPI) - For Drive Rest API
      3. JSPDF - For client-side PDF generation
      4. JSPDF-Autotable - For HTML Table to PDF conversion
    -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <!-- 
      ===================================================================
      SECTION 1: CSS & STYLING
      A robust Design System defining colors, grids, typography, 
      components (cards, modals, inputs), and layout.
      =================================================================== 
    -->
    <style>
        :root {
            /* --- COLOR PALETTE (Enterprise Blue) --- */
            --brand-primary: #1565C0;      /* Blue 800 */
            --brand-secondary: #0D47A1;    /* Blue 900 */
            --brand-accent: #2196F3;       /* Blue 500 */
            
            --success-color: #2E7D32;
            --success-bg: #E8F5E9;
            
            --warning-color: #EF6C00;
            --warning-bg: #FFF3E0;
            
            --danger-color: #C62828;
            --danger-bg: #FFEBEE;
            
            --info-color: #0277BD;
            --info-bg: #E1F5FE;

            /* --- NEUTRALS --- */
            --bg-body: #F4F7FA;
            --bg-sidebar: #1E293B;        /* Slate 800 */
            --bg-card: #FFFFFF;
            --text-main: #1F2937;
            --text-muted: #64748B;
            --text-inverted: #F8FAFC;
            --border-light: #E2E8F0;
            
            /* --- DIMENSIONS --- */
            --sidebar-width: 280px;
            --header-height: 70px;
            --radius-md: 8px;
            --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --transition-speed: 0.3s;
        }

        /* --- RESET --- */
        * {
            box-sizing: border-box;
            outline: none;
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* App-like Interface */
        }

        a { text-decoration: none; color: inherit; }
        ul { list-style: none; padding: 0; margin: 0; }
        button { border: none; font-family: inherit; }

        /* --- LAYOUT GRID --- */
        #app-root {
            display: flex;
            height: 100%;
            width: 100%;
        }

        /* --- SIDEBAR --- */
        aside {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            color: var(--text-inverted);
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255,255,255,0.05);
            transition: margin-left var(--transition-speed);
            z-index: 50;
        }

        .brand-header {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 24px;
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            background-color: rgba(0,0,0,0.15);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .brand-header svg {
            margin-right: 12px;
            color: var(--brand-accent);
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 24px 16px;
        }

        .nav-category {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #94A3B8;
            font-weight: 600;
            margin-bottom: 8px;
            padding-left: 12px;
            letter-spacing: 0.05em;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 4px;
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
            color: #CBD5E1;
            font-size: 0.95rem;
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .nav-item:hover {
            background-color: rgba(255,255,255,0.08);
            color: #FFFFFF;
        }

        .nav-item.active {
            background-color: var(--brand-primary);
            color: #FFFFFF;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        .nav-item.active svg { opacity: 1; }

        /* Sidebar Footer (Sync Status) */
        .sidebar-footer {
            padding: 20px;
            background-color: rgba(0,0,0,0.2);
            border-top: 1px solid rgba(255,255,255,0.05);
            font-size: 0.85rem;
        }
        
        .cloud-widget {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .status-dot {
            height: 8px;
            width: 8px;
            background-color: #64748B;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 0 2px rgba(100,116,139,0.3);
            transition: background 0.3s;
        }

        .status-dot.online {
            background-color: #10B981;
            box-shadow: 0 0 0 2px rgba(16,185,129,0.3);
            animation: pulse 2s infinite;
        }

        /* --- MAIN CONTENT AREA --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Top Header */
        .top-bar {
            height: var(--header-height);
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 32px;
            box-shadow: var(--shadow-sm);
        }

        .page-info h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-main);
            font-weight: 600;
        }

        .page-info span {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-pill {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            background-color: var(--bg-body);
            border-radius: 20px;
            border: 1px solid var(--border-light);
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background-color: var(--brand-accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }

        /* Viewport */
        .viewport-scroller {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
            scroll-behavior: smooth;
        }

        /* --- COMPONENT: BUTTONS --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            font-weight: 500;
            font-size: 0.9rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            gap: 8px;
            line-height: 1;
        }
        
        .btn:active { transform: translateY(1px); }

        .btn-primary { background: var(--brand-primary); color: white; }
        .btn-primary:hover { background: var(--brand-secondary); box-shadow: var(--shadow-sm); }
        
        .btn-secondary { background: white; border: 1px solid var(--border-light); color: var(--text-main); }
        .btn-secondary:hover { background: #F8FAFC; border-color: #CBD5E1; }
        
        .btn-success { background: var(--success-color); color: white; }
        .btn-success:hover { background: #1B5E20; }
        
        .btn-danger { background: white; border:1px solid var(--danger-color); color: var(--danger-color); }
        .btn-danger:hover { background: var(--danger-bg); }

        .btn-ghost { background: transparent; color: var(--brand-primary); }
        .btn-ghost:hover { text-decoration: underline; }

        .btn-full { width: 100%; }

        /* --- COMPONENT: CARDS --- */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
            transition: box-shadow 0.3s;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .card-body {
            padding: 24px;
        }

        /* --- COMPONENT: STAT GRID --- */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; width: 100%; height: 4px;
            background: var(--brand-primary);
        }
        
        .stat-card.stat-green::after { background: var(--success-color); }
        .stat-card.stat-orange::after { background: var(--warning-color); }
        .stat-card.stat-red::after { background: var(--danger-color); }

        .stat-title {
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-main);
        }
        
        /* --- COMPONENT: TABLES --- */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            border-radius: 6px;
            border: 1px solid var(--border-light);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        .data-table th {
            text-align: left;
            padding: 14px 24px;
            background-color: #F8FAFC;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-light);
        }

        .data-table td {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-main);
            vertical-align: middle;
        }

        .data-table tbody tr:hover {
            background-color: #F8FAFC;
        }

        /* --- COMPONENT: BADGES --- */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 12px;
            line-height: 1.2;
        }

        .badge-success { background: var(--success-bg); color: var(--success-color); }
        .badge-warning { background: var(--warning-bg); color: var(--warning-color); }
        .badge-danger  { background: var(--danger-bg);  color: var(--danger-color); }
        .badge-info    { background: var(--info-bg);    color: var(--info-color); }
        .badge-neutral { background: #F1F5F9; color: #64748B; }

        /* --- COMPONENT: FORMS & INPUTS --- */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-main);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            font-size: 0.95rem;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            transition: border 0.2s;
            background: #fff;
        }

        .form-control:focus {
            border-color: var(--brand-accent);
            box-shadow: 0 0 0 3px rgba(33,150,243, 0.1);
        }

        /* --- COMPONENT: MODALS --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(2px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal-overlay.open {
            display: flex;
            opacity: 1;
        }

        .modal-window {
            background: #fff;
            border-radius: 12px;
            width: 600px;
            max-width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-overlay.open .modal-window {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title { margin:0; font-size:1.25rem; }
        .modal-close { font-size: 1.5rem; cursor: pointer; color: #999; }
        .modal-body { padding: 24px; }
        
        .modal-footer {
            padding: 20px 24px;
            background-color: #F8FAFC;
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .w-full { width: 100%; }
        .mb-4 { margin-bottom: 1rem; }

        /* Animation */
        @keyframes pulse { 
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        /* Toaster Notifications */
        #toast-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 2000;
        }

        .toast-msg {
            min-width: 300px;
            background: #333;
            color: #fff;
            padding: 16px 20px;
            border-radius: 6px;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideInRight 0.3s ease-out;
        }

        .toast-msg.success { border-left: 5px solid var(--success-color); }
        .toast-msg.error { border-left: 5px solid var(--danger-color); }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Printer Logic */
        @media print {
            aside, .top-bar, .header-actions, .btn { display: none; }
            .card { box-shadow: none; border: none; }
        }

    </style>
</head>

<body>

    <div id="app-root">
        <!-- SIDEBAR START -->
        <aside id="app-sidebar">
            <div class="brand-header">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
                FRESKEY ERP
            </div>
            
            <div class="sidebar-nav">
                
                <div class="nav-category">Management Module</div>
                
                <div class="nav-item active" onclick="AppRouter.navigate('dashboard')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                    Dashboard
                </div>

                <div class="nav-item" onclick="AppRouter.navigate('sales')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                    Sales & Orders
                </div>

                <div class="nav-item" onclick="AppRouter.navigate('inventory')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"></path><path d="M4 6v12a2 2 0 0 0 2 2h14v-4"></path><path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z"></path></svg>
                    Inventory
                </div>

                <div class="nav-item" onclick="AppRouter.navigate('crm')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    Customers (CRM)
                </div>

                <div class="nav-item" onclick="AppRouter.navigate('finance')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                    Invoices & Ledger
                </div>

                <div class="nav-category">System</div>

                <div class="nav-item" onclick="AppRouter.navigate('settings')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    Settings
                </div>
                
            </div>

            <div class="sidebar-footer">
                <div class="cloud-widget">
                    <span>Google Drive</span>
                    <span id="sync-dot-el" class="status-dot"></span>
                </div>
                <div id="gdrive-status-text" style="color: #64748B; margin-bottom: 10px;">Not Connected</div>
                <button class="btn btn-primary btn-full" onclick="GDocsService.connect()">Connect & Sync</button>
            </div>
        </aside>
        <!-- SIDEBAR END -->


        <!-- MAIN CONTENT START -->
        <main class="main-content">
            
            <header class="top-bar">
                <div class="page-info">
                    <h2 id="page-title-el">Dashboard</h2>
                    <span id="page-date-el">Loading...</span>
                </div>
                
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="UI.Modals.Order.open()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Quick Sale
                    </button>
                    <div class="user-pill">
                        <span class="user-avatar">F</span>
                        <div style="font-size: 0.85rem; color: var(--text-muted); padding-right:8px;">Freskey Ops</div>
                    </div>
                </div>
            </header>

            <div class="viewport-scroller" id="main-viewport">
                <!-- VIEW INJECTED HERE VIA JS -->
            </div>

        </main>
        <!-- MAIN CONTENT END -->
    </div>


    <!-- =========================
         MODALS COLLECTION
         ========================= -->

    <!-- 1. SALES ORDER MODAL -->
    <div class="modal-overlay" id="modal-order">
        <div class="modal-window">
            <div class="modal-header">
                <h3 class="modal-title">Create New Order</h3>
                <span class="modal-close" onclick="UI.Modals.Order.close()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="order-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Customer</label>
                            <select id="ord-cust" class="form-control" onchange="UI.Modals.Order.updateDetails()">
                                <!-- Populated JS -->
                            </select>
                            <div id="cust-bal-display" style="font-size: 0.8rem; color: #dc3545; margin-top:5px; height: 16px;"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Order Date</label>
                            <input type="date" id="ord-date" class="form-control" required>
                        </div>
                    </div>

                    <!-- Products Table -->
                    <div class="table-responsive" style="max-height: 250px; overflow-y:auto; margin-bottom: 20px;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th width="80px">Qty</th>
                                </tr>
                            </thead>
                            <tbody id="ord-product-rows">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>

                    <div style="background: #F8FAFC; padding: 15px; border-radius: 8px; text-align: right;">
                         <span style="font-size: 1.2rem; font-weight: 700; color: var(--text-main);">Total: â‚¹ <span id="ord-grand-total">0.00</span></span>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="UI.Modals.Order.close()">Cancel</button>
                <button class="btn btn-success" onclick="SalesController.processOrder()">Create Invoice</button>
            </div>
        </div>
    </div>

    <!-- 2. PURCHASE STOCK MODAL -->
    <div class="modal-overlay" id="modal-purchase">
        <div class="modal-window" style="width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Stock Entry (Purchase)</h3>
                <span class="modal-close" onclick="UI.Modals.Purchase.close()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Product</label>
                    <select id="pch-sku" class="form-control"></select>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Quantity (Cases)</label>
                        <input type="number" id="pch-qty" class="form-control" value="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Batch / Ref No</label>
                        <input type="text" id="pch-ref" class="form-control" placeholder="PO-XXXX">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="UI.Modals.Purchase.close()">Close</button>
                <button class="btn btn-primary" onclick="InventoryController.addStock()">Confirm & Update</button>
            </div>
        </div>
    </div>

    <!-- 3. ADD CUSTOMER MODAL -->
    <div class="modal-overlay" id="modal-customer">
        <div class="modal-window">
            <div class="modal-header">
                <h3 class="modal-title">New Customer</h3>
                <span class="modal-close" onclick="UI.Modals.CRM.close()">&times;</span>
            </div>
            <div class="modal-body">
                 <div class="form-group"><label class="form-label">Customer Name</label><input type="text" id="new-cust-name" class="form-control"></div>
                 <div class="form-grid">
                     <div class="form-group"><label class="form-label">Phone</label><input type="text" id="new-cust-phone" class="form-control"></div>
                     <div class="form-group">
                         <label class="form-label">Type</label>
                         <select id="new-cust-type" class="form-control">
                             <option value="Retailer">Retailer</option>
                             <option value="Distributor">Distributor</option>
                             <option value="Event">Event</option>
                         </select>
                     </div>
                 </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="UI.Modals.CRM.close()">Cancel</button>
                <button class="btn btn-primary" onclick="CRMController.addCustomer()">Save</button>
            </div>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- 
      ===================================================================
      SECTION 2: BUSINESS LOGIC (JAVASCRIPT)
      Enterprise pattern: Repositories (Data) -> Services (Logic) -> Controllers (UI)
      =================================================================== 
    -->
    <script>
        
        /**
         * SYSTEM CONFIGURATION
         * Contains API Keys provided by the user.
         */
        const AppConfig = {
            API_KEY: 'AIzaSyCWo9OP6-QhyKWpfuV5oonyuC32IQHoOtE', 
            CLIENT_ID: '950010994560-v7p6cem78h9fsdp102iq4immb36t95ls.apps.googleusercontent.com',
            SCOPES: 'https://www.googleapis.com/auth/drive.file',
            DB_FILE_NAME: 'freskey-distribution-database.json',
            AUTHORIZED_EMAIL: 'freskeypiyo@gmail.com'
        };

        /**
         * DATE UTILITIES
         */
        const DateUtil = {
            today: () => new Date().toISOString().split('T')[0],
            niceDate: (d) => new Date(d).toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' }),
            dateTime: () => new Date().toLocaleString()
        };

        /**
         * CURRENCY FORMATTER (Indian Rupee)
         */
        const Money = (amount) => {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 0
            }).format(amount);
        };

        /**
         * ----------------------------------------------------------
         * DATA LAYER (In-Memory Database & Seed)
         * ----------------------------------------------------------
         */
        const Database = {
            customers: [
                { id: 101, name: 'Goyal Supermarket', phone: '9876543210', type: 'Retailer', creditLimit: 20000, currentBalance: 0 },
                { id: 102, name: 'Metro Distributors', phone: '9988776655', type: 'Distributor', creditLimit: 500000, currentBalance: 125000 },
                { id: 103, name: 'Taj Hotel (Events)', phone: '8877665544', type: 'Event', creditLimit: 0, currentBalance: 0 },
                { id: 104, name: 'Laxmi Stores', phone: '7766554433', type: 'Retailer', creditLimit: 15000, currentBalance: 4500 }
            ],
            products: [
                { id: 'sku_200', name: 'Freskey 200ml (Lemon)', packing: '24 Bottles/Case', price: 480, stock: 450 },
                { id: 'sku_500', name: 'Freskey 500ml (Lemon)', packing: '12 Bottles/Case', price: 360, stock: 120 },
                { id: 'sku_1L', name: 'Freskey 1 Litre', packing: '6 Bottles/Case', price: 300, stock: 55 },
                { id: 'sku_200m', name: 'Freskey 200ml (Mango)', packing: '24 Bottles/Case', price: 500, stock: 300 }
            ],
            orders: [
                // Seed some orders
                { id: 1001, date: '2025-10-01', custId: 101, items: [{name: 'Freskey 200ml', qty: 2, price: 480}], total: 960, status: 'Paid' },
                { id: 1002, date: '2025-10-05', custId: 102, items: [{name: 'Freskey 500ml', qty: 50, price: 360}], total: 18000, status: 'Completed' }
            ],
            invoices: [
                { id: 'INV-1002', orderId: 1002, custId: 102, total: 18000, date: '2025-10-05', status: 'Unpaid' }
            ],
            ledger: [
                { id: 1, date: '2025-10-01', type: 'Sale', ref: 'INV-1001', amount: 960, mode: 'Credit' },
                { id: 2, date: '2025-10-02', type: 'Payment', ref: 'INV-1001', amount: 960, mode: 'Cash' },
                { id: 3, date: '2025-10-05', type: 'Sale', ref: 'INV-1002', amount: 18000, mode: 'Credit' }
            ],

            // Methods to interact with data safely
            getById: (collection, id) => Database[collection].find(x => x.id == id),
            
            addProductStock: (skuId, qty) => {
                const p = Database.products.find(x => x.id === skuId);
                if (p) p.stock += parseInt(qty);
            },
            
            reduceProductStock: (skuId, qty) => {
                const p = Database.products.find(x => x.id === skuId);
                if (p && p.stock >= qty) {
                    p.stock -= parseInt(qty);
                    return true;
                }
                return false;
            }
        };

        /**
         * ----------------------------------------------------------
         * SERVICES LAYER (Business Logic)
         * ----------------------------------------------------------
         */
        const NotificationService = {
            show: (message, type = 'info') => {
                const container = document.getElementById('toast-container');
                const div = document.createElement('div');
                div.className = `toast-msg ${type}`;
                div.innerHTML = `<span>${message}</span> <small onclick="this.parentNode.remove()" style="cursor:pointer">&times;</small>`;
                container.appendChild(div);
                // Auto Remove
                setTimeout(() => div.remove(), 4000);
            }
        };

        const SalesService = {
            calculateCart: (inputElements) => {
                let items = [];
                let total = 0;
                
                inputElements.forEach(inp => {
                    const qty = parseInt(inp.value) || 0;
                    if(qty > 0) {
                        const pid = inp.getAttribute('data-id');
                        const product = Database.getById('products', pid);
                        const lineTotal = product.price * qty;
                        items.push({
                            id: pid,
                            name: product.name,
                            price: product.price,
                            qty: qty,
                            lineTotal: lineTotal
                        });
                        total += lineTotal;
                    }
                });
                return { items, total };
            },

            createOrder: (customerId, cartItems, totalAmount, date) => {
                const newId = 1000 + Database.orders.length + 1;
                
                // 1. Stock Deduction Logic
                for(let item of cartItems) {
                    const success = Database.reduceProductStock(item.id, item.qty);
                    if(!success) {
                        alert(`CRITICAL ERROR: Stock verification failed for ${item.name} mid-process.`);
                        return null; // Transaction rollback simulation
                    }
                }

                // 2. Create Order Record
                const order = {
                    id: newId,
                    date: date,
                    custId: customerId,
                    items: cartItems,
                    total: totalAmount,
                    status: 'Completed' 
                };
                Database.orders.push(order);

                // 3. Create Invoice Record
                const invoiceId = `INV-${newId}`;
                Database.invoices.push({
                    id: invoiceId,
                    orderId: newId,
                    custId: customerId,
                    total: totalAmount,
                    date: date,
                    status: 'Unpaid' // Starts Unpaid
                });

                // 4. Update Customer Ledger/Balance
                const cust = Database.getById('customers', customerId);
                cust.currentBalance += totalAmount;
                Database.ledger.push({
                    id: Date.now(),
                    date: date,
                    type: 'Sale',
                    ref: invoiceId,
                    amount: totalAmount,
                    mode: 'Credit'
                });

                return { order, invoiceId };
            }
        };

        const PDFService = {
            generateInvoice: (orderId) => {
                const { jsPDF } = window.jspdf;
                const order = Database.orders.find(o => o.id == orderId);
                const cust = Database.getById('customers', order.custId);
                const doc = new jsPDF();

                // --- HEADER ---
                doc.setFontSize(22);
                doc.setTextColor(21, 101, 192); // Brand Blue
                doc.text("HIMALAYAN BEVERAGES", 14, 20);
                
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text("Registered Office: Plot 44, Industrial Area", 14, 26);
                doc.text("GSTIN: 27AABCV1234F1Z5 | Contact: +91-9988776655", 14, 31);
                
                doc.setDrawColor(200);
                doc.line(14, 35, 196, 35);

                // --- DETAILS ---
                doc.setFontSize(12);
                doc.setTextColor(0);
                doc.text(`INVOICE NO: INV-${order.id}`, 14, 45);
                doc.text(`Date: ${order.date}`, 14, 52);
                
                doc.text("Bill To:", 120, 45);
                doc.setFontSize(11);
                doc.text(`${cust.name}`, 120, 52);
                doc.text(`${cust.type} Account`, 120, 58);
                doc.text(`Phone: ${cust.phone}`, 120, 64);

                // --- TABLE ---
                const tableRows = order.items.map((item, index) => {
                    return [index+1, item.name, item.qty, item.price.toFixed(2), item.lineTotal.toFixed(2)];
                });

                doc.autoTable({
                    startY: 75,
                    head: [['#', 'Item Description', 'Qty (Cases)', 'Unit Price', 'Total']],
                    body: tableRows,
                    theme: 'striped',
                    headStyles: { fillColor: [21, 101, 192] },
                    foot: [['', '', '', 'Grand Total', Money(order.total)]],
                    footStyles: { fillColor: [241, 245, 249], textColor: [0,0,0], fontStyle:'bold' }
                });

                // --- FOOTER ---
                const finalY = doc.lastAutoTable.finalY || 100;
                doc.setFontSize(10);
                doc.text("Terms & Conditions:", 14, finalY + 15);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text("1. All payments due within 15 days.", 14, finalY + 20);
                doc.text("2. Interest @18% pa will be charged on overdue payments.", 14, finalY + 24);
                doc.text("3. Goods once sold will not be taken back.", 14, finalY + 28);
                
                // SAVE DIRECTLY TO DEVICE
                doc.save(`Himalayan_Invoice_${order.id}.pdf`);
                NotificationService.show("PDF Downloaded successfully", "success");
            }
        };

        const GDocsService = {
            tokenClient: null,
            isConnected: false,

            init: () => {
                gapi.load('client', async () => {
                    await gapi.client.init({
                        apiKey: AppConfig.API_KEY,
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                    });
                });

                GDocsService.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: AppConfig.CLIENT_ID,
                    scope: AppConfig.SCOPES,
                    callback: (resp) => {
                        if (resp.error) {
                            console.error(resp);
                            return;
                        }
                        GDocsService.handleAuthSuccess(resp);
                    },
                });
            },

            connect: () => {
                if(!GDocsService.tokenClient) return alert("Google Script not ready. Check internet.");
                GDocsService.tokenClient.requestAccessToken({prompt: 'consent'});
            },

            handleAuthSuccess: (tokenResponse) => {
                GDocsService.isConnected = true;
                
                // Update Sidebar UI
                const statusTxt = document.getElementById('gdrive-status-text');
                const dot = document.getElementById('sync-dot-el');
                if(statusTxt && dot) {
                    statusTxt.innerHTML = "Synced & Online";
                    statusTxt.style.color = "#10B981";
                    dot.classList.add('online');
                }

                NotificationService.show("Google Drive Connected", "success");
                // Immediately Try to Backup
                GDocsService.backupDatabase();
            },

            backupDatabase: async () => {
                if(!GDocsService.isConnected) return;
                try {
                    // Create Content
                    const dbString = JSON.stringify(Database, null, 2);
                    const fileMetadata = {
                        name: AppConfig.DB_FILE_NAME,
                        mimeType: 'application/json'
                    };

                    // Search for existing file to overwrite
                    const q = `name = '${AppConfig.DB_FILE_NAME}' and trashed = false`;
                    const res = await gapi.client.drive.files.list({q, fields:'files(id)'});
                    const files = res.result.files;

                    if (files && files.length > 0) {
                        // UPDATE existing file
                        const fileId = files[0].id;
                        await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                            method: 'PATCH',
                            headers: { 
                                'Authorization': `Bearer ${gapi.client.getToken().access_token}`,
                                'Content-Type': 'application/json' 
                            },
                            body: dbString
                        });
                        NotificationService.show("Database Background Sync: Success", "success");
                    } else {
                        // CREATE new file (Requires Multipart upload logic usually, simplified here using blob approach logic compatible with REST)
                        const form = new FormData();
                        form.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
                        form.append('file', new Blob([dbString], {type: 'application/json'}));

                        await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` },
                            body: form
                        });
                        NotificationService.show("New Database File Created on Drive", "success");
                    }

                } catch(err) {
                    console.error("Drive Sync Error", err);
                    NotificationService.show("Sync Failed: Check Console", "error");
                }
            }
        };

        /**
         * ----------------------------------------------------------
         * CONTROLLER LAYER (DOM MANIPULATION & ROUTES)
         * ----------------------------------------------------------
         */
        const AppRouter = {
            currentRoute: 'dashboard',
            
            init: () => {
                // Initial Page Load
                document.getElementById('page-date-el').innerText = DateUtil.dateTime();
                AppRouter.navigate('dashboard');
                
                // Initialize Google Drive Scripts
                GDocsService.init();
            },

            navigate: (routeId) => {
                // Update UI Navigation State
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(el => el.classList.remove('active'));
                
                // Hack: In real apps use data-attributes. Here matching by onclick text
                // or just manually finding index is simple enough for the demo.
                
                // Clear Viewport
                const container = document.getElementById('main-viewport');
                container.innerHTML = '';
                AppRouter.currentRoute = routeId;

                // Title Update
                const titles = {
                    dashboard: 'Operational Dashboard',
                    sales: 'Sales & Orders',
                    inventory: 'Warehouse Management',
                    finance: 'Invoicing & Ledgers',
                    crm: 'Customer Directory',
                    settings: 'System Configuration'
                };
                document.getElementById('page-title-el').innerText = titles[routeId];

                // Route Logic
                switch(routeId) {
                    case 'dashboard': DashboardView.render(container); break;
                    case 'sales': SalesView.render(container); break;
                    case 'inventory': InventoryView.render(container); break;
                    case 'finance': FinanceView.render(container); break;
                    case 'crm': CRMView.render(container); break;
                    case 'settings': SettingsView.render(container); break;
                }
            }
        };

        // --- VIEWS ---

        const DashboardView = {
            render: (target) => {
                // Calculte KPIs
                const totalSales = Database.orders.reduce((acc, curr) => acc + curr.total, 0);
                const dueInvoices = Database.invoices.filter(i => i.status === 'Unpaid').reduce((acc, curr) => acc + curr.total, 0);
                const lowStockCount = Database.products.filter(p => p.stock < 50).length;

                target.innerHTML = `
                    <div class="stat-grid fade-in">
                        <div class="stat-card stat-green">
                            <div class="stat-title">Total Revenue</div>
                            <div class="stat-value">${Money(totalSales)}</div>
                        </div>
                        <div class="stat-card stat-orange">
                            <div class="stat-title">Pending Collections</div>
                            <div class="stat-value" style="color:var(--warning-color)">${Money(dueInvoices)}</div>
                        </div>
                        <div class="stat-card stat-red">
                            <div class="stat-title">Low Stock Alerts</div>
                            <div class="stat-value" style="color:var(--danger-color)">${lowStockCount} SKUs</div>
                        </div>
                    </div>

                    <div class="card fade-in">
                        <div class="card-header">
                            <h3>Recent Orders</h3>
                        </div>
                        <div class="card-body" style="padding:0">
                            <div class="table-responsive" style="border:none">
                                <table class="data-table">
                                    <thead><tr><th>ID</th><th>Date</th><th>Customer</th><th>Amount</th><th>Status</th></tr></thead>
                                    <tbody>
                                        ${Database.orders.slice(-5).reverse().map(o => {
                                            const cust = Database.getById('customers', o.custId);
                                            return `<tr>
                                                <td>#${o.id}</td>
                                                <td>${DateUtil.niceDate(o.date)}</td>
                                                <td>${cust.name}</td>
                                                <td>${Money(o.total)}</td>
                                                <td><span class="badge badge-success">${o.status}</span></td>
                                            </tr>`
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }
        };

        const SalesView = {
            render: (target) => {
                let html = `
                    <div class="card fade-in">
                        <div class="card-header">
                            <h3>Sales History</h3>
                        </div>
                        <div class="card-body">
                           <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Order #</th>
                                            <th>Date</th>
                                            <th>Customer</th>
                                            <th>Total</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>`;
                
                // Add rows
                Database.orders.forEach(order => {
                    const cust = Database.getById('customers', order.custId);
                    html += `<tr>
                        <td>#${order.id}</td>
                        <td>${DateUtil.niceDate(order.date)}</td>
                        <td>${cust.name}</td>
                        <td>${Money(order.total)}</td>
                        <td><span class="badge badge-neutral">${order.status}</span></td>
                        <td>
                            <button class="btn btn-primary btn-full" style="padding:4px 10px; font-size:0.8rem;" onclick="PDFService.generateInvoice('${order.id}')">
                                PDF Download
                            </button>
                        </td>
                    </tr>`;
                });

                html += `</tbody></table></div></div></div>`;
                target.innerHTML = html;
            }
        };

        const InventoryView = {
            render: (target) => {
                let html = `
                <div class="form-grid mb-4">
                     <button class="btn btn-primary" onclick="UI.Modals.Purchase.open()">+ Stock Entry / Purchase</button>
                     <div class="text-right text-muted">Total Stock Value: 
                        <b>${Money(Database.products.reduce((acc,p)=>acc+(p.stock*p.price),0))}</b>
                     </div>
                </div>

                <div class="card fade-in">
                    <div class="card-body">
                         <div class="table-responsive">
                             <table class="data-table">
                                 <thead>
                                     <tr>
                                        <th>SKU Code</th>
                                        <th>Product Name</th>
                                        <th>Case Packing</th>
                                        <th>Current Stock</th>
                                        <th>Valuation</th>
                                     </tr>
                                 </thead>
                                 <tbody>`;
                
                Database.products.forEach(p => {
                    const isLow = p.stock < 50;
                    html += `
                        <tr style="${isLow ? 'background:#fff1f2' : ''}">
                            <td style="font-family:monospace">${p.id}</td>
                            <td>
                                <b>${p.name}</b>
                                ${isLow ? '<span class="badge badge-danger" style="margin-left:5px">Low Stock</span>' : ''}
                            </td>
                            <td>${p.packing}</td>
                            <td style="font-weight:bold">${p.stock} cases</td>
                            <td>${Money(p.price * p.stock)}</td>
                        </tr>
                    `;
                });
                html += `</tbody></table></div></div></div>`;
                target.innerHTML = html;
            }
        };
        
        const FinanceView = {
            render: (target) => {
                let html = `
                <div class="card fade-in">
                    <div class="card-header">
                        <h3>Outstanding Invoices</h3>
                    </div>
                    <div class="card-body">
                         <div class="table-responsive">
                            <table class="data-table">
                                <thead><tr><th>Invoice</th><th>Date</th><th>Customer</th><th>Amount</th><th>Status</th><th>Action</th></tr></thead>
                                <tbody>`;
                
                // Render Invoice Rows
                const unpaid = Database.invoices; // For simplicity showing all, filter via status in row
                
                unpaid.slice().reverse().forEach(inv => {
                    const cust = Database.getById('customers', inv.custId);
                    const isPaid = inv.status === 'Paid';
                    
                    html += `<tr>
                        <td>${inv.id}</td>
                        <td>${inv.date}</td>
                        <td>${cust.name}</td>
                        <td>${Money(inv.total)}</td>
                        <td><span class="badge ${isPaid ? 'badge-success' : 'badge-danger'}">${inv.status}</span></td>
                        <td>
                            ${!isPaid ? 
                              `<button class="btn btn-success" style="padding:4px 8px; font-size:0.8rem" onclick="FinanceController.recordPayment('${inv.id}')">Record Pay</button>` :
                              `<span style="color:var(--success-color)">âœ“ Paid</span>`
                            }
                        </td>
                    </tr>`;
                });
                html += `</tbody></table></div></div></div>
                
                <div class="card fade-in">
                    <div class="card-header"><h3>General Ledger (Last 20)</h3></div>
                    <div class="card-body">
                         <table class="data-table">
                             <thead><tr><th>Ref</th><th>Type</th><th>Mode</th><th>Amount</th></tr></thead>
                             <tbody>
                             ${Database.ledger.slice().reverse().slice(0,20).map(l => 
                                `<tr><td>${l.ref}</td><td>${l.type}</td><td>${l.mode}</td><td>${Money(l.amount)}</td></tr>`
                             ).join('')}
                             </tbody>
                         </table>
                    </div>
                </div>`;
                target.innerHTML = html;
            }
        };

        const CRMView = {
            render: (target) => {
                 let html = `
                 <div class="mb-4 text-right">
                    <button class="btn btn-primary" onclick="UI.Modals.CRM.open()">Add New Customer</button>
                 </div>
                 <div class="card fade-in">
                    <div class="card-body">
                         <div class="table-responsive">
                            <table class="data-table">
                                <thead><tr><th>Name</th><th>Phone</th><th>Type</th><th>Current Balance</th></tr></thead>
                                <tbody>`;
                 Database.customers.forEach(c => {
                     html += `<tr>
                        <td><b>${c.name}</b></td>
                        <td>${c.phone}</td>
                        <td>${c.type}</td>
                        <td style="${c.currentBalance > c.creditLimit ? 'color:red; font-weight:bold' : ''}">
                             ${Money(c.currentBalance)}
                        </td>
                     </tr>`;
                 });
                 html += `</tbody></table></div></div></div>`;
                 target.innerHTML = html;
            }
        };

        const SettingsView = {
            render: (target) => {
                target.innerHTML = `
                <div class="card fade-in">
                    <div class="card-header"><h3>Cloud Integration</h3></div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div>
                                <label class="form-label">Authorized Account</label>
                                <input class="form-control" disabled value="${AppConfig.AUTHORIZED_EMAIL}">
                            </div>
                            <div>
                                <label class="form-label">Client ID (Obfuscated)</label>
                                <input class="form-control" disabled value="...${AppConfig.CLIENT_ID.slice(-8)}">
                            </div>
                        </div>
                        <div class="mt-4" style="padding:20px; background:#f0f9ff; border-radius:6px; color:#0c4a6e;">
                             <p>Google Drive synchronization saves the <b>entire in-memory database</b> to a file named <b>${AppConfig.DB_FILE_NAME}</b> in the connected account's Drive. </p>
                             <button class="btn btn-primary" onclick="GDocsService.backupDatabase()">Force Sync Now</button>
                        </div>
                    </div>
                </div>`;
            }
        };


        /**
         * ----------------------------------------------------------
         * BUSINESS LOGIC HANDLERS (Controllers)
         * ----------------------------------------------------------
         */
         
         const InventoryController = {
             addStock: () => {
                 const sku = document.getElementById('pch-sku').value;
                 const qty = document.getElementById('pch-qty').value;
                 
                 if(qty <= 0) return NotificationService.show("Invalid Qty", "error");
                 
                 Database.addProductStock(sku, qty);
                 NotificationService.show(`Added ${qty} cases to inventory`, "success");
                 UI.Modals.Purchase.close();
                 AppRouter.navigate('inventory'); // Refresh
                 GDocsService.backupDatabase();
             }
         };

         const CRMController = {
             addCustomer: () => {
                 const name = document.getElementById('new-cust-name').value;
                 const phone = document.getElementById('new-cust-phone').value;
                 const type = document.getElementById('new-cust-type').value;

                 if(!name) return NotificationService.show("Name is required", "error");

                 Database.customers.push({
                     id: 100 + Database.customers.length + 1,
                     name, phone, type, creditLimit: 10000, currentBalance: 0
                 });

                 NotificationService.show("Customer saved successfully", "success");
                 UI.Modals.CRM.close();
                 AppRouter.navigate('crm');
                 GDocsService.backupDatabase();
             }
         }

         const SalesController = {
             processOrder: () => {
                 const custId = parseInt(document.getElementById('ord-cust').value);
                 const date = document.getElementById('ord-date').value;
                 const inputs = document.querySelectorAll('.ord-qty-input');
                 
                 const { items, total } = SalesService.calculateCart(inputs);

                 if(items.length === 0) return NotificationService.show("Cart is empty", "error");

                 // Validate Credit (Mock Logic)
                 const cust = Database.getById('customers', custId);
                 if (cust.currentBalance + total > cust.creditLimit && cust.creditLimit > 0) {
                     if(!confirm(`Credit Limit Exceeded! \nLimit: ${cust.creditLimit} \nCurrent+New: ${cust.currentBalance+total} \nProceed anyway?`)) return;
                 }

                 const result = SalesService.createOrder(custId, items, total, date);

                 if(result) {
                     NotificationService.show(`Order ${result.order.id} Created!`, "success");
                     UI.Modals.Order.close();
                     
                     // Auto download invoice
                     if(confirm("Order Placed. Download Invoice PDF now?")) {
                        PDFService.generateInvoice(result.order.id);
                     }
                     AppRouter.navigate('sales'); // refresh
                     GDocsService.backupDatabase(); // sync
                 }
             }
         };

         const FinanceController = {
             recordPayment: (invoiceId) => {
                 const inv = Database.invoices.find(i => i.id === invoiceId);
                 if(!inv) return;
                 
                 if(confirm(`Receive full payment of ${Money(inv.total)} for ${invoiceId}?`)) {
                     inv.status = 'Paid';
                     
                     // Reduce Customer Balance
                     const cust = Database.getById('customers', inv.custId);
                     cust.currentBalance -= inv.total;
                     
                     // Add Ledger
                     Database.ledger.push({
                        id: Date.now(),
                        date: DateUtil.today(),
                        type: 'Payment',
                        ref: invoiceId,
                        amount: inv.total,
                        mode: 'Cash/Bank'
                     });

                     NotificationService.show("Payment Recorded & Balance Updated", "success");
                     AppRouter.navigate('finance');
                     GDocsService.backupDatabase();
                 }
             }
         };

         /**
          * UI HELPERS (Modal Logic)
          */
         const UI = {
             Modals: {
                 Order: {
                     open: () => {
                        // 1. Fill Customer Dropdown
                        const custSel = document.getElementById('ord-cust');
                        custSel.innerHTML = '<option value="">Select Customer...</option>';
                        Database.customers.forEach(c => {
                            custSel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                        });

                        // 2. Set Date
                        document.getElementById('ord-date').value = DateUtil.today();

                        // 3. Render Product Table
                        const tBody = document.getElementById('ord-product-rows');
                        tBody.innerHTML = '';
                        Database.products.forEach(p => {
                            tBody.innerHTML += `
                                <tr>
                                    <td>
                                        <div>${p.name}</div>
                                        <small style="color:#888">${p.packing}</small>
                                    </td>
                                    <td>â‚¹${p.price}</td>
                                    <td style="${p.stock < 50 ? 'color:red':''}">${p.stock} cs</td>
                                    <td>
                                        <input type="number" class="form-control ord-qty-input" 
                                        min="0" data-id="${p.id}" oninput="UI.Modals.Order.updateTotal()">
                                    </td>
                                </tr>
                            `;
                        });
                        
                        document.getElementById('modal-order').classList.add('open');
                        UI.Modals.Order.updateTotal(); // reset to 0
                     },
                     close: () => {
                         document.getElementById('modal-order').classList.remove('open');
                     },
                     updateDetails: () => {
                         const cid = document.getElementById('ord-cust').value;
                         if(cid) {
                             const c = Database.getById('customers', cid);
                             document.getElementById('cust-bal-display').innerText = `Current Due: ${Money(c.currentBalance)}`;
                         }
                     },
                     updateTotal: () => {
                         const inputs = document.querySelectorAll('.ord-qty-input');
                         const { total } = SalesService.calculateCart(inputs);
                         document.getElementById('ord-grand-total').innerText = total.toFixed(2);
                     }
                 },
                 Purchase: {
                     open: () => {
                         const sel = document.getElementById('pch-sku');
                         sel.innerHTML = '';
                         Database.products.forEach(p => sel.innerHTML += `<option value="${p.id}">${p.name}</option>`);
                         document.getElementById('modal-purchase').classList.add('open');
                     },
                     close: () => document.getElementById('modal-purchase').classList.remove('open')
                 },
                 CRM: {
                     open: () => document.getElementById('modal-customer').classList.add('open'),
                     close: () => document.getElementById('modal-customer').classList.remove('open')
                 }
             }
         };

         // START APP
         window.onload = AppRouter.init;

    </script>
</body>
</html>
