<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Himalayan Beverages | Cloud ERP</title>
    
    <!-- 
      LIBRARIES 
    -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <!-- 
      STYLES & RESPONSIVE DESIGN
    -->
    <style>
        :root {
            /* Theme Variables */
            --primary: #1e3a8a;       /* Blue 900 */
            --primary-light: #3b82f6; /* Blue 500 */
            --accent: #0ea5e9;        /* Sky 500 */
            --accent-glow: rgba(14, 165, 233, 0.2);
            
            --success: #16a34a; 
            --warning: #d97706; 
            --danger: #dc2626;
            
            --bg-body: #f8fafc;
            --bg-sidebar: #0f172a;    /* Slate 900 */
            --bg-card: #ffffff;
            
            --text-head: #1e293b;
            --text-body: #64748b;
            --text-inv: #f1f5f9;

            --sidebar-w: 260px;
            --header-h: 60px;
        }

        /* --- BASE RESET --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-body); color: var(--text-body); font-size: 14px;
            height: 100vh; overflow: hidden; display: flex;
        }
        
        /* --- UTILS --- */
        .text-bold { font-weight: 700; }
        .text-right { text-align: right; }
        .flex { display: flex; align-items: center; }
        .justify-between { justify-content: space-between; }
        .hidden { display: none !important; }
        
        .badge { 
            padding: 4px 10px; border-radius: 99px; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        .bg-paid { background: #dcfce7; color: #15803d; }
        .bg-pending { background: #fee2e2; color: #991b1b; }
        .bg-part { background: #fef9c3; color: #854d0e; }
        .bg-info { background: #e0f2fe; color: #075985; }

        /* --- RESPONSIVE SIDEBAR --- */
        #sidebar {
            width: var(--sidebar-w);
            background: var(--bg-sidebar);
            color: var(--text-inv);
            display: flex; flex-direction: column;
            z-index: 50; transition: transform 0.3s ease;
            height: 100%; border-right: 1px solid rgba(255,255,255,0.05);
        }

        .brand-area {
            height: var(--header-h);
            display: flex; align-items: center; padding: 0 20px;
            font-size: 1.1rem; font-weight: 800; color: white;
            background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .nav-scroller { flex: 1; overflow-y: auto; padding: 20px 10px; }
        .nav-item {
            padding: 12px 15px; margin-bottom: 5px; border-radius: 6px;
            cursor: pointer; transition: 0.2s; color: #94a3b8; font-weight: 500;
            display: flex; align-items: center; gap: 12px;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: var(--primary-light); color: white; box-shadow: 0 4px 12px var(--accent-glow); }
        .nav-item svg { width: 18px; height: 18px; }

        .cloud-widget {
            padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.15);
        }

        /* --- MAIN LAYOUT --- */
        #main {
            flex: 1; display: flex; flex-direction: column; 
            height: 100%; overflow: hidden; position: relative;
        }
        
        #topbar {
            height: var(--header-h); background: var(--bg-card);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; border-bottom: 1px solid #e2e8f0;
            z-index: 40;
        }
        
        #mobile-toggle { display: none; background:none; border:none; font-size: 1.5rem; color: #333; cursor:pointer; margin-right: 15px; }

        .page-content { flex: 1; overflow-y: auto; padding: 25px; position: relative; }

        /* --- RESPONSIVE MEDIA QUERIES --- */
        @media (max-width: 768px) {
            #sidebar {
                position: fixed; left: -100%; top:0; bottom:0; width: 80%; max-width: 300px;
                box-shadow: 10px 0 20px rgba(0,0,0,0.5);
            }
            #sidebar.open { transform: translateX(100%); left: -80%; /* Fix logic based on transform */ left:0; transform:none; }
            
            #mobile-toggle { display: block; }
            .desktop-user { display: none; }
            .page-content { padding: 15px; }
            
            /* Responsive Grid */
            .grid-kpi { grid-template-columns: 1fr !important; }
            .grid-cols-2 { grid-template-columns: 1fr !important; }
        }

        /* --- CARDS & GRIDS --- */
        .card {
            background: white; border-radius: 8px; border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 20px; overflow: hidden;
        }
        .card-header {
            padding: 15px 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;
        }
        .card-header h3 { margin: 0; font-size: 1rem; color: var(--text-head); }
        .card-body { padding: 20px; }

        .grid-kpi {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px;
        }
        .kpi-card {
            background: white; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0; position: relative;
        }
        .kpi-val { font-size: 1.6rem; font-weight: 700; color: var(--text-head); margin-top: 5px; }
        .kpi-lbl { font-size: 0.8rem; text-transform: uppercase; color: #94a3b8; font-weight: 600; }

        .grid-cols-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        /* --- BUTTONS --- */
        .btn {
            display: inline-flex; align-items: center; gap: 8px; justify-content: center;
            padding: 9px 18px; border-radius: 6px; font-weight: 600; font-size: 0.9rem;
            border: 1px solid transparent; cursor: pointer; transition: 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-sec { background: white; border: 1px solid #cbd5e1; color: var(--text-head); }
        .btn-success { background: var(--success); color: white; }
        .btn-sm { padding: 5px 12px; font-size: 0.8rem; }
        .w-full { width: 100%; }

        /* --- TABLES --- */
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; } /* Ensure horizontal scroll on mobile */
        th { text-align: left; padding: 12px 15px; background: #f8fafc; font-size: 0.75rem; color: #64748b; text-transform: uppercase; border-bottom: 1px solid #e2e8f0; }
        td { padding: 14px 15px; border-bottom: 1px solid #f1f5f9; color: #334155; }
        tr:hover { background: #fdfdfd; }

        /* --- MODALS --- */
        .modal-mask {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100;
            display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s;
            padding: 20px;
        }
        .modal-mask.active { opacity: 1; pointer-events: all; }
        .modal-box {
            background: white; width: 100%; max-width: 600px; max-height: 90vh; 
            border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }
        .modal-body { overflow-y: auto; padding: 25px; }
        .modal-foot { padding: 15px 25px; border-top: 1px solid #f1f5f9; display: flex; justify-content: flex-end; gap: 10px; background: #f8fafc; border-radius: 0 0 12px 12px; }
        
        .inp { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 15px; display: block; font-size: 0.95rem; }
        .inp:focus { border-color: var(--primary-light); box-shadow: 0 0 0 3px var(--accent-glow); }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }

        /* TOAST */
        #toast { position: fixed; bottom: 20px; right: 20px; background: #0f172a; color: white; padding: 15px 20px; border-radius: 6px; box-shadow: 0 10px 15px rgba(0,0,0,0.2); z-index: 200; transform: translateY(100px); transition: 0.3s; }
        #toast.show { transform: translateY(0); }
        
    </style>
</head>
<body>

    <!-- OVERLAY FOR MOBILE MENU -->
    <div id="sidebar-overlay" onclick="toggleMenu()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:49;display:none;"></div>

    <div id="sidebar">
        <div class="brand-area">
            <span>HIMALAYAN<span style="color:var(--accent);">ERP</span></span>
        </div>
        <div class="nav-scroller">
            <div class="nav-item active" onclick="Nav('dashboard')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 17l-6-11-6 8"/></svg>
                Dashboard
            </div>
            <div class="nav-item" onclick="Nav('orders')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                Sales & Invoice
            </div>
            <div class="nav-item" onclick="Nav('inventory')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"/><path d="M4 6v12a2 2 0 0 0 2 2h14v-4"/></svg>
                Stock Management
            </div>
            <div class="nav-item" onclick="Nav('crm')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                Customers
            </div>
            <div class="nav-item" onclick="Nav('finance')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
                Payments & Ledger
            </div>
        </div>
        
        <div class="cloud-widget">
            <div style="font-size:0.75rem; color:#64748b; margin-bottom:10px;">SYSTEM STATUS</div>
            <div id="drive-stat" style="color:white; font-size:0.85rem; display:flex; align-items:center; gap:5px; margin-bottom:10px;">
                <span style="width:8px; height:8px; border-radius:50%; background:grey; display:block;" id="stat-dot"></span> 
                Disconnected
            </div>
            <button onclick="Drive.auth()" class="btn btn-primary w-full btn-sm">Google Drive Sync</button>
        </div>
    </div>

    <div id="main">
        <header id="topbar">
            <div class="flex">
                <button id="mobile-toggle" onclick="toggleMenu()">&#9776;</button>
                <h2 style="font-size:1.1rem; margin:0;" id="page-title">Operations Dashboard</h2>
            </div>
            <div class="flex desktop-user">
                <span style="font-size:0.85rem; color:#64748b;">Logged in as: <b>Freskey Admin</b></span>
                <div style="width:32px; height:32px; background:var(--primary); color:white; border-radius:50%; display:grid; place-items:center; margin-left:10px; font-weight:700;">A</div>
            </div>
        </header>

        <div id="content" class="page-content">
            <!-- View injection container -->
        </div>
    </div>

    <!-- TOAST MSG -->
    <div id="toast">Operation Successful</div>


    <!-- =========== MODALS =========== -->

    <!-- ORDER MODAL -->
    <div id="m-order" class="modal-mask">
        <div class="modal-box">
            <div class="card-header">
                <h3>New Invoice / Order</h3>
                <button onclick="Modal('m-order', false)" style="border:none;background:none;font-size:1.5rem;">&times;</button>
            </div>
            <div class="modal-body">
                <div class="grid-cols-2">
                    <div>
                        <label>Customer</label>
                        <select id="ord-cust" class="inp"></select>
                    </div>
                    <div>
                        <label>Order Date</label>
                        <input type="date" id="ord-date" class="inp">
                    </div>
                </div>
                
                <div style="background:#f8fafc; padding:10px; border-radius:6px; margin-bottom:10px;">
                    <div style="font-size:0.85rem; font-weight:700; margin-bottom:5px;">ADD ITEMS</div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Item</th><th width="80px">Stk</th><th width="90px">Qty</th><th>Rate (Rs.)</th></tr></thead>
                            <tbody id="ord-list"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="text-right" style="font-size:1.2rem; font-weight:700; color:var(--primary);">
                    Grand Total: <span id="ord-total">Rs. 0.00</span>
                </div>
            </div>
            <div class="modal-foot">
                <button onclick="Modal('m-order', false)" class="btn btn-sec">Cancel</button>
                <button onclick="Sales.submit()" class="btn btn-primary">Generate PDF & Save</button>
            </div>
        </div>
    </div>

    <!-- PAYMENT MODAL -->
    <div id="m-pay" class="modal-mask">
        <div class="modal-box" style="max-width:400px;">
            <div class="card-header"><h3>Record Payment</h3></div>
            <div class="modal-body">
                <label>Reference Invoice</label>
                <input id="p-ref" class="inp" disabled>
                
                <div class="grid-cols-2">
                     <div><label>Total (Rs.)</label><input id="p-tot" class="inp" disabled></div>
                     <div><label>Due (Rs.)</label><input id="p-due" class="inp" disabled style="color:red; font-weight:bold"></div>
                </div>
                
                <label>Payment Amount Received (Rs.)</label>
                <input type="number" id="p-amt" class="inp" style="border:2px solid var(--success)">
            </div>
            <div class="modal-foot">
                <button onclick="Modal('m-pay', false)" class="btn btn-sec">Cancel</button>
                <button onclick="Finance.save()" class="btn btn-success">Save Payment</button>
            </div>
        </div>
    </div>
    
    <!-- ADD STOCK MODAL -->
    <div id="m-stk" class="modal-mask">
        <div class="modal-box">
            <div class="card-header"><h3>Stock Purchase / Entry</h3></div>
            <div class="modal-body">
                <label>Select Product</label>
                <select id="s-prod" class="inp"></select>
                
                <label>Quantity Added (Cases)</label>
                <input id="s-qty" type="number" class="inp">
                
                <label>Purchase Ref / Batch No</label>
                <input id="s-ref" class="inp">
            </div>
            <div class="modal-foot">
                 <button onclick="Modal('m-stk', false)" class="btn btn-sec">Cancel</button>
                 <button onclick="Inventory.add()" class="btn btn-primary">Update Stock</button>
            </div>
        </div>
    </div>


    <script>
        /* ======================== 
           CONFIG & UTILS
           ======================== */
        const APP = {
            API_KEY: 'AIzaSyCWo9OP6-QhyKWpfuV5oonyuC32IQHoOtE', 
            CLIENT_ID: '950010994560-v7p6cem78h9fsdp102iq4immb36t95ls.apps.googleusercontent.com',
            DB_FILE: 'himalayan_erp_db_v2.json',
            User: 'freskeypiyo@gmail.com'
        };

        const Util = {
            // FIX: Currency formatter using pure ASCII for PDF safety
            fmt: (n) => `Rs. ${n.toLocaleString('en-IN')}`, 
            rawDate: () => new Date().toISOString().split('T')[0],
            uid: () => Date.now().toString(36),
            toast: (msg) => {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.classList.add('show');
                setTimeout(()=>t.classList.remove('show'), 3000);
            }
        };

        /* ======================== 
           DATA STORE 
           ======================== */
        const DB = {
            customers: [
                { id: 'c1', name: 'Metro Cash & Carry', loc: 'Delhi', type: 'Distributor', balance: 0 },
                { id: 'c2', name: 'Taj Hotels', loc: 'Mumbai', type: 'HoReCa', balance: 15000 },
                { id: 'c3', name: 'Wedding Planners Inc', loc: 'Dehradun', type: 'Event', balance: 5000 }
            ],
            products: [
                { id: 'p1', name: 'Freskey Lemon 200ml', cat: 'Glass Bottle', pack:'24x200ml', price: 480, stock: 150 },
                { id: 'p2', name: 'Freskey Mango 500ml', cat: 'PET Bottle', pack:'12x500ml', price: 360, stock: 45 },
                { id: 'p3', name: 'Soda 300ml', cat: 'Soda', pack:'24x300ml', price: 500, stock: 200 },
                { id: 'p4', name: 'Jeera Fizz 200ml', cat: 'Glass Bottle', pack:'24x200ml', price: 480, stock: 20 }
            ],
            invoices: [
                { id: 'INV-101', date: '2025-10-01', custName: 'Taj Hotels', total: 48000, paid: 33000, status: 'Partial' },
                { id: 'INV-102', date: '2025-10-05', custName: 'Wedding Planners Inc', total: 5000, paid: 0, status: 'Unpaid' }
            ],
            transactions: []
        };

        /* ======================== 
           CONTROLLERS 
           ======================== */
        
        // --- 1. VIEWS ---
        function Nav(view) {
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            event && event.currentTarget.classList.add('active');
            
            // Mobile Menu Close
            toggleMenu(false); 

            const title = document.getElementById('page-title');
            const box = document.getElementById('content');
            
            // VIEW ROUTING
            if(view === 'dashboard') {
                title.innerText = "Executive Dashboard";
                const total = DB.invoices.reduce((s,i)=>s+i.total,0);
                const due = DB.invoices.reduce((s,i)=>s+(i.total-i.paid),0);
                
                // Analytics
                const topProd = [...DB.products].sort((a,b)=>b.stock - a.stock)[0]; // logic stub
                
                box.innerHTML = `
                <div class="grid-kpi">
                    <div class="kpi-card" style="border-left:4px solid var(--primary)">
                        <div class="kpi-lbl">Revenue</div>
                        <div class="kpi-val">${Util.fmt(total)}</div>
                    </div>
                    <div class="kpi-card" style="border-left:4px solid var(--danger)">
                        <div class="kpi-lbl">Pending Due</div>
                        <div class="kpi-val" style="color:var(--danger)">${Util.fmt(due)}</div>
                    </div>
                    <div class="kpi-card" style="border-left:4px solid var(--warning)">
                        <div class="kpi-lbl">Stock Alert</div>
                        <div class="kpi-val">${DB.products.filter(p=>p.stock<50).length} items</div>
                    </div>
                </div>
                
                <div class="grid-cols-2">
                    <div class="card">
                        <div class="card-header"><h3>Recent Activity</h3></div>
                        <div class="card-body">
                             ${DB.invoices.slice(0,3).map(i => `<div style="border-bottom:1px solid #eee; padding:10px 0;">INV <b>${i.id}</b> generated for ${i.custName}</div>`).join('')}
                        </div>
                    </div>
                    <div class="card">
                         <div class="card-header"><h3>Inventory Value Distribution</h3></div>
                         <div class="card-body" style="height:150px; display:flex; align-items:center; justify-content:center; color:#94a3b8">
                             Chart.js Canvas (Visuals)
                         </div>
                    </div>
                </div>
                `;
            }

            else if(view === 'orders') {
                title.innerText = "Sales & Invoicing";
                box.innerHTML = `
                <div class="flex justify-between" style="margin-bottom:15px;">
                     <div>Overview of all invoices</div>
                     <button onclick="Sales.init()" class="btn btn-primary">+ New Invoice</button>
                </div>
                <div class="card">
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Date</th><th>Inv #</th><th>Customer</th><th class="text-right">Total</th><th>Due</th><th>Status</th><th>PDF</th></tr></thead>
                            <tbody>
                                ${DB.invoices.map(i => {
                                    const due = i.total - i.paid;
                                    let cls = i.status==='Paid'?'bg-paid':(i.status==='Unpaid'?'bg-pending':'bg-part');
                                    return `<tr>
                                        <td>${i.date}</td>
                                        <td>${i.id}</td>
                                        <td>${i.custName}</td>
                                        <td class="text-right text-bold">${Util.fmt(i.total)}</td>
                                        <td style="color:${due>0?'red':'green'}">${Util.fmt(due)}</td>
                                        <td><span class="badge ${cls}">${i.status}</span></td>
                                        <td><button onclick="Sales.pdf('${i.id}')" class="btn btn-sm btn-sec">⇩</button></td>
                                    </tr>`
                                }).reverse().join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            }

            else if(view === 'inventory') {
                title.innerText = "Warehouse & Products";
                box.innerHTML = `
                <div class="flex justify-between" style="margin-bottom:15px;">
                     <div>Stock Management</div>
                     <button onclick="Inventory.init()" class="btn btn-primary">Purchase / Stock In</button>
                </div>
                <div class="card">
                    <div class="table-container">
                        <table>
                            <thead><tr><th>SKU</th><th>Product</th><th>Packing</th><th>Category</th><th>Stock</th><th>Rate</th></tr></thead>
                            <tbody>
                                ${DB.products.map(p => `<tr>
                                    <td>${p.id}</td><td class="text-bold">${p.name}</td><td>${p.pack}</td>
                                    <td><span class="badge bg-info">${p.cat}</span></td>
                                    <td class="${p.stock<50?'text-bold':''} ${p.stock<50?'text-right':''}" style="${p.stock<50?'color:red':''}">${p.stock} cases</td>
                                    <td>${Util.fmt(p.price)}</td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            }

            else if(view === 'finance') {
                 title.innerText = "Payment Ledger";
                 const pendings = DB.invoices.filter(i=>i.status !== 'Paid');
                 box.innerHTML = `
                 <div class="card">
                    <div class="card-header"><h3>Outstanding Collections</h3></div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Inv #</th><th>Customer</th><th>Total</th><th>Paid So Far</th><th>Balance</th><th>Action</th></tr></thead>
                            <tbody>
                                ${pendings.length === 0 ? '<tr><td colspan="6" style="padding:20px; text-align:center">No pending payments.</td></tr>' : 
                                  pendings.map(p => {
                                      const bal = p.total - p.paid;
                                      return `<tr>
                                        <td>${p.id}</td><td>${p.custName}</td><td>${Util.fmt(p.total)}</td>
                                        <td style="color:green">${Util.fmt(p.paid)}</td>
                                        <td class="text-bold" style="color:red">${Util.fmt(bal)}</td>
                                        <td><button class="btn btn-sm btn-success" onclick="Finance.open('${p.id}')">Record Pay</button></td>
                                      </tr>`
                                  }).join('')
                                }
                            </tbody>
                        </table>
                    </div>
                 </div>`;
            }
            
            else if(view === 'crm') {
                title.innerText = "Customer CRM";
                box.innerHTML = `<div class="card">
                   <div class="table-container">
                     <table><thead><tr><th>Name</th><th>Location</th><th>Type</th><th>Contact</th></tr></thead><tbody>
                     ${DB.customers.map(c=>`<tr><td><b>${c.name}</b></td><td>${c.loc}</td><td>${c.type}</td><td>-</td></tr>`).join('')}
                     </tbody></table>
                   </div></div>`
            }
        }

        // --- 2. SALES LOGIC ---
        const Sales = {
            init: () => {
                const s = document.getElementById('ord-cust');
                s.innerHTML = DB.customers.map(c=>`<option value="${c.id}">${c.name}</option>`);
                
                document.getElementById('ord-date').value = Util.rawDate();
                
                // Build dynamic rows (Input based)
                const list = document.getElementById('ord-list');
                list.innerHTML = DB.products.map(p => `
                    <tr>
                        <td>
                            <div>${p.name}</div>
                            <small>${p.pack}</small>
                        </td>
                        <td style="${p.stock<20?'color:red':''}">${p.stock}</td>
                        <td><input type="number" min="0" class="inp ord-qty" data-price="${p.price}" data-pid="${p.id}" data-name="${p.name}" style="width:70px; margin:0;" onchange="Sales.calc()"></td>
                        <td>${Util.fmt(p.price)}</td>
                    </tr>
                `).join('');
                
                Modal('m-order', true);
                Sales.calc();
            },
            calc: () => {
                let sum = 0;
                document.querySelectorAll('.ord-qty').forEach(el => {
                    const q = parseInt(el.value)||0;
                    sum += q * parseFloat(el.dataset.price);
                });
                document.getElementById('ord-total').innerText = Util.fmt(sum);
            },
            submit: () => {
                // Collect Items
                const inputs = document.querySelectorAll('.ord-qty');
                const items = [];
                let total = 0;
                
                inputs.forEach(el => {
                   const q = parseInt(el.value)||0;
                   if(q > 0) {
                       const price = parseFloat(el.dataset.price);
                       total += (q * price);
                       // Update Stock in DB
                       const prod = DB.products.find(p=>p.id===el.dataset.pid);
                       if(prod) prod.stock -= q; 
                       items.push([prod.name, q, `Rs. ${price}`, `Rs. ${q*price}`]);
                   }
                });
                
                if(items.length === 0) return alert("Select at least 1 item");
                
                // Save Order
                const cid = document.getElementById('ord-cust').value;
                const custObj = DB.customers.find(c=>c.id===cid);
                const invId = `INV-${Math.floor(Math.random()*9000)+1000}`;
                const date = document.getElementById('ord-date').value;
                
                DB.invoices.push({
                    id: invId,
                    date: date,
                    custName: custObj.name,
                    total: total,
                    paid: 0,
                    status: 'Unpaid'
                });
                
                Modal('m-order', false);
                Util.toast('Invoice Created Successfully');
                Nav('orders');
                
                // GENERATE PDF
                Sales.genPDF(invId, date, custObj, items, total);
                
                // Sync Drive
                Drive.sync();
            },
            genPDF: (invId, date, cust, items, total) => {
                 const { jsPDF } = window.jspdf;
                 const doc = new jsPDF();
                 
                 // FIXED: No complex symbols like '₹' to avoid garbage characters "¹ &4&8"
                 // Using "Rs." / "INR" strictly.
                 
                 doc.setFontSize(22);
                 doc.setTextColor(30, 58, 138); // Blue
                 doc.text("Himalayan Beverages", 14, 20);
                 
                 doc.setFontSize(10);
                 doc.setTextColor(100);
                 doc.text("TAX INVOICE", 195, 20, {align:'right'});
                 doc.text(`Invoice #: ${invId}`, 195, 25, {align:'right'});
                 doc.text(`Date: ${date}`, 195, 30, {align:'right'});
                 
                 doc.setTextColor(0);
                 doc.text("Bill To:", 14, 40);
                 doc.setFont(undefined, 'bold');
                 doc.text(cust.name, 14, 45);
                 doc.setFont(undefined, 'normal');
                 doc.text(`Location: ${cust.loc}`, 14, 50);

                 // TABLE
                 doc.autoTable({
                     startY: 60,
                     head: [['Description', 'Qty', 'Price', 'Total']],
                     body: items,
                     theme: 'striped',
                     headStyles: { fillColor: [30, 58, 138] },
                 });
                 
                 const y = doc.lastAutoTable.finalY + 10;
                 doc.text(`Grand Total: Rs. ${total.toLocaleString('en-IN')}.00`, 195, y, {align:'right'});
                 
                 // Footer
                 doc.setFontSize(8);
                 doc.setTextColor(150);
                 doc.text("Thank you for your business. Computer Generated Invoice.", 14, 280);
                 
                 doc.save(`${invId}.pdf`);
            },
            pdf: (id) => {
                alert("To download past PDF, recreate using data logic (Simulated here)");
                // In full version, re-trigger genPDF with DB data
            }
        };

        // --- 3. FINANCE & STOCK ---
        const Finance = {
             open: (invId) => {
                 const inv = DB.invoices.find(i=>i.id===invId);
                 document.getElementById('p-ref').value = inv.id;
                 document.getElementById('p-tot').value = inv.total;
                 document.getElementById('p-due').value = inv.total - inv.paid;
                 Modal('m-pay', true);
             },
             save: () => {
                 const invId = document.getElementById('p-ref').value;
                 const amt = parseFloat(document.getElementById('p-amt').value);
                 if(!amt) return alert("Enter amount");
                 
                 const inv = DB.invoices.find(i=>i.id===invId);
                 inv.paid += amt;
                 inv.status = inv.paid >= inv.total ? 'Paid' : 'Partial';
                 
                 Modal('m-pay', false);
                 Util.toast("Payment Recorded");
                 Nav('finance');
                 Drive.sync();
             }
        };

        const Inventory = {
             init: () => {
                 document.getElementById('s-prod').innerHTML = DB.products.map(p=>`<option value="${p.id}">${p.name}</option>`);
                 Modal('m-stk', true);
             },
             add: () => {
                 const pid = document.getElementById('s-prod').value;
                 const qty = parseInt(document.getElementById('s-qty').value);
                 if(!qty) return;
                 
                 const p = DB.products.find(x=>x.id===pid);
                 p.stock += qty;
                 Modal('m-stk', false);
                 Util.toast(`Added ${qty} cases to stock`);
                 Nav('inventory');
                 Drive.sync();
             }
        };
        
        // --- 4. GOOGLE DRIVE SYNC ---
        const Drive = {
             tokenClient: null,
             init: () => {
                 try {
                     gapi.load('client', async () => {
                        await gapi.client.init({
                            apiKey: APP.API_KEY,
                            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                        });
                     });
                     Drive.tokenClient = google.accounts.oauth2.initTokenClient({
                         client_id: APP.CLIENT_ID,
                         scope: 'https://www.googleapis.com/auth/drive.file',
                         callback: (resp) => {
                             if(resp.error) return console.error(resp);
                             Drive.onAuth();
                         },
                     });
                 } catch(e){ console.log("Cloud unavailable"); }
             },
             auth: () => { Drive.tokenClient.requestAccessToken({prompt:'consent'}); },
             onAuth: () => {
                 document.getElementById('drive-stat').innerHTML = "<span style='width:8px;height:8px;border-radius:50%;background:#4ade80'></span> Online & Syncing";
                 document.getElementById('stat-dot').style.background="#4ade80";
                 Util.toast("Google Drive Connected");
                 Drive.sync();
             },
             sync: async () => {
                 if(!gapi.client.getToken()) return;
                 const blob = new Blob([JSON.stringify(DB)], {type:'application/json'});
                 // For simplicity in single-file demo, we assume overwrite or create logic
                 // This part simulates the call structure:
                 console.log("Syncing to " + APP.DB_FILE);
                 // Real impl involves searching for fileId, then PATCH or POST multipart.
             }
        };
        
        // --- 5. UI CORE ---
        function Modal(id, state) {
            const el = document.getElementById(id);
            if(state) el.classList.add('active');
            else el.classList.remove('active');
        }
        function toggleMenu(forceState) {
            const sb = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            // Logic to toggle 'open' class
            const isOpen = sb.classList.contains('open');
            const targetState = forceState !== undefined ? forceState : !isOpen;

            if(targetState) {
                sb.classList.add('open');
                overlay.style.display = 'block';
            } else {
                sb.classList.remove('open');
                overlay.style.display = 'none';
            }
        }

        // --- INIT ---
        window.onload = () => {
            Nav('dashboard');
            Drive.init();
        };

    </script>
</body>
</html>
