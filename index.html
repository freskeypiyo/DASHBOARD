<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freskey Admin Panel | Control Room</title>
    
    <!-- Google API Scripts -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    
    <!-- PDF Generation Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* =========================================
           CSS STYLES (Responsive & Clean)
           ========================================= */
        :root {
            --color-primary: #0f172a; 
            --color-primary-light: #1e293b;
            --color-accent: #0ea5e9; 
            --color-accent-hover: #0284c7;
            --color-success: #10b981; 
            --color-warning: #f59e0b; 
            --color-danger: #ef4444; 
            --bg-body: #f1f5f9; 
            --bg-card: #ffffff;
            --bg-input: #f8fafc;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --text-light: #94a3b8;
            --border-color: #e2e8f0;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); color: var(--text-main); font-size: 14px; line-height: 1.5; height: 100vh; overflow: hidden; }
        
        /* Layout */
        #app-container { display: grid; grid-template-columns: 240px 1fr; height: 100vh; }
        .sidebar { background-color: var(--color-primary); color: white; display: flex; flex-direction: column; z-index: 100; transition: 0.3s; }
        .main-content { background-color: var(--bg-body); overflow-y: auto; display: flex; flex-direction: column; width: 100%; }
        
        /* Mobile Specific */
        @media (max-width: 768px) {
            #app-container { display: block; }
            .sidebar { position: fixed; left: -260px; top: 0; bottom: 0; width: 260px; box-shadow: var(--shadow-lg); }
            .sidebar.open { transform: translateX(260px); }
            .top-bar { padding: 1rem; }
            #menu-toggle { display: block !important; margin-right: 15px; background:none; border:1px solid #ddd; padding:4px 8px; font-size:1.2rem;}
            #overlay.active { display: block; }
            .dashboard-split { grid-template-columns: 1fr !important; }
        }

        #menu-toggle { display: none; }
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 90; }

        /* UI Elements */
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; border-radius: var(--radius-sm); font-weight: 600; cursor: pointer; border: none; transition: 0.2s; }
        .btn-primary { background: var(--color-primary); color: white; }
        .btn-primary:hover { background: var(--color-primary-light); }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); }
        .btn-google { background: white; color: #555; border: 1px solid #ddd; width: 100%; gap:10px; padding: 0.8rem; }
        
        .card { background: var(--bg-card); padding: 1.5rem; border-radius: var(--radius-md); box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .dashboard-split { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; }
        
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.85rem; }
        .form-input, .form-select { width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-input); }
        
        /* Tables */
        .table-container { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: white; min-width: 600px; }
        th { text-align: left; padding: 1rem; background: var(--bg-body); font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); }
        td { padding: 1rem; border-top: 1px solid var(--border-color); }
        
        /* Sidebar Nav */
        .brand-section { padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .brand-title { font-size: 1.5rem; font-weight: bold; }
        .nav-item { padding: 0.8rem 1.5rem; cursor: pointer; color: var(--text-light); transition: 0.2s; }
        .nav-item:hover, .nav-item.active { color: var(--color-accent); background: rgba(255,255,255,0.05); }
        .user-section { padding: 1rem; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.8rem; overflow: hidden; text-overflow: ellipsis; }

        /* Login Screen */
        #login-screen { position: fixed; inset: 0; background: var(--color-primary); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-box { background: white; padding: 2.5rem; border-radius: var(--radius-lg); width: 90%; max-width: 400px; box-shadow: var(--shadow-lg); text-align: center; }

        /* Toast */
        #toast-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 10000; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { background: white; padding: 1rem; border-radius: var(--radius-md); box-shadow: var(--shadow-lg); border-left: 4px solid var(--color-primary); min-width: 250px; animation: slideIn 0.3s; }
        @keyframes slideIn { from{transform:translateX(100%)} to{transform:translateX(0)} }
        
        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 5000; padding: 1rem; }
        .modal { background: white; padding: 2rem; border-radius: var(--radius-md); width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        
        .hidden { display: none !important; }
        .flex { display: flex; } .justify-between { justify-content: space-between; } .items-center { align-items: center; } .gap-2 { gap: 0.5rem; } .gap-4 { gap: 1rem; }
        .text-success { color: var(--color-success); } .text-danger { color: var(--color-danger); }
        .top-bar { background: white; padding: 1rem 2rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        
        /* Helper */
        .hint-text { font-size: 0.8rem; color: var(--color-accent); font-weight: 600; display: block; margin-top: 4px; }
    </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen">
    <div class="login-box">
        <h1 style="color:var(--color-primary); margin-bottom:0.5rem; font-weight:800; font-size:2rem;">FRESKEY<span style="color:var(--color-accent)">.</span></h1>
        <p style="color:#666; margin-bottom:2rem;">Admin Control Panel</p>
        
        <div id="g_id_onload"
             data-client_id="950010994560-v7p6cem78h9fsdp102iq4immb36t95ls.apps.googleusercontent.com"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>
        
        <button class="btn btn-google" onclick="GoogleAuth.initTokenClient()">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20">
            <span>Sign in with Google</span>
        </button>
        <p id="login-status" style="margin-top:1rem; font-size:0.8rem; color:#888;">Secure Cloud Database</p>
    </div>
</div>

<!-- MOBILE OVERLAY -->
<div id="overlay" onclick="app.toggleSidebar()"></div>

<!-- APP UI -->
<div id="app-container" class="hidden">
    <aside class="sidebar" id="sidebar">
        <div class="brand-section">
            <div class="flex justify-between items-center">
                <div class="brand-title">FRESKEY</div>
                <div onclick="app.toggleSidebar()" style="cursor:pointer; font-size:1.5rem; display:none;" class="mobile-close">√ó</div>
            </div>
            <div style="font-size:0.75rem; opacity:0.7; letter-spacing:1px; text-transform:uppercase;">Control First</div>
        </div>
        <nav class="nav-menu">
            <div class="nav-item active" onclick="router.navigate('dashboard')">üìä Dashboard</div>
            <div class="nav-item" onclick="router.navigate('new-order')">üìù New Order</div>
            <div class="nav-item" onclick="router.navigate('customers')">üë• Customers</div>
            <div class="nav-item" onclick="router.navigate('deliveries')">üöö Deliveries</div>
            <div class="nav-item" onclick="router.navigate('payments')">üí∞ Payments</div>
            <div class="nav-item" onclick="router.navigate('events')">üéâ Events</div>
            <div class="nav-item" onclick="router.navigate('inventory')">üì¶ Inventory</div>
            <div class="nav-item" onclick="router.navigate('reports')">üìà Reports</div>
            <div class="nav-item" onclick="router.navigate('settings')">‚öôÔ∏è Settings</div>
        </nav>
        <div class="user-section">
            <div id="user-display-email" style="font-weight:600;">...</div>
            <small id="sync-status" class="text-success">‚óè Synced</small>
        </div>
    </aside>

    <main class="main-content">
        <header class="top-bar">
            <div class="flex items-center">
                <button id="menu-toggle" onclick="app.toggleSidebar()">‚ò∞</button>
                <h2 id="page-title" style="font-size:1.25rem; font-weight:700; color:var(--text-main);">Dashboard</h2>
            </div>
            <div class="flex items-center gap-4">
                <span id="clock" style="color:#888; font-family:monospace; display:none;"></span>
                <button class="btn btn-outline" onclick="GoogleAuth.logout()" style="font-size:0.8rem;">Logout</button>
            </div>
        </header>

        <div id="content-area" class="content-area"></div>
    </main>
</div>

<div id="toast-container"></div>
<div id="modal-container" class="hidden modal-overlay"></div>

<script>
/* =============================================================================
   FRESKEY ENGINE: Auto-Sync Google Drive Database & PDF Reports
   ============================================================================= */

const CONSTANTS = {
    SKUS: ['200ml', '500ml', '1L'],
    CASE_SIZE: { '200ml': 24, '500ml': 20, '1L': 12 },
    HUBS: ['North Zone', 'South Zone', 'East Zone', 'West Hub', 'Central'],
    CUSTOMER_TYPES: ['Residential', 'Corporate', 'Retail', 'Event'],
    PAYMENT_MODES: ['Cash', 'Online/UPI', 'Credit'],
    STATUS: { ACTIVE: 'Active', BLOCKED: 'Blocked', DELIVERED: 'Delivered', PENDING: 'Pending' },
    DB_FILENAME: 'freskey_db.json'
};

const GOOGLE_CONFIG = {
    CLIENT_ID: '950010994560-v7p6cem78h9fsdp102iq4immb36t95ls.apps.googleusercontent.com',
    API_KEY: 'AIzaSyCWo9OP6-QhyKWpfuV5oonyuC32IQHoOtE',
    SCOPES: 'https://www.googleapis.com/auth/drive.file',
    DISCOVERY_DOCS: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
};

let store = {
    settings: { prices: {'200ml':10, '500ml':20, '1L':40}, costs: {'200ml':4, '500ml':8, '1L':15}, creditDefaults: {'Residential':500, 'Retail':2000, 'Corporate':5000, 'Event':0} },
    inventory: {'200ml':0, '500ml':0, '1L':0},
    customers: [], orders: [], events: [],
    fileId: null // Stores the Google Drive File ID
};

let tokenClient;
let gapiInited = false;
let gisInited = false;

/* --- GOOGLE AUTH & DRIVE SYNC --- */
const GoogleAuth = {
    init: function() {
        gapi.load('client', async () => {
            await gapi.client.init({ apiKey: GOOGLE_CONFIG.API_KEY, discoveryDocs: GOOGLE_CONFIG.DISCOVERY_DOCS });
            gapiInited = true;
        });
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CONFIG.CLIENT_ID,
            scope: GOOGLE_CONFIG.SCOPES,
            callback: '', // Set dynamic
        });
        gisInited = true;
    },

    initTokenClient: function() {
        if(!gisInited) return UI.toast("Google Services Loading... Wait", "warning");
        tokenClient.callback = async (resp) => {
            if (resp.error) throw resp;
            await this.handleLoginSuccess(resp.access_token);
        };
        tokenClient.requestAccessToken({prompt: ''});
    },

    handleLoginSuccess: async function(token) {
        document.getElementById('login-status').innerText = "Loading Database...";
        
        // 1. Get User Info
        const userReq = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { Authorization: `Bearer ${token}` }});
        const user = await userReq.json();
        document.getElementById('user-display-email').innerText = user.email;
        
        // 2. Find Database File
        await this.findAndLoadDB();

        // 3. Enter App
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        router.navigate('dashboard');

        // 4. Start Auto-Sync (Every 1 Minute)
        setInterval(() => this.saveDB(true), 60000); 
    },

    findAndLoadDB: async function() {
        try {
            // Search for file
            const q = `name = '${CONSTANTS.DB_FILENAME}' and trashed = false`;
            const resp = await gapi.client.drive.files.list({ q: q, fields: 'files(id, name)' });
            const files = resp.result.files;

            if (files && files.length > 0) {
                // FOUND: Load it
                store.fileId = files[0].id;
                UI.toast("Database Found. Loading...", "info");
                const fileContent = await gapi.client.drive.files.get({ fileId: store.fileId, alt: 'media' });
                // Merge loaded data into store, keeping fileId
                const loadedData = fileContent.result;
                store = { ...store, ...loadedData, fileId: store.fileId };
                UI.toast("Data Loaded Successfully", "success");
            } else {
                // NOT FOUND: Create new with Mock Data
                UI.toast("No Database Found. Creating New...", "warning");
                DataGenerator.init();
                await this.createDBFile();
            }
        } catch (err) {
            console.error(err);
            UI.toast("Error Loading Data. Using Offline Mode.", "danger");
            DataGenerator.init(); // Fallback
        }
    },

    createDBFile: async function() {
        const fileContent = JSON.stringify(store);
        const file = new Blob([fileContent], {type: 'application/json'});
        const metadata = { 'name': CONSTANTS.DB_FILENAME, 'mimeType': 'application/json' };

        const accessToken = gapi.client.getToken().access_token;
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
        form.append('file', file);

        const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
            body: form
        });
        const data = await res.json();
        store.fileId = data.id;
        UI.toast("Database Created in Drive", "success");
    },

    saveDB: async function(isAuto = false) {
        if (!store.fileId) return; // Can't save if no file ID
        
        document.getElementById('sync-status').innerText = "‚Üª Syncing...";
        if(!isAuto) UI.toast("Syncing Data to Drive...", "info");

        const fileContent = JSON.stringify(store);
        const file = new Blob([fileContent], {type: 'application/json'});
        
        const accessToken = gapi.client.getToken().access_token;
        
        // Update existing file (PATCH)
        const res = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${store.fileId}?uploadType=media`, {
            method: 'PATCH',
            headers: new Headers({ 
                'Authorization': 'Bearer ' + accessToken,
                'Content-Type': 'application/json'
            }),
            body: fileContent
        });

        if(res.ok) {
            document.getElementById('sync-status').innerText = "‚óè Synced";
            if(isAuto) UI.toast("Auto-Sync: Data Saved", "success");
            else UI.toast("Manual Sync Complete", "success");
        } else {
            document.getElementById('sync-status').innerText = "‚ö† Error";
            UI.toast("Sync Failed. Check Internet.", "danger");
        }
    },

    logout: function() {
        const token = gapi.client.getToken();
        if (token) google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        location.reload();
    }
};

/* --- CORE LOGIC --- */
const Engine = {
    checkCredit: (id, amt) => {
        const c = store.customers.find(x => x.id === id);
        return c ? (c.type === 'Event' || (c.outstanding + amt <= c.creditLimit)) : false;
    },
    getStats: () => {
        const today = new Date().toISOString().split('T')[0];
        let stats = { rev:0, btl:0, pro:0, pen:0, sku:{'200ml':0,'500ml':0,'1L':0} };
        store.orders.forEach(o => {
            if(o.date === today) {
                stats.rev += o.amount; stats.btl += o.totalBottles; stats.pro += o.profit;
                if(!o.isPaid) stats.pen += o.amount;
                Object.keys(o.items).forEach(k => stats.sku[k] += o.items[k]);
            }
        });
        return stats;
    },
    blockCust: (id) => { const c = store.customers.find(x=>x.id===id); if(c) c.status = CONSTANTS.STATUS.BLOCKED; },
    updateStock: (sku, qty, op) => { op === 'add' ? store.inventory[sku] += qty : store.inventory[sku] -= qty; },
    getCases: (sku, btl) => { 
        const c = (btl / CONSTANTS.CASE_SIZE[sku]).toFixed(1);
        return c.endsWith('.0') ? parseInt(c) : c;
    },
    
    // PDF GENERATOR
    generateDailyPDF: function() {
        if (!window.jspdf) return UI.toast("PDF Lib not loaded", "danger");
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const today = new Date().toISOString().split('T')[0];
        const stats = this.getStats();

        // Header
        doc.setFontSize(18);
        doc.text("Freskey Daily Sales Report", 14, 20);
        doc.setFontSize(10);
        doc.text(`Date: ${today}`, 14, 28);
        doc.text(`Generated by: ${document.getElementById('user-display-email').innerText}`, 14, 33);

        // Summary Box
        doc.setDrawColor(0);
        doc.setFillColor(240, 240, 240);
        doc.rect(14, 40, 180, 25, 'F');
        doc.setFontSize(12);
        doc.text(`Total Bottles: ${stats.btl}`, 20, 50);
        doc.text(`Revenue: Rs. ${stats.rev}`, 80, 50);
        doc.text(`Profit: Rs. ${stats.pro}`, 140, 50);
        doc.setFontSize(10);
        doc.text(`Pending Collections: Rs. ${stats.pen}`, 20, 60);

        // Table Data
        const tableBody = store.orders
            .filter(o => o.date === today)
            .map(o => [
                o.customerName,
                o.area,
                `${o.totalBottles}`,
                `Rs. ${o.amount}`,
                o.paymentMode,
                o.status
            ]);

        // Generate Table
        doc.autoTable({
            startY: 70,
            head: [['Customer', 'Area', 'Bottles', 'Amount', 'Mode', 'Status']],
            body: tableBody,
            theme: 'grid',
            headStyles: { fillColor: [15, 23, 42] } // matching brand color
        });

        doc.save(`Freskey_Report_${today}.pdf`);
        UI.toast("PDF Downloaded", "success");
    }
};

/* --- UI HELPERS --- */
const UI = {
    toast: (msg, type) => {
        const el = document.createElement('div');
        el.className = `toast`; el.style.borderLeftColor = `var(--color-${type})`;
        el.innerHTML = `<span>${msg}</span>`;
        document.getElementById('toast-container').appendChild(el);
        setTimeout(() => el.remove(), 3000);
    },
    modal: (html) => {
        const mc = document.getElementById('modal-container');
        mc.innerHTML = `<div class="modal"><div class="modal-header"><h3 class="modal-title">Freskey Control</h3><span class="close-modal" onclick="UI.close()">√ó</span></div><div>${html}</div></div>`;
        mc.classList.remove('hidden');
    },
    close: () => document.getElementById('modal-container').classList.add('hidden')
};

const app = {
    toggleSidebar: () => document.getElementById('sidebar').classList.toggle('open') || document.getElementById('overlay').classList.toggle('active'),
};

/* --- DATA GENERATOR (Fallback) --- */
const DataGenerator = {
    init: function() {
        store.inventory = { '200ml': 1200, '500ml': 800, '1L': 400 };
        for(let i=0; i<30; i++) {
            store.customers.push({
                id: `C${i}`, name: `Customer ${i}`, type: 'Retail', area: 'North Zone', 
                location: 'Main St', phone: '9999999999', status: 'Active', 
                creditLimit: 2000, outstanding: 0, joinedDate: new Date().toISOString()
            });
        }
    }
};

/* --- PAGES & ROUTER --- */
const Pages = {
    dashboard: () => {
        const st = Engine.getStats();
        return `
        <div class="stat-grid">
            <div class="card"><div class="stat-label">Sold Today</div><div class="stat-value">${st.btl}</div></div>
            <div class="card"><div class="stat-label">Revenue</div><div class="stat-value">‚Çπ${st.rev}</div></div>
            <div class="card"><div class="stat-label">Pending</div><div class="stat-value text-danger">‚Çπ${st.pen}</div></div>
        </div>
        <div class="dashboard-split">
            <div class="card">
                <h3>Actions</h3>
                <div class="flex gap-4" style="margin-top:1rem;">
                    <button class="btn btn-primary" onclick="router.navigate('new-order')" style="width:100%">+ Order</button>
                    <button class="btn btn-outline" onclick="GoogleAuth.saveDB()" style="width:100%">Force Sync</button>
                </div>
            </div>
            <div class="card"><h3>Alerts</h3>${st.pen > 1000 ? '<div class="alert-box">Collect Pending Cash</div>' : '<p class="text-muted">System Normal</p>'}</div>
        </div>`;
    },
    newOrder: () => {
        const opts = store.customers.filter(c=>c.status!=='Blocked').map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
        return `
        <div class="card" style="max-width:600px; margin:0 auto;">
            <div class="form-group"><label class="form-label">Customer</label><select id="n-cust" class="form-select">${opts}</select></div>
            <div class="form-group"><label class="form-label">Date</label><input type="date" id="n-date" class="form-input" value="${new Date().toISOString().split('T')[0]}"></div>
            <hr style="margin:1rem 0; border:0; border-top:1px solid #eee;">
            <div class="flex gap-4">
                <div style="flex:1"><label class="form-label">200ml</label><input type="number" id="q200" class="form-input" placeholder="0" oninput="Pages.calcTotal()"></div>
                <div style="flex:1"><label class="form-label">500ml</label><input type="number" id="q500" class="form-input" placeholder="0" oninput="Pages.calcTotal()"></div>
                <div style="flex:1"><label class="form-label">1L</label><input type="number" id="q1l" class="form-input" placeholder="0" oninput="Pages.calcTotal()"></div>
            </div>
            <div style="margin-top:1rem; text-align:right; font-weight:bold; font-size:1.2rem;" id="ord-total">‚Çπ0</div>
            <div class="form-group mt-2">
                <label class="form-label">Payment</label>
                <select id="n-pay" class="form-select">${CONSTANTS.PAYMENT_MODES.map(m=>`<option>${m}</option>`).join('')}</select>
            </div>
            <button class="btn btn-primary" style="width:100%; margin-top:1rem;" onclick="Pages.subOrder()">Place Order</button>
        </div>`;
    },
    calcTotal: () => {
        const q2 = parseInt(document.getElementById('q200').value)||0;
        const q5 = parseInt(document.getElementById('q500').value)||0;
        const q1 = parseInt(document.getElementById('q1l').value)||0;
        const t = (q2*store.settings.prices['200ml'])+(q5*store.settings.prices['500ml'])+(q1*store.settings.prices['1L']);
        document.getElementById('ord-total').innerText = `‚Çπ${t}`;
    },
    subOrder: () => {
        const cid = document.getElementById('n-cust').value;
        const cust = store.customers.find(c=>c.id===cid);
        const q2 = parseInt(document.getElementById('q200').value)||0;
        const q5 = parseInt(document.getElementById('q500').value)||0;
        const q1 = parseInt(document.getElementById('q1l').value)||0;
        const amt = (q2*store.settings.prices['200ml'])+(q5*store.settings.prices['500ml'])+(q1*store.settings.prices['1L']);
        const items = {}; if(q2)items['200ml']=q2; if(q5)items['500ml']=q5; if(q1)items['1L']=q1;

        if(amt===0) return UI.toast("Empty Order", "warning");

        const pay = document.getElementById('n-pay').value;
        if(pay==='Credit' && !Engine.checkCredit(cid, amt)) return UI.toast("Credit Limit Exceeded", "danger");

        store.orders.push({
            id: 'ORD'+Date.now(), customerId: cid, customerName: cust.name, area: cust.area,
            date: document.getElementById('n-date').value, items, totalBottles: q2+q5+q1, amount: amt,
            paymentMode: pay, isPaid: pay!=='Credit', status: 'Pending', profit: amt*0.3 // approx
        });
        
        if(pay==='Credit') cust.outstanding += amt;
        Engine.updateStock('200ml', q2, 'sub'); Engine.updateStock('500ml', q5, 'sub'); Engine.updateStock('1L', q1, 'sub');
        
        UI.toast("Order Saved", "success");
        router.navigate('dashboard');
    },
    customers: () => {
        const rows = store.customers.map(c=>`<tr><td>${c.name}</td><td>${c.area}</td><td>${c.outstanding}</td><td><button class="btn btn-outline" style="padding:2px 5px" onclick="Pages.editCust('${c.id}')">Edit</button></td></tr>`).join('');
        return `
        <div class="flex justify-between items-center mb-4"><h3 style="margin:0">Customers</h3><button class="btn btn-primary" onclick="Pages.addCustModal()">+ Add</button></div>
        <div class="table-container"><table><thead><tr><th>Name</th><th>Hub</th><th>Due</th><th>Act</th></tr></thead><tbody>${rows}</tbody></table></div>`;
    },
    addCustModal: () => {
        UI.modal(`
            <div class="form-group"><label>Name</label><input id="nc-name" class="form-input"></div>
            <div class="form-group"><label>Area</label><select id="nc-area" class="form-select">${CONSTANTS.HUBS.map(h=>`<option>${h}</option>`).join('')}</select></div>
            <div class="form-group"><label>Credit Limit</label><input type="number" id="nc-lim" class="form-input" value="1000"></div>
            <button class="btn btn-primary" style="width:100%" onclick="Pages.saveCust()">Save</button>
        `);
    },
    saveCust: () => {
        const n = document.getElementById('nc-name').value;
        if(!n) return;
        store.customers.push({id:'C'+Date.now(), name:n, area:document.getElementById('nc-area').value, status:'Active', creditLimit:parseInt(document.getElementById('nc-lim').value), outstanding:0, type:'Retail'});
        UI.close(); UI.toast("Added", "success"); router.render();
    },
    editCust: (id) => {
        const c = store.customers.find(x=>x.id===id);
        UI.modal(`
            <h3>${c.name}</h3>
            <div class="form-group"><label>Limit</label><input id="ec-lim" class="form-input" value="${c.creditLimit}"></div>
            <button class="btn btn-primary" style="width:100%" onclick="(() => { store.customers.find(x=>x.id==='${id}').creditLimit = parseInt(document.getElementById('ec-lim').value); UI.close(); router.render(); })()">Update</button>
        `);
    },
    deliveries: () => {
        const today=new Date().toISOString().split('T')[0];
        const rows = store.orders.filter(o=>o.date===today && o.status==='Pending').map(o=>`<tr><td>${o.customerName}</td><td>${o.area}</td><td>${o.totalBottles}</td><td><button class="btn btn-success" style="padding:2px 5px" onclick="((id)=>{store.orders.find(x=>x.id===id).status='Delivered';router.render()})('${o.id}')">Done</button></td></tr>`).join('');
        return `<h3>Deliveries (${today})</h3><div class="table-container"><table><thead><tr><th>Cust</th><th>Loc</th><th>Btl</th><th>Ok</th></tr></thead><tbody>${rows||'<tr><td colspan="4">No pending</td></tr>'}</tbody></table></div>`;
    },
    payments: () => {
        const rows = store.customers.filter(c=>c.outstanding>0).map(c=>`<tr><td>${c.name}</td><td class="text-danger">${c.outstanding}</td><td><button class="btn btn-primary" style="padding:2px 5px" onclick="Pages.getMoney('${c.id}')">Recv</button></td></tr>`).join('');
        return `<h3>Payments</h3><div class="table-container"><table><thead><tr><th>Name</th><th>Due</th><th>Act</th></tr></thead><tbody>${rows}</tbody></table></div>`;
    },
    getMoney: (id) => {
        const c = store.customers.find(x=>x.id===id);
        UI.modal(`<h3>${c.name}</h3><p>Due: Rs. ${c.outstanding}</p><button class="btn btn-success" style="width:100%" onclick="(() => { store.customers.find(x=>x.id==='${id}').outstanding=0; UI.close(); router.render(); })()">Mark Paid (Full)</button>`);
    },
    events: () => {
        const rows = store.events.map(e=>`<tr><td>${e.name}</td><td>${e.date}</td><td>${e.bottles}</td></tr>`).join('');
        return `<div class="flex justify-between mb-4"><h3>Events</h3><button class="btn btn-primary" onclick="Pages.addEvt()">+ Book</button></div><div class="table-container"><table><thead><tr><th>Name</th><th>Date</th><th>Btl</th></tr></thead><tbody>${rows}</tbody></table></div>`;
    },
    addEvt: () => {
        UI.modal(`<div class="form-group"><label>Name</label><input id="ev-n" class="form-input"></div><div class="form-group"><label>Date</label><input type="date" id="ev-d" class="form-input"></div><div class="form-group"><label>Bottles</label><input type="number" id="ev-b" class="form-input"></div><button class="btn btn-primary" style="width:100%" onclick="Pages.saveEvt()">Book</button>`);
    },
    saveEvt: () => {
         store.events.push({id:'E'+Date.now(), name:document.getElementById('ev-n').value, date:document.getElementById('ev-d').value, bottles:document.getElementById('ev-b').value, status:'Scheduled'});
         UI.close(); router.render();
    },
    inventory: () => {
        return `<div class="stat-grid">
            <div class="card"><h4>200ml</h4><h2>${store.inventory['200ml']}</h2><small>${Engine.getCases('200ml', store.inventory['200ml'])} Cases</small><button class="btn btn-outline" style="width:100%;margin-top:5px" onclick="Pages.addStk('200ml')">+</button></div>
            <div class="card"><h4>500ml</h4><h2>${store.inventory['500ml']}</h2><small>${Engine.getCases('500ml', store.inventory['500ml'])} Cases</small><button class="btn btn-outline" style="width:100%;margin-top:5px" onclick="Pages.addStk('500ml')">+</button></div>
            <div class="card"><h4>1L</h4><h2>${store.inventory['1L']}</h2><small>${Engine.getCases('1L', store.inventory['1L'])} Cases</small><button class="btn btn-outline" style="width:100%;margin-top:5px" onclick="Pages.addStk('1L')">+</button></div>
        </div>`;
    },
    addStk: (s) => { const q=prompt('Qty Bottles:'); if(q) {store.inventory[s]+=parseInt(q); router.render();} },
    reports: () => {
        return `<h3>Reports</h3>
        <div class="stat-grid" style="margin-top:1rem;">
            <div class="card" onclick="Engine.generateDailyPDF()" style="cursor:pointer; border-left:4px solid var(--color-primary);"><h4>Daily Sales Report</h4><small>Download PDF</small></div>
            <div class="card" onclick="Engine.exportCustomerLedgerCSV()" style="cursor:pointer; border-left:4px solid var(--color-success);"><h4>Customer CSV</h4><small>Download CSV</small></div>
        </div>`;
    },
    settings: () => `<h3>Settings</h3><div class="card"><p>Prices</p>200ml: Rs.${store.settings.prices['200ml']}<br>500ml: Rs.${store.settings.prices['500ml']}<br>1L: Rs.${store.settings.prices['1L']}<hr style="margin:1rem 0; border:0; border-top:1px solid #eee;"><button class="btn btn-google" onclick="GoogleAuth.saveDB()">Force Data Sync</button></div>`
};

const router = {
    navigate: (p) => { 
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        document.getElementById('page-title').innerText = p.charAt(0).toUpperCase() + p.slice(1);
        document.getElementById('content-area').innerHTML = Pages[p]();
        if(window.innerWidth<=768 && document.getElementById('sidebar').classList.contains('open')) app.toggleSidebar();
    },
    render: () => router.navigate(document.getElementById('page-title').innerText.toLowerCase().replace(' ','-') || 'dashboard')
};

/* Start */
setInterval(()=>document.getElementById('clock').innerText=new Date().toLocaleTimeString(),1000);
GoogleAuth.init();

</script>
</body>
</html>
