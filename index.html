<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freskey Admin Panel | Cloud Sync</title>
    
    <!-- Google API Scripts -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    
    <!-- Reporting Libraries (PDF & Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* =========================================
           1. CSS VARIABLES & RESET
           ========================================= */
        :root {
            /* Brand Colors */
            --color-primary: #0f172a; 
            --color-primary-light: #1e293b;
            --color-accent: #0ea5e9; 
            --color-accent-hover: #0284c7;
            
            /* Status Colors */
            --color-success: #10b981; 
            --color-warning: #f59e0b; 
            --color-danger: #ef4444; 
            --color-info: #3b82f6;

            /* Backgrounds */
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --bg-input: #f8fafc;

            /* Text */
            --text-main: #0f172a;
            --text-muted: #64748b;
            --text-light: #94a3b8;
            --text-white: #ffffff;

            /* Borders */
            --border-color: #e2e8f0;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, sans-serif; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-size: 14px;
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
        }

        /* =========================================
           2. RESPONSIVE LAYOUT & UTILITIES
           ========================================= */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .font-bold { font-weight: 700; }
        .text-success { color: var(--color-success); }
        .text-danger { color: var(--color-danger); }
        .text-muted { color: var(--text-muted); }

        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0.5rem 1rem; border-radius: var(--radius-sm);
            font-weight: 600; cursor: pointer; border: 1px solid transparent;
            transition: all 0.2s; font-size: 0.875rem;
        }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover { background-color: var(--color-primary-light); }
        .btn-accent { background-color: var(--color-accent); color: white; }
        .btn-danger { background-color: var(--color-danger); color: white; }
        .btn-success { background-color: var(--color-success); color: white; }
        .btn-outline { background-color: transparent; border-color: var(--border-color); color: var(--text-main); }
        .btn-google { background-color: white; color: #757575; border: 1px solid #ddd; display: flex; gap: 10px; width: 100%; justify-content: center; padding: 12px; }

        /* App Container */
        #app-container {
            display: grid;
            grid-template-columns: 240px 1fr;
            height: 100vh;
            transition: all 0.3s;
        }

        /* Sidebar */
        .sidebar {
            background-color: var(--color-primary);
            color: var(--text-white);
            display: flex; flex-direction: column;
            border-right: 1px solid var(--color-primary-light);
            z-index: 50;
        }
        .brand-section { padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .brand-title { font-size: 1.5rem; font-weight: bold; }
        .nav-menu { flex: 1; padding: 1rem 0; overflow-y: auto; }
        .nav-item {
            padding: 0.75rem 1.5rem; cursor: pointer; color: var(--text-light);
            transition: all 0.2s; display: flex; align-items: center; gap: 10px; font-weight: 500;
        }
        .nav-item:hover { color: white; background-color: rgba(255,255,255,0.05); }
        .nav-item.active { color: var(--color-accent); background-color: rgba(14, 165, 233, 0.1); border-left: 3px solid var(--color-accent); }
        .user-section { padding: 1rem 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.8rem; }

        /* Main Content */
        .main-content { background-color: var(--bg-body); overflow-y: auto; display: flex; flex-direction: column; position: relative; }
        .top-bar {
            background: white; padding: 1rem 2rem; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 40;
        }
        .screen-title { font-size: 1.25rem; font-weight: 700; color: var(--color-primary); }
        .content-area { padding: 2rem; max-width: 1400px; margin: 0 auto; width: 100%; }

        /* Mobile Toggle */
        .mobile-toggle { display: none; font-size: 1.5rem; cursor: pointer; margin-right: 1rem; }

        /* Responsive Media Queries */
        @media (max-width: 768px) {
            #app-container { grid-template-columns: 1fr; }
            .sidebar {
                position: fixed; top: 0; left: -240px; width: 240px; height: 100%;
                transition: left 0.3s ease;
            }
            .sidebar.open { left: 0; }
            .mobile-toggle { display: block; }
            .content-area { padding: 1rem; }
            .dashboard-split { grid-template-columns: 1fr !important; }
            .top-bar { padding: 0.5rem 1rem; }
            .stat-grid { grid-template-columns: 1fr 1fr; } 
        }

        /* Cards & Forms */
        .card { background: var(--bg-card); border-radius: var(--radius-md); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); padding: 1.5rem; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .dashboard-split { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem; }
        .form-input, .form-select {
            width: 100%; padding: 0.625rem; border: 1px solid var(--border-color);
            border-radius: var(--radius-sm); background: var(--bg-input); font-size: 0.9rem;
        }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: var(--radius-md); overflow: hidden; margin-top: 1rem; }
        th { text-align: left; padding: 1rem; background: var(--bg-body); font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); }
        td { padding: 1rem; border-top: 1px solid var(--border-color); font-size: 0.9rem; }
        
        /* Badges */
        .badge { padding: 0.25rem 0.6rem; border-radius: 99px; font-size: 0.75rem; font-weight: 600; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #e0f2fe; color: #075985; }

        /* Login Screen */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--color-primary); display: flex; align-items: center; justify-content: center; z-index: 9999;
        }
        .login-box { background: white; padding: 2.5rem; border-radius: var(--radius-lg); width: 90%; max-width: 400px; box-shadow: var(--shadow-md); }

        /* Toasts & Modals */
        #toast-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 10000; display: flex; flex-direction: column; gap: 1rem; }
        .toast { padding: 1rem; background: white; border-radius: var(--radius-md); box-shadow: var(--shadow-md); border-left: 4px solid var(--color-info); animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center; z-index: 5000; backdrop-filter: blur(2px);
        }
        .modal { background: white; padding: 2rem; border-radius: var(--radius-md); width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        
        /* Loaders */
        .sync-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #333; color: #fff; margin-left: 10px; }
        .sync-badge.syncing { background: var(--color-warning); color: black; }
    </style>
</head>
<body>

<!-- 0. LOGIN SCREEN -->
<div id="login-screen">
    <div class="login-box">
        <div class="text-center mb-4">
            <h1 style="font-size:2rem; font-weight:800; color:var(--color-primary)">FRESKEY<span style="color:var(--color-accent)">.</span></h1>
            <p class="text-muted">Cloud Admin Control</p>
        </div>
        
        <button class="btn btn-google" onclick="GoogleAuth.handleAuthClick()">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20" height="20">
            <span>Sign in with Google</span>
        </button>
        <p id="login-msg" class="text-center text-muted mt-4" style="font-size: 0.8rem;">Requires Google Drive Permissions</p>
    </div>
</div>

<!-- APP CONTAINER -->
<div id="app-container" class="hidden">
    <!-- MOBILE OVERLAY -->
    <div id="sidebar-overlay" onclick="toggleSidebar()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:45; background:rgba(0,0,0,0.5);"></div>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="brand-section flex justify-between items-center">
            <div>
                <div class="brand-title">FRESKEY</div>
                <div class="brand-subtitle" style="font-size:0.7rem; opacity:0.7;">CONTROL CENTER</div>
            </div>
            <div onclick="toggleSidebar()" class="hidden" style="cursor:pointer; font-size:1.5rem;">√ó</div>
        </div>
        <nav class="nav-menu">
            <div class="nav-item active" onclick="router.navigate('dashboard')">üìä Dashboard</div>
            <div class="nav-item" onclick="router.navigate('new-order')">üìù New Order</div>
            <div class="nav-item" onclick="router.navigate('customers')">üë• Customers</div>
            <div class="nav-item" onclick="router.navigate('deliveries')">üöö Deliveries</div>
            <div class="nav-item" onclick="router.navigate('payments')">üí∞ Payments</div>
            <div class="nav-item" onclick="router.navigate('events')">üéâ Events</div>
            <div class="nav-item" onclick="router.navigate('inventory')">üì¶ Inventory</div>
            <div class="nav-item" onclick="router.navigate('reports')">üìà Reports & Data</div>
            <div class="nav-item" onclick="router.navigate('settings')">‚öôÔ∏è Settings</div>
        </nav>
        <div class="user-section">
            <div id="user-display-email" style="font-weight:bold;">...</div>
            <div class="flex items-center mt-1">
                <div style="width:8px; height:8px; background:#10b981; border-radius:50%; margin-right:5px;"></div>
                <span id="sync-status">Connected</span>
            </div>
        </div>
    </aside>

    <!-- MAIN -->
    <main class="main-content">
        <header class="top-bar">
            <div class="flex items-center">
                <span class="mobile-toggle" onclick="toggleSidebar()">‚ò∞</span>
                <div class="screen-title" id="page-title">Dashboard</div>
            </div>
            <div class="flex items-center gap-2">
                <span id="last-sync-time" class="text-muted" style="font-size:0.75rem;">Synced: Just now</span>
                <button class="btn btn-primary" style="font-size:0.8rem; padding: 0.3rem 0.8rem;" onclick="GoogleDriveService.saveToDrive(true)">
                    ‚òÅÔ∏è Force Save
                </button>
                <button class="btn btn-outline" style="font-size:0.8rem; padding: 0.3rem 0.8rem;" onclick="location.reload()">Exit</button>
            </div>
        </header>

        <div id="content-area" class="content-area"></div>
    </main>
</div>

<!-- UTILS -->
<div id="toast-container"></div>
<div id="modal-container" class="hidden modal-overlay"></div>

<script>
/**
 * ============================================================================
 * FRESKEY APP - COMPLETE SOLUTION (DRIVE SYNC + REPORTS + RESPONSIVE)
 * ============================================================================
 */

// --- CONFIGURATION ---
// IMPORTANT: REPLACE THIS WITH YOUR OWN CLIENT ID FROM GOOGLE CLOUD CONSOLE
const CLIENT_ID = '950010994560-v7p6cem78h9fsdp102iq4immb36t95ls.apps.googleusercontent.com'; 
const API_KEY = ''; // Optional if using GIS for Token only, but good to have if using GAPI discovery
const SCOPES = 'https://www.googleapis.com/auth/drive.file';
const DB_FILENAME = 'freskey_db.json';

// --- DATA STORE ---
let store = {
    settings: {
        prices: { '200ml': 10, '500ml': 20, '1L': 40 },
        costs: { '200ml': 4, '500ml': 8, '1L': 15 },
        creditDefaults: { 'Residential': 500, 'Corporate': 5000, 'Retail': 2000, 'Event': 0 }
    },
    inventory: { '200ml': 0, '500ml': 0, '1L': 0 },
    customers: [],
    orders: [],
    events: [],
    lastUpdated: null
};

// --- 1. GOOGLE DRIVE SERVICE (SYNC ENGINE) ---
let tokenClient;
let gapiInited = false;
let gisInited = false;
let driveFileId = null; // Stores the ID of the file in Drive
let autoSyncInterval = null;

const GoogleAuth = {
    init: function() {
        gapi.load('client', async () => {
            await gapi.client.init({
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            });
            gapiInited = true;
            this.checkLoad();
        });
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: (resp) => this.handleTokenResponse(resp),
        });
        gisInited = true;
        this.checkLoad();
    },

    checkLoad: function() {
        if (gapiInited && gisInited) {
            console.log("Google Services Ready");
        }
    },

    handleAuthClick: function() {
        tokenClient.requestAccessToken({prompt: 'consent'});
    },

    handleTokenResponse: async function(resp) {
        if (resp.error) {
            UI.toast("Auth Error: " + resp.error, "danger");
            return;
        }
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        
        // Get User Email (Basic decode)
        const token = gapi.client.getToken().access_token;
        fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { Authorization: `Bearer ${token}` } })
            .then(r => r.json())
            .then(user => {
                document.getElementById('user-display-email').innerText = user.email;
                UI.toast(`Logged in as ${user.given_name}`, "success");
            });

        // Initialize Drive Sync
        await GoogleDriveService.initSync();
    }
};

const GoogleDriveService = {
    initSync: async function() {
        UI.toast("Checking Drive for Database...", "info");
        try {
            // 1. Search for file
            const response = await gapi.client.drive.files.list({
                q: `name = '${DB_FILENAME}' and trashed = false`,
                fields: 'files(id, name)',
                spaces: 'drive'
            });

            const files = response.result.files;
            if (files && files.length > 0) {
                // File exists - Download it
                driveFileId = files[0].id;
                await this.downloadData(driveFileId);
            } else {
                // File does not exist - Use Mock Data & Create File
                UI.toast("New Database Created", "info");
                DataGenerator.init(); // Load defaults
                await this.createFile();
            }

            // Start Auto Sync (Every 60 Seconds)
            this.startAutoSync();
            router.navigate('dashboard');

        } catch (err) {
            console.error(err);
            UI.toast("Drive Sync Error: " + err.message, "danger");
            // Fallback to local
            DataGenerator.init();
            router.navigate('dashboard');
        }
    },

    downloadData: async function(fileId) {
        try {
            const response = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            });
            store = response.result; // Update local store from cloud
            UI.toast("Data Synced from Drive", "success");
            Engine.refreshLastSyncTime();
        } catch (e) {
            UI.toast("Error downloading data", "danger");
        }
    },

    createFile: async function() {
        const fileContent = JSON.stringify(store);
        const metadata = { name: DB_FILENAME, mimeType: 'application/json' };
        
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', new Blob([fileContent], { type: 'application/json' }));

        const accessToken = gapi.client.getToken().access_token;
        
        fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
            body: form
        }).then(res => res.json()).then(val => {
            driveFileId = val.id; // Save new ID
            Engine.refreshLastSyncTime();
        });
    },

    saveToDrive: async function(manual = false) {
        if (!driveFileId) {
            if(manual) this.createFile();
            return;
        }

        store.lastUpdated = new Date().toISOString();
        const fileContent = JSON.stringify(store);

        // Update existing file
        fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=media`, {
            method: 'PATCH',
            headers: new Headers({ 
                'Authorization': 'Bearer ' + gapi.client.getToken().access_token,
                'Content-Type': 'application/json'
            }),
            body: fileContent
        }).then(res => {
            if(res.ok) {
                Engine.refreshLastSyncTime();
                if(manual) UI.toast("Data Saved to Drive", "success");
            }
        }).catch(err => {
            if(manual) UI.toast("Upload Failed", "danger");
        });
    },

    startAutoSync: function() {
        if(autoSyncInterval) clearInterval(autoSyncInterval);
        autoSyncInterval = setInterval(() => {
            this.saveToDrive(false);
        }, 60000); // 1 Minute
    }
};

// --- 2. LOGIC ENGINE ---
const Engine = {
    refreshLastSyncTime: function() {
        const time = new Date().toLocaleTimeString();
        document.getElementById('last-sync-time').innerText = `Synced: ${time}`;
        document.getElementById('sync-status').innerText = "Live Sync Active";
    },
    
    getDashboardStats: function() {
        const today = new Date().toISOString().split('T')[0];
        let stats = { revenue: 0, bottles: 0, profit: 0, pending: 0, sku: {'200ml':0,'500ml':0,'1L':0} };
        
        store.orders.forEach(o => {
            if(o.date === today) {
                stats.revenue += o.amount;
                stats.bottles += o.totalBottles;
                stats.profit += (o.amount - o.cost);
                if(!o.isPaid) stats.pending += o.amount;
                Object.keys(o.items).forEach(k => stats.sku[k] += o.items[k]);
            }
        });
        return stats;
    },

    generateDailyReportPDF: function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const today = new Date().toISOString().split('T')[0];
        
        // Title
        doc.setFontSize(18);
        doc.text("FRESKEY - Daily Sales Report", 14, 20);
        doc.setFontSize(10);
        doc.text(`Date: ${today}`, 14, 28);
        doc.text(`Generated By: Admin`, 14, 33);

        // Summary
        const stats = this.getDashboardStats();
        doc.setFontSize(12);
        doc.text("Summary:", 14, 45);
        doc.setFontSize(10);
        doc.text(`Total Revenue: Rs. ${stats.revenue}`, 14, 52);
        doc.text(`Bottles Sold: ${stats.bottles}`, 14, 58);
        doc.text(`Pending Collections: Rs. ${stats.pending}`, 14, 64);

        // Table
        const tableData = store.orders
            .filter(o => o.date === today)
            .map(o => [o.id, o.customerName, o.totalBottles, `Rs. ${o.amount}`, o.paymentMode]);

        doc.autoTable({
            startY: 70,
            head: [['Order ID', 'Customer', 'Bottles', 'Amount', 'Payment']],
            body: tableData,
        });

        doc.save(`Freskey_Daily_Report_${today}.pdf`);
        UI.toast("PDF Report Downloaded", "success");
    },

    generateMonthlyExcel: function(monthStr) {
        // monthStr format "YYYY-MM"
        if(!monthStr) return UI.toast("Please select a month", "warning");

        const filteredOrders = store.orders.filter(o => o.date.startsWith(monthStr));
        
        if(filteredOrders.length === 0) return UI.toast("No records found for this month", "info");

        // Format data for Excel
        const data = filteredOrders.map(o => ({
            "Date": o.date,
            "Order ID": o.id,
            "Customer Name": o.customerName,
            "Type": store.customers.find(c=>c.id === o.customerId)?.type || 'N/A',
            "200ml Qty": o.items['200ml'] || 0,
            "500ml Qty": o.items['500ml'] || 0,
            "1L Qty": o.items['1L'] || 0,
            "Total Bottles": o.totalBottles,
            "Total Amount": o.amount,
            "Cost": o.cost,
            "Profit": o.amount - o.cost,
            "Payment Mode": o.paymentMode,
            "Status": o.isPaid ? "Paid" : "Pending"
        }));

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Monthly Sales");
        XLSX.writeFile(wb, `Freskey_Sales_${monthStr}.xlsx`);
        UI.toast("Excel Sheet Downloaded", "success");
    }
};

// --- 3. UI HANDLERS ---
const UI = {
    toast: function(msg, type='info') {
        const box = document.createElement('div');
        box.className = `toast`;
        box.style.borderLeftColor = type==='danger' ? 'red' : type==='success' ? 'green' : 'blue';
        box.innerHTML = `<strong>${type.toUpperCase()}</strong>: ${msg}`;
        document.getElementById('toast-container').appendChild(box);
        setTimeout(() => box.remove(), 3000);
    },
    modal: function(html) {
        const c = document.getElementById('modal-container');
        c.innerHTML = `<div class="modal"><div class="text-right mb-2"><button class="btn btn-outline" onclick="UI.closeModal()">‚úï</button></div>${html}</div>`;
        c.classList.remove('hidden');
    },
    closeModal: function() { document.getElementById('modal-container').classList.add('hidden'); }
};

function toggleSidebar() {
    document.querySelector('.sidebar').classList.toggle('open');
    const overlay = document.getElementById('sidebar-overlay');
    overlay.style.display = overlay.style.display === 'none' ? 'block' : 'none';
}

// --- 4. MOCK GENERATOR (Only runs if Drive Empty) ---
const DataGenerator = {
    init: function() {
        console.log("Generating Mock Data...");
        store.inventory = { '200ml': 2000, '500ml': 1000, '1L': 500 };
        const types = ['Residential', 'Corporate', 'Retail'];
        for(let i=1; i<=20; i++) {
            store.customers.push({
                id: `C${100+i}`, name: `Customer ${i}`, type: types[i%3],
                phone: '9999999999', area: 'Central Hub', creditLimit: 2000, outstanding: 0, status: 'Active'
            });
        }
    }
};

// --- 5. ROUTER & PAGES ---
const router = {
    navigate: function(page) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.querySelector(`.nav-item[onclick*='${page}']`)?.classList.add('active');
        document.getElementById('page-title').innerText = page.charAt(0).toUpperCase() + page.slice(1);
        
        // Close sidebar on mobile nav
        document.querySelector('.sidebar').classList.remove('open');
        document.getElementById('sidebar-overlay').style.display = 'none';

        const content = document.getElementById('content-area');
        content.innerHTML = Pages[page] ? Pages[page]() : '<h1>404</h1>';
        
        if(page === 'new-order') this.bindNewOrderEvents();
    },

    bindNewOrderEvents: function() {
        // Helper to calc totals
        window.calcOrder = () => {
            const p = store.settings.prices;
            const q200 = parseInt(document.getElementById('q200').value) || 0;
            const q500 = parseInt(document.getElementById('q500').value) || 0;
            const q1l = parseInt(document.getElementById('q1l').value) || 0;
            const total = (q200*p['200ml']) + (q500*p['500ml']) + (q1l*p['1L']);
            document.getElementById('ord-total').innerText = '‚Çπ' + total;
        };
    }
};

const Pages = {
    dashboard: function() {
        const stats = Engine.getDashboardStats();
        return `
            <div class="stat-grid">
                <div class="card text-center"><h3 class="text-muted">Today's Sales</h3><h1 class="font-bold">‚Çπ${stats.revenue}</h1></div>
                <div class="card text-center"><h3 class="text-muted">Bottles</h3><h1 class="font-bold">${stats.bottles}</h1></div>
                <div class="card text-center"><h3 class="text-muted">Est. Profit</h3><h1 class="text-success font-bold">‚Çπ${stats.profit}</h1></div>
                <div class="card text-center"><h3 class="text-muted">Pending</h3><h1 class="text-danger font-bold">‚Çπ${stats.pending}</h1></div>
            </div>
            <div class="dashboard-split">
                <div class="card">
                    <h3 class="font-bold mb-4">Quick Actions</h3>
                    <div class="flex gap-4">
                        <button class="btn btn-primary w-full" onclick="router.navigate('new-order')">New Order</button>
                        <button class="btn btn-accent w-full" onclick="router.navigate('deliveries')">Logistics</button>
                    </div>
                </div>
                <div class="card">
                    <h3 class="font-bold mb-2">Sync Status</h3>
                    <p class="text-muted text-sm">Auto-upload active (60s interval).</p>
                    <div class="sync-badge syncing mt-2">Drive Connected</div>
                </div>
            </div>
        `;
    },

    newOrder: function() {
        const options = store.customers.map(c => `<option value="${c.id}">${c.name} (${c.type})</option>`).join('');
        return `
            <div class="card" style="max-width: 800px; margin:0 auto;">
                <div class="form-group"><label class="form-label">Customer</label><select id="ord-cust" class="form-select">${options}</select></div>
                <div class="form-group"><label class="form-label">Date</label><input type="date" id="ord-date" class="form-input" value="${new Date().toISOString().split('T')[0]}"></div>
                <hr class="my-4">
                <div class="flex gap-2">
                    <div class="w-full"><label class="form-label">200ml</label><input type="number" id="q200" class="form-input" placeholder="0" oninput="calcOrder()"></div>
                    <div class="w-full"><label class="form-label">500ml</label><input type="number" id="q500" class="form-input" placeholder="0" oninput="calcOrder()"></div>
                    <div class="w-full"><label class="form-label">1 Litre</label><input type="number" id="q1l" class="form-input" placeholder="0" oninput="calcOrder()"></div>
                </div>
                <div class="flex justify-between items-center mt-4 bg-gray-50 p-4 rounded">
                    <strong>Total Amount</strong>
                    <span id="ord-total" class="font-bold text-xl">‚Çπ0</span>
                </div>
                <div class="form-group mt-2">
                    <label class="form-label">Payment</label>
                    <select id="ord-pay" class="form-select">
                        <option>Cash</option><option>Online</option><option>Credit</option>
                    </select>
                </div>
                <button class="btn btn-success w-full mt-4" onclick="Pages.submitOrder()">Confirm Order</button>
            </div>
        `;
    },

    submitOrder: function() {
        const custId = document.getElementById('ord-cust').value;
        const cust = store.customers.find(c => c.id === custId);
        const q200 = parseInt(document.getElementById('q200').value) || 0;
        const q500 = parseInt(document.getElementById('q500').value) || 0;
        const q1l = parseInt(document.getElementById('q1l').value) || 0;
        
        if(q200+q500+q1l === 0) return UI.toast("Empty Order", "danger");

        const amt = (q200*10) + (q500*20) + (q1l*40);
        const cost = (q200*4) + (q500*8) + (q1l*15);
        const pay = document.getElementById('ord-pay').value;

        const order = {
            id: 'ORD'+Date.now(),
            customerId: custId,
            customerName: cust.name,
            date: document.getElementById('ord-date').value,
            items: { '200ml': q200, '500ml': q500, '1L': q1l },
            totalBottles: q200+q500+q1l,
            amount: amt,
            cost: cost,
            paymentMode: pay,
            isPaid: pay !== 'Credit',
            status: 'Pending'
        };

        if(pay === 'Credit') cust.outstanding += amt;
        
        // Deduct Inventory
        store.inventory['200ml'] -= q200;
        store.inventory['500ml'] -= q500;
        store.inventory['1L'] -= q1l;

        store.orders.push(order);
        UI.toast("Order Placed", "success");
        router.navigate('dashboard');
    },

    customers: function() {
        const rows = store.customers.map(c => 
            `<tr><td>${c.name}</td><td>${c.type}</td><td>‚Çπ${c.outstanding}</td><td><span class="badge badge-success">${c.status}</span></td></tr>`
        ).join('');
        return `
            <div class="card">
                <div class="flex justify-between items-center mb-2">
                    <h3>Customer Database</h3>
                    <button class="btn btn-primary" onclick="Pages.addCustomerModal()">+ Add</button>
                </div>
                <div style="overflow-x:auto">
                    <table><thead><tr><th>Name</th><th>Type</th><th>Dues</th><th>Status</th></tr></thead><tbody>${rows}</tbody></table>
                </div>
            </div>
        `;
    },

    addCustomerModal: function() {
        UI.modal(`
            <h3>Add Customer</h3>
            <input id="new-name" class="form-input mb-2" placeholder="Name">
            <select id="new-type" class="form-select mb-2"><option>Residential</option><option>Retail</option><option>Corporate</option></select>
            <button class="btn btn-primary w-full" onclick="Pages.saveCustomer()">Save</button>
        `);
    },

    saveCustomer: function() {
        const name = document.getElementById('new-name').value;
        const type = document.getElementById('new-type').value;
        if(!name) return;
        store.customers.push({ id: 'C'+Date.now(), name, type, outstanding: 0, status: 'Active' });
        UI.closeModal();
        router.navigate('customers');
    },

    deliveries: function() {
        const today = new Date().toISOString().split('T')[0];
        const list = store.orders.filter(o => o.date === today && o.status === 'Pending').map(o => 
            `<tr><td>${o.customerName}</td><td>${o.totalBottles} btls</td><td><button class="btn btn-outline" onclick="Pages.markDelivered('${o.id}')">Done</button></td></tr>`
        ).join('');
        return `<div class="card"><h3>Logistics (${today})</h3><table><thead><tr><th>Client</th><th>Qty</th><th>Action</th></tr></thead><tbody>${list || '<tr><td colspan="3">No Pending Deliveries</td></tr>'}</tbody></table></div>`;
    },

    markDelivered: function(id) {
        const o = store.orders.find(x => x.id === id);
        if(o) o.status = 'Delivered';
        router.navigate('deliveries');
    },

    payments: function() {
        const dues = store.customers.filter(c => c.outstanding > 0).map(c => 
            `<tr><td>${c.name}</td><td class="text-danger">‚Çπ${c.outstanding}</td><td><button class="btn btn-success" onclick="Pages.payModal('${c.id}')">Collect</button></td></tr>`
        ).join('');
        return `<div class="card"><h3>Collections</h3><table><thead><tr><th>Client</th><th>Due</th><th>Action</th></tr></thead><tbody>${dues}</tbody></table></div>`;
    },

    payModal: function(id) {
        const c = store.customers.find(x => x.id === id);
        UI.modal(`
            <h3>Collect from ${c.name}</h3>
            <p>Current Due: ‚Çπ${c.outstanding}</p>
            <input type="number" id="pay-amt" class="form-input mb-2" value="${c.outstanding}">
            <button class="btn btn-success w-full" onclick="Pages.processPay('${id}')">Record Payment</button>
        `);
    },

    processPay: function(id) {
        const amt = parseInt(document.getElementById('pay-amt').value);
        const c = store.customers.find(x => x.id === id);
        c.outstanding -= amt;
        UI.closeModal();
        router.navigate('payments');
    },

    inventory: function() {
        return `
            <div class="stat-grid">
                <div class="card"><h3>200ml Stock</h3><h1>${store.inventory['200ml']}</h1></div>
                <div class="card"><h3>500ml Stock</h3><h1>${store.inventory['500ml']}</h1></div>
                <div class="card"><h3>1L Stock</h3><h1>${store.inventory['1L']}</h1></div>
            </div>
            <button class="btn btn-primary" onclick="UI.toast('Stock Update UI not active in demo','info')">Add Stock</button>
        `;
    },

    reports: function() {
        return `
            <div class="card">
                <h3 class="mb-4">Business Reports</h3>
                
                <div class="flex flex-col gap-4">
                    <!-- Daily Report -->
                    <div style="border:1px solid #eee; padding:15px; border-radius:8px;">
                        <h4 class="font-bold">Daily Sales Report (PDF)</h4>
                        <p class="text-muted text-sm mb-2">Generates receipt for today's transactions.</p>
                        <button class="btn btn-primary" onclick="Engine.generateDailyReportPDF()">üìÑ Download PDF</button>
                    </div>

                    <!-- Monthly Excel -->
                    <div style="border:1px solid #eee; padding:15px; border-radius:8px;">
                        <h4 class="font-bold">Monthly Master Sheet (Excel)</h4>
                        <p class="text-muted text-sm mb-2">Export complete sales record for a specific month.</p>
                        <div class="flex gap-2">
                            <input type="month" id="report-month" class="form-input" style="width:200px">
                            <button class="btn btn-success" onclick="Engine.generateMonthlyExcel(document.getElementById('report-month').value)">üìä Download Excel</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    events: function() { return '<div class="card"><h3>Event Management</h3><p>Module active.</p></div>'; },
    settings: function() { return '<div class="card"><h3>Settings</h3><p>System Config.</p></div>'; }
};

// Initialize Google Scripts
GoogleAuth.init();
</script>
</body>
</html>
